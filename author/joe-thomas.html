<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Joe Thomas | Articles by Joe Thomas</title>
    <link rel="shortcut icon" type="image/png" href="https://jsthomas.github.io/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://jsthomas.github.io/favicon.ico">
    <link href="https://jsthomas.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Joe Thomas Full Atom Feed" />
    <link rel="stylesheet" href="https://jsthomas.github.io/theme/css/main.css" type="text/css" />
    <link rel="stylesheet" href="https://jsthomas.github.io/theme/css/pygments.css" type="text/css" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="Joe Thomas" />
</head>
<body>
    <header>
        <nav>
            <ul>

                <li class="ephemeral selected"><a href="https://jsthomas.github.io/author/joe-thomas.html">Joe Thomas</a></li>
                <li><a href="https://jsthomas.github.io/">About</a></li>
                <li><a href="https://jsthomas.github.io/pages/works.html">Works</a></li>
                <li><a href="https://jsthomas.github.io/blog">Blog</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://jsthomas.github.io/">Joe Thomas</a></h1>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Oct 20, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://jsthomas.github.io/first-opam-package.html" rel="bookmark" title="Permanent Link to &quot;What I learned publishing an open source package&quot;">What I learned publishing an open source package</a>
                </h2>

                
                

                <p>Today I published my first package on OPAM! You can find <code>tidy_email</code>
and its sub-libraries (<code>tidy_email_mailgun</code>, <code>tidy_email_sendgrid</code>,
and <code>tidy_email_smtp</code>)
<a href="https://opam.ocaml.org/packages/tidy_email/tidy_email.0.0.1/">here</a>. This
wrapped up a goal I wanted to accomplish while at <a href="https://www.recurse.com/">Recurse
Center</a>: Writing a simple (but useful) OCaml
library and making it available via <code>opam</code>.</p>
<p>I chose this project for several reasons:</p>
<ol>
<li>I wanted more experience designing small APIs in OCaml.</li>
<li>I thought releasing a small library would help me understand how
"open source maintainer" work differs from paid closed-source
application development.</li>
<li>I wanted to learn more about the mechanics/process of packaging
   code for OPAM.</li>
</ol>
<p>The rest of this post explains the process I used and which parts
worked well. Most of this discussion is applicable to general open
source development, but some of the tooling-related points are
specific to OCaml.</p>
<h1>Picking a Topic</h1>
<p>When I started my batch at RC, I knew that I wanted to publish
<em>something</em>, but hadn't settled on a topic. Contributing to other
projects was a valuable source of ideas. After working on a couple of
issues for the web framework
<a href="https://github.com/aantron/dream">Dream</a>, I wrote a small <a href="https://jsthomas.github.io/ocaml-email.html">blog
post</a> showing how to
build a simple email feature with Mailgun. That started a discussion
with other Dream contributors about how to simplify the implementation
of email features.</p>
<p>After a few more conversations, I decided to write an "adapter"
library that creates a consistent interface across different email
services. Instead of having to study Mailgun or Sendgrid's REST API
and worry about the details of making HTTP requests, you can install
<code>tidy_email</code>, provide your API keys, and use a <code>send</code> function that
consumes a simple email type. The library also makes switching email
providers as simple as changing your credentials.</p>
<p>I intentionally kept the scope of the library very small, since this
allowed me to complete the project in a short time frame
while learning several new skills/systems.</p>
<h1>Looking at "Prior Art"</h1>
<p>Before I started implementing, I researched existing libraries that
dealt with email. This took time but paid dividends by helping me to
avoid re-inventing existing functionality. I learned more about
<a href="https://github.com/oxidizing/letters/"><code>letters</code></a>, a library for
sending email via SMTP and supporting libraries like
<a href="https://github.com/mirage/mrmime"><code>mrmime</code></a> for parsing and
generating email. Later, I utilized some of these libraries while
adding an SMTP option to <code>tidy_email</code>.</p>
<p>Investigating other work in the OCaml web development space helped me
to articulate some of the design goals for my library.  I looked at
the web framework
<a href="https://github.com/oxidizing/sihl/tree/master/sihl-email">sihl</a>,
which has email among it's many capabilities, and realized I wanted to
make a very "slim" library that didn't couple sending email with other
dependencies related to SQL, HTTP, etc.</p>
<h1>Picking a Name</h1>
<p>Naming things is hard! I spent some time looking through OPAM to see
which names were already taken (<code>emile</code>, <code>letters</code>). Ultimately, I
decided on these constraints:</p>
<ul>
<li>The name needed to be short, easy to search and remember.</li>
<li>Ideally it would have only simple English words in it.</li>
<li>The name should relate to email in an obvious way.</li>
</ul>
<p>I settled on <code>tidy_email</code> based on Dream's description as a "tidy,
feature-complete web framework". The goal of the library would be to
provide a "tidy" (i.e. well-designed, beginner-friendly) API for
sending mail, and hopefully appeal to people who also like Dream.</p>
<p>One mistake I made early on was not sticking to a consistent naming
scheme; I had <code>tidy-email</code>, <code>tidy_email</code>, and "tidy email" in
different places. Fortunately, github makes it fairly easy to re-name
a repo if you change your mind later; it will even redirect from the
old repo name to the new one.</p>
<h1>Writing a First Draft</h1>
<p>Even though <code>tidy_email</code> is quite simple. It took me some time to set
all the resources up.</p>
<p>Before I could get an account with Sendgrid, I had to register a
domain and create a simple website. I used AWS for this because I was
already familiar with it from past jobs. I also needed to register for
Mailgun and create keys for API and SMTP access. At some point, I had
accumulated enough credentials that I needed to set up password
management to stay organized.</p>
<p>Once I had access to services, I was able to write a first draft of
the library. This turned out to be harder than I expected! I wasted a
lot of time over-complicating my code with new concepts I had learned
(functors and higher order modules). Eventually I came to my senses
and wrote a much simpler implementation.</p>
<p>I found keeping good notes to be quite helpful in this phase. Later, I
turned these notes into documentation explaining how to set up mail
services and some relevant trade-offs when choosing a service (tl;dr:
Mailgun was the easiest, lowest-commitment way to get started).</p>
<h1>Getting Feedback</h1>
<p>My main advice is: Don't go it alone. Having someone (ideally a more
experienced maintainer) review early drafts of work was really
valuable for staying on track. This helped me:</p>
<ul>
<li>Understand how new users would think.</li>
<li>Re-order things to make them easier for first-time users to understand.</li>
<li>Remove confusing or superfluous parts of my API.</li>
<li>Leverage github features I wasn't aware of (actions and secrets).</li>
</ul>
<p>I also found it helpful to attend <a href="https://discuss.ocaml.org/t/ocaml-cafe-wed-oct-13-1pm-u-s-central/8610">OCaml
Cafe</a>
(this is currently meeting on Zoom). A lecture about <code>dune</code> given by
Rudi Grinberg showed me some techniques that made managing multiple
<code>.opam</code> files much easier.</p>
<h1>Testing</h1>
<p>I didn't keep a careful count of my hours but I estimate that more
than half were spent writing unit and integration tests. Setting these
up early made it much easier to iterate on my design and accept pull
requests. Github actions were pretty straightforward to configure
(specified with a simple YAML
<a href="https://github.com/jsthomas/tidy_email/blob/main/.github/workflows/test.yml">file</a>)
after looking at a few examples. I appreciated not having to sign up
for yet another service in order to get a simple CI system working.</p>
<p>In <code>tidy_email</code>, an "integration test" is just a small executable that
tries to send an email to a mailbox. I used github secrets to add API
keys to my project so that integration tests could run securely on an
PR/merge that I made. It would've been nice to be able to run
integration tests on outside PRs automatically, but there isn't really
a way to do that securely.</p>
<p>Integration tests ended up being very advantageous for shaking out
problems that new users are likely to encounter. For example, by
testing with (intentionally) invalid SMTP credentials, I
<a href="https://jsthomas.github.io/smtp-debugging.html">learned</a> that Mailgun
can terminate SMTP connections in a way that is hard for <code>colombe</code> to
handle. Debugging this example gave me some valuable experience
digging into <code>tidy_email</code>'s dependencies and helped me file a good bug
report to help improve <code>colombe</code>.</p>
<h1>Documentation</h1>
<p>I spent more time than expected writing documentation. The main lesson
I learned is: <em>Don't bury the lede.</em> When people look at your repo,
they have limited time. Therefore, the first things you should show
them are</p>
<ol>
<li>A simple, one sentence summary of what the library does.</li>
<li>A minimal working example (code) illustrating the library in action.</li>
</ol>
<p>Everything that comes after this introduction should be in the service
of getting the user set up as painlessly as possible. In my case, that
meant adding sign-up links to the relevant services the library
supports. I also provided a brief explanation of the trade-offs when
choosing a service.</p>
<p><code>tidy_email</code> is small enough that I didn't write documentation beyond
a readme, comments in the code, and folders of working examples. I
think for a project any larger than this, I would have had to invest
some time thinking about how to generate and host a static site with
documentation (e.g. ReadTheDocs).</p>
<h1>Release</h1>
<p>Publishing my code on <a href="https://opam.ocaml.org/">opam</a> was relatively
painless. To sum up the process:</p>
<ol>
<li>I ran <code>dune build</code> one final time and verified my opam files were
   up to date.</li>
<li>I created a "tag" for my project (<code>git tag -a 0.0.1 &amp;&amp; git push origin 0.0.1</code>).</li>
<li>I ran "opam publish", which created a <a href="https://github.com/ocaml/opam-repository/pull/19816">pull
   request</a> on
   <code>ocaml/opam-repository</code>.</li>
<li>~12 hours later my PR passed CI and was approved.</li>
<li>About 6 hours after that, my PR was merged and showed up on <code>opam</code>.</li>
</ol>
<p>My <a href="https://github.com/ocaml/opam-repository/pull/19634">first
attempt</a> at
publishing didn't pass CI because of some simple mistakes I made in my
<code>.opam</code> files. Fixing these was relatively straightforward after
reading the docs and looking at some other repos for reference.</p>
<h1>Final Thoughts</h1>
<p>None of the work involved with releasing <code>tidy_email</code> was especially
<em>hard</em>, but there were <em>many</em> small tasks to understand. Compared to
paid application development work, I found that this project had more
"admin work": signing up for services, configuring things, and writing
prose.</p>
<p>Overall, I found this type of work quite rewarding. It has been fun to
see new people discover and star the repo on Github. The project
motivated me to learn aspects of email that I would not have otherwise
explored. Given how much open source software I use, it feels great
to make a small contribution to the community.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://jsthomas.github.io/first-opam-package.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://jsthomas.github.io/category/oss-projects.html" rel="tag">OSS, Projects</a>
                </div>
            </article>            <h4 class="date">Sep 03, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://jsthomas.github.io/elm-space-battle.html" rel="bookmark" title="Permanent Link to &quot;Writing a Simple Browser Game in Elm&quot;">Writing a Simple Browser Game in Elm</a>
                </h2>

                
                

                <p>TL;DR : This week I built a little spaceship game using Elm! You can
play the game <a href="https://jsthomas.github.io/static/elm-space-battle/index.html">here</a> (it
probably won't work well on mobile or if you have a tiny screen) and
see the source code
<a href="https://github.com/jsthomas/elm-space-battle">here</a>.</p>
<p><em>Here's a screenshot:</em></p>
<p><img alt="A screenshot of my
game." src="https://jsthomas.github.io/images/elm-space-battle/game_small.png" style="width: 595px; height: auto;"/></p>
<h1>Context</h1>
<p>This was my last week at Recurse Center; after Labor Day, I head back
to full time work as a data engineer. One of my main RC projects,
<a href="https://github.com/jsthomas/tidy-email">tidy-email</a>, is waiting on
some upstream changes on OPAM before it can be released. In light of
all this, I decided to work on a short term project this week, and
learn a bit of <a href="https://elm-lang.org/">Elm</a>.</p>
<p>My reasons for learning Elm are twofold. First, I think this
technology is a great example of how to make strongly typed functional
programming accessible to a wider audience. It's worth studying just
for the sake of examining how ideas are presented, because I can
re-use those skills to build user-friendly OCaml projects. Second, the
"Elm Architecture" is widely used in front-end programming and I'd
like to fill in some of the gaps in my front-end skill-set.</p>
<h1>Defining the Project</h1>
<p>I wanted this week's project to be small in scope and entertaining, so
I decided to build a game similar to the 1962 game <em>Spacewar!</em>,
written for the PDP-1 at MIT. You can read more about this game
<a href="https://en.wikipedia.org/wiki/Spacewar!">here</a> and play an emulated
version <a href="https://www.masswerk.at/spacewar/">here</a>.</p>
<p><img alt="The original spacewar on a DEC
monitor." src="https://jsthomas.github.io/images/elm-space-battle/Spacewar_screenshot_small.png" style="width: 600px; height: auto;"/></p>
<p><em>Spacewar!</em> features two rocket ships orbiting a star; the objective
is to destroy the other player's ship by shooting it with a
torpedo. The star exerts a gravitational pull on the two rockets,
which complicates the ship's trajectories. A player that gets too
close to the star loses. Player's that fly off the screen reappear on
the opposite side, just like in Asteroids.</p>
<p>After playing with <em>Spacewar!</em> for a bit, I decided on the following
rules for my game:</p>
<ul>
<li>The game should be single player instead of two player, with simple
  AI opponents.</li>
<li>The player's should have a finite number of torpedoes, which
  replenish as they are used.</li>
<li>The AI opponents should be able to shoot their own torpedoes at the
  player.</li>
<li>Both the player and torpedoes should be influenced by gravity.</li>
<li>There should be a display at the top of the screen tracking how many
  torpedoes the player has left and how many enemies they need to
  destroy.</li>
<li>The player can lose by colliding with the sun, a torpedo, or an
  enemy.</li>
</ul>
<h1>Getting set up with Elm</h1>
<p>I was quite impressed with how simple it was to get set up with
<code>elm</code>. There is a single executable that handles compiling Elm source
files, downloading dependencies from the internet, and serving an Elm
<code>repl</code>.</p>
<p>I read <a href="https://elmprogramming.com/">Beginning Elm</a> to get a feel for
the language. If you're coming to Elm from another strongly typed
language like OCaml or Haskell, this guide is a pretty fast read. I
appreciated that it provided chapters on the Elm architecture and how
to make requests against a JSON API, so that I could jump right to
those topics and start learning what I wanted to know.</p>
<p>I also found the online code editor
<a href="https://ellie-app.com/62Dy7vxsBHZa1">Ellie</a> quite helpful for running
little experiments without installing anything, especially as I wanted
to learn more about the elm-canvas library.</p>
<p>The main Elm documentation
<a href="https://package.elm-lang.org/packages/joakin/elm-canvas/4.3.0/">page</a>
provided a concise overview of the graphics package I wanted to
use. Overall, I was quite happy with the quality of the documentation,
though I did encounter a number of dead links on stack overflow.</p>
<p>I used VSCode with the <code>Elm</code> extension for my development work. This
was straightforward to install. Syntax and error highlighting worked
fine. I found the error highlighter to be quite aggressive. Part way
through adding a new function definition, the highlighter would mark
the entire source file as a single error, which was distracting. I
didn't bother to get live-reloading working because the project was so
small, but this would've been nice to have.</p>
<h1>Thoughts on the Elm Architecture</h1>
<p>The Elm Architecture is worth expanding on a bit, and is summed up by
the following diagram in <em>Beginning Elm</em>:</p>
<p><img alt="Elm architecture diagram" src="https://jsthomas.github.io/images/elm-space-battle/elm-arch.png" style="width: 1022px; height: auto;"/></p>
<p>The Elm runtime is responsible for handling all side-effects, so that
Elm programmers only need to work with pure functions and immutable
data. To define the application, we provide the runtime with a handful
of important definitions:</p>
<ul>
<li>A model that defines the state of the game at a moment in time.</li>
<li>An initial model state, to be used when the app loads.</li>
<li>A view function, that explains how to render the model in the browser.</li>
<li>An update rule, that explains how to transform one model into
  another model based on inputs from the runtime.</li>
<li>Finally, any subscriptions the app needs. In my case, the app
  subscribes to events from the keyboard and events from a timer, and
  these events dictate how to update the model.</li>
</ul>
<p>I found that separating effectful code from pure code was very
convenient. It greatly simplified reasoning about my game logic. I
found that it natural to express different "game rules" in terms of
transformations on the <code>Model</code>, like this:</p>
<div class="highlight"><pre><span></span><code><span class="nv">removeOldTorpedos</span> <span class="nf">:</span> <span class="kt">Model</span> <span class="nf">-&gt;</span> <span class="kt">Model</span>
<span class="nv">removeOldTorpedos</span> <span class="nv">model</span> <span class="nf">=</span>
    <span class="kr">let</span> <span class="nv">torpedoLifetime</span> <span class="nf">=</span> <span class="mi">60</span> <span class="nf">*</span> <span class="mi">2</span> <span class="kr">in</span>  <span class="c1">-- ~ 2 seconds</span>
    <span class="kr">let</span> <span class="nv">isLive</span> <span class="nv">b</span> <span class="nf">=</span> <span class="nv">model</span><span class="nf">.</span><span class="nv">time</span> <span class="nf">-</span> <span class="nv">b</span><span class="nf">.</span><span class="nv">created</span> <span class="nf">&lt;</span> <span class="nv">torpedoLifetime</span> <span class="kr">in</span>
    <span class="p">{</span><span class="nv">model</span> <span class="nf">|</span> <span class="nv">torpedos</span> <span class="nf">=</span> <span class="kt">List</span><span class="nf">.</span><span class="nv">filter</span> <span class="nv">isLive</span> <span class="nv">model</span><span class="nf">.</span><span class="nv">torpedos</span><span class="p">}</span>
</code></pre></div>
<h1>Developer Experience</h1>
<p>Building a game in Elm was quite pleasant. The compiler's error
messages are easy to interpret and the type system enables aggressive
refactoring that would have been difficult for me to do in
JavaScript. I found it quite easy to evolve my design as I worked and
I didn't need to refer back to <em>Beginning Elm</em> or the documentation
very often.</p>
<p>Overall I found Elm much easier to understand than rescript. I think
this was in part because there are better-established conventions
about how to build with Elm, and rescript is newer. I also found Elm's
syntax easier to understand coming from OCaml than the JS/OCaml hybrid
syntax in rescript.</p>
<p>I started the project with a very simple goal: Display a static scene
with a background of stars, a yellow sun at the center, and two space
ships. From there, I started to add simple physics, the ability to
respond to keyboard events, and a simple collision detection
system.</p>
<p>I really enjoyed how the compiler enabled me to explore "what-if"
scenarios, like "What if I wanted to make the torpedoes change colors
over time?". I found myself working in this cycle:</p>
<ul>
<li>Ask a what-if question.</li>
<li>Change the data model to support that question.</li>
<li>Fix the errors identified by the compiler.</li>
<li>Compile.</li>
<li>Try the game and reflect on whether it was more fun.</li>
</ul>
<p>This tight development loop allowed me to spend most of my time
"discovering" the right definitions for my game rather than fighting
with confusing JavaScript bugs. Once I had a canvas and keyboard
inputs working (which required a bit of research), the game came
together quite quickly.</p>
<h1>Conclusion</h1>
<p>Fundamentally, I think Elm was easy to start using for two reasons:</p>
<ul>
<li>It cleanly separates pure computations from ones with side effects,
  via the Elm Architecture.</li>
<li>The Elm team spent time making the tools easy to use and created
  well-written tutorials explaining the language.</li>
</ul>
<p>This is definitely a tool I'd consider using for future front-end work
and I'd recommend it to other developers who are interested in
exploring strongly typed functional programming for the first time.</p>
<h1>Feedback</h1>
<p>If you found this post useful (or conversely, think that the advice
here is bad), send me an email. My contact information is listed on
the <a href="/">About</a> page.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://jsthomas.github.io/elm-space-battle.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://jsthomas.github.io/category/fp-elm.html" rel="tag">FP, Elm</a>
                </div>
            </article>            <h4 class="date">Aug 30, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://jsthomas.github.io/icfp-2021.html" rel="bookmark" title="Permanent Link to &quot;Things I learned at ICFP 2021&quot;">Things I learned at ICFP 2021</a>
                </h2>

                
                

                <p>Last week I attended ICFP for the first time. Due to the pandemic, the
conference was entirely online. This made it really easy and
inexpensive to attend (were it in person, I would've had to fly to
Korea), but also made it harder to meet people and benefit from "the
hallway track".</p>
<p>Despite the circumstances, there were a number of interesting
sessions. Below is a summary of some of the projects I learned about
at the conference. Some caveats:</p>
<ul>
<li>
<p>ICFP has a lot of parallel tracks. I was focused primarily on ML and
  OCaml sessions, so I'm sure there were interesting talks that I
  missed.</p>
</li>
<li>
<p>I missed some talks due to timezone issues.</p>
</li>
<li>
<p>I'm approaching the conference as someone who primarily works on the
  backend of analytics applications, so I wasn't as interested in new
  results about PL theory.</p>
</li>
</ul>
<p>I think conferences are a great way to hear about new technologies,
but for depth you have to study on your own afterwards. As such, this
post is a bit of a "listicle" capturing topics I might want to
investigate later.</p>
<h1>Keynote</h1>
<p>Ravi Chugh gave an interesting keynote about how programming language
techniques can be applied to human-computer interaction problems. He
demonstrated a 2D graphics editor called Sketch-n-sketch where the
user could create an image using a GUI or a programming language, and
synchronize between the two.</p>
<p>Before this session, I didn't realize how much research has been done
into applying FP/PL techniques to human/computer interfaces. It would
be interesting to apply similar techniques to a 3D animation system
like Blender. When I used to work on animation (long, long ago), I
wanted GUI capabilities for building individual models in a scene but
would have preferred a programming language when rigging characters or
automating certain motions. Debugging GUI-based automation was
no fun at all.</p>
<h1>Historical Talks</h1>
<p>Don Syme gave a talk about the history of F#. This covered the
original motivation for the language, it's interactions with the C#
community, and the impact of Object Orient Programming's popularity on
PL research. Xavier Leroy gave a presentation about the history of
OCaml (this year was the language's 25th anniversary), and also
commented on the impact of OO. It was interesting to hear about how
OCaml was used for teaching programming in Universities and how this
language related to research in automated theorem proving.</p>
<h1>Research and Industry Talks</h1>
<p>Marten Agren gave a talk about how Standard Chartered uses a strict
version of Haskell for their work, and how FP is especially suited to
scalable inter-operation with spreadsheets. Before this talk, I didn't
know that some people use Haskell without lazy evaluation.</p>
<p>Denis Merigoux gave a <a href="https://youtu.be/jmHwAh_-IOU">presentation</a>
about a new DSL called <a href="https://github.com/CatalaLang">Catala</a> that
makes it possible to model laws (e.g. tax law) with code. The compiler
for the language is written in OCaml. Naturally, the correctness of
these types of systems is quite important; errors mean that essential
social services aren't delivered (e.g. paychecks for government
workers). It's interesting to think about other areas where this work
could be applied beyond tax law. For example, most utility costs are
also a matter of public record and having an open, formally verified
system for calculating those costs would help ensure rate payers are
billed fairly.</p>
<h2>Talks about tooling and libraries</h2>
<p>The OCaml workshop featured several exciting talks about improvements
to the OCaml ecosystem.</p>
<p>Laurent Mazare spoke about how Jane Street makes OCaml libraries
accessible from within python, with a special focus on Jupyter
notebooks. As someone who has worked supporting data scientists in the
past, this seems like a great way to get the benefits of the Python
data science ecosystem while building primarily in a strongly typed
language. I'm not sure what this work means for projects like Owl that
try to provide a similar feature set as Numpy/SciPy/Pandas in OCaml.</p>
<p>Di Long Li and Gabriel Radanne presented a new library called
<a href="https://github.com/daypack-dev/timere"><code>timere</code></a> that makes it easier
to work with dates and times. The library simplifies solving
recurrence-rule problems like "tell me which Christmases fall on a
Wednesday from now on". I think this is a great development,
especially if you're building an application that works with time
series data from a business domain. Gabriel Radanne also presented
<a href="https://github.com/Drup/dowsing"><code>dowsing</code></a> a tool that allows the
user to search OCaml codebases using a type signature. This is a bit
like <a href="https://hoogle.haskell.org/">hoogle</a>, but the underlying
techniques used to enable search are quite different.</p>
<p>Thomas Leonard gave an impressive talk about applying the new effect
system in multicore OCaml to the <code>angstrom</code> library, demonstrating
performance on par with Rust. I think it will be exciting to start
using effects as they become available in the next year or two.</p>
<p>Two different teams discussed their efforts to improve the state of
OCaml documentation, so that a site similar to
<a href="https://hackage.haskell.org/">hackage</a> could be generated directly
from OPAM. This seems like a great way to lower one of the barriers to
entry for maintainers and make OCaml documentation more consistent.</p>
<p>Gargi Sharma presented work that a team at Tarides is doing on
<a href="https://github.com/ocurrent/current-bench"><code>current-bench</code></a>, a system
for analyzing benchmarking data that integrates with OCaml CI
systems. Using their tools, one can track trends in benchmark data
over time and identify builds that improved or degraded
performance. This system also provides a nice example of how to build
an analytics app using FP techniques. They use <code>rescript</code> for their
frontend, <code>hasura</code> to serve analytics results via GraphQL, and an
OCaml program for ingesting performance data into their database.</p>
<h1>Takeaways</h1>
<p>There was a lot of focus on "ecosystem tooling" at the OCaml workshop
and considerable excitement about the upcoming release of multicore
OCaml. I didn't hear much about work on the frontend (ReasonML,
Bucklescript, Rescript) or updates about applications of OCaml to
statistics/numerical computing. Possibly this was just a function of
the unusual pandemic environment or the nature of a conference with a
more academic focus. In any case, I'm excited to dive into some of
these new tools, and especially to start getting the benefits of
improved documentation and search capabilities for OCaml libraries.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://jsthomas.github.io/icfp-2021.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://jsthomas.github.io/category/fp-icfp.html" rel="tag">FP, ICFP</a>
                </div>
            </article>            <h4 class="date">Aug 25, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://jsthomas.github.io/smtp-debugging.html" rel="bookmark" title="Permanent Link to &quot;Debugging an SMTP Integration in OCaml&quot;">Debugging an SMTP Integration in OCaml</a>
                </h2>

                
                

                <p>For the last few weeks I've been working on a side project to create a
small library called
<a href="https://github.com/jsthomas/tidy-email"><code>tidy_email</code></a> that makes it
easier to send email in OCaml. The repository has some example
programs illustrating how to connect to different email services. I
wanted to make sure that these programs would fail gracefully if
configured with the wrong credentials. But when I ran my example <a href="https://github.com/jsthomas/tidy-email/blob/main/smtp/example/send.ml">SMTP
app</a>
with an invalid password, I saw this:</p>
<div class="highlight"><pre><span></span><code><span class="err">Send failed. Details: Error: Stack overflow</span>
</code></pre></div>
<p>I expected to see some sort of "not authorized" message. Why was
this happening? This post summarizes how I debugged this problem.</p>
<h2>Context</h2>
<p>Among email services (like Mailgun, Sendgrid, and Amazon SES) there
are typically two ways for a web application to send email: make a
request to a REST API or use
<a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol">SMTP</a>. REST
APIs are convenient because they expose more features. In particular,
when you provide malformed data, the API can respond with a detailed
explanation of what the application did incorrectly. On the other
hand, SMTP is advantageous if you already have a mail server, want to
integrate with a legacy system, or can't be bothered to write a custom
REST API integration.</p>
<p><code>tidy_email</code> provides a simple wrapper around other libraries that
handle HTTP requests and/or SMTP. For SMTP, it uses
<a href="https://github.com/oxidizing/letters"><code>letters</code></a>, which in turn
depends on a library called
<a href="https://github.com/mirage/colombe/"><code>colombe</code></a>. At a high level, what
I wanted to understand was why <code>letters</code> was experiencing a stack
overflow when provided with bad SMTP credentials.</p>
<p>The specific SMTP server I was testing against was provided by
Mailgun. I had previously had some
<a href="https://github.com/oxidizing/letters/issues/35">difficulties</a> with
this server; these came about because Mailgun's implementation doesn't
strictly adhere to the relevant RFCs, and I thought something similar
might be occurring here.</p>
<h2>Gathering Data</h2>
<p>I started by cloning the <code>letters</code> and <code>colombe</code> repositories from
github. Fortunately, I already had
<a href="https://github.com/ocaml/merlin/wiki/emacs-from-scratch#configuring-your-project"><code>merlin</code></a>
installed for Emacs. This gave me the ability to jump from a function
call in my source code to the function's definition (<code>C-c l</code>). It also
allowed me to quickly look up types (<code>C-c t</code>). These hotkeys were
invaluable for efficiently working with unfamiliar code.</p>
<p>Before I started digging into the source code, I tried running
<code>strace</code> on my test app. This tool produces a log of all system calls
made by the app under test. This results in a <em>lot</em> of output; here is
an excerpt of what I saw:</p>
<div class="highlight"><pre><span></span><code><span class="err">read(5, "220 Mailgun Influx ready\r\n", 4096) = 26</span>
<span class="err">read(5, 0x56132a92d460, 4096)           = -1 EAGAIN (Resource temporarily unavailable)</span>
<span class="err">write(5, "EHLO glenmeretechnologies.com\r\n", 31) = 31</span>
<span class="err">getpid()                                = 15565</span>
<span class="err">epoll_wait(3, [{EPOLLIN, {u32=5, u64=8589934597}}], 64, 9879) = 1</span>
<span class="err">read(5, "250-smtp-out-n02.prod.us-west-2."..., 4096) = 144</span>
<span class="err">read(5, 0x56132a92d460, 4096)           = -1 EAGAIN (Resource temporarily unavailable)</span>
<span class="err">write(5, "STARTTLS\r\n", 10)            = 10</span>
<span class="err">getpid()                                = 15565</span>
<span class="err">epoll_wait(3, [{EPOLLIN, {u32=5, u64=8589934597}}], 64, 9840) = 1</span>
<span class="err">read(5, "220 Go ahead\r\n", 4096)       = 14</span>
<span class="err">brk(0x56132a954000)                     = 0x56132a954000</span>
<span class="err">brk(0x56132a975000)                     = 0x56132a975000</span>
<span class="err">brk(0x56132a996000)                     = 0x56132a996000</span>
<span class="err">read(5, 0x56132a92d460, 4096)           = -1 EAGAIN (Resource temporarily unavailable)</span>
<span class="err">write(5, "\26\3\3\2\0\1\0\1\374\3\0033y\374\354\246\200\2749u\7\375P\226\273\37\342|\257\235\277h"..., 517) = 517</span>
<span class="err">getpid()                                = 15565</span>
<span class="err">epoll_wait(3, [{EPOLLIN, {u32=5, u64=8589934597}}], 64, 9796) = 1</span>
<span class="err">read(5, "\26\3\3\0Z\2\0\0V\3\3\22c1v\234\367\0\322fR\230\264\236;\314\f\23\234$\245\33"..., 4096) = 3389</span>
<span class="err">read(5, 0x56132a92d460, 4096)           = -1 EAGAIN (Resource temporarily unavailable)</span>
<span class="err">...</span>
<span class="err">read(5, "", 4096)                       = 0</span>
<span class="err">(last line repeats hundreds of times)</span>
</code></pre></div>
<p>From this output, I was able to glean a couple of things:</p>
<ol>
<li>
<p>My app is successfully connecting to <code>smtp.mailgun.org</code>, as
   evidenced by the <code>220 Go ahead</code> message.</p>
</li>
<li>
<p>The hundreds of <code>read</code> calls seem related to the stack overflow
   issue. They suggest some sort of infinite loop or that the app is
   trying to read data that isn't available for some reason.</p>
</li>
</ol>
<h2>Getting more information about SMTP</h2>
<p>At this point, I decided I needed to learn a little bit about how SMTP
works. Fortunately, wikipedia provides a fairly concise
<a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol">overview</a>
with an example of a successful SMTP session (<code>S</code> = Server, <code>C</code> = Client):</p>
<div class="highlight"><pre><span></span><code><span class="n">S</span><span class="o">:</span> <span class="mi">220</span> <span class="n">smtp</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">com</span> <span class="n">ESMTP</span> <span class="n">Postfix</span>
<span class="n">C</span><span class="o">:</span> <span class="n">HELO</span> <span class="n">relay</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">com</span>
<span class="n">S</span><span class="o">:</span> <span class="mi">250</span> <span class="n">smtp</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">com</span><span class="o">,</span> <span class="n">I</span> <span class="n">am</span> <span class="n">glad</span> <span class="n">to</span> <span class="n">meet</span> <span class="n">you</span>
<span class="n">C</span><span class="o">:</span> <span class="n">MAIL</span> <span class="n">FROM</span><span class="o">:&lt;</span><span class="n">bob</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="na">com</span><span class="o">&gt;</span>
<span class="n">S</span><span class="o">:</span> <span class="mi">250</span> <span class="n">Ok</span>
<span class="n">C</span><span class="o">:</span> <span class="n">RCPT</span> <span class="n">TO</span><span class="o">:&lt;</span><span class="n">alice</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="na">com</span><span class="o">&gt;</span>
<span class="n">S</span><span class="o">:</span> <span class="mi">250</span> <span class="n">Ok</span>
<span class="n">C</span><span class="o">:</span> <span class="n">RCPT</span> <span class="n">TO</span><span class="o">:&lt;</span><span class="n">theboss</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="na">com</span><span class="o">&gt;</span>
<span class="n">S</span><span class="o">:</span> <span class="mi">250</span> <span class="n">Ok</span>
<span class="n">C</span><span class="o">:</span> <span class="n">DATA</span>
<span class="n">S</span><span class="o">:</span> <span class="mi">354</span> <span class="n">End</span> <span class="n">data</span> <span class="k">with</span> <span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;&lt;</span><span class="n">LF</span><span class="o">&gt;.&lt;</span><span class="n">CR</span><span class="o">&gt;&lt;</span><span class="n">LF</span><span class="o">&gt;</span>
<span class="n">C</span><span class="o">:</span> <span class="n">From</span><span class="o">:</span> <span class="s2">"Bob Example"</span> <span class="o">&lt;</span><span class="n">bob</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="na">com</span><span class="o">&gt;</span>
<span class="n">C</span><span class="o">:</span> <span class="n">To</span><span class="o">:</span> <span class="n">Alice</span> <span class="n">Example</span> <span class="o">&lt;</span><span class="n">alice</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="na">com</span><span class="o">&gt;</span>
<span class="n">C</span><span class="o">:</span> <span class="n">Cc</span><span class="o">:</span> <span class="n">theboss</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="na">com</span>
<span class="n">C</span><span class="o">:</span> <span class="n">Date</span><span class="o">:</span> <span class="n">Tue</span><span class="o">,</span> <span class="mi">15</span> <span class="n">Jan</span> <span class="mi">2008</span> <span class="mi">16</span><span class="o">:</span><span class="mi">02</span><span class="o">:</span><span class="mi">43</span> <span class="o">-</span><span class="mi">0500</span>
<span class="n">C</span><span class="o">:</span> <span class="n">Subject</span><span class="o">:</span> <span class="n">Test</span> <span class="n">message</span>
<span class="n">C</span><span class="o">:</span>
<span class="n">C</span><span class="o">:</span> <span class="n">Hello</span> <span class="n">Alice</span><span class="o">.</span>
<span class="n">C</span><span class="o">:</span> <span class="n">This</span> <span class="k">is</span> <span class="n">a</span> <span class="n">test</span> <span class="n">message</span> <span class="k">with</span> <span class="mi">5</span> <span class="n">header</span> <span class="n">fields</span> <span class="n">and</span> <span class="mi">4</span> <span class="n">lines</span> <span class="k">in</span> <span class="n">the</span> <span class="n">message</span> <span class="n">body</span><span class="o">.</span>
<span class="n">C</span><span class="o">:</span> <span class="n">Your</span> <span class="n">friend</span><span class="o">,</span>
<span class="n">C</span><span class="o">:</span> <span class="n">Bob</span>
<span class="n">C</span><span class="o">:</span> <span class="o">.</span>
<span class="n">S</span><span class="o">:</span> <span class="mi">250</span> <span class="n">Ok</span><span class="o">:</span> <span class="n">queued</span> <span class="k">as</span> <span class="mi">12345</span>
<span class="n">C</span><span class="o">:</span> <span class="n">QUIT</span>
<span class="n">S</span><span class="o">:</span> <span class="mi">221</span> <span class="n">Bye</span>
</code></pre></div>
<p>Unfortunately, this excerpt doesn't explain much about how a session
using STARTTLS should look. Since I saw some successful <code>read</code> calls
in my strace output, with arguments that weren't readable text, I
inferred that TLS was probably interfering with my ability to easily
see what was going on in the session after the first 220 response.</p>
<h2>Getting more data from logs</h2>
<p>I used <code>merlin</code> to jump to the <a href="https://github.com/mirage/colombe/blob/master/sendmail/sendmail_with_starttls.ml">relevant
parts</a>
of the <code>colombe</code> source code and noticed that <code>colombe</code> uses the
<code>Logs</code> module. Adding these two lines at the start of my test app
allowed me to start collecting log output, and see what was going on
in <code>colombe</code>:</p>
<div class="highlight"><pre><span></span><code>  <span class="nn">Logs</span><span class="p">.</span><span class="n">set_reporter</span> <span class="o">(</span><span class="nn">Logs</span><span class="p">.</span><span class="n">format_reporter</span> <span class="bp">()</span><span class="o">);</span>
  <span class="nn">Logs</span><span class="p">.</span><span class="n">set_level</span> <span class="o">(</span><span class="nc">Some</span> <span class="nn">Logs</span><span class="p">.</span><span class="nc">Info</span><span class="o">);</span>
</code></pre></div>
<p>When I took a look at the log output, I saw:</p>
<div class="highlight"><pre><span></span><code><span class="p">...</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">Return</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">READ</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="mi">220</span><span class="w"> </span><span class="n">Mailgun</span><span class="w"> </span><span class="n">Influx</span><span class="w"> </span><span class="n">ready</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">READ</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="mi">250</span><span class="o">-</span><span class="n">smtp</span><span class="o">-</span><span class="k">out</span><span class="o">-</span><span class="n">n01</span><span class="p">.</span><span class="n">prod</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">2.</span><span class="n">postgun</span><span class="p">.</span><span class="n">com</span><span class="w"></span>
<span class="mi">250</span><span class="o">-</span><span class="n">AUTH</span><span class="w"> </span><span class="n">PLAIN</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"></span>
<span class="mi">250</span><span class="o">-</span><span class="k">SIZE</span><span class="w"> </span><span class="mi">52428800</span><span class="w"></span>
<span class="mi">250</span><span class="o">-</span><span class="mi">8</span><span class="n">BITMIME</span><span class="w"></span>
<span class="mi">250</span><span class="o">-</span><span class="n">SMTPUTF8</span><span class="w"></span>
<span class="mi">250</span><span class="o">-</span><span class="n">PIPELINING</span><span class="w"></span>
<span class="mi">250</span><span class="w"> </span><span class="n">STARTTLS</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">Return</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">READ</span><span class="w"> </span><span class="err">:</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">Return</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">WARNING</span><span class="o">]</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">base64</span><span class="w"> </span><span class="k">value</span><span class="err">:</span><span class="w"> </span><span class="ss">"Go ahead"</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">READ</span><span class="w"> </span><span class="err">:</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">Return</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="mi">535</span><span class="w"> </span><span class="n">Authentication</span><span class="w"> </span><span class="n">failed</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="n">Quitting</span><span class="w"> </span><span class="k">connection</span><span class="p">...</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">Before</span><span class="w"> </span><span class="n">recv</span><span class="p">...</span><span class="w"></span>
<span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">READ</span><span class="w"> </span><span class="err">:</span><span class="w"></span>
<span class="p">(</span><span class="n">repeats</span><span class="p">,</span><span class="w"> </span><span class="n">hundreds</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">times</span><span class="p">)</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</code></pre></div>
<p>Similar to the <code>strace</code> results, I could see many failed reads. But
this time I could see they occurred after a <code>535 Authentication
failed</code> message came back from the server.</p>
<p>During this phase of analysis it was helpful to be able to add my own
log points to the source code. In order to do this, though, I needed
to ensure that my test app would build against my modified version of
<code>colombe</code>, not the published version on <code>opam</code>. Within the <code>colombe</code>
repo, I ran</p>
<div class="highlight"><pre><span></span><code>dune build src <span class="o">&amp;&amp;</span> dune install colombe <span class="o">&amp;&amp;</span> dune build sendmail <span class="o">&amp;&amp;</span> dune install sendmail
</code></pre></div>
<p>This pinned both <code>colombe</code> and <code>sendmail</code> to my local versions on
disk. Because <code>letters</code> uses these two libraries, I also needed to go
to my <code>letters</code> repo and run:</p>
<div class="highlight"><pre><span></span><code>dune build . <span class="o">&amp;&amp;</span> dune install letters
</code></pre></div>
<p>With these two steps taken care of, I could use <code>dune</code> to execute my
test app and see the custom instrumentation that I'd added to the
underlying libraries.</p>
<h2>Reproducing the problem</h2>
<p>At this point, I was pretty confident that <code>colombe</code> was having
problems immediately after trying to quit the SMTP session by sending
a <code>QUIT</code>. After some google searching, I learned that <code>openssl</code>
allows you to run an SMTP session interactively. To test, I ran:</p>
<div class="highlight"><pre><span></span><code><span class="err">openssl s_client -connect smtp.mailgun.org:587 -starttls smtp</span>
</code></pre></div>
<p>The first part of the session looked like this:</p>
<div class="highlight"><pre><span></span><code>250 STARTTLS
---
Post-Handshake New Session Ticket arrived:
SSL-Session:
    Protocol  : TLSv1.3
    Cipher    : TLS_AES_128_GCM_SHA256
    Session-ID: 7E83FE3CC7D65BE60AF56A2E049C09A27AB33DF834454617B81C0469A32EEC62
    Session-ID-ctx:
    Resumption PSK: 4A7C875CECCCA5633D3FF2107857EAF220FF561B782AAC3AC416385612E08AAB
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 604800 (seconds)
    TLS session ticket:
    0000 - 4a 79 8c 03 d5 1e 3f 5d-dc b2 2d b6 38 db 4e 10   Jy....?]..-.8.N.
    0010 - 91 b6 1d 44 d2 95 c9 50-f3 f9 a7 89 8d 0e b9 7e   ...D...P.......~
    0020 - f1 d6 52 da 3d 84 f5 ee-58 72 a8 81 1e 0f ad c7   ..R.=...Xr......
    0030 - c7 76 8f 8c d9 d9 56 8f-f3 72 de 0e bf 17 b0 2f   .v....V..r...../
    0040 - 72 a7 98 cd 92 46 da 45-fc b8 a9 d4 6e 73 71 f5   r....F.E....nsq.
    0050 - 74 f2 1d eb 83 b3 01 83-77 3f 7a e0 9a 36 4a fe   t.......w?z..6J.
    0060 - b3 89 3e c7 4c aa 87 eb-6d 46 42 46 73 8f 35 1f   ..&gt;.L...mFBFs.5.
    0070 - 8c                                                .

    Start Time: 1630180065
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
    Max Early Data: 0
---
read R BLOCK
EHLO
250-smtp-out-n02.prod.us-west-2.postgun.com
250-AUTH PLAIN LOGIN
250-SIZE 52428800
250-8BITMIME
250-SMTPUTF8
250 PIPELINING
</code></pre></div>
<p>By running <code>EHLO</code>, I was able to see the different operations this
SMTP server supports. In the output above, we can see that one of
those operations is <code>AUTH PLAIN</code>. I tried to authenticate with invalid
credentials, and saw this:</p>
<div class="highlight"><pre><span></span><code>AUTH PLAIN BADPASSWORD
501 Invalid response encoding
535 Authentication failed
closed
</code></pre></div>
<p>This means that after a client provides bad credentials, Mailgun's
SMTP implementation immediately terminates the connection. But, when
<code>colombe</code> encountered a failure to authenticate, it tried to clean up
the session like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">properly_quit_and_fail</span> <span class="n">ctx</span> <span class="n">err</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">open</span> <span class="nc">Monad</span> <span class="k">in</span>
  <span class="k">let</span><span class="o">*</span> <span class="o">_</span><span class="n">txts</span> <span class="o">=</span> <span class="n">send</span> <span class="n">ctx</span> <span class="nn">Value</span><span class="p">.</span><span class="nc">Quit</span> <span class="bp">()</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">recv</span> <span class="n">ctx</span> <span class="nn">Value</span><span class="p">.</span><span class="nc">PP_221</span> <span class="k">in</span>
  <span class="nc">Error</span> <span class="n">err</span>
</code></pre></div>
<p>So <code>colombe</code> tried to send a <code>QUIT</code> message and await a <code>221 Bye</code>, but
that message never arrived because the server had already closed the
connection.</p>
<h2>Fixing the problem</h2>
<p>Once I understood the problem, I realized I could avoid the issue by
revising <code>properly_quit_and_fail</code> to prevent waiting on a response
from the server. Effectively, this meant changing a <code>let*</code> to a <code>let</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">properly_quit_and_fail</span> <span class="n">ctx</span> <span class="n">err</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">open</span> <span class="nc">Monad</span> <span class="k">in</span>
  <span class="k">let</span> <span class="o">_</span><span class="n">txts</span> <span class="o">=</span> <span class="n">send</span> <span class="n">ctx</span> <span class="nn">Value</span><span class="p">.</span><span class="nc">Quit</span> <span class="bp">()</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">recv</span> <span class="n">ctx</span> <span class="nn">Value</span><span class="p">.</span><span class="nc">PP_221</span> <span class="k">in</span>
  <span class="nc">Error</span> <span class="n">err</span>
</code></pre></div>
<p>I also filed this
<a href="https://github.com/mirage/colombe/issues/46">issue</a>, which prompted
one of the maintainers to
<a href="https://github.com/mirage/colombe/pull/47">refactor</a> how connections
are managed, with a much more thorough solution than what I had
done. (Many thanks to Calascibetta Romain for fixing my issue so
quickly!) Once merged, other <code>colombe</code> users shouldn't encounter the
stack overflow issues I described here.</p>
<h2>Final Thoughts</h2>
<p>This was an interesting bug to investigate because it covered a number
of unfamiliar topics. I didn't know much about SMTP when I started,
and I learned a couple useful facts while debugging:</p>
<ul>
<li>SMTP sessions consist of a handful of commands that are fairly easy
  to understand.</li>
<li>OpenSSL's tooling makes it easy to test SMTP by hand.</li>
<li>Even very commonly used mail services like Mailgun may not work
  exactly the way you expect from reading RFCs or other documentation!</li>
</ul>
<p>I also learned some useful techniques I can reuse the next time I need
to debug OCaml problems:</p>
<ul>
<li>When writing test apps, enable logging (at info level) from the
  beginning!</li>
<li>Use <code>dune install</code> to add instrumentation and temporary bug fixes to
  libraries.</li>
<li>Developer tooling like <code>merlin</code> is very helpful for efficiently
  navigating unfamiliar code.</li>
</ul>
<h2>Feedback</h2>
<p>If you found this post useful (or conversely, found an error), send me
an email. I'm interested in adding more tutorial resources to the
OCaml ecosystem and would happy to hear suggestions about how to make
these resources better. My contact information is listed on the
<a href="/">About</a> page.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://jsthomas.github.io/smtp-debugging.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://jsthomas.github.io/category/ocaml-smtp-debugging.html" rel="tag">OCaml, SMTP, Debugging</a>
                </div>
            </article>            <h4 class="date">Aug 17, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://jsthomas.github.io/job-search-2021.html" rel="bookmark" title="Permanent Link to &quot;Thoughts on running a job search in 2021&quot;">Thoughts on running a job search in 2021</a>
                </h2>

                
                

                <p>I recently wrapped up a job search. My new job starts as I'm in the
process of leaving the <a href="https://www.recurse.com/">Recurse Center</a>, so
I thought this would be a good time to summarize my impressions of the
job market for software developers in 2021.</p>
<p>I've encountered a fair amount of advice for software developers who
are just getting out of university, but less advice for developers on
their second or third job. This post is my attempt to fill that gap a
bit and write down some advice to my earlier self. Hopefully it
contains useful suggestions for other job seekers, especially other
Recursers.</p>
<h2>Background</h2>
<p>Like many software engineers, I have mixed feelings about how our
industry (specifically, software companies in the US) conduct
interviews. My first few interviews out of university (circa 2010)
were pretty difficult. These consisted of solving "leetcode" style
problems in a panel interview format, where 5-6 older engineers scowl
at you while you work at a whiteboard. Having been both an interviewer
and an interviewee, my impression is that the process is pretty ad-hoc
and varies a lot between companies. As an industry, we just aren't
that scientific about crafting interviews and reviewing the results.</p>
<p>After talking to a number of experienced developers and reading
comments on Hacker News, I think many software engineers find the
interview process frustratingly artificial, like a sort of "hazing"
ritual. In this viewpoint, the difficulty of interviewing forces
candidates into a "scarcity" mindset where interviews are hard to get,
job offers are even harder to obtain, and unemployment is to be
constantly feared.</p>
<p>My mission this Summer has been to change my perspective on that. I
don't think that finding a job will ever be "fun" per se. It's always
a bit stressful. But, I didn't want to operate from the basis that
interviewing is to be feared, especially when that feeling is
amplified by sentiments on social media (e.g. Hacker News).</p>
<h2>General Strategy</h2>
<p>Talking to people about their job searches, I observed two
main strategies:</p>
<ol>
<li>Develop one strong resume and send it out to many companies.</li>
<li>Target a handful of specific companies that fit your interests.</li>
</ol>
<p>I lean heavily toward the second strategy and applied to 6-10
positions this time. The following criteria narrowed my search quite a
bit:</p>
<ul>
<li>I wanted to continue working on analytics/data engineering problems.</li>
<li>The role needed to allow for remote work.</li>
<li>I wasn't interested in working for a FAANG type company this time
  out; as far as I can tell, interviewing for these roles is quite
  different from interviewing with a startup.</li>
<li>I wouldn't take a position that I felt had serious negative
  externalities (i.e. cryptocurrency/NFTs, fossil fuels).</li>
<li>The role would ideally involve some amount of functional programming.</li>
</ul>
<p>In general, I didn't apply to positions unless I met the majority of
the requirements in the job spec. For most positions I prepared a
custom cover letter. I primarily applied to most companies directly
through their website. The main exception to this rule was companies
affiliated with the Recurse Center; for these I applied via RC's
career services program.</p>
<p>Before I started my search, I overhauled my personal website, LinkedIn
page, and resume. My previous job at a smaller, sales-focused company
had a significant advantage: It was much easier to frame my past work
in terms of a benefit to the company's business. Instead of saying <em>"I
set up server X and built technology Y"</em>, I could write: <em>"I built X
which serves Y percent of all customers and saved Z dollars."</em> This
was more difficult when I was working in a research role, separated
from users by several degrees. I think my resume was stronger on this
job search than on previous ones, largely because I kept an up to date
"achievement list" in my previous role.</p>
<h2>Companies with an Open Source Presence</h2>
<p>This time I applied to more companies that list their source code on
github. For these I followed a somewhat different strategy.</p>
<p>I started by making a list of public repos the company was actively
developing. This can typically be worked out by examining github
activity and (in some cases) presentations from recent conferences. I
downloaded some of these projects to get a sense of how they worked;
this was a helpful test to determine whether I would want to do this
type of work long term. If I found a project with a smallish issue
that I could solve, I prepared a pull request.</p>
<p>This process had a few benefits:</p>
<ul>
<li>It helped me learn a little more about the company's code review
  practices.</li>
<li>A merged PR gave me something to mention in my cover letter, to help
  me stand out from other applicants.</li>
<li>It allowed me to expand my portfolio of open source work.</li>
</ul>
<p>This <em>was</em> a more labor-intensive strategy, but I considered it worth
the effort. In some cases, this technique allowed me to skip over
technical assessments or other "take home" assignments, because the
hiring manager was happy to use the PR I had prepared as a
substitute. In general, this technique seemed to "fast track" my
application when it worked.</p>
<h2>Contracting</h2>
<p>During my job search I also explored the possibility of working as a
contractor. This came about because one of the companies I applied to
wanted to hire me full time but didn't have the funds to do so;
instead they offered me part time work until they could afford bring
me on full time.</p>
<p>Setting up an LLC isn't terribly difficult (perhaps a day worth of
work and $100-600, all in) and gives you the ability to do some
part-time work while looking for a permanent position. This took some
of the pressure off of my job search and helped me feel more confident
that I could support myself while looking for work. My general
impression is that it's easier to get hired as a contractor than as a
full time employee, because neither side is committed for the long
term.</p>
<p>It's probably worth noting that this strategy might not work as well
if you haven't already built up a broad professional network or are
earlier in your career.</p>
<h2>Things I could have improved</h2>
<p>Although I'm happy with the outcome of my job search, there are some
things I could have done better.</p>
<p>Most of my mistakes were errors in "timing" my applications. I applied
to a French company in late July and failed to realize many European
companies are completely shut down in August due to vacations. This
meant that even though they were interested in talking to me in
September, any other offers I received would arrive well <em>before</em> I
could start their interview process.</p>
<p>I decided to stagger my job applications such that the applications I
felt least confident about went out first and the ones I considered
"safe fallbacks" went out last. I thought this was reasonable because
I was writing custom cover letters, at a rate of 1-2 per day. In
retrospect, this approach was suboptimal. It had the effect of making
my job search longer than it needed to be. One of the "safe fallback"
jobs I had applied to had already been filled earlier in the month; it
couldn't have helped me, even though I was a good fit! It would've
been better to just learn that first thing.</p>
<p>I augmented my main job search by using two jobs boards, AngelList and
FunctionalWorks. I didn't get useful leads from either service,
despite having had success with AngelList in the past. I suspect that
because these tools make it easy to apply to lots of jobs at once,
it's very hard to make your resume stand out when you use these
channels.</p>
<p>I spent a lot of time working on leetcode problems. To my surprise,
this didn't actually come up much during my interviews. The firms I
was really interested in asked me for a sample of my open source work
(i.e. links to github) and/or gave me a take-home exercise that was
quite reasonable. There were no tricky algorithm/puzzle questions. I'm
not sure if I will bother with "grinding leetcode" in the future; I'd
much rather just focus on consistently growing my open source
portfolio and let that speak for itself.</p>
<h2>Things that went well</h2>
<p>I found that my professional network was very useful this Summer. My
experience has been that networking effects take time to build up, but
they yield information that would be difficult to obtain any other
way. People I met at the Recurse Center offered to connect me with
managers they knew. Conferences I had attended some years ago produced
useful leads on new jobs. Friends from grad school who had startup
experience and other scientific expertise gave me valuable advice
about whether certain jobs would be a good fit.</p>
<p>Previously, I was uncertain about whether having a blog was especially
useful. My website was very helpful on this job search. Multiple
interviewers mentioned reading through my posts and asked me questions
about past projects I had documented. If I had one recommendation for
new software developers, it would be to start keeping a blog
early. Add a technical post every month or two. Github pages makes
this really easy (and it's free). I now feel pretty confident that a
blog is a good way to "make a name for yourself" especially if you're
interested in somewhat niche topics.</p>
<p>Due to the pandemic, the chances of an onsite interview were basically
zero. I knew that I would need to come across well on video so I set
up my home office such that I would be in front of a plain white wall
with a whiteboard. This ensured I could easily talk through a design
if I needed. I wore a dress shirt for all of my interviews;
essentially the same outfit I wore when I worked in an office in
Boston. I'm not sure that this was strictly necessary, but I think it
gave me a small psychological boost and communicated that I was a
reliable professional with a quality home office.</p>
<p>I spent a fair amount of time preparing questions for interviewers,
especially longer on-site interviews. I found that it can be very
helpful to frame questions in a way that's quantitative and does not
contain a value judgement. For example, instead of asking "How stable
is your production environment?" (value judgement, qualitative) I
instead asked "How many times have you been paged in the last 6
months?" (quantitative). This approach yielded more quantitative <em>and</em>
qualitative data about a company's technology, so that I was better
informed about the day to day experience of working in a particular
role.</p>
<p>The final thing that I did well was to end some interview processes
early, when I identified that the company or manager wasn't a good fit
for me. Some hiring managers were very pushy about knowing my "three
greatest weaknesses" or my past salary. I decided not to deal with
them further after a first interview, which saved everyone time and
effort. I also terminated some interview processes because managers
described business goals that didn't make sense to me. I used the
following test: "How would my former tech leads react if I presented
this proposal to them?" If the answer was "very negatively", I often
reconsidered whether to continue with an interview.</p>
<h2>Feedback</h2>
<p>Interviewing is always somewhat stressful. If you're in the midst of a
job search, my main advice is: Hang in there, you'll find a job if
you're persistent and ask the right questions.</p>
<p>If you found this post useful (or conversely, think that this advice
is bad), send me an email. My contact information is listed on the
<a href="/">About</a> page.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://jsthomas.github.io/job-search-2021.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://jsthomas.github.io/category/jobs.html" rel="tag">Jobs</a>
                </div>
            </article>            <h4 class="date">Jul 23, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://jsthomas.github.io/ocaml-email.html" rel="bookmark" title="Permanent Link to &quot;How to send emails from Dream&quot;">How to send emails from Dream</a>
                </h2>

                
                

                <p>I recently <a href="https://github.com/aantron/dream/issues/138">learned</a> the
OCaml ecosystem has most of the libraries needed to build email
features, but I wasn't able to find an example that brings all of
those pieces together. I wanted a simple example I could easily adapt
to build common account verification and password recovery workflows
in the Dream web framework. This post is my attempt to solve that
problem and explain what I learned in the process. The accompanying
code can be found
<a href="https://github.com/jsthomas/dream-email-example">here</a>.</p>
<h2>Defining the problem</h2>
<p>As an application developer, my main concerns when
sending mail are:</p>
<ol>
<li>Trying to ensure the address I'm sending to is valid.</li>
<li>Handling the email synthesis process asynchronously, so it doesn't
   block the web server from handling requests quickly.</li>
<li>Transmitting the email content (SMTP or a REST API call)</li>
<li>Monitoring that the applications messages aren't getting
   blocked/dropped for some reason.</li>
</ol>
<p>To test how easily I could satisfy these requirements, I built a web
app that lets the user send an arbitary email.</p>
<p><img alt="A screenshot of the email form." src="https://jsthomas.github.io/images/ocaml-email/screenshot.png" style="width: 671px; height: auto;"/></p>
<p>The app has two parts:</p>
<ul>
<li>A server process responsible for showing the form above and
  validating user inputs.</li>
<li>A "worker" process responsible for sending mail. The worker gets its
  tasks from a queue populated by the server.</li>
</ul>
<h2>Validating Email Addresses</h2>
<p>I decided to utilize the library
<a href="https://github.com/dinosaure/emile"><code>emile</code></a> for address
validation. An email address might be invalid for reasons outside of
the application's control (like the domain going way), but <code>emile</code> at
least provides a way to check a given string conforms to 5(!) RFCs
relevant to parsing email addresses. Check out the
<a href="https://github.com/dinosaure/emile/blob/master/test/test.ml#L34">tests</a>
to see the impressive diversity of valid email addresses on the web.</p>
<p>The library provides several different predicates for checking
addresses. I utilized <code>Emile.of_string</code>, which generates a simple
result type, like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">form_post</span> <span class="n">request</span> <span class="o">=</span>
  <span class="k">match</span><span class="o">%</span><span class="n">lwt</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">form</span> <span class="n">request</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Ok</span> <span class="o">[</span><span class="s2">"address"</span><span class="o">,</span> <span class="n">address</span><span class="o">;</span> <span class="s2">"message"</span><span class="o">,</span> <span class="n">message</span><span class="o">;</span> <span class="s2">"subject"</span><span class="o">,</span> <span class="n">subject</span> <span class="o">]</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">parse</span> <span class="o">=</span> <span class="nn">Emile</span><span class="p">.</span><span class="n">of_string</span> <span class="n">address</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">alert</span> <span class="o">=</span> <span class="k">match</span> <span class="n">parse</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Ok</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">"Sent an email to %s."</span> <span class="n">address</span>
        <span class="o">|</span> <span class="nc">Error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">"%s is not a valid email address."</span> <span class="n">address</span>
      <span class="k">in</span>
      <span class="k">let</span> <span class="n">queue_req</span> <span class="o">=</span> <span class="k">match</span> <span class="n">parse</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Ok</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">queue_email</span> <span class="n">address</span> <span class="n">subject</span> <span class="n">message</span>
        <span class="o">|</span> <span class="nc">Error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">return_unit</span>
    <span class="k">in</span>
    <span class="n">queue_req</span> <span class="o">&gt;&gt;=</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
        <span class="nn">Dream</span><span class="p">.</span><span class="n">html</span> <span class="o">(</span><span class="nn">Template</span><span class="p">.</span><span class="n">show_form</span> <span class="o">~</span><span class="n">alert</span> <span class="n">request</span><span class="o">))</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">empty</span> <span class="o">`</span><span class="nc">Bad_Request</span>
</code></pre></div>
<p>This way, if a user provides an invalid address, the form displays a simple
warning message and won't queue any email tasks.</p>
<h2>Queuing Tasks with RabbitMQ</h2>
<p>The second issue I needed to address is handling the email send
process with a background worker (<code>queue_email</code> in the code excerpt
above). Sending an email can be a slow process, especially if you need
to make additional database queries or render images to produce a
customized email. That shouldn't block the web server from quickly
responding to the user's requests. Instead, the server should record
the email task in a <em>queue</em>, to be handled by a background worker that
isn't as sensitive to latency.</p>
<p>There are several different technologies that can be used to solve
this problem, for example <a href="https://www.rabbitmq.com/">RabbitMQ</a>,
<a href="https://redislabs.com/ebook/part-2-core-concepts/chapter-6-application-components-in-redis/6-4-task-queues/6-4-1-first-in-first-out-queues/">Redis</a>
and <a href="https://aws.amazon.com/sqs/">SQS</a>. I decided to use RabbitMQ
because I didn't want to tie my implementation to one cloud provider
and RabbitMQ is supported by
<a href="https://github.com/andersfugmann/amqp-client">amqp-client</a> on
OPAM. This isn't the only way to go: for Redis and SQS, you might have
success with the packages
<a href="https://opam.ocaml.org/packages/redis/">redis</a> or
<a href="https://opam.ocaml.org/packages/aws-sqs/">aws-sqs</a>, respectively.</p>
<p>The worker and server process share a common function for establishing
a connection to RabbitMQ:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">rabbit_connection</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">connection</span> <span class="o">=</span> <span class="nn">Connection</span><span class="p">.</span><span class="n">connect</span> <span class="o">~</span><span class="n">id</span><span class="o">:</span><span class="s2">"dream"</span> <span class="s2">"localhost"</span> <span class="k">in</span>
  <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">channel</span> <span class="o">=</span> <span class="nn">Connection</span><span class="p">.</span><span class="n">open_channel</span> <span class="o">~</span><span class="n">id</span><span class="o">:</span><span class="s2">"email"</span> <span class="nn">Channel</span><span class="p">.</span><span class="n">no_confirm</span> <span class="n">connection</span> <span class="k">in</span>
  <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">queue</span> <span class="o">=</span> <span class="nn">Queue</span><span class="p">.</span><span class="n">declare</span> <span class="n">channel</span> <span class="o">~</span><span class="n">arguments</span><span class="o">:[</span><span class="nn">Rpc</span><span class="p">.</span><span class="nn">Server</span><span class="p">.</span><span class="n">queue_argument</span><span class="o">]</span> <span class="s2">"email"</span> <span class="k">in</span>
  <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span> <span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">queue</span><span class="o">)</span>
</code></pre></div>
<p>I was initially little confused about why I needed a "channel" when I
already had a connection to the broker. Both the worker and the server
connect to the RabbitMQ Broker via TCP. It's common for clients to
need several connections to the broker, but it's costly to have many
TCP connections. RabbitMQ lets us avoid this cost with channels, which
are like "lightweight connections that share a single TCP
connection", according to these <a href="https://www.rabbitmq.com/channels.html">docs</a>.</p>
<p>I created this function to submit messages to the queue:</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span> <span class="n">email</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">address</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
  <span class="n">subject</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
  <span class="n">text</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
<span class="o">}</span> <span class="o">[@@</span><span class="n">deriving</span> <span class="n">yojson</span><span class="o">]</span>

<span class="k">let</span> <span class="n">queue_email</span> <span class="n">address</span> <span class="n">subject</span> <span class="n">text</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">email</span> <span class="o">=</span> <span class="o">{</span><span class="n">address</span><span class="o">;</span> <span class="n">subject</span><span class="o">;</span> <span class="n">text</span><span class="o">}</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">email</span> <span class="o">|&gt;</span> <span class="n">yojson_of_email</span> <span class="o">|&gt;</span> <span class="nn">Yojson</span><span class="p">.</span><span class="nn">Safe</span><span class="p">.</span><span class="n">to_string</span> <span class="k">in</span>
  <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">channel</span><span class="o">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">rabbit_connection</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Queue</span><span class="p">.</span><span class="n">publish</span> <span class="n">channel</span> <span class="n">queue</span> <span class="o">(</span><span class="nn">Message</span><span class="p">.</span><span class="n">make</span> <span class="n">text</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Lwt</span><span class="p">.</span><span class="n">return_unit</span>
</code></pre></div>
<p>Here the server writes the address, subject, and text into a record
type that can be serialized to JSON before being pushed into the queue.</p>
<p>The worker process, <code>queue_worker</code>, is fairly simple to define:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">handle_message</span> <span class="o">(</span><span class="n">m</span><span class="o">:</span> <span class="nn">Message</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">snd</span> <span class="n">m</span><span class="o">.</span><span class="n">message</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">email</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="nc">Some</span> <span class="o">(</span><span class="n">text</span> <span class="o">|&gt;</span> <span class="nn">Yojson</span><span class="p">.</span><span class="nn">Safe</span><span class="p">.</span><span class="n">from_string</span> <span class="o">|&gt;</span> <span class="n">email_of_yojson</span><span class="o">)</span>
    <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">"Received invalid email record from RabbitMQ: %s"</span> <span class="n">text</span><span class="o">;</span>
      <span class="nc">None</span>
  <span class="k">in</span>
  <span class="k">match</span> <span class="n">email</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">send_email</span> <span class="n">e</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">return_unit</span>


<span class="k">let</span> <span class="n">queue_worker</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">"Starting Queue Worker</span><span class="se">\n</span><span class="s2">"</span><span class="o">;</span>
  <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">channel</span><span class="o">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">rabbit_connection</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">handle</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="nn">Queue</span><span class="p">.</span><span class="n">get</span> <span class="o">~</span><span class="n">no_ack</span><span class="o">:</span><span class="bp">true</span> <span class="n">channel</span> <span class="n">queue</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">message</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">task</span> <span class="o">=</span> <span class="k">match</span> <span class="n">message</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span> <span class="n">handle_message</span> <span class="n">m</span>
      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">"No new tasks, waiting.</span><span class="se">\n</span><span class="s2">"</span><span class="o">;</span> <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span> <span class="nn">Lwt_unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">5</span><span class="o">.</span>
    <span class="k">in</span>
    <span class="n">task</span> <span class="o">&gt;&gt;=</span> <span class="n">handle</span>
  <span class="k">in</span>
  <span class="n">handle</span> <span class="bp">()</span>
</code></pre></div>
<p>The worker consists of an infinite loop. When the worker wakes and
finds tasks in the queue, it uses <code>yojson</code> to deserialize the
messages and passes them to <code>send_email</code>. If no work is available,
the worker just sleeps for 5 seconds.</p>
<h2>Sending Email with <code>cohttp</code> and Mailgun</h2>
<p>In order to send mail, I set up a trial
<a href="https://documentation.mailgun.com/en/latest/quickstart-sending.html#send-via-smtp">Mailgun</a>
account. I selected this provider for several reasons:</p>
<ul>
<li>Mailgun has a generous free tier (5000 emails).</li>
<li>A new account also comes with a "sandbox" domain, so I didn't have
  to deal with registering a domain.</li>
<li>Mailgun supports both a REST API and SMTP, allowing me to try
  different integrations.</li>
<li>Mailgun provides dashboards for tracking messages sent over time as
  well as emails that were rejected (bounced, marked as spam, etc.).</li>
</ul>
<p>Mailgun's API allowed me to send an email by sending a POST with an API key and form
data, like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">send_email</span> <span class="o">(</span><span class="n">e</span><span class="o">:</span> <span class="n">email</span><span class="o">)</span> <span class="o">=</span>
   <span class="k">let</span> <span class="k">open</span> <span class="nc">Cohttp</span> <span class="k">in</span>
   <span class="k">let</span> <span class="k">open</span> <span class="nc">Cohttp_lwt_unix</span> <span class="k">in</span>

   <span class="k">let</span> <span class="n">api_key</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">"MAILGUN_API_KEY"</span> <span class="k">in</span>
   <span class="k">let</span> <span class="n">sender</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">"MAILGUN_SEND_ADDRESS"</span> <span class="k">in</span>
   <span class="k">let</span> <span class="n">api_base</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">"MAILGUN_API_BASE"</span> <span class="k">in</span>

   <span class="k">let</span> <span class="n">params</span> <span class="o">=</span> <span class="o">[</span>
     <span class="o">(</span><span class="s2">"from"</span><span class="o">,</span> <span class="o">[</span><span class="n">sender</span><span class="o">]);</span>
     <span class="o">(</span><span class="s2">"to"</span><span class="o">,</span> <span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">address</span><span class="o">]);</span>
     <span class="o">(</span><span class="s2">"subject"</span><span class="o">,</span> <span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">subject</span><span class="o">]);</span>
     <span class="o">(</span><span class="s2">"text"</span><span class="o">,</span> <span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">text</span><span class="o">])</span>
   <span class="o">]</span> <span class="k">in</span>
   <span class="k">let</span> <span class="n">cred</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Basic</span> <span class="o">(</span><span class="s2">"api"</span><span class="o">,</span> <span class="n">api_key</span><span class="o">)</span> <span class="k">in</span>
   <span class="k">let</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">api_base</span> <span class="o">^</span> <span class="s2">"/messages"</span> <span class="o">|&gt;</span> <span class="nn">Uri</span><span class="p">.</span><span class="n">of_string</span> <span class="k">in</span>
   <span class="k">let</span> <span class="n">headers</span> <span class="o">=</span> <span class="nn">Header</span><span class="p">.</span><span class="n">add_authorization</span> <span class="o">(</span><span class="nn">Header</span><span class="p">.</span><span class="n">init</span> <span class="bp">()</span><span class="o">)</span> <span class="n">cred</span> <span class="k">in</span>
   <span class="k">let</span> <span class="n">start</span> <span class="o">=</span>
     <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">"Initiating email send to %s.</span><span class="se">\n</span><span class="s2">"</span> <span class="n">e</span><span class="o">.</span><span class="n">address</span><span class="o">;</span>
     <span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="bp">()</span> <span class="k">in</span>
   <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">resp</span><span class="o">,</span> <span class="n">rbody</span> <span class="o">=</span> <span class="nn">Client</span><span class="p">.</span><span class="n">post_form</span> <span class="n">uri</span> <span class="o">~</span><span class="n">params</span> <span class="o">~</span><span class="n">headers</span> <span class="k">in</span>
   <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">finish</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="bp">()</span> <span class="o">|&gt;</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span> <span class="k">in</span>
   <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">rbody_str</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Cohttp_lwt</span><span class="p">.</span><span class="nn">Body</span><span class="p">.</span><span class="n">to_string</span> <span class="n">rbody</span><span class="o">)</span> <span class="k">in</span>
   <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">"API Response Status: %d.</span><span class="se">\n</span><span class="s2">"</span> <span class="o">(</span><span class="nn">Code</span><span class="p">.</span><span class="n">code_of_status</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="o">);</span>
   <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">"API Response body %s.</span><span class="se">\n</span><span class="s2">"</span> <span class="n">rbody_str</span><span class="o">;</span>
   <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">"Time to send an email: %.2fs</span><span class="se">\n</span><span class="s2">"</span> <span class="o">(</span><span class="n">finish</span> <span class="o">-.</span> <span class="n">start</span><span class="o">);</span>
   <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span> <span class="bp">()</span>
</code></pre></div>
<p>The endpoint replies with either 200 and a JSON body like this:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="nt">"id"</span><span class="p">:</span> <span class="s2">"&lt;some mailgun email address here&gt;"</span>
  <span class="s2">"message"</span><span class="p">:</span> <span class="s2">"Queued. Thank you."</span>
<span class="p">}</span>
</code></pre></div>
<p>or else a 400 and an explanation of why the request was rejected. In
my tests, a successful API request typically took between 0.5 and 1
seconds. For comparison, the webserver can serve the email form in
less than 200 microseconds, so the performance benefits to shifting
email tasks to a background queue are nontrivial.</p>
<h2>Sending email with SMTP</h2>
<p>Mailgun supports SMTP but they recommend using their API, especially
for sending large amounts of mail at once. I used
<a href="https://github.com/oxidizing/letters/">letters</a> to test their SMTP
support with this script:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">body</span> <span class="o">=</span> <span class="nn">Letters</span><span class="p">.</span><span class="nc">Plain</span> <span class="o">{|</span><span class="nc">This</span> <span class="n">is</span> <span class="n">a</span> <span class="n">test</span> <span class="n">email</span> <span class="n">body</span><span class="o">.|}</span>

<span class="k">let</span> <span class="n">send_email</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Letters</span><span class="p">.</span><span class="nn">Config</span><span class="p">.</span><span class="n">make</span>
      <span class="o">~</span><span class="n">username</span><span class="o">:</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">"MAILGUN_SMTP_USER"</span>
      <span class="o">~</span><span class="n">password</span><span class="o">:</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">"MAILGUN_SMTP_PASSWORD"</span>
      <span class="o">~</span><span class="n">hostname</span><span class="o">:</span><span class="s2">"smtp.mailgun.org"</span>
      <span class="o">~</span><span class="n">with_starttls</span><span class="o">:</span><span class="bp">true</span><span class="o">)</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">sender</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">"MAILGUN_SMTP_SENDER"</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">recipients</span> <span class="o">=</span> <span class="o">[</span><span class="nn">Letters</span><span class="p">.</span><span class="nc">To</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">"EMAIL_ADDRESS"</span><span class="o">)]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">subject</span> <span class="o">=</span> <span class="s2">"Test email from mailgun."</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">mail</span> <span class="o">=</span> <span class="nn">Letters</span><span class="p">.</span><span class="n">build_email</span> <span class="o">~</span><span class="n">from</span><span class="o">:</span><span class="n">sender</span> <span class="o">~</span><span class="n">recipients</span> <span class="o">~</span><span class="n">subject</span> <span class="o">~</span><span class="n">body</span> <span class="k">in</span>

  <span class="nn">Printexc</span><span class="p">.</span><span class="n">record_backtrace</span> <span class="bp">true</span><span class="o">;</span>
  <span class="k">match</span> <span class="n">mail</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Ok</span> <span class="n">message</span> <span class="o">-&gt;</span>
    <span class="o">(</span><span class="k">try</span><span class="o">%</span><span class="n">lwt</span>
       <span class="nn">Letters</span><span class="p">.</span><span class="n">send</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">sender</span> <span class="o">~</span><span class="n">recipients</span> <span class="o">~</span><span class="n">message</span>
    <span class="k">with</span>
      <span class="n">e</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">"Error. %s</span><span class="se">\n</span><span class="s2">"</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">);</span>
      <span class="nn">Printexc</span><span class="p">.</span><span class="n">print_backtrace</span> <span class="n">stdout</span><span class="o">;</span>
      <span class="nn">Lwt</span><span class="p">.</span><span class="n">return_unit</span>
   <span class="o">)</span>
  <span class="o">|</span> <span class="nc">Error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">"Message synthesis failed."</span><span class="o">;</span> <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">return_unit</span>


<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Lwt_main</span><span class="p">.</span><span class="n">run</span> <span class="o">@@</span> <span class="n">send_email</span> <span class="bp">()</span>
</code></pre></div>
<p>I ran into some
<a href="https://github.com/oxidizing/letters/issues/35">difficulties</a> because
Mailgun does not consistently follow RFC 4954 (thanks to Calascibetta
Romain for figuring out the problem and creating a
<a href="https://github.com/mirage/colombe/pull/41">patch</a>). Once I applied
the patch, I was able to send mail successfully.</p>
<p>I haven't fully explored the tradeoffs of using SMTP versus an
API. The main goal of my experiements was to confirm that if I needed
to integrate with a specific SMTP server, I knew how to do so.</p>
<h2>Discussion</h2>
<p>This example focused on email, but task queues and background workers
can be used to implement other important pieces of functionality for
web applications. For example, I've utilized
<a href="https://docs.celeryproject.org/en/stable/getting-started/introduction.html">celery</a>
in the past to generate weekly reports and schedule recurring ETL
jobs. This exercise was a nice opportunity to see how one would
construct a system similar to <code>celery</code> in OCaml. It also provides a
simple illustration of how we can utilize queues to facilitate
horizontal scaling. If the volume of email requests grows too big for
one machine, we can put the web server and the worker on separate
instances or have multiple worker instances consuming from the email
queue.</p>
<p>I didn't cover error handling in this example, but that's clearly an
important piece of functionality to include when building a production
email system. At a minimum, it would be useful to add a retry
mechanism in the event that Mailgun is unavailable.</p>
<h2>References</h2>
<p>I found the resources below helpful for working on this project:</p>
<ul>
<li>The <code>amqp-client</code>
<a href="https://andersfugmann.github.io/amqp-client/amqp-client-lwt/index.html">documentation</a>,
  especially the
  <a href="https://github.com/andersfugmann/amqp-client/tree/master/examples">examples</a>
  were helpful for setting up with RabbitMQ.</li>
<li>The <a href="https://github.com/mirage/ocaml-cohttp#client-tutorial">client
  tutorial</a>
  was helpful for getting started with <code>cohttp</code>. Later, I utilized
  <a href="https://mirage.github.io/ocaml-cohttp/cohttp-lwt-unix/Cohttp_lwt_unix/Client/index.html">this
  section</a>
  of the docs to understand that I needed to use <code>post_form</code> instead
  of <code>post</code> when interacting with Mailgun's API.</li>
</ul>
<h2>Feedback</h2>
<p>If you ended up looking through the source code for this example, let
me know how what you thought! I'm interested in adding more tutorial
resources to the OCaml ecosystem, so feel free to post a PR or issue
to
<a href="https://github.com/jsthomas/dream-email-example">dream-email-example</a>
if you have ideas about how to make these resources better.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://jsthomas.github.io/ocaml-email.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://jsthomas.github.io/category/ocaml.html" rel="tag">OCaml</a>
                </div>
            </article>            <h4 class="date">Jul 12, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://jsthomas.github.io/ocaml-dream-api.html" rel="bookmark" title="Permanent Link to &quot;Writing a REST API with Dream&quot;">Writing a REST API with Dream</a>
                </h2>

                
                

                <p>In the last few weeks I've been building a simple REST API using the
<a href="https://aantron.github.io/dream/">Dream</a> web framework. Writing APIs
has been one major component of my paid programming work and I wanted
to compare and contrast the experience of writing an API in a strongly
typed functional programming language with the same workflow in a
dynamically typed language like Python.</p>
<p>You can find the source code for this project
<a href="https://github.com/jsthomas/sensors">here</a>. Hopefully, this repo will
be a useful resource for anyone who wants to look at a slightly larger
example application that uses Dream. Though I'm still a beginner, I
was surprised how easy it was to complete familiar tasks in this
framework. I'm optimistic about the future of web programming in
OCaml!</p>
<p>This post provides a sort of "experience report" for working with
Dream, Yojson, and Caqti. Obviously, these types of reports are highly
subjective and you should run your own experiments too!  I'll be
comparing with my experience in working with
<a href="https://trypyramid.com/">Pyramid</a> and
<a href="https://www.sqlalchemy.org/">SQLAlchemy</a>, since those are the Python
projects I've used most.</p>
<p>Finally, it's important to point out that Dream is in alpha (version
<code>1.0.0~alpha2</code> as of this writing). This is an early version!
Comparisons with frameworks like Pyramid or Flask are in some sense
apples-and-oranges, because those projects have had a long time (and
many engineering hours) to mature. Ultimately, the point of this post
(and the repo that goes with it) isn't to make make value judgements
("framework X is good, Y is bad"), but rather to understand how to
translate concepts from one workflow to another.</p>
<h2>Problem Definition</h2>
<p>I decided to build a API for managing time series data. My
requirements for the project were as follows:</p>
<ul>
<li>The API will allow creating, reading, and deleting "sensors". A
  sensor is an abstract IoT device that measures a floating point
  quantity at a specific cadence (for example a weather station
  measuring average hourly windspeed).</li>
<li>Every sensor gets an API key that allows it to upload (POST) data to
  an endpoint.</li>
<li>A GET endpoint will allow users to retrieve the data a sensor
  generated between two dates.</li>
<li>The API sends and receives data formatted as JSON and must be backed
  by a PostgreSQL database.</li>
<li>The API should have <code>login/logout</code> endpoints for a (not yet built)
  frontend to use.</li>
<li>Finally, a user should only be allowed to access sensor data that
  belongs to them.</li>
</ul>
<p>I chose these requirements because they cover a number of different
read/write operations that require data formatting/parsing and
tracking relationships between four different entities (users, keys,
sensors, and readings).</p>
<h2>Dependencies and Setup</h2>
<p>For this build, I needed three core dependencies:</p>
<ol>
<li>A server to handle web requests (Dream).</li>
<li>Support for parsing and synthesizing JSON records.</li>
<li>A library for integrating with PostgreSQL.</li>
</ol>
<p>After a bit of research, I settled on
<a href="https://opam.ocaml.org/packages/yojson/">Yojson</a> and
<a href="https://opam.ocaml.org/packages/caqti/">Caqti</a> for (2) and (3)
respectively. Both of these are fairly standard and appear in the
excellent corpus of
<a href="https://github.com/aantron/dream/tree/master/example">examples</a> that
accompany Dream. Since I had previously written an
<a href="https://github.com/aantron/dream/tree/master/example/w-docker-postgres">example</a>
of how to use Dream with a dockerized PostrgreSQL container, I used
that as a starting point.</p>
<p>It's useful to have a way to run (and re-run) ad-hoc requests against
the API during development. I used <a href="https://insomnia.rest/">Insomnia</a>
for this, but other tools like <code>curl</code> would work too.</p>
<h2>Adding an endpoint</h2>
<p>To give a sense of my development workflow, I want to walk through my
process for adding a simple endpoint, <code>/api/login</code>. Inside the router,
that endpoint looks like:</p>
<div class="highlight"><pre><span></span><code><span class="nn">Dream</span><span class="p">.</span><span class="n">post</span> <span class="s2">"/api/login"</span> <span class="n">login</span><span class="o">;</span>
</code></pre></div>
<p>In this excerpt <code>login</code> is a "handler". Handlers are responsible for
translating requests into responses; this is captured in their <a href="https://aantron.github.io/dream/#type-handler">type
signature</a>.</p>
<p>Conceptually, the <code>login</code> handler needs to do three things:</p>
<ol>
<li>Receive a JSON body and confirm it's formatted as expected.</li>
<li>Look up the relevant user/password combination in the database.</li>
<li>Load the relevant session information if the credentials are valid.</li>
</ol>
<p>For the first part, the endpoint needs to receive a JSON payload that
looks like <code>{"username": "...", "password": "..."}</code>. To describe that
payload, I introduced a simple record type:</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span> <span class="n">login_doc</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">username</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
  <span class="n">password</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
<span class="o">}</span> <span class="o">[@@</span><span class="n">deriving</span> <span class="n">yojson</span><span class="o">]</span>
</code></pre></div>
<p>Adding <code>[@@deriving yojson]</code> means the compiler can generate functions
to convert these records to and from JSON. In this case those
functions are called <code>login_doc_of_yojson</code> and <code>yojson_of_login_doc</code>.</p>
<p>My <code>login</code> handler looked roughly like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">json_receiver</span> <span class="n">json_parser</span> <span class="n">handler</span> <span class="n">request</span> <span class="o">=</span>
  <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">body</span> <span class="o">=</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">body</span> <span class="n">request</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">parse</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="nc">Some</span> <span class="o">(</span><span class="n">body</span>
      <span class="o">|&gt;</span> <span class="nn">Yojson</span><span class="p">.</span><span class="nn">Safe</span><span class="p">.</span><span class="n">from_string</span>
      <span class="o">|&gt;</span> <span class="n">json_parser</span><span class="o">)</span>
    <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span>
      <span class="nc">None</span>
  <span class="k">in</span>
  <span class="k">match</span> <span class="n">parse</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">doc</span> <span class="o">-&gt;</span> <span class="n">handler</span> <span class="n">doc</span> <span class="n">request</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
    <span class="o">{</span> <span class="n">error</span><span class="o">=</span><span class="s2">"Received invalid JSON input."</span> <span class="o">}</span>
    <span class="o">|&gt;</span> <span class="n">yojson_of_error_doc</span>
    <span class="o">|&gt;</span> <span class="n">json_response</span> <span class="o">~</span><span class="n">status</span><span class="o">:</span> <span class="o">`</span><span class="nc">Bad_Request</span>


<span class="k">let</span> <span class="n">login</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">login_base</span> <span class="n">login_doc</span> <span class="n">request</span> <span class="o">=</span>
    <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">user_id</span> <span class="o">=</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">sql</span> <span class="n">request</span>
        <span class="o">(</span><span class="nn">Models</span><span class="p">.</span><span class="nn">User</span><span class="p">.</span><span class="n">get</span> <span class="n">login_doc</span><span class="o">.</span><span class="n">username</span> <span class="n">login_doc</span><span class="o">.</span><span class="n">password</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">match</span> <span class="n">user_id</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">id</span> <span class="o">-&gt;</span>
      <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">invalidate_session</span> <span class="n">request</span> <span class="k">in</span>
      <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">put_session</span> <span class="s2">"user"</span> <span class="o">(</span><span class="nn">Int</span><span class="p">.</span><span class="n">to_string</span> <span class="n">id</span><span class="o">)</span> <span class="n">request</span> <span class="k">in</span>
      <span class="nn">Dream</span><span class="p">.</span><span class="n">empty</span> <span class="o">`</span><span class="nc">OK</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">empty</span> <span class="o">`</span><span class="nc">Forbidden</span>
  <span class="k">in</span>
  <span class="n">json_receiver</span> <span class="n">login_doc_of_yojson</span> <span class="n">login_base</span>
</code></pre></div>
<p>If a user uploads an invalid JSON body, this will cause
<code>login_doc_of_yojson</code> to throw an exception. By default, this produces
a 500 server error response. To handle this situation more gracefully,
I introduced <code>json_receiver</code>. If the parser passed to <code>json_receiver</code>
succeeds on the request body, the results are passed to the inner
handler. Otherwise, the server responds with a <code>400 Bad
Request</code>. Re-using <code>json_receiver</code> across my endpoints allows me to
avoid introducing a<code>try/with</code> block any time time I need to handle
JSON input.</p>
<p>I decided to manage models in a separate library, <code>Models</code>. The
build tool, <code>dune</code>, made this easy to do; I just needed separate
<code>dune</code> files for the <code>server/model</code> and <code>server/bin</code> folders. I like
this design because it simplifies re-use of the database portion of my
project. For example, if I later needed to build a CLI admin tool,
that tool could utilize my existing queries without being exposed to
API concerns.</p>
<p>Inside <code>User</code>, the <code>get</code> query function is defined as:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">get</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">query</span> <span class="o">=</span>
    <span class="nn">R</span><span class="p">.</span><span class="n">find_opt</span> <span class="nn">T</span><span class="p">.</span><span class="o">(</span><span class="n">tup2</span> <span class="nn">T</span><span class="p">.</span><span class="n">string</span> <span class="nn">T</span><span class="p">.</span><span class="n">string</span><span class="o">)</span> <span class="nn">T</span><span class="p">.</span><span class="n">int</span>
      <span class="s2">"SELECT id FROM app_user WHERE username = ? and password = ?"</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="n">username</span> <span class="n">password</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Db</span> <span class="o">:</span> <span class="nc">DB</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">user_or_error</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">find_opt</span> <span class="n">query</span> <span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">Caqti_lwt</span><span class="p">.</span><span class="n">or_fail</span> <span class="n">user_or_error</span>
</code></pre></div>
<p>Caqti allows us to define a function that consumes our query
parameters (the username and password) along with a database
connection, and produces a promise that will resolve with the results
of the query. In this case, the types encode that the function
produces an <code>int option</code> containing the user's primary key if the
credentials are valid. (Note that it's not a good idea to store
passwords in plain text like this; this is just for illustrative
purposes.)</p>
<p>Session management, the final item that the endpoint needs to address,
is handled by Dream. The framework allows sessions to be stored in
cookies, memory, or the database; I opted for database sessions
because I had used similar session backends in the past. Sessions
allow us to store pairs key/value strings across requests. I used the
session just to store the logged-in user's ID, so that the API has
easy access in later database queries.</p>
<h2>Thoughts on the Dream Router</h2>
<p>The final router for my server looked like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Dream</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">interface</span><span class="o">:</span><span class="s2">"0.0.0.0"</span>
  <span class="o">@@</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">logger</span>
  <span class="o">@@</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">sql_pool</span> <span class="s2">"postgresql://sensors@127.0.0.1/sensors"</span>
  <span class="o">@@</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">sql_sessions</span>
  <span class="o">@@</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">router</span> <span class="o">[</span>
    <span class="c">(* More endpoints here ... *)</span>

    <span class="nn">Dream</span><span class="p">.</span><span class="n">get</span> <span class="s2">"/version"</span> <span class="n">version</span><span class="o">;</span>
    <span class="nn">Dream</span><span class="p">.</span><span class="n">post</span> <span class="s2">"/api/login"</span> <span class="n">login</span><span class="o">;</span>
    <span class="nn">Dream</span><span class="p">.</span><span class="n">post</span> <span class="s2">"/api/logout"</span> <span class="n">logout</span><span class="o">;</span>

    <span class="nn">Dream</span><span class="p">.</span><span class="n">scope</span> <span class="s2">"/api"</span> <span class="o">[</span><span class="n">login_required</span><span class="o">]</span> <span class="o">[</span>
      <span class="nn">Dream</span><span class="p">.</span><span class="n">get</span> <span class="s2">"/user/:user_id"</span> <span class="n">user</span><span class="o">;</span>
      <span class="c">(* More endpoints here... *)</span>
    <span class="o">];</span>

    <span class="nn">Dream</span><span class="p">.</span><span class="n">scope</span> <span class="s2">"/sensor"</span> <span class="bp">[]</span> <span class="o">[</span>
      <span class="nn">Dream</span><span class="p">.</span><span class="n">post</span> <span class="s2">"/upload"</span> <span class="o">@@</span> <span class="n">api_key_required</span> <span class="n">sensor_upload</span><span class="o">;</span>
    <span class="o">]</span>
  <span class="o">]</span>
  <span class="o">@@</span> <span class="nn">Dream</span><span class="p">.</span><span class="n">not_found</span>
</code></pre></div>
<p>I really appreciate how Dream makes it possible to get a concise
overview of the API; in some Pyramid projects, I found this wasn't
always possible. In fact, in Pyramid I sometimes struggled with subtle
routing bugs that were not obvious until run time. Having the compiler
validate the router in Dream was a welcome change.</p>
<p>At the moment, Pyramid makes it somewhat easier to handle
access/permissions concerns compared to Dream. Working in Pyramid, it
was relatively common for the routes to manage some amount of
parameter validation and permissions. For example, given a path
<code>/user/123/article/abc456</code>, the route (or "resources" in Pyramid
terminology) would be responsible for:</p>
<ul>
<li>Extracting the user and article IDs (<code>123</code> and <code>abc456</code>).</li>
<li>Determining those records actually exist in the database, and
  passing them to the view/handler in a context record.</li>
<li>Validating that the requester has permissions to operate on those
User and Article records.</li>
</ul>
<p>This is discussed a bit more in the Pyramid Docs under <a href="https://docs.pylonsproject.org/projects/pyramid/en/latest/narr/traversal.html">URL
traversal</a>.
Effectively, Pyramid resources mean that handler/view code downstream
can focus on updating database records and/or rendering HTML/JSON
without worrying about permissions concerns.</p>
<p>I didn't want to build a permissions system for my API so instead I
incorporated User IDs into my function signatures in <code>Model</code> and used
inner joins to model permissions. For example, here is an example of a
query that fetches the metadata for all sensors belonging to a
particular user:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="n">k</span><span class="p">.</span><span class="n">uuid</span>
<span class="k">FROM</span> <span class="n">sensor</span> <span class="n">s</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">user_sensor</span> <span class="n">us</span>
 <span class="k">ON</span> <span class="n">us</span><span class="p">.</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">id</span> <span class="k">AND</span> <span class="n">us</span><span class="p">.</span><span class="n">app_user</span> <span class="o">=</span> <span class="err">$</span><span class="mi">1</span> <span class="k">AND</span> <span class="n">us</span><span class="p">.</span><span class="n">sensor</span> <span class="o">=</span> <span class="err">$</span><span class="mi">2</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">api_key</span> <span class="n">k</span>
 <span class="k">ON</span> <span class="n">s</span><span class="p">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">id</span>
</code></pre></div>
<p>By joining against <code>user_sensor</code>, I ensure that a user only gets data
for the sensors they own.</p>
<p>I should point out that Dream allows us to use a custom router,
however! The project has <a href="https://github.com/aantron/dream/issues/122">an
issue</a> for more elaborate
routing and Ulrik Strid has introduced
<a href="https://github.com/ulrikstrid/dream-routes">dream-routes</a>, which
allows additional type information to be encoded in routes. So,
writing a more sophisticated router that behaves like Pyramid's
resource system is certainly possible.</p>
<h2>Comparing Caqti and SQLAlchemy</h2>
<p>As a web programmer, especially one working on an analytics project,
it's important to get comfortable working with the database library
you've chosen for your project. Indeed, a significant portion of this
project consisted of familiarizing myself with <code>Caqti</code>.</p>
<p>Caqti is a bit different from SQLAlchemy. With SQLAlchemy, you
typically define one class for each table. Then, using SQLAlchemy's
metaprogramming features, those classes are used to define
queries. For comparison, here are equivalent queries against the user
table:</p>
<p><strong>Caqti</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">get</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">query</span> <span class="o">=</span>
    <span class="nn">R</span><span class="p">.</span><span class="n">find_opt</span> <span class="nn">T</span><span class="p">.</span><span class="o">(</span><span class="n">tup2</span> <span class="nn">T</span><span class="p">.</span><span class="n">string</span> <span class="nn">T</span><span class="p">.</span><span class="n">string</span><span class="o">)</span> <span class="nn">T</span><span class="p">.</span><span class="n">int</span>
      <span class="s2">"SELECT id FROM app_user WHERE username = ? and password = ?"</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="n">username</span> <span class="n">password</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Db</span> <span class="o">:</span> <span class="nc">DB</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="k">let</span><span class="o">%</span><span class="n">lwt</span> <span class="n">user_or_error</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">find_opt</span> <span class="n">query</span> <span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">Caqti_lwt</span><span class="p">.</span><span class="n">or_fail</span> <span class="n">user_or_error</span>
</code></pre></div>
<p><strong>SQLAlchemy</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">,</span>
        <span class="n">User</span><span class="o">.</span><span class="n">password</span> <span class="o">==</span> <span class="n">password</span>
    <span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
</code></pre></div>
<p>Working with Caqti, a mistake in the syntax of a SQL query won't be
discovered until runtime. I made fewer mistakes like this with
SQLAlchemy because most queries are written in Python and can be
linted by the IDE. Another recurring point of confusion for me with
Caqti had to do with matching the function on the <code>Caqti_request</code>
(<code>R.find_opt</code> above) with the function invoked in <code>Db</code>
(<code>Db.find_opt</code>); this is how we indicate that the query produces zero,
one, zero/one, or multiple rows. If the two don't agree, the program
won't compile; initially I struggled to understand what this
compiler error meant:</p>
<div class="highlight"><pre><span></span><code><span class="n">Error</span><span class="o">:</span> <span class="n">The</span> <span class="kd">function</span> <span class="n">applied</span> <span class="n">to</span> <span class="k">this</span> <span class="n">argument</span> <span class="n">has</span> <span class="n">type</span>
         <span class="o">?</span><span class="n">env</span><span class="o">:(</span><span class="n">Caqti_driver_info</span><span class="o">.</span><span class="na">t</span> <span class="o">-&gt;</span> <span class="n">string</span> <span class="o">-&gt;</span> <span class="n">Caqti_query</span><span class="o">.</span><span class="na">t</span><span class="o">)</span> <span class="o">-&gt;</span>
         <span class="o">?</span><span class="n">oneshot</span><span class="o">:</span><span class="n">bool</span> <span class="o">-&gt;</span>
         <span class="o">(</span><span class="err">'</span><span class="n">a</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="o">[&lt;</span> <span class="err">`</span><span class="n">Many</span> <span class="o">|</span> <span class="err">`</span><span class="n">One</span> <span class="o">|</span> <span class="err">`</span><span class="n">Zero</span> <span class="o">&gt;</span> <span class="err">`</span><span class="n">Zero</span> <span class="o">])</span> <span class="n">Caqti_request</span><span class="o">.</span><span class="na">t</span>
<span class="n">This</span> <span class="n">argument</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">applied</span> <span class="n">without</span> <span class="n">label</span>
</code></pre></div>
<p>Using Caqti became easier as I became accustomed to thinking in terms of
prepared queries. About halfway through the project I realized I
needed to switch from SQLite to PostgreSQL, and changing databases was
fairly painless because Caqti supports both.</p>
<p>I also made use of Caqti's features for dealing with custom column
types. Caqti does not have built-in support for JSON columns, but
adding a custom column type to handle this was straightforward:</p>
<div class="highlight"><pre><span></span><code><span class="n">type</span><span class="w"> </span><span class="n">readings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="k">option</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="o">[</span><span class="n">@@deriving yojson</span><span class="o">]</span><span class="w"></span>

<span class="n">let</span><span class="w"> </span><span class="n">sql_readings</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">  </span><span class="n">let</span><span class="w"> </span><span class="n">encode</span><span class="w"> </span><span class="p">(</span><span class="nl">a</span><span class="p">:</span><span class="w"> </span><span class="n">readings</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">Ok</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">yojson_of_readings</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">Yojson</span><span class="p">.</span><span class="n">Safe</span><span class="p">.</span><span class="n">to_string</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="ow">in</span><span class="w"></span>
<span class="w">  </span><span class="n">let</span><span class="w"> </span><span class="n">decode</span><span class="w"> </span><span class="nc">text</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">Ok</span><span class="w"> </span><span class="p">(</span><span class="nc">text</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">Yojson</span><span class="p">.</span><span class="n">Safe</span><span class="p">.</span><span class="n">from_string</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">readings_of_yojson</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="ow">in</span><span class="w"></span>
<span class="w">  </span><span class="n">T</span><span class="p">.(</span><span class="n">custom</span><span class="w"> </span><span class="o">~</span><span class="n">encode</span><span class="w"> </span><span class="o">~</span><span class="n">decode</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>In my case, the JSON that I needed to store consisted of arrays of
floating point numbers, so building the custom type was simply a
matter of connecting Yojson and Caqti in the right way.</p>
<h2>Discussion</h2>
<p>Ever since I started building web applications in Python, I've thought
of an API server as a big function that transforms requests into
responses, with any nontrivial state residing in databases or services
like S3. Dream provides a modern web framework that matches my mental
model for how a web server should work.</p>
<p>Web programming in OCaml "feels" a bit different than working in
Python. In Python it's possible to get something running quickly, but
it's also easy to forget corner cases and introduce defects that have
to be addressed later in the application's lifecycle. An OCaml project
requires some up-front investment, but this investment pays off later
in several ways. First, fast feedback from the compiler (together with
editor integrations like <code>merlin</code> and <code>tuareg</code>) helped me to identify
issues earlier. <code>Yojson</code> made it simple to enforce that JSON requests
and responses adhered to a fixed schema, and helped me process inputs
more systematically. OCaml made refactoring safe and easy, so that I
could confidently adapt my design as I introduced new requirements. In
the right context, I think the advantages of using OCaml could
significantly reduce the total lifecycle costs of maintaining many web
applications without reducing the pace of new development.</p>
<h2>References</h2>
<p>I found the resources below helpful for working on this project:</p>
<ul>
<li>The Dream <a href="https://aantron.github.io/dream/">API docs</a> set a high
  standard for readability and helped me quickly get up to speed with
  the framework.</li>
<li>This <a href="https://github.com/aantron/dream/tree/master/example">section</a>
  of the Dream repo has excellent examples, both for working with the
  framework and deploying it.</li>
<li>I referred to Bobby Priambodo's <a href="https://medium.com/@bobbypriambodo/interfacing-ocaml-and-postgresql-with-caqti-a92515bdaa11">blog
  posts</a>
  about interfacing Caqti and PostgreSQL as I wrote the models in my project.</li>
<li>The Caqti
  <a href="https://paurkedal.github.io/ocaml-caqti/index.html">docs</a>,
  especially for <code>Caqti_type</code> and <code>Caqti_request</code> were helpful as I
  was writing queries.</li>
<li>There is also an
  <a href="https://github.com/paurkedal/ocaml-caqti/blob/master/tests/bikereg.ml">example</a>
  in the Caqti repo that is worth looking through.</li>
<li>The README on
  <a href="https://github.com/janestreet/ppx_yojson_conv">ppx_yojson_conv</a> had
  helpful examples that I referred to while writing my own
  JSON-related types.</li>
</ul>
<h2>Feedback</h2>
<p>If you ended up looking through the source code for my API, let me
know how what you thought! I'm interested in adding more tutorial
resources to the OCaml ecosystem, so feel free to post a PR or issue
to
<a href="https://github.com/jsthomas/sensors">sensors</a>
if you have ideas about how to make these resources better.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://jsthomas.github.io/ocaml-dream-api.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://jsthomas.github.io/category/ocaml.html" rel="tag">OCaml</a>
                </div>
            </article>            <h4 class="date">Jul 01, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://jsthomas.github.io/ocaml-shell.html" rel="bookmark" title="Permanent Link to &quot;Let's write a shell in OCaml!&quot;">Let's write a shell in OCaml!</a>
                </h2>

                
                

                <p>This Summer I'm studying OCaml and systems programming at the <a href="https://www.recurse.com/">Recurse
Center</a>. Currently I'm reading the
delightful book <a href="https://pages.cs.wisc.edu/~remzi/OSTEP/"><em>Operating Systems: Three Easy
Pieces</em></a> by Remzi
Arpaci-Dusseau and Andrea Arpaci-Dusseau. Besides great exposition,
the book includes several interesting projects, one of which is to
<a href="https://github.com/remzi-arpacidusseau/ostep-projects/tree/master/processes-shell">write a
shell</a>.</p>
<p>The project materials, a set of shell scripts that define tests, are
language agnostic. I believe the authors intended for students to use
C, but I worked through the exercise in OCaml; you can find the final
result <a href="https://github.com/jsthomas/simple-ocaml-shell">in this
repo</a>. This blog post
is a short experience report; if you're interested in working on a
beginner OCaml project, hopefully it provides some useful scaffolding
for your studies.</p>
<h2>Shell features</h2>
<p>The shell I built (<code>osh</code>) has a somewhat limited feature set. It:</p>
<ul>
<li>
<p>Allows several commands to be run in parallel (e.g. <code>program1 arg1 &amp;
  program2 arg2 arg3</code>)</p>
</li>
<li>
<p>Supports simple output redirection (e.g. <code>echo "hello" &gt;
  hello.txt</code>). Both <code>stdout</code> and <code>stderr</code> go to the same file.</p>
</li>
<li>
<p>Has three builtin functions, <code>cd</code>, <code>exit</code>, and <code>path</code>. <code>path</code> allows
  you to define a list of directories to search for executables; we
  need this because environment variables aren't supported.</p>
</li>
</ul>
<p>Other niceties, like tab completion and pipes, aren't supported. To
facilitate testing, the shell can run in a batch mode (<code>osh &lt;my file
of commands&gt;</code>) as well as an interactive mode. A final simplifying
assumption is that <code>osh</code> only provides a basic error message when
inputs are malformed.</p>
<h2>Concepts</h2>
<p>There are three main topics I studied while working on this project:</p>
<ol>
<li>
<p>The <code>Unix</code> module, especially <code>fork</code> and
    <code>execv</code>. <a href="https://ocaml.github.io/ocamlunix/ocamlunix.html">This
    page</a>, from
    Xavier Leroy and Didier Rémy, was helpful for getting up to
    speed. The man-pages were also useful.</p>
</li>
<li>
<p>The <a href="https://ocaml.org/api/Stream.html"><code>Stream</code></a> module. Streams
   in OCaml are roughly analogous to generators in Python; they
   allowed me to use a single type (a <code>string Stream.t</code>) to represent
   commands coming from an interactive session or a batch file.</p>
</li>
<li>
<p>The <a href="https://github.com/inhabitedtype/angstrom">Angstrom</a>
   parser-combinator library. I used this library to determine whether
   a given line of user input is well formed.</p>
</li>
</ol>
<p>I suspect you could implement the parser without Angstrom, if you
really wanted to. I wanted to learn more about this library, and this
project seemed like a good place to try it out.</p>
<p>Although I previously worked through some simple monadic parser
exercises in Haskell, I struggled the most with Angstrom. Reading one
of the main <a href="https://github.com/inhabitedtype/angstrom/blob/master/lib/angstrom.mli">mli
files</a>
seemed to be the best way to get an overview of the combinators the
library provides. I also spent a fair amount of time experimenting in
<code>utop</code> as I put my parser together.</p>
<h2>Steps</h2>
<p>Here is a rough outline for how I built my shell.</p>
<p>First, I defined a main function that would fetch a line of text from
<code>stdin</code> and echo it back to the user. Then I added the ability to
represent either interactive or batch input with a <code>Stream</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">prompt_stream</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">_</span> <span class="o">=</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">"osh&gt; "</span><span class="o">;</span>
    <span class="nc">Some</span> <span class="o">(</span><span class="n">read_line</span> <span class="bp">()</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="n">f</span>


<span class="k">let</span> <span class="n">file_stream</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">_</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">in_channel</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
      <span class="nc">None</span>
  <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="n">f</span>
</code></pre></div>
<p>It's useful to do this part as early as possible, since batch input
allows you to run the tests.</p>
<p>Once I could get <code>osh</code> to fail all 22 test cases, I started adding the
simpler built-in commands <code>cd</code> and <code>exit</code>. (Note <code>./test-osh.sh -c</code>
will run all 22 tests, without stopping at the first one that fails.)</p>
<p>My first version of <code>main</code> just treated user input as <code>string list</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="k">rec</span> <span class="n">main</span> <span class="n">stream</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">parse</span> <span class="n">text</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">split_on_char</span> <span class="sc">' '</span> <span class="n">text</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">process</span> <span class="n">text</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">parse</span> <span class="n">text</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">main</span> <span class="n">stream</span>  <span class="c">(* Empty lines should just be treated as no-ops. *)</span>
    <span class="o">|</span> <span class="o">[</span><span class="s2">""</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">main</span> <span class="n">stream</span>
    <span class="o">|</span> <span class="o">[</span><span class="s2">"exit"</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">exit</span> <span class="mi">0</span>
    <span class="o">|</span> <span class="o">[</span><span class="s2">"cd"</span><span class="o">;</span> <span class="n">x</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">chdir</span> <span class="n">x</span>
    <span class="o">|</span> <span class="s2">"cd"</span><span class="o">::</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">print_error</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="n">x</span><span class="o">::</span><span class="n">xs</span> <span class="o">-&gt;</span>
      <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
      <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="c">(* Child *)</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">execv</span> <span class="n">x</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="n">xs</span><span class="o">)</span>
      <span class="o">|</span> <span class="n">child_pid</span> <span class="o">-&gt;</span> <span class="c">(* Parent *)</span>
        <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">waitpid</span> <span class="bp">[]</span> <span class="n">child_pid</span>
        <span class="k">in</span> <span class="bp">()</span>
  <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span> <span class="n">process</span> <span class="n">stream</span>
</code></pre></div>
<p>This worked well enough for running simple commands like <code>/usr/bin/ls
-lah</code>. In order to get output redirection and <code>&amp;</code> to work, I needed to
upgrade the program's parsing capabilities. I switched from
representing user input with a <code>string list</code> to a variant type:</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span> <span class="n">exec</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">executable</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
  <span class="n">arguments</span><span class="o">:</span> <span class="kt">string</span> <span class="kt">list</span><span class="o">;</span>
  <span class="n">output</span><span class="o">:</span> <span class="kt">string</span> <span class="n">option</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">type</span> <span class="n">line</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">NoOp</span>
  <span class="o">|</span> <span class="nc">ChangeDirectory</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="o">|</span> <span class="nc">PathChange</span> <span class="k">of</span> <span class="kt">string</span> <span class="kt">list</span>
  <span class="o">|</span> <span class="nc">Executable</span> <span class="k">of</span> <span class="n">exec</span> <span class="kt">list</span>
  <span class="o">|</span> <span class="nc">Quit</span>
</code></pre></div>
<p>I found the OCaml compiler (and its emacs integrations, <code>merlin</code> and
<code>tuareg</code>) very helpful for refactoring. When I revised my types to
make them better reflect the data I wanted to model, type errors
identified all of the places I needed to update. At this point, I
introduced an Angstrom parser and re-implemented support for <code>cd</code>,
<code>exit</code>, and <code>path</code>. That allowed me to get familiar with the parser
combinators <code>*&gt;</code>, <code>many</code>, and <code>choice</code>, before attempting the more
complicated parsers needed to support <code>&amp;</code> and <code>&gt;</code>.</p>
<p>The type system protected me from a number of silly mistakes, but it
wasn't a silver bullet. I spent an hour confused about why one of my
parsers would go into an infinite loop before realizing I needed to
use <code>many1</code> instead of <code>many</code>. I think this is the sort of mistake I
would learn to avoid if I spent more time working with Angstrom.</p>
<h2>Discussion</h2>
<p>As I worked through this project, I started to appreciate how OCaml
chooses "good defaults" for my code (especially immutable data)
without forbidding me from working in an imperative mode when I need
to.</p>
<p>For example, I found that the function responsible for running a child
process was most natural to express with imperative language features:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">run_executable</span> <span class="n">path</span> <span class="o">{</span><span class="n">executable</span><span class="o">;</span> <span class="n">arguments</span><span class="o">;</span> <span class="n">output</span><span class="o">}</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">full_paths</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="o">^</span> <span class="s2">"/"</span> <span class="o">^</span> <span class="n">executable</span><span class="o">)</span> <span class="n">path</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">executables</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">append</span> <span class="n">full_paths</span> <span class="o">[</span><span class="n">executable</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">present</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="n">executable_present</span> <span class="n">executables</span> <span class="k">in</span>

  <span class="k">match</span> <span class="n">present</span> <span class="k">with</span>
  <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">print_error</span> <span class="bp">()</span><span class="o">;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="o">_</span> <span class="o">-&gt;</span>
    <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="c">(* Child *)</span>
       <span class="k">let</span> <span class="n">out</span> <span class="o">=</span> <span class="k">match</span> <span class="n">output</span> <span class="k">with</span>
         <span class="o">|</span> <span class="nc">Some</span> <span class="n">filename</span> <span class="o">-&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">filename</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_TRUNC</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span> <span class="o">]</span> <span class="mo">0o640</span>
         <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span>
       <span class="k">in</span>
       <span class="k">let</span> <span class="n">err</span> <span class="o">=</span> <span class="k">match</span> <span class="n">output</span> <span class="k">with</span>
         <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span>
         <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">out</span>
       <span class="k">in</span>
       <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">out</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
       <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">err</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span><span class="o">;</span>
       <span class="nn">Unix</span><span class="p">.</span><span class="n">execv</span> <span class="n">x</span> <span class="o">@@</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">@@</span> <span class="n">executable</span><span class="o">::</span><span class="n">arguments</span><span class="o">;</span>
    <span class="o">|</span> <span class="n">child_pid</span> <span class="o">-&gt;</span> <span class="c">(* Parent *)</span>
      <span class="nc">Some</span> <span class="n">child_pid</span>
</code></pre></div>
<p>Writing this way made it easy for me to switch between C and OCaml; in
both languages, we follow a pattern of calling <code>fork</code>, then <code>execv</code> in
the child process. The fact that I can easily re-use my knowledge of
the UNIX APIs across different programming languages is one of the
main reasons I'm excited to learn more systems programming concepts!</p>
<p>Variants and pattern matching are features I miss when working in
languages like Python. These features make it so easy to look at a
function like:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="n">main</span> <span class="n">stream</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">[</span><span class="s2">"/bin"</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">process</span> <span class="n">text</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Parser</span><span class="p">.</span><span class="n">parse_line</span> <span class="n">text</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">print_error</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">Ok</span> <span class="o">(</span><span class="nc">NoOp</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="bp">()</span> <span class="c">(* Empty lines should just be treated as no-ops. *)</span>
    <span class="o">|</span> <span class="nc">Ok</span> <span class="o">(</span><span class="nc">Quit</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">exit</span> <span class="mi">0</span>
    <span class="o">|</span> <span class="nc">Ok</span> <span class="o">(</span><span class="nc">ChangeDirectory</span> <span class="n">x</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">change_directory</span> <span class="n">x</span>
    <span class="o">|</span> <span class="nc">Ok</span> <span class="o">(</span><span class="nc">PathChange</span> <span class="n">paths</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">cwd</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getcwd</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="n">path</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">amend_path</span> <span class="n">cwd</span><span class="o">)</span> <span class="n">paths</span>
    <span class="o">|</span> <span class="nc">Ok</span> <span class="o">(</span><span class="nc">Executable</span> <span class="n">execs</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">run_executables</span> <span class="o">!</span><span class="n">path</span> <span class="n">execs</span>
  <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span> <span class="n">process</span> <span class="n">stream</span>
</code></pre></div>
<p>and quickly understand all of the different commands <code>osh</code> supports.</p>
<p>Although it took me some time to get up and running with Angstrom, I
strongly prefer working with parser combinators to writing an
imperative parser (as I've had to do in Python and Java). Angstrom
makes it easy to build up small parsers and test them in isolation
before composing them into the larger parser you really need. If I
planned to develop a shell with more features, I would probably break
<code>Parser</code> out into its own file with separate unit tests.</p>
<h2>Feedback</h2>
<p>If you give this project a try, let me know how it turned out! I'm
interested in adding more tutorial resources to the OCaml ecosystem,
so feel free to post a PR or issue to
<a href="https://github.com/jsthomas/simple-ocaml-shell">simple-ocaml-shell</a>
if you have ideas about how to make these resources better.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://jsthomas.github.io/ocaml-shell.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://jsthomas.github.io/category/ocaml.html" rel="tag">OCaml</a>
                </div>
            </article>            <h4 class="date">Jun 27, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://jsthomas.github.io/oss-how-why.html" rel="bookmark" title="Permanent Link to &quot;How I Contribute to Open Source Projects&quot;">How I Contribute to Open Source Projects</a>
                </h2>

                
                

                <p>Contributing to public projects is one of the most fulfilling aspects
of my software development practice. It allows me to make new
professional connections and gain exposure to challenges I would never
encounter on the job. But it <em>is</em> effortful, especially after a full
day of paid work. Over time, I've developed (mostly by trial and
error) a process that makes it easier for me to fit open source work
into my schedule and make this extra effort worthwhile.</p>
<p>Earlier in my career I wanted to contribute to public projects but
didn't know how to begin. In this post, I tried to provide a concise
summary of the advice I wish I'd received long ago.</p>
<h2>Why contribute?</h2>
<p>Like most engineers, my paid work has been on years-long,
closed-source projects driven by deadlines and business
requirements. In that context, it's normal to build with the most
standard components possible. If your Django app needs flash messages,
you probably want to use the <a href="https://docs.djangoproject.com/en/3.2/ref/contrib/messages/">messages
framework</a>,
rather than rolling your own solution; there just isn't much business
value in writing something new. As a result, there are some design
problems you don't get to spend much time thinking about while doing paid
work.</p>
<p>Working on OSS projects lets me to grow my skills beyond boundaries
imposed by business concerns. For instance, working on <a href="https://github.com/aantron/dream/issues/43">this
issue</a> let me build a
flash message system for a new web framework,
<a href="https://aantron.github.io/dream/">Dream</a>. Within the structure of
that project, I had an opportunity to study how Rails, Django, and
Phoenix implement flash messages. Discussing the merits of these
different approaches with more experienced engineers helped me become
a better designer.</p>
<p>I've also found that OSS projects are an effective way to practice the
investigative skills I use on the first few months of a new job. When
I join an organization, I have to get up to speed on new codebases
(sometimes in a language I haven't used before).  Working on an
unfamiliar open source project simulates these conditions, without the
accompanying pressures of a new job.</p>
<h2>How do I find new projects to work on?</h2>
<p>Conferences focused on a specific programming language or family of
technologies are a great way to meet maintainers. When I attended
<a href="http://www.composeconference.org/2017/">Compose 2017</a>, a
serendipitous conversation in between sessions led to a 3-4 month
period of making contributions to
<a href="https://github.com/ocsigen/lwt/">lwt</a>, learning a lot more about
OCaml, and this <a href="https://jsthomas.github.io/map-comparison.html">blog
post</a>.</p>
<p>Conferences <em>can</em> be a bit of a gamble. The costs of travel, lodging,
and fees are significant. Most conferences will post their talks
later. Watching these is a great way to stay informed. This Strange
Loop <a href="https://youtu.be/gCWtkvDQ2ZI">talk</a>, for instance, gave me a
good overview of the Unison programming language, which eventually
allowed me to contribute this
<a href="https://github.com/unisonweb/unison/pull/1639">change</a>. This approach
is much more efficient for finding projects that spark your interest,
since you can watch talks at 2x speed and skip ones that aren't
useful.</p>
<h2>Evaluating whether a project is a good fit</h2>
<p>Once I've found a project (usually on github) that I think is
interesting, there are a few things I check before deciding whether to
contribute.</p>
<p>First, I look at whether the project has recent commits. If the most
recent commit is more than a few months old, that might mean the
project is abandoned. Since I'm interested in being a contributor
rather than a maintainer, working on these repos is usually not a good
use of time.</p>
<p>The second thing I look at are the project's pull requests. If there
are many old, open pull requests (ones that don't have any comments),
this is another sign that the project might be abandoned. Looking
through closed PRs, or PRs with a lot of comments, typically gives me
some idea of how contributors and maintainers interact. The
maintainers I've interacted with have been friendly and welcoming; I
avoid projects where that isn't the norm.</p>
<p>Next, I'll take a look at the project's issue list. If users and
maintainers write clearly, it's much easier for me to make progress on
an issue without having to ask too many questions. Issues with links
to relevant code, minimal working examples, and repro steps are all
good signs.</p>
<p>I also look to see whether the project has Travis or Circle CI set up,
since that means I can get quick feedback on a PR without talking to
anyone. The CI systems is also helpful as a model for setting up my
development environment; often I will look through the CI
configuration in order to run my unit tests with the exact same
databases/dependencies/settings.</p>
<p>Finally, I'll take a more in-depth look at the codebase itself. At
this point, I'm just trying to answer basic questions, like:</p>
<ul>
<li>How is the source tree organized?</li>
<li>Do most of the functions/classes/modules have comprehensible names?</li>
<li>Where are the tests? Where would I add new tests?</li>
<li>Are there comments?</li>
</ul>
<h2>Finding a task</h2>
<p>Once I'm confident that I want to participate, my next step is to
choose an open issue to work on. Ones that are marked "good first
issue" or "beginner" are great for a first contribution, and I'll
often start with those.</p>
<p>I try to keep the scope of my first contribution small. For example,
<a href="https://github.com/arenadotio/pgx/issues/97">this issue</a> on the OCaml
library <code>pgx</code> asked for someone to add support for a different
date-time library (in this case <code>ptime</code>) because not everyone can use
Jane Street's <code>Core</code> library. This was an ideal first issue because I
could use the existing <code>Core</code> implementation as a model for what I
needed to build.</p>
<p>If an issue is a little bit old, it's a good idea to leave a note
asking whether the maintainer is still interested in having it
addressed. For example, I was interested in working on this
<a href="https://github.com/aantron/dream/issues/43">issue</a>, but it was a
month old. Rather than jumping into an implementation that might go to
waste, I left a comment expressing interest and offering some design
ideas. Replies in that thread allowed me to create this <a href="https://github.com/aantron/dream/pull/62">pull
request</a>, confident in the
knowledge that someone would want to use my work.</p>
<p>Once I've picked out task, it's (finally) time to implement a
solution. If I can get as far as implementing some unit tests and
getting most of them to pass, I post a comment on the issue indicating
that I'm working on a pull request. Personally, I consider it best
practice to <em>only</em> post one of these comments if I'm very confident
that I'll have a PR ready in the next few days. Conversely, no-one
wants to duplicate effort, so it's courteous to indicate that you're
preparing a PR.</p>
<h2>Pull request and review</h2>
<p>Since pull requests take time to review, I try to perform at least one
round of self-review before opening a PR. Generally, I won't open a PR
unless I have fairly good test coverage for my work and the tests (and
lint steps) are passing. At a paid position, it's easy to have a
meeting or use slack to discuss a change. Public projects tend to be
more asynchronous, so it's important to read instructions carefully,
write clearly, and address obvious issues on your own.</p>
<p>When I write a description for my PR, I include a link to the issue it
addresses, usually in the first sentence. If the change adds new types
or functions, I include a summary of that as well. If there are design
details I'm unsure of, I flag these with comments so that the
reviewer(s) can discuss them with me.</p>
<p>The code review process on a public project can be a little different
from code review inside a company. At some jobs, I've observed an
unspoken rule that PRs need to be more or less correct on the first or
second try, otherwise you'll be considered ineffective. My sense is
that the review process on public projects is much more
iterative. Sometimes it isn't possible to gather all of the necessary
requirements until a first PR is drafted and people have something to
react to. It can take several rounds of revision before all of the
interested parties agree that the design is right.</p>
<p>This <a href="https://github.com/aantron/dream/pull/62">PR</a> for instance,
required several tries to find a flash message implementation that fit
with the philosophy of the project. These situations are an
opportunity to practice discussing (and justifying) your design
decisions with other technical-minded people. I think the key to
success with public reviews is to read reviewer's comments carefully,
make an effort to understand their goals, and then fit your changes to
support those goals.</p>
<h2>General suggestions</h2>
<p>If you plan on making OSS contributions long term, I'd suggest having
both a schedule and dedicated hardware for your work. Working after
dinner from 6 to 8 PM weeknights helps me get into a productive
mindset quickly. Time-boxing my work also helps me avoid exhausting my
interest in a project by putting in too many consecutive hours. Using
an inexpensive, second-hand laptop for my public projects makes it
easy for me to suspend my work when I'm done for the night and then
start the next day exactly where I left off, without having to set up
my browser/editor/terminals again.</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://jsthomas.github.io/oss-how-why.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://jsthomas.github.io/category/oss-projects.html" rel="tag">OSS, Projects</a>
                </div>
            </article>            <h4 class="date">Jun 06, 2017</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://jsthomas.github.io/map-comparison.html" rel="bookmark" title="Permanent Link to &quot;Microbenchmarking Implementations of Map in OCaml&quot;">Microbenchmarking Implementations of Map in OCaml</a>
                </h2>

                
                

                <p><code>Map</code> is one of the first higher-order functions I remember
encountering when I learned some rudimentary functional programming
topics as an undergraduate. More recently I began learning OCaml. The
<code>map</code>
<a href="https://github.com/ocaml/ocaml/blob/2691c40f2ff9bc34912db39bc1f17045c9241473/stdlib/list.ml#L80-L82">implementation</a>
I found in the standard library was the textbook definition I was
expecting</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="k">rec</span> <span class="n">map</span> <span class="n">f</span> <span class="o">=</span> <span class="k">function</span>
   <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">[]</span>
  <span class="o">|</span> <span class="n">a</span><span class="o">::</span><span class="n">l</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">f</span> <span class="n">a</span> <span class="k">in</span> <span class="n">r</span> <span class="o">::</span> <span class="n">map</span> <span class="n">f</span> <span class="n">l</span>
</code></pre></div>
<p>but I was surprised to learn there are actually several
implementations of <code>map</code> in the OCaml ecosystem. I wanted to know more
about these different implementations and their performance
characteristics. This article summarizes what I learned.</p>
<p>Part of my motivation to write this post arose from
<a href="https://github.com/ocsigen/lwt/pull/347">this discussion</a> of a pull
request that proposes the default <code>map</code> implementation in <code>lwt</code> should
be tail recursive. After reading all of the comments, I wanted to
develop experiments that would convince me whether this was a good
idea.</p>
<h1>Introduction</h1>
<p>Since I'll introduce several versions of <code>map</code>, I'll refer to the
implementation above as <code>stdlib</code>. An important aspect of this version
is that it isn't <em>tail recursive</em>. A tail recursive function uses
recursion in a specific way; it only calls itself as the final
operation in the function. In OCaml, tail recursive functions get the
benefit of tail-call optimization so that they only use one frame on
the stack. In contrast, the <code>stdlib</code> implementation takes space on the
stack proportional to the length of the input list. For long enough
lists, this causes a stack overflow.</p>
<p>We can make a basic tail-recursive version of <code>map</code> by composing two
standard library functions that are tail recursive: <code>List.rev_map</code>
(which creates the output of <code>map</code>, but in reversed order) and
<code>List.rev</code> which reverses lists. I'll call this naive implementation
<code>ntr</code> (naive tail recursive). Compared to <code>stdlib</code>, <code>ntr</code> allocates
twice as much space on the heap (one list for the output of
<code>List.rev_map</code>, and a second equally long list for <code>List.rev</code>) and
spends additional time performing a list traversal. The benefit is
that with this implementation, calling <code>map</code> on a long list won't
result in a stack overflow.</p>
<p>As we'll see later in the Results section, the naive tail recursive
implementation is, overall, slower than the <code>stdlib</code>
implementation. However, there are some optimizations we can apply to
improve the performance of both versions.</p>
<p>The first trick I call "unrolling". Similar to
<a href="https://en.wikipedia.org/wiki/Loop_unrolling">loop unrolling in procedural languages</a>,
the idea is to use cases to <code>map</code> on groups of list elements so fewer
function calls are needed to complete the work. For example, an
unrolled version of <code>stdlib</code> looks like:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span> <span class="k">rec</span> <span class="n">map</span> <span class="n">f</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
  <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">[]</span>
  <span class="o">|</span> <span class="o">[</span><span class="n">x1</span><span class="o">]</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x1</span> <span class="k">in</span>
    <span class="o">[</span><span class="n">f1</span><span class="o">]</span>
  <span class="o">|</span> <span class="o">[</span><span class="n">x1</span><span class="o">;</span> <span class="n">x2</span><span class="o">]</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x1</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x2</span> <span class="k">in</span>
    <span class="o">[</span><span class="n">f1</span><span class="o">;</span> <span class="n">f2</span><span class="o">]</span>
  <span class="o">|</span> <span class="n">x1</span> <span class="o">::</span> <span class="n">x2</span> <span class="o">::</span> <span class="n">x3</span> <span class="o">::</span> <span class="n">tl</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x1</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x2</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">f3</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x3</span> <span class="k">in</span>
    <span class="n">f1</span> <span class="o">::</span> <span class="n">f2</span> <span class="o">::</span> <span class="n">f3</span> <span class="o">::</span> <span class="n">map</span> <span class="n">tl</span>
</code></pre></div>
<p>We get to choose how many elements to unroll (here I picked 3); some
profiling is needed to decide the most appropriate number.</p>
<p>The second trick I call "hybridizing". The <code>stdlib</code> version is faster,
but isn't safe for long lists. The tail recursive implementation is
slow, but safe for all lists. When we "hybridize" the two, we use the
faster version up to some fixed number of elements (e.g. 1000), and
then switch to the safe version for the remainder of the list.</p>
<p>These two optimizations are useful for understanding the
implementations of <code>map</code> we find in other libraries. For example, both
<a href="https://github.com/janestreet/base/blob/f10483e957206dc6b656a28ffec667d8b068c149/src/list.ml#L311-L345"><code>base</code></a>
and
<a href="https://github.com/c-cube/ocaml-containers/blob/d659ba677e3dbd95430f59b3794ac2f2a5677d61/src/core/CCList.ml#L20-L37"><code>containers</code></a>
use an unrolled <code>stdlib</code>-style <code>map</code>, hybridized with an
<code>ntr</code>-style <code>map</code>.</p>
<p>Looking at <code>ntr</code>, one might ask: Is it strictly necessary to use
additional heap space to get the implementation to be tail recursive?
The answer is no. The <code>batteries</code> package
<a href="https://github.com/ocaml-batteries-team/batteries-included/blob/c10c65a203a7590b15b9a370f66e8c2884817428/src/batList.mlv#L163-L173">implements <code>map</code></a>
so that the work is done by a single tail recursive function, creating
one new list on the heap. To achieve this, the implementation uses
mutable state and casting to avoid a second list traversal
(specifically,
<a href="https://github.com/ocaml-batteries-team/batteries-included/blob/c10c65a203a7590b15b9a370f66e8c2884817428/src/batList.mlv#L69">here</a>).</p>
<p>As with any optimization, one makes tradeoffs between elegance,
performance, and the language features one considers acceptable to
use. I wanted to know:</p>
<ul>
<li>
<p>Which version is the fastest in practice?</p>
</li>
<li>
<p>How much speed does one lose using the safer tail recursive version?</p>
</li>
</ul>
<p>Both <code>base</code> and <code>containers</code> decided to hybridize with an <code>ntr</code>-style
<code>map</code> for safety. But the <code>batteries</code> implementation is also robust to
stack overflow. That led to one final question:</p>
<ul>
<li>How fast is an unrolled <code>stdlib</code>-style <code>map</code> hybridized with a
  <code>batteries</code>-style <code>map</code>?</li>
</ul>
<h1>Experimental Setup</h1>
<p>In 2014, Jane Street introduced a
<a href="https://github.com/janestreet/core_bench">library</a> for
microbenchmarking called <code>core_bench</code>. As they explain
<a href="https://blogs.janestreet.com/core_bench-micro-benchmarking-for-ocaml/">on their blog</a>,
<code>core_bench</code> is intended to measure the performance of small pieces of
OCaml code. This library helps developers to better understand the
cost of individual operations, like <code>map</code>.</p>
<p>There are a couple benefits to measuring <code>map</code> implementations with
<code>core_bench</code>.</p>
<ol>
<li>
<p>The library makes it easy to track both time and use of the heap.</p>
</li>
<li>
<p>Once you specify your test, <code>core_bench</code> automatically provides
   many <a href="https://github.com/janestreet/core_bench/wiki/Getting-Started-with-Core_bench">command line
   options</a>
   to help you present your test data in different ways.</p>
</li>
<li>
<p>The library uses statistical techniques (bootstrapping and linear
   regression) to reduce many runs worth of data to a small number of
   meaningful performance metrics that account for the amortized cost
   of garbage collection and error introduced by system activity.</p>
</li>
</ol>
<p>I wrote
<a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/maptest.ml">this program</a>
to compare performance between the six implementations I described
above. The program includes the batteries-hybrid I described above,
which I'll refer to as <code>batt-hybr</code>. Other test details:</p>
<ul>
<li>I tested each algorithm against lists of lengths <span class="math">\(N=10^2, 10^3,
  10^4\)</span> and <span class="math">\(10^5\)</span>. On my system, <span class="math">\(N=10^5\)</span> was the highest power of 10
  for which the <code>stdlib</code> implementation did not fail due to a stack
  overflow.</li>
<li>Each list consisted of integer elements (all 0), and the function
  mapped onto the list simply added one to each element.</li>
<li>I ran these tests on a Lenovo X220, Intel Core i5-2520M CPU (2.50GHz ×
  4 cores), with 4GB RAM.</li>
<li>I used the OCaml 4.03.0 compiler, and compiled to native code
  without using <code>flambda</code>. (<a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/makefile">This
  makefile</a>
  gives the full specifications.)</li>
</ul>
<h1>Results</h1>
<p>For each list size, <code>core_bench</code> produces a table with several metrics besides time:</p>
<ul>
<li><code>mWd</code> : Words allocated on the minor heap.</li>
<li><code>mjWd</code> : Words allocated on the major heap.</li>
<li><code>Prom</code> : Words promoted from minor to major heap.</li>
</ul>
<p>The library also allows us to produce 95% confidence intervals and
<span class="math">\(R^2\)</span> values for the time estimates.</p>
<p><strong>Map Benchmark, N = 100</strong></p>
<div class="highlight"><pre><span></span><code><span class="err">┌────────────┬──────────┬──────────┬───────────────┬─────────┬──────────┬──────────┬────────────┐</span>
<span class="err">│ Name       │ Time R^2 │ Time/Run │          95ci │ mWd/Run │ mjWd/Run │ Prom/Run │ Percentage │</span>
<span class="err">├────────────┼──────────┼──────────┼───────────────┼─────────┼──────────┼──────────┼────────────┤</span>
<span class="err">│ ntr        │     1.00 │ 741.20ns │ -0.23% +0.22% │ 609.01w │    0.53w │    0.53w │    100.00% │</span>
<span class="err">│ containers │     1.00 │ 439.55ns │ -0.64% +0.67% │ 304.03w │    0.17w │    0.17w │     59.30% │</span>
<span class="err">│ batteries  │     1.00 │ 581.65ns │ -0.14% +0.16% │ 309.01w │    0.35w │    0.35w │     78.47% │</span>
<span class="err">│ base       │     1.00 │ 438.63ns │ -0.19% +0.20% │ 304.03w │    0.16w │    0.16w │     59.18% │</span>
<span class="err">│ stdlib     │     1.00 │ 610.45ns │ -0.10% +0.11% │ 304.01w │    0.17w │    0.17w │     82.36% │</span>
<span class="err">│ batt-hybr  │     1.00 │ 426.76ns │ -0.15% +0.17% │ 304.03w │    0.17w │    0.17w │     57.58% │</span>
<span class="err">└────────────┴──────────┴──────────┴───────────────┴─────────┴──────────┴──────────┴────────────┘</span>
</code></pre></div>
<p><strong>Map Benchmark, N = 1000</strong></p>
<div class="highlight"><pre><span></span><code><span class="err">┌────────────┬──────────┬──────────┬───────────────┬─────────┬──────────┬──────────┬────────────┐</span>
<span class="err">│ Name       │ Time R^2 │ Time/Run │          95ci │ mWd/Run │ mjWd/Run │ Prom/Run │ Percentage │</span>
<span class="err">├────────────┼──────────┼──────────┼───────────────┼─────────┼──────────┼──────────┼────────────┤</span>
<span class="err">│ ntr        │     1.00 │   8.84us │ -0.14% +0.15% │  6.01kw │   52.08w │   52.08w │    100.00% │</span>
<span class="err">│ containers │     1.00 │   5.07us │ -0.13% +0.15% │  3.00kw │   17.23w │   17.23w │     57.34% │</span>
<span class="err">│ batteries  │     1.00 │   6.57us │ -0.14% +0.14% │  3.01kw │   34.71w │   34.71w │     74.32% │</span>
<span class="err">│ base       │     1.00 │   4.99us │ -0.20% +0.24% │  3.00kw │   17.08w │   17.08w │     56.44% │</span>
<span class="err">│ stdlib     │     1.00 │   6.84us │ -0.10% +0.10% │  3.00kw │   17.22w │   17.22w │     77.34% │</span>
<span class="err">│ batt-hybr  │     1.00 │   4.96us │ -0.13% +0.13% │  3.00kw │   17.07w │   17.07w │     56.10% │</span>
<span class="err">└────────────┴──────────┴──────────┴───────────────┴─────────┴──────────┴──────────┴────────────┘</span>
</code></pre></div>
<p><strong>Map Benchmark, N = 10,000</strong></p>
<div class="highlight"><pre><span></span><code><span class="err">┌────────────┬──────────┬──────────┬───────────────┬─────────┬──────────┬──────────┬────────────┐</span>
<span class="err">│ Name       │ Time R^2 │ Time/Run │          95ci │ mWd/Run │ mjWd/Run │ Prom/Run │ Percentage │</span>
<span class="err">├────────────┼──────────┼──────────┼───────────────┼─────────┼──────────┼──────────┼────────────┤</span>
<span class="err">│ ntr        │     0.99 │ 203.11us │ -0.45% +0.53% │ 60.01kw │   5.40kw │   5.40kw │    100.00% │</span>
<span class="err">│ containers │     1.00 │ 144.95us │ -0.50% +0.60% │ 48.01kw │   3.04kw │   3.04kw │     71.37% │</span>
<span class="err">│ batteries  │     1.00 │ 136.87us │ -0.51% +0.63% │ 30.01kw │   3.64kw │   3.64kw │     67.39% │</span>
<span class="err">│ base       │     1.00 │ 130.85us │ -0.34% +0.39% │ 44.98kw │   2.66kw │   2.66kw │     64.42% │</span>
<span class="err">│ stdlib     │     1.00 │ 118.70us │ -0.30% +0.29% │ 30.00kw │   1.80kw │   1.80kw │     58.44% │</span>
<span class="err">│ batt-hybr  │     1.00 │ 106.91us │ -0.42% +0.52% │ 30.01kw │   2.22kw │   2.22kw │     52.64% │</span>
<span class="err">└────────────┴──────────┴──────────┴───────────────┴─────────┴──────────┴──────────┴────────────┘</span>
</code></pre></div>
<p><strong>Map Benchmark, N = 100,000</strong></p>
<div class="highlight"><pre><span></span><code><span class="err">┌────────────┬──────────┬──────────┬───────────────┬──────────┬──────────┬──────────┬────────────┐</span>
<span class="err">│ Name       │ Time R^2 │ Time/Run │          95ci │  mWd/Run │ mjWd/Run │ Prom/Run │ Percentage │</span>
<span class="err">├────────────┼──────────┼──────────┼───────────────┼──────────┼──────────┼──────────┼────────────┤</span>
<span class="err">│ ntr        │     0.98 │  10.27ms │ -2.39% +2.32% │ 600.02kw │ 411.83kw │ 411.83kw │     94.33% │</span>
<span class="err">│ containers │     0.99 │  10.62ms │ -2.19% +1.83% │ 588.02kw │ 404.91kw │ 404.91kw │     97.61% │</span>
<span class="err">│ batteries  │     1.00 │   7.19ms │ -0.78% +0.79% │ 300.02kw │ 300.35kw │ 300.35kw │     66.02% │</span>
<span class="err">│ base       │     0.99 │  10.88ms │ -1.54% +1.41% │ 584.99kw │ 397.60kw │ 397.60kw │    100.00% │</span>
<span class="err">│ stdlib     │     0.99 │   6.33ms │ -1.08% +1.07% │ 300.01kw │ 171.73kw │ 171.73kw │     58.18% │</span>
<span class="err">│ batt-hybr  │     0.93 │   6.09ms │ -4.30% +4.63% │ 300.02kw │ 285.46kw │ 285.46kw │     55.93% │</span>
<span class="err">└────────────┴──────────┴──────────┴───────────────┴──────────┴──────────┴──────────┴────────────┘</span>
</code></pre></div>
<p>A few things I noticed about the data:</p>
<ul>
<li>
<p>The tail recursive implementation is slow, but not always the
  slowest. In the <span class="math">\(N=10^5\)</span> case, <code>ntr</code>,<code>base</code>, and <code>containers</code> show
  similar performance; this makes sense given they have the same
  behavior after a prefix of the list.</p>
</li>
<li>
<p>For short lists, <code>base</code>, <code>containers</code>, and <code>batt-hybr</code> are fastest,
  likely because of unrolling.</p>
</li>
<li>
<p>We can see from the <code>mWd</code> and <code>mjWd</code> columns that <code>ntr</code> uses the
  most heap space, as we would expect.</p>
</li>
<li>
<p>As we increase the size of the list, <code>stdlib</code> gets faster relative
  to <code>ntr</code>; I suspect this can be attributed to the cost of garbage
  collection.</p>
</li>
<li>
<p>Overall, <code>batt-hybr</code> appears to have the best performance (though in
  the <span class="math">\(N=10^5\)</span> case, the confidence interval is large enough that we
  can't conclude <code>batt-hybr</code> is faster than <code>stdlib</code>, and the <span class="math">\(R^2\)</span>
  value is a bit low).</p>
</li>
</ul>
<h1>Conclusions</h1>
<p>The data above suggest three main findings:</p>
<ol>
<li>
<p>The stack-based standard library implementation of <code>map</code> is faster
   than the naive tail recursive implementation, taking about 60-80%
   of the time to do the same work depending on the size of the list.</p>
</li>
<li>
<p>There are clear benefits to both unrolling and
   hybridizing. Hybridizing lets us take an implementation that
   performs well on long lists (<code>batteries</code>), and make it even better
   by combining it with one that's fast on short lists, to produce
   <code>batt-hybr</code>.</p>
</li>
<li>
<p>Overall, the data show we don't have to give up safety (resistance
   to stack overflow) to get better performance. A tail recursive
   implementation can be quite competitive, albeit more complex.</p>
</li>
</ol>
<h1>Discussion</h1>
<p>A follow up question to this analysis, in the context of the
discussion of <code>Lwt_list.map_p</code> is: "How significant is the cost of
<code>map</code> compared to other operations?" To partially address this, I
wrote
<a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/bufftest.ml">another program</a>
that measures how long it takes to write 4096 bytes to a Unix pipe
using <code>Lwt_unix.write</code>, and then read it back using <code>Lwt_unix.read</code>. Using
<code>core_bench</code>, I found:</p>
<p><strong>Unix Pipe Read/Write Benchmark</strong></p>
<div class="highlight"><pre><span></span><code><span class="err">┌─────────┬──────────┬───────────────┬─────────┬────────────┐</span>
<span class="err">│Time R^2 │ Time/Run │          95ci │ mWd/Run │ Percentage │</span>
<span class="err">├─────────┼──────────┼───────────────┼─────────┼────────────┤</span>
<span class="err">│    1.00 │ 893.33ns │ -0.16% +0.18% │  56.00w │    100.00% │</span>
<span class="err">└─────────┴──────────┴───────────────┴─────────┴────────────┘</span>
</code></pre></div>
<p>It seems reasonable to estimate that <code>Lwt_list.map_p</code> would primarily
be applied to IO operations like the ones in this experiment. In that
case, the data suggest the cost per element of applying the slowest
<code>map</code> implementation (<code>ntr</code>) is about 0.82% of the cost of one 4KB
read/write operation on a unix pipe. In the context of <code>Lwt</code>, it seems
reasonable to conclude the implementation of <code>map</code> isn't a significant
concern; the real cost is performing IO. In light of that, it seems
preferable to use an implementation that cannot cause a stack
overflow.</p>
<p>A second question that might be asked about this analysis is: "Was it
necessary to introduce the added complexity of <code>core_bench</code> to measure
the performance of <code>map</code>?" For example, one might set up a performance
test with just successive calls to <code>Time.now</code> or
<code>Unix.gettimeofday</code>. In an earlier draft of this article, I tried such
an
<a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/profile.ml">approach</a>,
producing some misleading data. In that test, I did a full garbage
collection in between runs (applications of <code>map</code>), which suppressed
that (nontrivial) cost and made the tail recursive implementation
appear quite fast. <code>core_bench</code> does a much better job incorporating
the cost of garbage collection by varying the number of test runs
performed in a row and then establishing a trend (with linear
regression) that reflects the amortized cost of garbage collection per
run.</p>
<p>One interesting finding did arise from my earlier tests: for short
lists, allocating memory on the heap actually appears to be faster
than creating frames on the stack. Since the tests perform a full
garbage collection between test runs, the timings show only the cost
of allocating space on the heap. This produced data like the
following:</p>
<p><strong>Summary Statistics, <span class="math">\(N=10^3\)</span> Garbage Collected Map Benchmark Times (μs)</strong></p>
<table class="dataframe">
<thead>
<tr>
<th></th>
<th>Std. Lib.</th>
<th>NTR</th>
<th>Base</th>
<th>Batteries</th>
<th>Containers</th>
</tr>
</thead>
<tbody>
<tr>
<th>Mean</th>
<td>27.18</td>
<td>27.21</td>
<td>11.23</td>
<td>19.03</td>
<td>13.06</td>
</tr>
<tr>
<th>Min</th>
<td>15.97</td>
<td>14.07</td>
<td>6.91</td>
<td>9.06</td>
<td>7.87</td>
</tr>
<tr>
<th>25%</th>
<td>18.84</td>
<td>17.88</td>
<td>7.15</td>
<td>10.97</td>
<td>10.01</td>
</tr>
<tr>
<th>50%</th>
<td>20.03</td>
<td>19.07</td>
<td>8.11</td>
<td>15.50</td>
<td>10.01</td>
</tr>
<tr>
<th>75%</th>
<td>23.13</td>
<td>22.17</td>
<td>12.87</td>
<td>18.84</td>
<td>10.97</td>
</tr>
<tr>
<th>Max</th>
<td>849.01</td>
<td>576.02</td>
<td>379.80</td>
<td>622.03</td>
<td>434.88</td>
</tr>
</tbody>
</table>
<p><strong>Summary Statistics, <span class="math">\(N=10^4\)</span> Garbage Collected Map Benchmark Times (μs)</strong></p>
<table class="dataframe">
<thead>
<tr>
<th></th>
<th>Std. Lib.</th>
<th>NTR</th>
<th>Base</th>
<th>Batteries</th>
<th>Containers</th>
</tr>
</thead>
<tbody>
<tr>
<th>Mean</th>
<td>230.23</td>
<td>216.60</td>
<td>141.39</td>
<td>144.59</td>
<td>161.56</td>
</tr>
<tr>
<th>Min</th>
<td>77.01</td>
<td>73.91</td>
<td>61.04</td>
<td>54.84</td>
<td>63.18</td>
</tr>
<tr>
<th>25%</th>
<td>97.04</td>
<td>86.07</td>
<td>67.95</td>
<td>58.89</td>
<td>70.81</td>
</tr>
<tr>
<th>50%</th>
<td>121.95</td>
<td>99.90</td>
<td>75.10</td>
<td>61.99</td>
<td>77.01</td>
</tr>
<tr>
<th>75%</th>
<td>193.83</td>
<td>284.91</td>
<td>148.59</td>
<td>118.26</td>
<td>175.24</td>
</tr>
<tr>
<th>Max</th>
<td>12719.87</td>
<td>2753.97</td>
<td>2960.21</td>
<td>3616.09</td>
<td>13603.93</td>
</tr>
</tbody>
</table>
<p>When we ignore the time spent on garbage collection, we see that <code>ntr</code>
is surprisingly competitive, especially in comparison with <code>stdlib</code>;
the difference between the two implementations, of course, is that
<code>ntr</code> allocates more memory on the heap while <code>stdlib</code> creates more
stack frames.</p>
<h2>Notes</h2>
<p>Thanks to <a href="https://github.com/aantron">Anton Bachin</a> and
<a href="https://github.com/c-cube/">Simon Cruanes</a> for reading drafts of this
post.</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://jsthomas.github.io/map-comparison.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://jsthomas.github.io/category/ocaml.html" rel="tag">OCaml</a>
                </div>
            </article>

                <div class="clear"></div>
                <div class="pages">


                    <a href="https://jsthomas.github.io/author/joe-thomas2.html" class="next_page">Next&nbsp;&rarr;</a>

                    <span>Page 1 of 2</span>
                </div>

        </div>
        <div class="clear"></div>
    </div>
     <!-- Global site tag (gtag.js) - Google Analytics -->
     <script async src="https://www.googletagmanager.com/gtag/js?id=G-8L9H76FSM5"></script>
     <script>
       window.dataLayer = window.dataLayer || [];
       function gtag(){dataLayer.push(arguments);}
       gtag('js', new Date());

       gtag('config', 'G-8L9H76FSM5');
     </script>
</body>
</html>