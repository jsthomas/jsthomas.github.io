<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Joe Thomas</title><link href="https://jsthomas.github.io/" rel="alternate"></link><link href="https://jsthomas.github.io/feeds/all.atom.xml" rel="self"></link><id>https://jsthomas.github.io/</id><updated>2021-07-01T00:00:00-04:00</updated><entry><title>Let's write a shell in OCaml!</title><link href="https://jsthomas.github.io/ocaml-shell.html" rel="alternate"></link><published>2021-07-01T00:00:00-04:00</published><updated>2021-07-01T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2021-07-01:/ocaml-shell.html</id><summary type="html">&lt;p&gt;A user experience report about writing a simple shell in OCaml&lt;/p&gt;</summary><content type="html">&lt;p&gt;This Summer I'm studying OCaml and systems programming at the &lt;a href="https://www.recurse.com/"&gt;Recurse
Center&lt;/a&gt;. Currently I'm reading the
delightful book &lt;a href="https://pages.cs.wisc.edu/~remzi/OSTEP/"&gt;&lt;em&gt;Operating Systems: Three Easy
Pieces&lt;/em&gt;&lt;/a&gt; by Remzi
Arpaci-Dusseau and Andrea Arpaci-Dusseau. Besides great exposition,
the book includes several interesting projects, one of which is to
&lt;a href="https://github.com/remzi-arpacidusseau/ostep-projects/tree/master/processes-shell"&gt;write a
shell&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The project materials, a set of shell scripts that define tests, are
language agnostic. I believe the authors intended for students to use
C, but I worked through the exercise in OCaml; you can find the final
result &lt;a href="https://github.com/jsthomas/simple-ocaml-shell"&gt;in this
repo&lt;/a&gt;. This blog post
is a short experience report; if you're interested in working on a
beginner OCaml project, hopefully it can provides some useful
scaffolding for your studies.&lt;/p&gt;
&lt;h2&gt;Shell features&lt;/h2&gt;
&lt;p&gt;The shell I built (&lt;code&gt;osh&lt;/code&gt;) has a somewhat limited feature set. It:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Allows several commands to be run in parallel (e.g. &lt;code&gt;program1 arg1 &amp;amp;
  program2 arg2 arg3&lt;/code&gt;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Supports simple output redirection (e.g. &lt;code&gt;echo "hello" &amp;gt;
  hello.txt&lt;/code&gt;). Both &lt;code&gt;stdout&lt;/code&gt; and &lt;code&gt;stderr&lt;/code&gt; go to the same file.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Has three builtin functions, &lt;code&gt;cd&lt;/code&gt;, &lt;code&gt;exit&lt;/code&gt;, and &lt;code&gt;path&lt;/code&gt;. &lt;code&gt;path&lt;/code&gt; allows
  you to define a list of directories to search for executables; we
  need this because environment variables aren't supported.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Other niceties, like tab completion and pipes, aren't supported. To
facilitate testing, the shell can run in a batch mode (&lt;code&gt;osh &amp;lt;my file
of commands&amp;gt;&lt;/code&gt;) as well as an interactive mode. A final simplifying
assumption is that &lt;code&gt;osh&lt;/code&gt; only provides a basic error message when
inputs are malformed.&lt;/p&gt;
&lt;h2&gt;Concepts&lt;/h2&gt;
&lt;p&gt;There are three main topics I studied while working on this project:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The &lt;code&gt;Unix&lt;/code&gt; module, especially &lt;code&gt;fork&lt;/code&gt; and
    &lt;code&gt;execv&lt;/code&gt;. &lt;a href="https://ocaml.github.io/ocamlunix/ocamlunix.html"&gt;This
    page&lt;/a&gt;, from
    Xavier Leroy and Didier RÃ©my, was helpful for getting up to
    speed. The man-pages were also useful.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;a href="https://ocaml.org/api/Stream.html"&gt;&lt;code&gt;Stream&lt;/code&gt;&lt;/a&gt; module. Streams
   in OCaml are roughly analogous to generators in Python; they
   allowed me to use a single type (a &lt;code&gt;string Stream.t&lt;/code&gt;) to represent
   commands coming from an interactive session or a batch file.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;a href="https://github.com/inhabitedtype/angstrom"&gt;Angstrom&lt;/a&gt;
   parser-combinator library. I used this library to determine whether
   a given line of user input is well formed.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I suspect you could implement the parser without Angstrom, if you
really wanted to. I wanted to learn more about this library, and this
project seemed like a good place to try it out.&lt;/p&gt;
&lt;p&gt;Although I previously worked through some simple monadic parser
exercises in Haskell, I struggled the most with Angstrom. Reading one
of the main &lt;a href="https://github.com/inhabitedtype/angstrom/blob/master/lib/angstrom.mli"&gt;mli
files&lt;/a&gt;
seemed to be the best way to get an overview of the combinators the
library provides. I also spent a fair amount of time experimenting in
&lt;code&gt;utop&lt;/code&gt; as I put my parser together.&lt;/p&gt;
&lt;h2&gt;Steps&lt;/h2&gt;
&lt;p&gt;Here is a rough outline for how I built my shell.&lt;/p&gt;
&lt;p&gt;First, I defined a main function that would fetch a line of text from
&lt;code&gt;stdin&lt;/code&gt; and echo it back to the user. Then I added the ability to
represent either interactive or batch input with a &lt;code&gt;Stream&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;prompt_stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"osh&amp;gt; "&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;read_line&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;


&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;file_stream&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;in_channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;open_in&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;
      &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;input_line&lt;/span&gt; &lt;span class="n"&gt;in_channel&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="nc"&gt;End_of_file&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="n"&gt;close_in&lt;/span&gt; &lt;span class="n"&gt;in_channel&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
      &lt;span class="nc"&gt;None&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It's useful to do this part as early as possible, since batch input
allows you to run the tests.&lt;/p&gt;
&lt;p&gt;Once I could get &lt;code&gt;osh&lt;/code&gt; to fail all 22 test cases, I started adding the
simpler built-in commands &lt;code&gt;cd&lt;/code&gt; and &lt;code&gt;exit&lt;/code&gt;. (Note &lt;code&gt;./test-osh.sh -c&lt;/code&gt;
will run all 22 tests, without stopping at the first one that fails.)&lt;/p&gt;
&lt;p&gt;My first version of &lt;code&gt;main&lt;/code&gt; just treated user input as &lt;code&gt;string list&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;rec&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;String&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split_on_char&lt;/span&gt; &lt;span class="sc"&gt;' '&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;  &lt;span class="c"&gt;(* Empty lines should just be treated as no-ops. *)&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;""&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"exit"&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;exit&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"cd"&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;chdir&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="s2"&gt;"cd"&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;print_error&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;xs&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fork&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
      &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Child *)&lt;/span&gt;
        &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;execv&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Array&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;of_list&lt;/span&gt; &lt;span class="n"&gt;xs&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
      &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Parent *)&lt;/span&gt;
        &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;waitpid&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt;
        &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iter&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This worked well enough for running simple commands like &lt;code&gt;/usr/bin/ls
-lah&lt;/code&gt;. In order to get output redirection and &lt;code&gt;&amp;amp;&lt;/code&gt; to work, I needed to
upgrade the program's parsing capabilities. I switched from
representing user input with a &lt;code&gt;string list&lt;/code&gt; to a variant type:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;type&lt;/span&gt; &lt;span class="n"&gt;exec&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="kt"&gt;list&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;option&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;type&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;NoOp&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;ChangeDirectory&lt;/span&gt; &lt;span class="k"&gt;of&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;PathChange&lt;/span&gt; &lt;span class="k"&gt;of&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="kt"&gt;list&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Executable&lt;/span&gt; &lt;span class="k"&gt;of&lt;/span&gt; &lt;span class="n"&gt;exec&lt;/span&gt; &lt;span class="kt"&gt;list&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Quit&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I found the OCaml compiler (and its emacs integrations, &lt;code&gt;merlin&lt;/code&gt; and
&lt;code&gt;tuareg&lt;/code&gt;) very helpful for refactoring. When I revised my types to
make them better reflect the data I wanted to model, type errors
identified all of the places I needed to update. At this point, I
introduced an Angstrom parser and re-implemented support for &lt;code&gt;cd&lt;/code&gt;,
&lt;code&gt;exit&lt;/code&gt;, and &lt;code&gt;path&lt;/code&gt;. That allowed me to get familiar with the parser
combinators &lt;code&gt;*&amp;gt;&lt;/code&gt;, &lt;code&gt;many&lt;/code&gt;, and &lt;code&gt;choice&lt;/code&gt;, before attempting the more
complicated parsers needed to support &lt;code&gt;&amp;amp;&lt;/code&gt; and &lt;code&gt;&amp;gt;&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The type system protected me from a number of silly mistakes, but it
wasn't a silver bullet. I spent an hour confused about why one of my
parsers would go into an infinite loop before realizing I needed to
use &lt;code&gt;many1&lt;/code&gt; instead of &lt;code&gt;many&lt;/code&gt;. I think this is the sort of mistake I
would learn to avoid if I spent more time working with Angstrom.&lt;/p&gt;
&lt;h2&gt;Discussion&lt;/h2&gt;
&lt;p&gt;As I worked through this project, I started to appreciate how OCaml
chooses "good defaults" for my code (especially immutable data)
without forbidding me from working in an imperative mode when I need
to.&lt;/p&gt;
&lt;p&gt;For example, I found that the function responsible for running a child
process was most natural to express with imperative language features:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;run_executable&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;full_paths&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;fun&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;^&lt;/span&gt; &lt;span class="s2"&gt;"/"&lt;/span&gt; &lt;span class="o"&gt;^&lt;/span&gt; &lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;executables&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt; &lt;span class="n"&gt;full_paths&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;present&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt; &lt;span class="n"&gt;executable_present&lt;/span&gt; &lt;span class="n"&gt;executables&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;

  &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;present&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;print_error&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fork&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Child *)&lt;/span&gt;
       &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;openfile&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;O_TRUNC&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;O_WRONLY&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;O_CREAT&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="mo"&gt;0o640&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;
       &lt;span class="k"&gt;in&lt;/span&gt;
       &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stderr&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt;
       &lt;span class="k"&gt;in&lt;/span&gt;
       &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dup2&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
       &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dup2&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stderr&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
       &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;execv&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Array&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;of_list&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Parent *)&lt;/span&gt;
      &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Writing this way made it easy for me to switch between C and OCaml; in
both languages, we follow a pattern of calling &lt;code&gt;fork&lt;/code&gt;, then &lt;code&gt;execv&lt;/code&gt; in
the child process. The fact that I can easily re-use my knowledge of
the UNIX APIs across different programming languages is one of the
main reasons I'm excited to learn more systems programming concepts!&lt;/p&gt;
&lt;p&gt;Variants and pattern matching are features I miss when working in
languages like Python. These features make it so easy to look at a
function like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ref&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"/bin"&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="nn"&gt;Parser&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse_line&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Error&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;print_error&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;NoOp&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="c"&gt;(* Empty lines should just be treated as no-ops. *)&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Quit&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;exit&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;ChangeDirectory&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;change_directory&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;PathChange&lt;/span&gt; &lt;span class="n"&gt;paths&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;cwd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getcwd&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
      &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;amend_path&lt;/span&gt; &lt;span class="n"&gt;cwd&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;paths&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Executable&lt;/span&gt; &lt;span class="n"&gt;execs&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;run_executables&lt;/span&gt; &lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="n"&gt;execs&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iter&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and quickly understand all of the different commands &lt;code&gt;osh&lt;/code&gt; supports.&lt;/p&gt;
&lt;p&gt;Although it took me some time to get up and running with Angstrom, I
strongly prefer working with parser combinators to writing an
imperative parser (as I've had to do in Python and Java). Angstrom
makes it easy to build up small parsers and test them in isolation
before composing them into the larger parser you really need. If I
planned to develop a more robust shell, I would probably break
&lt;code&gt;Parser&lt;/code&gt; out into its own module, with separate unit tests.&lt;/p&gt;
&lt;h2&gt;Feedback&lt;/h2&gt;
&lt;p&gt;If you give this project a try, let me know how it turned out! I'm
interested in adding more tutorial resources to the OCaml ecosystem,
so feel free to post a PR or issue to
&lt;a href="https://github.com/jsthomas/simple-ocaml-shell"&gt;simple-ocaml-shell&lt;/a&gt;
if you have ideas about how to make these resources better.&lt;/p&gt;</content><category term="OCaml"></category></entry><entry><title>How I Contribute to Open Source Projects</title><link href="https://jsthomas.github.io/oss-how-why.html" rel="alternate"></link><published>2021-06-27T00:00:00-04:00</published><updated>2021-06-27T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2021-06-27:/oss-how-why.html</id><summary type="html">&lt;p&gt;A short explanation of my open source process.&lt;/p&gt;</summary><content type="html">&lt;p&gt;Contributing to public projects is one of the most fulfilling aspects
of my software development practice. It allows me to make new
professional connections and gain exposure to challenges I would never
encounter on the job. But it &lt;em&gt;is&lt;/em&gt; effortful, especially after a full
day of paid work. Over time, I've developed (mostly by trial and
error) a process that makes it easier for me to fit open source work
into my schedule and make this extra effort worthwhile.&lt;/p&gt;
&lt;p&gt;Earlier in my career I wanted to contribute to public projects but
didn't know how to begin. In this post, I tried to provide a concise
summary of the advice I wish I'd received long ago.&lt;/p&gt;
&lt;h2&gt;Why contribute?&lt;/h2&gt;
&lt;p&gt;Like most engineers, my paid work has been on years-long,
closed-source projects driven by deadlines and business
requirements. In that context, it's normal to build with the most
standard components possible. If your Django app needs flash messages,
you probably want to use the &lt;a href="https://docs.djangoproject.com/en/3.2/ref/contrib/messages/"&gt;messages
framework&lt;/a&gt;,
rather than rolling your own solution; there just isn't much business
value in writing something new. As a result, there are some design
problems you don't get to spend much time thinking about while doing paid
work.&lt;/p&gt;
&lt;p&gt;Working on OSS projects lets me to grow my skills beyond boundaries
imposed by business concerns. For instance, working on &lt;a href="https://github.com/aantron/dream/issues/43"&gt;this
issue&lt;/a&gt; let me build a
flash message system for a new web framework,
&lt;a href="https://aantron.github.io/dream/"&gt;Dream&lt;/a&gt;. Within the structure of
that project, I had an opportunity to study how Rails, Django, and
Phoenix implement flash messages. Discussing the merits of these
different approaches with more experienced engineers helped me become
a better designer.&lt;/p&gt;
&lt;p&gt;I've also found that OSS projects are an effective way to practice the
investigative skills I use on the first few months of a new job. When
I join an organization, I have to get up to speed on new codebases
(sometimes in a language I haven't used before).  Working on an
unfamiliar open source project simulates these conditions, without the
accompanying pressures of a new job.&lt;/p&gt;
&lt;h2&gt;How do I find new projects to work on?&lt;/h2&gt;
&lt;p&gt;Conferences focused on a specific programming language or family of
technologies are a great way to meet maintainers. When I attended
&lt;a href="http://www.composeconference.org/2017/"&gt;Compose 2017&lt;/a&gt;, a
serendipitous conversation in between sessions led to a 3-4 month
period of making contributions to
&lt;a href="https://github.com/ocsigen/lwt/"&gt;lwt&lt;/a&gt;, learning a lot more about
OCaml, and this &lt;a href="https://jsthomas.github.io/map-comparison.html"&gt;blog
post&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Conferences &lt;em&gt;can&lt;/em&gt; be a bit of a gamble. The costs of travel, lodging,
and fees are significant. Most conferences will post their talks
later. Watching these is a great way to stay informed. This Strange
Loop &lt;a href="https://youtu.be/gCWtkvDQ2ZI"&gt;talk&lt;/a&gt;, for instance, gave me a
good overview of the Unison programming language, which eventually
allowed me to contribute this
&lt;a href="https://github.com/unisonweb/unison/pull/1639"&gt;change&lt;/a&gt;. This approach
is much more efficient for finding projects that spark your interest,
since you can watch talks at 2x speed and skip ones that aren't
useful.&lt;/p&gt;
&lt;h2&gt;Evaluating whether a project is a good fit&lt;/h2&gt;
&lt;p&gt;Once I've found a project (usually on github) that I think is
interesting, there are a few things I check before deciding whether to
contribute.&lt;/p&gt;
&lt;p&gt;First, I look at whether the project has recent commits. If the most
recent commit is more than a few months old, that might mean the
project is abandoned. Since I'm interested in being a contributor
rather than a maintainer, working on these repos is usually not a good
use of time.&lt;/p&gt;
&lt;p&gt;The second thing I look at are the project's pull requests. If there
are many old, open pull requests (ones that don't have any comments),
this is another sign that the project might be abandoned. Looking
through closed PRs, or PRs with a lot of comments, typically gives me
some idea of how contributors and maintainers interact. The
maintainers I've interacted with have been friendly and welcoming; I
avoid projects where that isn't the norm.&lt;/p&gt;
&lt;p&gt;Next, I'll take a look at the project's issue list. If users and
maintainers write clearly, it's much easier for me to make progress on
an issue without having to ask too many questions. Issues with links
to relevant code, minimal working examples, and repro steps are all
good signs.&lt;/p&gt;
&lt;p&gt;I also look to see whether the project has Travis or Circle CI set up,
since that means I can get quick feedback on a PR without talking to
anyone. The CI systems is also helpful as a model for setting up my
development environment; often I will look through the CI
configuration in order to run my unit tests with the exact same
databases/dependencies/settings.&lt;/p&gt;
&lt;p&gt;Finally, I'll take a more in-depth look at the codebase itself. At
this point, I'm just trying to answer basic questions, like:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;How is the source tree organized?&lt;/li&gt;
&lt;li&gt;Do most of the functions/classes/modules have comprehensible names?&lt;/li&gt;
&lt;li&gt;Where are the tests? Where would I add new tests?&lt;/li&gt;
&lt;li&gt;Are there comments?&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Finding a task&lt;/h2&gt;
&lt;p&gt;Once I'm confident that I want to participate, my next step is to
choose an open issue to work on. Ones that are marked "good first
issue" or "beginner" are great for a first contribution, and I'll
often start with those.&lt;/p&gt;
&lt;p&gt;I try to keep the scope of my first contribution small. For example,
&lt;a href="https://github.com/arenadotio/pgx/issues/97"&gt;this issue&lt;/a&gt; on the OCaml
library &lt;code&gt;pgx&lt;/code&gt; asked for someone to add support for a different
date-time library (in this case &lt;code&gt;ptime&lt;/code&gt;) because not everyone can use
Jane Street's &lt;code&gt;Core&lt;/code&gt; library. This was an ideal first issue because I
could use the existing &lt;code&gt;Core&lt;/code&gt; implementation as a model for what I
needed to build.&lt;/p&gt;
&lt;p&gt;If an issue is a little bit old, it's a good idea to leave a note
asking whether the maintainer is still interested in having it
addressed. For example, I was interested in working on this
&lt;a href="https://github.com/aantron/dream/issues/43"&gt;issue&lt;/a&gt;, but it was a
month old. Rather than jumping into an implementation that might go to
waste, I left a comment expressing interest and offering some design
ideas. Replies in that thread allowed me to create this &lt;a href="https://github.com/aantron/dream/pull/62"&gt;pull
request&lt;/a&gt;, confident in the
knowledge that someone would want to use my work.&lt;/p&gt;
&lt;p&gt;Once I've picked out task, it's (finally) time to implement a
solution. If I can get as far as implementing some unit tests and
getting most of them to pass, I post a comment on the issue indicating
that I'm working on a pull request. Personally, I consider it best
practice to &lt;em&gt;only&lt;/em&gt; post one of these comments if I'm very confident
that I'll have a PR ready in the next few days. Conversely, no-one
wants to duplicate effort, so it's courteous to indicate that you're
preparing a PR.&lt;/p&gt;
&lt;h2&gt;Pull request and review&lt;/h2&gt;
&lt;p&gt;Since pull requests take time to review, I try to perform at least one
round of self-review before opening a PR. Generally, I won't open a PR
unless I have fairly good test coverage for my work and the tests (and
lint steps) are passing. At a paid position, it's easy to have a
meeting or use slack to discuss a change. Public projects tend to be
more asynchronous, so it's important to read instructions carefully,
write clearly, and address obvious issues on your own.&lt;/p&gt;
&lt;p&gt;When I write a description for my PR, I include a link to the issue it
addresses, usually in the first sentence. If the change adds new types
or functions, I include a summary of that as well. If there are design
details I'm unsure of, I flag these with comments so that the
reviewer(s) can discuss them with me.&lt;/p&gt;
&lt;p&gt;The code review process on a public project can be a little different
from code review inside a company. At some jobs, I've observed an
unspoken rule that PRs need to be more or less correct on the first or
second try, otherwise you'll be considered ineffective. My sense is
that the review process on public projects is much more
iterative. Sometimes it isn't possible to gather all of the necessary
requirements until a first PR is drafted and people have something to
react to. It can take several rounds of revision before all of the
interested parties agree that the design is right.&lt;/p&gt;
&lt;p&gt;This &lt;a href="https://github.com/aantron/dream/pull/62"&gt;PR&lt;/a&gt; for instance,
required several tries to find a flash message implementation that fit
with the philosophy of the project. These situations are an
opportunity to practice discussing (and justifying) your design
decisions with other technical-minded people. I think the key to
success with public reviews is to read reviewer's comments carefully,
make an effort to understand their goals, and then fit your changes to
support those goals.&lt;/p&gt;
&lt;h2&gt;General suggestions&lt;/h2&gt;
&lt;p&gt;If you plan on making OSS contributions long term, I'd suggest having
both a schedule and dedicated hardware for your work. Working after
dinner from 6 to 8 PM weeknights helps me get into a productive
mindset quickly. Time-boxing my work also helps me avoid exhausting my
interest in a project by putting in too many consecutive hours. Using
an inexpensive, second-hand laptop for my public projects makes it
easy for me to suspend my work when I'm done for the night and then
start the next day exactly where I left off, without having to set up
my browser/editor/terminals again.&lt;/p&gt;</content><category term="OSS, Projects"></category></entry><entry><title>Microbenchmarking Implementations of Map in OCaml</title><link href="https://jsthomas.github.io/map-comparison.html" rel="alternate"></link><published>2017-06-06T00:00:00-04:00</published><updated>2017-06-06T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2017-06-06:/map-comparison.html</id><summary type="html">&lt;p&gt;A comparison of different implementations of map in OCaml&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;code&gt;Map&lt;/code&gt; is one of the first higher-order functions I remember
encountering when I learned some rudimentary functional programming
topics as an undergraduate. More recently I began learning OCaml. The
&lt;code&gt;map&lt;/code&gt;
&lt;a href="https://github.com/ocaml/ocaml/blob/2691c40f2ff9bc34912db39bc1f17045c9241473/stdlib/list.ml#L80-L82"&gt;implementation&lt;/a&gt;
I found in the standard library was the textbook definition I was
expecting&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;rec&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;function&lt;/span&gt;
   &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;but I was surprised to learn there are actually several
implementations of &lt;code&gt;map&lt;/code&gt; in the OCaml ecosystem. I wanted to know more
about these different implementations and their performance
characteristics. This article summarizes what I learned.&lt;/p&gt;
&lt;p&gt;Part of my motivation to write this post arose from
&lt;a href="https://github.com/ocsigen/lwt/pull/347"&gt;this discussion&lt;/a&gt; of a pull
request that proposes the default &lt;code&gt;map&lt;/code&gt; implementation in &lt;code&gt;lwt&lt;/code&gt; should
be tail recursive. After reading all of the comments, I wanted to
develop experiments that would convince me whether this was a good
idea.&lt;/p&gt;
&lt;h1&gt;Introduction&lt;/h1&gt;
&lt;p&gt;Since I'll introduce several versions of &lt;code&gt;map&lt;/code&gt;, I'll refer to the
implementation above as &lt;code&gt;stdlib&lt;/code&gt;. An important aspect of this version
is that it isn't &lt;em&gt;tail recursive&lt;/em&gt;. A tail recursive function uses
recursion in a specific way; it only calls itself as the final
operation in the function. In OCaml, tail recursive functions get the
benefit of tail-call optimization so that they only use one frame on
the stack. In contrast, the &lt;code&gt;stdlib&lt;/code&gt; implementation takes space on the
stack proportional to the length of the input list. For long enough
lists, this causes a stack overflow.&lt;/p&gt;
&lt;p&gt;We can make a basic tail-recursive version of &lt;code&gt;map&lt;/code&gt; by composing two
standard library functions that are tail recursive: &lt;code&gt;List.rev_map&lt;/code&gt;
(which creates the output of &lt;code&gt;map&lt;/code&gt;, but in reversed order) and
&lt;code&gt;List.rev&lt;/code&gt; which reverses lists. I'll call this naive implementation
&lt;code&gt;ntr&lt;/code&gt; (naive tail recursive). Compared to &lt;code&gt;stdlib&lt;/code&gt;, &lt;code&gt;ntr&lt;/code&gt; allocates
twice as much space on the heap (one list for the output of
&lt;code&gt;List.rev_map&lt;/code&gt;, and a second equally long list for &lt;code&gt;List.rev&lt;/code&gt;) and
spends additional time performing a list traversal. The benefit is
that with this implementation, calling &lt;code&gt;map&lt;/code&gt; on a long list won't
result in a stack overflow.&lt;/p&gt;
&lt;p&gt;As we'll see later in the Results section, the naive tail recursive
implementation is, overall, slower than the &lt;code&gt;stdlib&lt;/code&gt;
implementation. However, there are some optimizations we can apply to
improve the performance of both versions.&lt;/p&gt;
&lt;p&gt;The first trick I call "unrolling". Similar to
&lt;a href="https://en.wikipedia.org/wiki/Loop_unrolling"&gt;loop unrolling in procedural languages&lt;/a&gt;,
the idea is to use cases to &lt;code&gt;map&lt;/code&gt; on groups of list elements so fewer
function calls are needed to complete the work. For example, an
unrolled version of &lt;code&gt;stdlib&lt;/code&gt; looks like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;rec&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;f1&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;f1&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;x3&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;tl&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f3&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x3&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;f3&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;tl&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We get to choose how many elements to unroll (here I picked 3); some
profiling is needed to decide the most appropriate number.&lt;/p&gt;
&lt;p&gt;The second trick I call "hybridizing". The &lt;code&gt;stdlib&lt;/code&gt; version is faster,
but isn't safe for long lists. The tail recursive implementation is
slow, but safe for all lists. When we "hybridize" the two, we use the
faster version up to some fixed number of elements (e.g. 1000), and
then switch to the safe version for the remainder of the list.&lt;/p&gt;
&lt;p&gt;These two optimizations are useful for understanding the
implementations of &lt;code&gt;map&lt;/code&gt; we find in other libraries. For example, both
&lt;a href="https://github.com/janestreet/base/blob/f10483e957206dc6b656a28ffec667d8b068c149/src/list.ml#L311-L345"&gt;&lt;code&gt;base&lt;/code&gt;&lt;/a&gt;
and
&lt;a href="https://github.com/c-cube/ocaml-containers/blob/d659ba677e3dbd95430f59b3794ac2f2a5677d61/src/core/CCList.ml#L20-L37"&gt;&lt;code&gt;containers&lt;/code&gt;&lt;/a&gt;
use an unrolled &lt;code&gt;stdlib&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt;, hybridized with an
&lt;code&gt;ntr&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Looking at &lt;code&gt;ntr&lt;/code&gt;, one might ask: Is it strictly necessary to use
additional heap space to get the implementation to be tail recursive?
The answer is no. The &lt;code&gt;batteries&lt;/code&gt; package
&lt;a href="https://github.com/ocaml-batteries-team/batteries-included/blob/c10c65a203a7590b15b9a370f66e8c2884817428/src/batList.mlv#L163-L173"&gt;implements &lt;code&gt;map&lt;/code&gt;&lt;/a&gt;
so that the work is done by a single tail recursive function, creating
one new list on the heap. To achieve this, the implementation uses
mutable state and casting to avoid a second list traversal
(specifically,
&lt;a href="https://github.com/ocaml-batteries-team/batteries-included/blob/c10c65a203a7590b15b9a370f66e8c2884817428/src/batList.mlv#L69"&gt;here&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;As with any optimization, one makes tradeoffs between elegance,
performance, and the language features one considers acceptable to
use. I wanted to know:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Which version is the fastest in practice?&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;How much speed does one lose using the safer tail recursive version?&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Both &lt;code&gt;base&lt;/code&gt; and &lt;code&gt;containers&lt;/code&gt; decided to hybridize with an &lt;code&gt;ntr&lt;/code&gt;-style
&lt;code&gt;map&lt;/code&gt; for safety. But the &lt;code&gt;batteries&lt;/code&gt; implementation is also robust to
stack overflow. That led to one final question:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;How fast is an unrolled &lt;code&gt;stdlib&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt; hybridized with a
  &lt;code&gt;batteries&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt;?&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Experimental Setup&lt;/h1&gt;
&lt;p&gt;In 2014, Jane Street introduced a
&lt;a href="https://github.com/janestreet/core_bench"&gt;library&lt;/a&gt; for
microbenchmarking called &lt;code&gt;core_bench&lt;/code&gt;. As they explain
&lt;a href="https://blogs.janestreet.com/core_bench-micro-benchmarking-for-ocaml/"&gt;on their blog&lt;/a&gt;,
&lt;code&gt;core_bench&lt;/code&gt; is intended to measure the performance of small pieces of
OCaml code. This library helps developers to better understand the
cost of individual operations, like &lt;code&gt;map&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;There are a couple benefits to measuring &lt;code&gt;map&lt;/code&gt; implementations with
&lt;code&gt;core_bench&lt;/code&gt;.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The library makes it easy to track both time and use of the heap.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Once you specify your test, &lt;code&gt;core_bench&lt;/code&gt; automatically provides
   many &lt;a href="https://github.com/janestreet/core_bench/wiki/Getting-Started-with-Core_bench"&gt;command line
   options&lt;/a&gt;
   to help you present your test data in different ways.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The library uses statistical techniques (bootstrapping and linear
   regression) to reduce many runs worth of data to a small number of
   meaningful performance metrics that account for the amortized cost
   of garbage collection and error introduced by system activity.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I wrote
&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/maptest.ml"&gt;this program&lt;/a&gt;
to compare performance between the six implementations I described
above. The program includes the batteries-hybrid I described above,
which I'll refer to as &lt;code&gt;batt-hybr&lt;/code&gt;. Other test details:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I tested each algorithm against lists of lengths &lt;span class="math"&gt;\(N=10^2, 10^3,
  10^4\)&lt;/span&gt; and &lt;span class="math"&gt;\(10^5\)&lt;/span&gt;. On my system, &lt;span class="math"&gt;\(N=10^5\)&lt;/span&gt; was the highest power of 10
  for which the &lt;code&gt;stdlib&lt;/code&gt; implementation did not fail due to a stack
  overflow.&lt;/li&gt;
&lt;li&gt;Each list consisted of integer elements (all 0), and the function
  mapped onto the list simply added one to each element.&lt;/li&gt;
&lt;li&gt;I ran these tests on a Lenovo X220, Intel Core i5-2520M CPU (2.50GHz Ã
  4 cores), with 4GB RAM.&lt;/li&gt;
&lt;li&gt;I used the OCaml 4.03.0 compiler, and compiled to native code
  without using &lt;code&gt;flambda&lt;/code&gt;. (&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/makefile"&gt;This
  makefile&lt;/a&gt;
  gives the full specifications.)&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Results&lt;/h1&gt;
&lt;p&gt;For each list size, &lt;code&gt;core_bench&lt;/code&gt; produces a table with several metrics besides time:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;mWd&lt;/code&gt; : Words allocated on the minor heap.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;mjWd&lt;/code&gt; : Words allocated on the major heap.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Prom&lt;/code&gt; : Words promoted from minor to major heap.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The library also allows us to produce 95% confidence intervals and
&lt;span class="math"&gt;\(R^2\)&lt;/span&gt; values for the time estimates.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 100&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;ââââââââââââââ¬âââââââââââ¬âââââââââââ¬ââââââââââââââââ¬ââââââââââ¬âââââââââââ¬âââââââââââ¬âââââââââââââ&lt;/span&gt;
&lt;span class="err"&gt;â Name       â Time R^2 â Time/Run â          95ci â mWd/Run â mjWd/Run â Prom/Run â Percentage â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ¼âââââââââââ¼âââââââââââ¼ââââââââââââââââ¼ââââââââââ¼âââââââââââ¼âââââââââââ¼âââââââââââââ¤&lt;/span&gt;
&lt;span class="err"&gt;â ntr        â     1.00 â 741.20ns â -0.23% +0.22% â 609.01w â    0.53w â    0.53w â    100.00% â&lt;/span&gt;
&lt;span class="err"&gt;â containers â     1.00 â 439.55ns â -0.64% +0.67% â 304.03w â    0.17w â    0.17w â     59.30% â&lt;/span&gt;
&lt;span class="err"&gt;â batteries  â     1.00 â 581.65ns â -0.14% +0.16% â 309.01w â    0.35w â    0.35w â     78.47% â&lt;/span&gt;
&lt;span class="err"&gt;â base       â     1.00 â 438.63ns â -0.19% +0.20% â 304.03w â    0.16w â    0.16w â     59.18% â&lt;/span&gt;
&lt;span class="err"&gt;â stdlib     â     1.00 â 610.45ns â -0.10% +0.11% â 304.01w â    0.17w â    0.17w â     82.36% â&lt;/span&gt;
&lt;span class="err"&gt;â batt-hybr  â     1.00 â 426.76ns â -0.15% +0.17% â 304.03w â    0.17w â    0.17w â     57.58% â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ´âââââââââââ´âââââââââââ´ââââââââââââââââ´ââââââââââ´âââââââââââ´âââââââââââ´âââââââââââââ&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 1000&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;ââââââââââââââ¬âââââââââââ¬âââââââââââ¬ââââââââââââââââ¬ââââââââââ¬âââââââââââ¬âââââââââââ¬âââââââââââââ&lt;/span&gt;
&lt;span class="err"&gt;â Name       â Time R^2 â Time/Run â          95ci â mWd/Run â mjWd/Run â Prom/Run â Percentage â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ¼âââââââââââ¼âââââââââââ¼ââââââââââââââââ¼ââââââââââ¼âââââââââââ¼âââââââââââ¼âââââââââââââ¤&lt;/span&gt;
&lt;span class="err"&gt;â ntr        â     1.00 â   8.84us â -0.14% +0.15% â  6.01kw â   52.08w â   52.08w â    100.00% â&lt;/span&gt;
&lt;span class="err"&gt;â containers â     1.00 â   5.07us â -0.13% +0.15% â  3.00kw â   17.23w â   17.23w â     57.34% â&lt;/span&gt;
&lt;span class="err"&gt;â batteries  â     1.00 â   6.57us â -0.14% +0.14% â  3.01kw â   34.71w â   34.71w â     74.32% â&lt;/span&gt;
&lt;span class="err"&gt;â base       â     1.00 â   4.99us â -0.20% +0.24% â  3.00kw â   17.08w â   17.08w â     56.44% â&lt;/span&gt;
&lt;span class="err"&gt;â stdlib     â     1.00 â   6.84us â -0.10% +0.10% â  3.00kw â   17.22w â   17.22w â     77.34% â&lt;/span&gt;
&lt;span class="err"&gt;â batt-hybr  â     1.00 â   4.96us â -0.13% +0.13% â  3.00kw â   17.07w â   17.07w â     56.10% â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ´âââââââââââ´âââââââââââ´ââââââââââââââââ´ââââââââââ´âââââââââââ´âââââââââââ´âââââââââââââ&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 10,000&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;ââââââââââââââ¬âââââââââââ¬âââââââââââ¬ââââââââââââââââ¬ââââââââââ¬âââââââââââ¬âââââââââââ¬âââââââââââââ&lt;/span&gt;
&lt;span class="err"&gt;â Name       â Time R^2 â Time/Run â          95ci â mWd/Run â mjWd/Run â Prom/Run â Percentage â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ¼âââââââââââ¼âââââââââââ¼ââââââââââââââââ¼ââââââââââ¼âââââââââââ¼âââââââââââ¼âââââââââââââ¤&lt;/span&gt;
&lt;span class="err"&gt;â ntr        â     0.99 â 203.11us â -0.45% +0.53% â 60.01kw â   5.40kw â   5.40kw â    100.00% â&lt;/span&gt;
&lt;span class="err"&gt;â containers â     1.00 â 144.95us â -0.50% +0.60% â 48.01kw â   3.04kw â   3.04kw â     71.37% â&lt;/span&gt;
&lt;span class="err"&gt;â batteries  â     1.00 â 136.87us â -0.51% +0.63% â 30.01kw â   3.64kw â   3.64kw â     67.39% â&lt;/span&gt;
&lt;span class="err"&gt;â base       â     1.00 â 130.85us â -0.34% +0.39% â 44.98kw â   2.66kw â   2.66kw â     64.42% â&lt;/span&gt;
&lt;span class="err"&gt;â stdlib     â     1.00 â 118.70us â -0.30% +0.29% â 30.00kw â   1.80kw â   1.80kw â     58.44% â&lt;/span&gt;
&lt;span class="err"&gt;â batt-hybr  â     1.00 â 106.91us â -0.42% +0.52% â 30.01kw â   2.22kw â   2.22kw â     52.64% â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ´âââââââââââ´âââââââââââ´ââââââââââââââââ´ââââââââââ´âââââââââââ´âââââââââââ´âââââââââââââ&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 100,000&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;ââââââââââââââ¬âââââââââââ¬âââââââââââ¬ââââââââââââââââ¬âââââââââââ¬âââââââââââ¬âââââââââââ¬âââââââââââââ&lt;/span&gt;
&lt;span class="err"&gt;â Name       â Time R^2 â Time/Run â          95ci â  mWd/Run â mjWd/Run â Prom/Run â Percentage â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ¼âââââââââââ¼âââââââââââ¼ââââââââââââââââ¼âââââââââââ¼âââââââââââ¼âââââââââââ¼âââââââââââââ¤&lt;/span&gt;
&lt;span class="err"&gt;â ntr        â     0.98 â  10.27ms â -2.39% +2.32% â 600.02kw â 411.83kw â 411.83kw â     94.33% â&lt;/span&gt;
&lt;span class="err"&gt;â containers â     0.99 â  10.62ms â -2.19% +1.83% â 588.02kw â 404.91kw â 404.91kw â     97.61% â&lt;/span&gt;
&lt;span class="err"&gt;â batteries  â     1.00 â   7.19ms â -0.78% +0.79% â 300.02kw â 300.35kw â 300.35kw â     66.02% â&lt;/span&gt;
&lt;span class="err"&gt;â base       â     0.99 â  10.88ms â -1.54% +1.41% â 584.99kw â 397.60kw â 397.60kw â    100.00% â&lt;/span&gt;
&lt;span class="err"&gt;â stdlib     â     0.99 â   6.33ms â -1.08% +1.07% â 300.01kw â 171.73kw â 171.73kw â     58.18% â&lt;/span&gt;
&lt;span class="err"&gt;â batt-hybr  â     0.93 â   6.09ms â -4.30% +4.63% â 300.02kw â 285.46kw â 285.46kw â     55.93% â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ´âââââââââââ´âââââââââââ´ââââââââââââââââ´âââââââââââ´âââââââââââ´âââââââââââ´âââââââââââââ&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;A few things I noticed about the data:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The tail recursive implementation is slow, but not always the
  slowest. In the &lt;span class="math"&gt;\(N=10^5\)&lt;/span&gt; case, &lt;code&gt;ntr&lt;/code&gt;,&lt;code&gt;base&lt;/code&gt;, and &lt;code&gt;containers&lt;/code&gt; show
  similar performance; this makes sense given they have the same
  behavior after a prefix of the list.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;For short lists, &lt;code&gt;base&lt;/code&gt;, &lt;code&gt;containers&lt;/code&gt;, and &lt;code&gt;batt-hybr&lt;/code&gt; are fastest,
  likely because of unrolling.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We can see from the &lt;code&gt;mWd&lt;/code&gt; and &lt;code&gt;mjWd&lt;/code&gt; columns that &lt;code&gt;ntr&lt;/code&gt; uses the
  most heap space, as we would expect.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;As we increase the size of the list, &lt;code&gt;stdlib&lt;/code&gt; gets faster relative
  to &lt;code&gt;ntr&lt;/code&gt;; I suspect this can be attributed to the cost of garbage
  collection.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Overall, &lt;code&gt;batt-hybr&lt;/code&gt; appears to have the best performance (though in
  the &lt;span class="math"&gt;\(N=10^5\)&lt;/span&gt; case, the confidence interval is large enough that we
  can't conclude &lt;code&gt;batt-hybr&lt;/code&gt; is faster than &lt;code&gt;stdlib&lt;/code&gt;, and the &lt;span class="math"&gt;\(R^2\)&lt;/span&gt;
  value is a bit low).&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Conclusions&lt;/h1&gt;
&lt;p&gt;The data above suggest three main findings:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The stack-based standard library implementation of &lt;code&gt;map&lt;/code&gt; is faster
   than the naive tail recursive implementation, taking about 60-80%
   of the time to do the same work depending on the size of the list.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;There are clear benefits to both unrolling and
   hybridizing. Hybridizing lets us take an implementation that
   performs well on long lists (&lt;code&gt;batteries&lt;/code&gt;), and make it even better
   by combining it with one that's fast on short lists, to produce
   &lt;code&gt;batt-hybr&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Overall, the data show we don't have to give up safety (resistance
   to stack overflow) to get better performance. A tail recursive
   implementation can be quite competitive, albeit more complex.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h1&gt;Discussion&lt;/h1&gt;
&lt;p&gt;A follow up question to this analysis, in the context of the
discussion of &lt;code&gt;Lwt_list.map_p&lt;/code&gt; is: "How significant is the cost of
&lt;code&gt;map&lt;/code&gt; compared to other operations?" To partially address this, I
wrote
&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/bufftest.ml"&gt;another program&lt;/a&gt;
that measures how long it takes to write 4096 bytes to a Unix pipe
using &lt;code&gt;Lwt_unix.write&lt;/code&gt;, and then read it back using &lt;code&gt;Lwt_unix.read&lt;/code&gt;. Using
&lt;code&gt;core_bench&lt;/code&gt;, I found:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Unix Pipe Read/Write Benchmark&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;âââââââââââ¬âââââââââââ¬ââââââââââââââââ¬ââââââââââ¬âââââââââââââ&lt;/span&gt;
&lt;span class="err"&gt;âTime R^2 â Time/Run â          95ci â mWd/Run â Percentage â&lt;/span&gt;
&lt;span class="err"&gt;âââââââââââ¼âââââââââââ¼ââââââââââââââââ¼ââââââââââ¼âââââââââââââ¤&lt;/span&gt;
&lt;span class="err"&gt;â    1.00 â 893.33ns â -0.16% +0.18% â  56.00w â    100.00% â&lt;/span&gt;
&lt;span class="err"&gt;âââââââââââ´âââââââââââ´ââââââââââââââââ´ââââââââââ´âââââââââââââ&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It seems reasonable to estimate that &lt;code&gt;Lwt_list.map_p&lt;/code&gt; would primarily
be applied to IO operations like the ones in this experiment. In that
case, the data suggest the cost per element of applying the slowest
&lt;code&gt;map&lt;/code&gt; implementation (&lt;code&gt;ntr&lt;/code&gt;) is about 0.82% of the cost of one 4KB
read/write operation on a unix pipe. In the context of &lt;code&gt;Lwt&lt;/code&gt;, it seems
reasonable to conclude the implementation of &lt;code&gt;map&lt;/code&gt; isn't a significant
concern; the real cost is performing IO. In light of that, it seems
preferable to use an implementation that cannot cause a stack
overflow.&lt;/p&gt;
&lt;p&gt;A second question that might be asked about this analysis is: "Was it
necessary to introduce the added complexity of &lt;code&gt;core_bench&lt;/code&gt; to measure
the performance of &lt;code&gt;map&lt;/code&gt;?" For example, one might set up a performance
test with just successive calls to &lt;code&gt;Time.now&lt;/code&gt; or
&lt;code&gt;Unix.gettimeofday&lt;/code&gt;. In an earlier draft of this article, I tried such
an
&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/profile.ml"&gt;approach&lt;/a&gt;,
producing some misleading data. In that test, I did a full garbage
collection in between runs (applications of &lt;code&gt;map&lt;/code&gt;), which suppressed
that (nontrivial) cost and made the tail recursive implementation
appear quite fast. &lt;code&gt;core_bench&lt;/code&gt; does a much better job incorporating
the cost of garbage collection by varying the number of test runs
performed in a row and then establishing a trend (with linear
regression) that reflects the amortized cost of garbage collection per
run.&lt;/p&gt;
&lt;p&gt;One interesting finding did arise from my earlier tests: for short
lists, allocating memory on the heap actually appears to be faster
than creating frames on the stack. Since the tests perform a full
garbage collection between test runs, the timings show only the cost
of allocating space on the heap. This produced data like the
following:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary Statistics, &lt;span class="math"&gt;\(N=10^3\)&lt;/span&gt; Garbage Collected Map Benchmark Times (Î¼s)&lt;/strong&gt;&lt;/p&gt;
&lt;table class="dataframe"&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;Std. Lib.&lt;/th&gt;
&lt;th&gt;NTR&lt;/th&gt;
&lt;th&gt;Base&lt;/th&gt;
&lt;th&gt;Batteries&lt;/th&gt;
&lt;th&gt;Containers&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;th&gt;Mean&lt;/th&gt;
&lt;td&gt;27.18&lt;/td&gt;
&lt;td&gt;27.21&lt;/td&gt;
&lt;td&gt;11.23&lt;/td&gt;
&lt;td&gt;19.03&lt;/td&gt;
&lt;td&gt;13.06&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Min&lt;/th&gt;
&lt;td&gt;15.97&lt;/td&gt;
&lt;td&gt;14.07&lt;/td&gt;
&lt;td&gt;6.91&lt;/td&gt;
&lt;td&gt;9.06&lt;/td&gt;
&lt;td&gt;7.87&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;25%&lt;/th&gt;
&lt;td&gt;18.84&lt;/td&gt;
&lt;td&gt;17.88&lt;/td&gt;
&lt;td&gt;7.15&lt;/td&gt;
&lt;td&gt;10.97&lt;/td&gt;
&lt;td&gt;10.01&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;50%&lt;/th&gt;
&lt;td&gt;20.03&lt;/td&gt;
&lt;td&gt;19.07&lt;/td&gt;
&lt;td&gt;8.11&lt;/td&gt;
&lt;td&gt;15.50&lt;/td&gt;
&lt;td&gt;10.01&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;75%&lt;/th&gt;
&lt;td&gt;23.13&lt;/td&gt;
&lt;td&gt;22.17&lt;/td&gt;
&lt;td&gt;12.87&lt;/td&gt;
&lt;td&gt;18.84&lt;/td&gt;
&lt;td&gt;10.97&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Max&lt;/th&gt;
&lt;td&gt;849.01&lt;/td&gt;
&lt;td&gt;576.02&lt;/td&gt;
&lt;td&gt;379.80&lt;/td&gt;
&lt;td&gt;622.03&lt;/td&gt;
&lt;td&gt;434.88&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;Summary Statistics, &lt;span class="math"&gt;\(N=10^4\)&lt;/span&gt; Garbage Collected Map Benchmark Times (Î¼s)&lt;/strong&gt;&lt;/p&gt;
&lt;table class="dataframe"&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;Std. Lib.&lt;/th&gt;
&lt;th&gt;NTR&lt;/th&gt;
&lt;th&gt;Base&lt;/th&gt;
&lt;th&gt;Batteries&lt;/th&gt;
&lt;th&gt;Containers&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;th&gt;Mean&lt;/th&gt;
&lt;td&gt;230.23&lt;/td&gt;
&lt;td&gt;216.60&lt;/td&gt;
&lt;td&gt;141.39&lt;/td&gt;
&lt;td&gt;144.59&lt;/td&gt;
&lt;td&gt;161.56&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Min&lt;/th&gt;
&lt;td&gt;77.01&lt;/td&gt;
&lt;td&gt;73.91&lt;/td&gt;
&lt;td&gt;61.04&lt;/td&gt;
&lt;td&gt;54.84&lt;/td&gt;
&lt;td&gt;63.18&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;25%&lt;/th&gt;
&lt;td&gt;97.04&lt;/td&gt;
&lt;td&gt;86.07&lt;/td&gt;
&lt;td&gt;67.95&lt;/td&gt;
&lt;td&gt;58.89&lt;/td&gt;
&lt;td&gt;70.81&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;50%&lt;/th&gt;
&lt;td&gt;121.95&lt;/td&gt;
&lt;td&gt;99.90&lt;/td&gt;
&lt;td&gt;75.10&lt;/td&gt;
&lt;td&gt;61.99&lt;/td&gt;
&lt;td&gt;77.01&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;75%&lt;/th&gt;
&lt;td&gt;193.83&lt;/td&gt;
&lt;td&gt;284.91&lt;/td&gt;
&lt;td&gt;148.59&lt;/td&gt;
&lt;td&gt;118.26&lt;/td&gt;
&lt;td&gt;175.24&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Max&lt;/th&gt;
&lt;td&gt;12719.87&lt;/td&gt;
&lt;td&gt;2753.97&lt;/td&gt;
&lt;td&gt;2960.21&lt;/td&gt;
&lt;td&gt;3616.09&lt;/td&gt;
&lt;td&gt;13603.93&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;When we ignore the time spent on garbage collection, we see that &lt;code&gt;ntr&lt;/code&gt;
is surprisingly competitive, especially in comparison with &lt;code&gt;stdlib&lt;/code&gt;;
the difference between the two implementations, of course, is that
&lt;code&gt;ntr&lt;/code&gt; allocates more memory on the heap while &lt;code&gt;stdlib&lt;/code&gt; creates more
stack frames.&lt;/p&gt;
&lt;h2&gt;Notes&lt;/h2&gt;
&lt;p&gt;Thanks to &lt;a href="https://github.com/aantron"&gt;Anton Bachin&lt;/a&gt; and
&lt;a href="https://github.com/c-cube/"&gt;Simon Cruanes&lt;/a&gt; for reading drafts of this
post.&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="OCaml"></category></entry><entry><title>Refactoring Python Code</title><link href="https://jsthomas.github.io/mgptree-refactor.html" rel="alternate"></link><published>2017-05-01T00:00:00-04:00</published><updated>2017-05-01T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2017-05-01:/mgptree-refactor.html</id><summary type="html">&lt;p&gt;Refactoring some python code from many years ago.&lt;/p&gt;</summary><content type="html">&lt;p&gt;Recently, a friend from grad-school asked me about an
&lt;a href="https://github.com/jsthomas/mgptree"&gt;experimental python data visualization tool&lt;/a&gt;
I wrote in 2012. Since the code had rotted (to the point that it no
longer worked), and my understanding of python has changed quite a bit
since I originally wrote it, I thought this would be a good
opportunity to write about my current processes for debugging and refactoring.&lt;/p&gt;
&lt;h2&gt;What's this supposed to do again?&lt;/h2&gt;
&lt;p&gt;The premise of the program is pretty simple:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The
   &lt;a href="https://www.genealogy.math.ndsu.nodak.edu/"&gt;Mathematics Genealogy Project (MGP)&lt;/a&gt;
   lets us search for advisor-advisee relationships between names.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We want to take a list of names &lt;span class="math"&gt;\(L\)&lt;/span&gt; and an integer &lt;span class="math"&gt;\(n\)&lt;/span&gt;, and look up
   &lt;span class="math"&gt;\(n\)&lt;/span&gt; generations of mathematicians, starting from &lt;span class="math"&gt;\(L\)&lt;/span&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Then, we want to render the digraph of advisee-advisor
   relationships using the &lt;a href="http://graphviz.org/"&gt;&lt;code&gt;graphviz&lt;/code&gt;&lt;/a&gt; program
   &lt;code&gt;dot&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Looking at this code it's surprising some of the things I did and
didn't know:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Prior to 2014, I wasn't in the habit of using virtual environments
   and &lt;code&gt;pip&lt;/code&gt;. For this project, that's not really a big deal because
   there aren't a lot of dependencies.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I wasn't aware of &lt;code&gt;pylint&lt;/code&gt;. Today, I find that &lt;code&gt;pylint&lt;/code&gt; makes it a
   lot easier to write clean python and refactor existing code.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Some things that haven't changed:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;I still think graphviz is really great. It makes plotting directed
   graphs &lt;em&gt;so&lt;/em&gt; easy, and it's easy to decorate them with a lot of
   metadata.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;argparse&lt;/code&gt; makes it easy to write a command line interface that
   works just like other familiar unix tools. I especially like that
   adds &lt;code&gt;-h&lt;/code&gt; options for displaying help, which are invaluable when
   building a more extensive CLI tool.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Phase 1: Cleaning up lint issues.&lt;/h2&gt;
&lt;p&gt;Whenever I'm starting on unfamiliar python code, I like to begin with
&lt;code&gt;pylint&lt;/code&gt;'s suggestions.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="o"&gt;```&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;384&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Invalid&lt;/span&gt; &lt;span class="k"&gt;method&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="ss"&gt;"extractPersonalData"&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;invalid&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;384&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Missing&lt;/span&gt; &lt;span class="k"&gt;method&lt;/span&gt; &lt;span class="n"&gt;docstring&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;missing&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;docstring&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;391&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;11&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="k"&gt;Do&lt;/span&gt; &lt;span class="k"&gt;not&lt;/span&gt; &lt;span class="n"&gt;use&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SEQUENCE&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;condition&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;as&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;condition&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;395&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;11&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="k"&gt;Do&lt;/span&gt; &lt;span class="k"&gt;not&lt;/span&gt; &lt;span class="n"&gt;use&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SEQUENCE&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;condition&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;as&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;condition&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;399&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;11&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="k"&gt;Do&lt;/span&gt; &lt;span class="k"&gt;not&lt;/span&gt; &lt;span class="n"&gt;use&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SEQUENCE&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;condition&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;as&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;condition&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;402&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Missing&lt;/span&gt; &lt;span class="k"&gt;method&lt;/span&gt; &lt;span class="n"&gt;docstring&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;missing&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;docstring&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;405&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Missing&lt;/span&gt; &lt;span class="k"&gt;method&lt;/span&gt; &lt;span class="n"&gt;docstring&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;missing&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;docstring&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;408&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Unused&lt;/span&gt; &lt;span class="k"&gt;variable&lt;/span&gt; &lt;span class="s1"&gt;'name'&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;unused&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;variable&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;---------------------------------------------------------------------&lt;/span&gt;
&lt;span class="n"&gt;Your&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="n"&gt;has&lt;/span&gt; &lt;span class="n"&gt;been&lt;/span&gt; &lt;span class="n"&gt;rated&lt;/span&gt; &lt;span class="k"&gt;at&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;83&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;
&lt;span class="o"&gt;```&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Pylint scored my original code -1.83/10. D'oh. It turns out one of the
things I wasn't following in 2012 was PEP8, which means I had a lot of
formatting/whitespace issues. Fixing these, my score rose to
6.94/10.&lt;/p&gt;
&lt;p&gt;One thing that I really like about &lt;code&gt;pylint&lt;/code&gt; is how it dramatically
simplifies finding unused variables in my code. Sometimes, I even use
this to help me refactor more systematically: First I change whatever
lines I planned to simplify, then I let &lt;code&gt;pylint&lt;/code&gt; confirm that I can
get rid of the variables I'd planned to eliminate. It turns out I had
four unused variables in 430 lines of code, all easy to fix.&lt;/p&gt;
&lt;p&gt;Another convention I wasn't following in 2012 is the use of
docstrings. Instead, I was writing big block comments, like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;################################################################################&lt;/span&gt;
&lt;span class="c1"&gt;# Procedure: validate_scrape&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Input: Parser and options objects from optparse&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Output: A list of well-formed name tuples.&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Effects: Checks the options object to confirm the inputs are well formed.&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;################################################################################&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that I work with jupyter and ipython more often, I have a better
appreciation for docstrings. It's really helpful to be able to do
&lt;code&gt;function_i_dont_remember ?&lt;/code&gt; at a REPL and immediately pull up
documentation without context switching.&lt;/p&gt;
&lt;h2&gt;Phase 2: Cleaning up the output.&lt;/h2&gt;
&lt;p&gt;After fixing documentation, the next issue I wanted to improve was the
script's lack of logging. For some reason, I'd thought it would be a
good idea to send everything directly to &lt;code&gt;stdout&lt;/code&gt; or &lt;code&gt;stderr&lt;/code&gt;. I even
added a &lt;code&gt;verbose&lt;/code&gt; command line flag, and then introduced conditionals
in my code, like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;OPTIONS&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;verbose_on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Searching MGP for &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;, &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;, &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;.&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;last&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;first&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;middle&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To simplify this, I introduced the &lt;code&gt;logging&lt;/code&gt; package with a simple
configuration:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;logging&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basicConfig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;level&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;logging&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                    &lt;span class="nb"&gt;format&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;&lt;span class="si"&gt;%(asctime)s&lt;/span&gt;&lt;span class="s1"&gt; &lt;/span&gt;&lt;span class="si"&gt;%(message)s&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                    &lt;span class="n"&gt;datefmt&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'%m/&lt;/span&gt;&lt;span class="si"&gt;%d&lt;/span&gt;&lt;span class="s1"&gt;/%Y %I:%M:%S %p'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;which let me write logs at several different levels whose visibility
can be adjusted in the configuration.&lt;/p&gt;
&lt;h2&gt;Phase 3: Fixing bugs.&lt;/h2&gt;
&lt;p&gt;At this point, I'd resolved most of the obvious issues I wanted to
fix, and narrowed down &lt;code&gt;pylint&lt;/code&gt;'s suggestions to four issues, two of
which were TODOs I'd notice while addressing other issues:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="o"&gt;*************&lt;/span&gt; &lt;span class="n"&gt;Module&lt;/span&gt; &lt;span class="n"&gt;mgptree&lt;/span&gt;
&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;58&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Refactor&lt;/span&gt; &lt;span class="k"&gt;options&lt;/span&gt; &lt;span class="k"&gt;to&lt;/span&gt; &lt;span class="n"&gt;be&lt;/span&gt; &lt;span class="n"&gt;either&lt;/span&gt; &lt;span class="n"&gt;completely&lt;/span&gt; &lt;span class="k"&gt;global&lt;/span&gt; &lt;span class="k"&gt;or&lt;/span&gt; &lt;span class="k"&gt;not&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fixme&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;158&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Consider&lt;/span&gt; &lt;span class="n"&gt;refactor&lt;/span&gt; &lt;span class="n"&gt;here&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fixme&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;36&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="k"&gt;Using&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="k"&gt;global&lt;/span&gt; &lt;span class="k"&gt;statement&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;global&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;statement&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;R&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;208&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Too&lt;/span&gt; &lt;span class="n"&gt;many&lt;/span&gt; &lt;span class="n"&gt;instance&lt;/span&gt; &lt;span class="n"&gt;attributes&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;7&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;too&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;many&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;attributes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;--------------------------------------------------------------------&lt;/span&gt;
&lt;span class="n"&gt;Your&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="n"&gt;has&lt;/span&gt; &lt;span class="n"&gt;been&lt;/span&gt; &lt;span class="n"&gt;rated&lt;/span&gt; &lt;span class="k"&gt;at&lt;/span&gt; &lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;77&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Fixing the whitespace/formatting issues turned out to be a good way to
re-familiarize myself with the code before attempting to fix the
functional issues.&lt;/p&gt;
&lt;p&gt;After running &lt;code&gt;mgptree&lt;/code&gt; on a couple simple examples and looking at the
logs, I realized that the main functional issue was in the function
&lt;code&gt;fetch_id_num&lt;/code&gt;. This function is supposed to take a tuple of names
(first, middle, and last) and determine the ID number of the
mathematician with that name in the MGP service (if the lookup fails
or returns multiple answers, we return &lt;code&gt;None&lt;/code&gt;). The function is
supposed to do this by using &lt;code&gt;requests&lt;/code&gt; to make a POST to the URL
associated with the PHP script that handles users' searches on the MGP
site, and then scraping the resulting reply.&lt;/p&gt;
&lt;p&gt;Looking at the MGP website, it didn't appear to be very different from
what I remembered seeing in 2012, so I was puzzled why my scraping
code had stopped working. After running my function a few times in an
&lt;code&gt;ipython&lt;/code&gt; shell, I realized my main error was my URL. Like a lot of
websites, the math genealogy has moved to HTTPS since 2012. Fixing
that and one other formatting change in the pages' &lt;code&gt;&amp;lt;title&amp;gt;&lt;/code&gt; section
and my scraping code was working properly again.&lt;/p&gt;
&lt;h2&gt;Wrapping Up&lt;/h2&gt;
&lt;p&gt;Overall, the improvements I made to my script were pretty trivial,
but they illustrate some practices that I think are really helpful for
increasing one's personal productivity:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;em&gt;Restoring an Invariant&lt;/em&gt;: When I don't know what to do next (or
   where to start), I find &lt;code&gt;pylint&lt;/code&gt; and &lt;code&gt;nosetests&lt;/code&gt; are great
   guides. Both tools specify an invariant (no lint errors above a
   certain level, all unit tests passing, etc.) that should be
   maintained whenever code gets committed. If the invariant isn't
   satisfied, the next steps are clear: Investigate why, and fix it.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;em&gt;One Thing a Time:&lt;/em&gt; Even though my changes were simple, I made a
   total of 8 commits to get my code back in working order. Each one
   focusses on a single issue I wanted to improve in the code
   (i.e. remove all whitespace lint errors). I find it can be really
   easy to start "improving" two or three issues at the same time, and
   then do a poor job on all of them (or get stuck). For me, following
   the rule of one issue per commit has been a great way to stay
   organized and break larger problems into manageable pieces.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I can see a couple of areas I might want to improve in the future. It
would be nice to to store scraped data in an &lt;code&gt;sqlite&lt;/code&gt; database, which
might simplify computing other graph-based presentations of the
dataset (for example, finding all of the students descended from a
particular mathematician). It might also be cool to convert this to a
django or flask app, so that people unfamiliar with the command line
can generate their own graphs.&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="Python, Projects, Refactoring"></category></entry><entry><title>A Mathematics Geneaology Project Visualizer</title><link href="https://jsthomas.github.io/math-genealogy-visualizer.html" rel="alternate"></link><published>2014-04-02T00:00:00-04:00</published><updated>2014-04-02T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2014-04-02:/math-genealogy-visualizer.html</id><summary type="html">&lt;p&gt;A program to visualize data from the Mathematics Geneaology Project&lt;/p&gt;</summary><content type="html">&lt;p&gt;The
&lt;a href="http://genealogy.math.ndsu.nodak.edu/"&gt;Mathematics Geneaology Project&lt;/a&gt;
(MGP) is a publicly searchable database that records advisor-advisee
relations between mathematicians. Their website is interesting,
particularly if you're interested in the history of
mathematics. Unfortunately, their website is also mostly text-based;
there isn't a way to visualize the relationships between large groups
of people.&lt;/p&gt;
&lt;p&gt;I've created a tool that produces a directed graph displaying the
advisor-advisee relations stored in the MGP database. I created this
tool in 2012 in order to learn about how to process data from the web
using python.&lt;/p&gt;
&lt;h2&gt;Example Output&lt;/h2&gt;
&lt;p&gt;After reading the steps below, you should be able to produce a picture
like the one below.&lt;/p&gt;
&lt;p&gt;&lt;img alt="A genealogical tree" src="https://jsthomas.github.io/images/mgptree/gauss.png" style="width: 764px; height: auto;"/&gt;&lt;/p&gt;
&lt;p&gt;Naturally, the real purpose of the tool is to make much bigger graphs
than this!&lt;/p&gt;
&lt;h2&gt;Download&lt;/h2&gt;
&lt;p&gt;You will need the following:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;A copy of my python script which you can &lt;a href="https://github.com/jsthomas/mgptree"&gt;download here&lt;/a&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;An installation of &lt;a href="http://www.graphviz.org/"&gt;graphviz&lt;/a&gt; (this
program takes care of the actual graph drawing).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Basic knowledge of the command line.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;On an Ubuntu machine, these dependencies (&lt;code&gt;graphviz&lt;/code&gt; and &lt;code&gt;requests&lt;/code&gt;)
can be installed via:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ sudo apt install virtualenv graphviz
$ virtualenv venv
$ venv/bin/activate
&lt;span class="o"&gt;(&lt;/span&gt;venv&lt;span class="o"&gt;)&lt;/span&gt; $ pip install requirements.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Usage Example&lt;/h2&gt;
&lt;p&gt;The easiest way to learn how to use this tool is by way of an
example. Place the &lt;code&gt;mgptree&lt;/code&gt; script in a convenient folder (the
program generates a number of files). Change the permissions on the
script so that you can execute it.&lt;/p&gt;
&lt;p&gt;Let's say we want to generate a tree for GauÃ and Fourier, going back
5 generations. The first step is to prepare a file of names for our
search:&lt;/p&gt;
&lt;p&gt;So, we create a unicode text file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;GauÃ, Carl, Friedrich&lt;/span&gt;
&lt;span class="err"&gt;Fourier, Jean-Baptiste, Joseph&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I'll call the file &lt;code&gt;gf.txt&lt;/code&gt;. Now we need to get some data from the
web. We do this as follows:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;(venv) $ python mgptree.py -g 5 -s -i gf.txt -o gf.mgp&lt;/span&gt;
&lt;span class="err"&gt;Saved 25 records to file gf.mgp.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;code&gt;-s&lt;/code&gt; option indicates we want to "scrape" data from the MGP
website. The &lt;code&gt;-g&lt;/code&gt; option indicates how many generations backward we
want to search. The &lt;code&gt;-i&lt;/code&gt; denotes our input file, the &lt;code&gt;-o gf.mgp&lt;/code&gt;
indicates that we want to save our results in a database named
&lt;code&gt;gf.mgp&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Now we need to graph the data, so we type the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;(venv) $ python mgptree.py -p -i gf.mgp -o gf.dot&lt;/span&gt;
&lt;span class="err"&gt;(venv) $ dot -Tpng gf.dot -o gf.png&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In the first line, the &lt;code&gt;-p&lt;/code&gt; indicates we are now in "plotting mode"
where we want to convert the input database &lt;code&gt;gf.mgp&lt;/code&gt; to a textual
format, which we'll save as &lt;code&gt;gf.dot&lt;/code&gt;. The next line hands the textual
data to the graphviz program &lt;code&gt;dot&lt;/code&gt;, which converts it to a PNG image
file named &lt;code&gt;gf.png&lt;/code&gt;. (Many other file formats are available.)&lt;/p&gt;
&lt;p&gt;&lt;img alt="Genealogical trees of Gauss and Fourier" src="https://jsthomas.github.io/images/mgptree/gf.png" style="width: 1915px; height: auto;"/&gt;&lt;/p&gt;
&lt;p&gt;Creating the intermediate database &lt;code&gt;gf.mgp&lt;/code&gt; allows us to work with the
data offline, without having to query the web while we are figuring
out how we want to plot the data.  For example, suppose we only want
to present two generations of the data we just downloaded. Then we'd
type&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;(venv) $ python mgptree.py -p -g2 -i gf.mgp -o gf_tiny.dot&lt;/span&gt;
&lt;span class="err"&gt;(venv) $ dot -Tpng gf_tiny.dot -o gf_tiny.png&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and we wouldn't have to retrieve any information from the web. The
result, &lt;code&gt;gf_tiny.png&lt;/code&gt; looks like this:&lt;/p&gt;
&lt;p&gt;&lt;img alt="A small genealogical tree of Gauss and Fourier." src="https://jsthomas.github.io/images/mgptree/gf_tiny.png" style="width: 907px; height: auto;"/&gt;&lt;/p&gt;
&lt;p&gt;This feature can be pretty useful if you're trying to work with very
large sets of data and don't know how much information you want to
present.&lt;/p&gt;
&lt;h2&gt;Usage Tips&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The Math Geneaology Project has some "holes" in its data. This seems
to be particularly true for mathematicians who didn't get their degree
in Europe or the US. If you or your advisor aren't listed, add your
data to their website
&lt;a href="http://genealogy.math.ndsu.nodak.edu/submit.php"&gt;here&lt;/a&gt; to help fill
in the gaps!&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The number of requests to the MGP's database can grow to be quite
large if you search back 10 or more generations. In particular, it's
probably not a good idea to try to generate a tree for a large number
of people &lt;em&gt;and&lt;/em&gt; many generations.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Accurately matching name data isn't easy. For example, the
mathematician Felix Klein is really named Christian Felix Klein. If
your searches don't succeed, check to make sure you've got your name
data right. This is particularly true for names with accents and
umlauts.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Making Pretty Graphs&lt;/h2&gt;
&lt;p&gt;Because my script produces an intermediate &lt;code&gt;.dot&lt;/code&gt; file, it is possible
for you to edit that file to add additional information or decorations
to the graph. Don't like the font I chose? Change the &lt;code&gt;font=Courier&lt;/code&gt;
entry in the &lt;code&gt;.dot&lt;/code&gt; file. Want to adjust a few nodes so that
significant mathematicians have special node colors? Search for their
names in the &lt;code&gt;.dot&lt;/code&gt; file, then add the metadata
&lt;code&gt;color=[your color here]&lt;/code&gt; to their nodes. The documentation for
graphviz is very useful for tasks like this.&lt;/p&gt;</content><category term="Python, Projects"></category></entry><entry><title>A Camera-Based Virtual Keyboard System</title><link href="https://jsthomas.github.io/vkeyboard.html" rel="alternate"></link><published>2013-12-10T00:00:00-05:00</published><updated>2013-12-10T00:00:00-05:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2013-12-10:/vkeyboard.html</id><summary type="html">&lt;p&gt;A brief summary of my term project for ECE 532&lt;/p&gt;</summary><content type="html">&lt;p&gt;In the Fall of 2013, I developed a camera-based keyboard system as my
term project for an image analysis course. This page provides a brief
summary of my project.&lt;/p&gt;
&lt;p&gt;In my system, a webcam looks down on a user's hands, which rest on a
paper keyboard template. My program collects images from the webcam to
determine when and where the user touches the keyboard template. When
the user touches a key, my program produces the corresponding letter
as output.&lt;/p&gt;
&lt;p&gt;Virtual keyboards are still actively researched in computer science
and electrical engineering. The system I implemented uses techniques
published in [1]-[3] between 2010 and 2013. Camera-based virtual
keyboards require a number of interesting image analysis techniques to
implement. They are particularly of interest in mobile applications
and in areas where one would like to avoid the cost of a physical
keyboard (for example, projects providing computers to people in the
developing world).&lt;/p&gt;
&lt;h1&gt;Processing Steps&lt;/h1&gt;
&lt;p&gt;The virtual keyboard system I implemented needed to solve three main
problems:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Detect the locations of the user's fingertips.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Detect whether any fingertips are in contact with the tabletop.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;When a fingertip touches the tabletop, determine which key was
pressed on the keyboard.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The first problem can be solved by segmenting an input image &lt;span class="math"&gt;\(I\)&lt;/span&gt; into
two regions: one representing the hands and another representing the
background. For each connected component of the hand region, we can
extract a contour &lt;span class="math"&gt;\(\gamma\)&lt;/span&gt; that traverses the boundary
counterclockwise. Places where &lt;span class="math"&gt;\(\gamma\)&lt;/span&gt; has high curvature (the
places where &lt;span class="math"&gt;\(\gamma\)&lt;/span&gt; bends the most sharply) typically correspond to
fingertips.&lt;/p&gt;
&lt;p&gt;&lt;img alt="Virtual keyboard processing steps." src="https://jsthomas.github.io/images/vkeyboard/kb_processing.png" style="width: 1680px; height: auto;"/&gt;&lt;/p&gt;
&lt;p&gt;I addressed the second problem using a technique called &lt;em&gt;shadow
analysis&lt;/em&gt;, which is discussed in [1]. With this technique, we perform
another segmentation on &lt;span class="math"&gt;\(I\)&lt;/span&gt;, to locate the regions in the image that
represent the shadows of the user's hands. Then, we examine small
neighborhoods near the user's fingertips. If the proportion of
shadow-pixels in a given neighborhood is above a certain threshold, we
infer that the corresponding fingertip is not in contact with the
tabletop (because it has a shadow). Otherwise, we declare that
fingertip to be touching the keyboard.&lt;/p&gt;
&lt;p&gt;The last problem is solved by making some assumptions about the
geometry of the keyboard and imaging system. I assumed that the
keyboard template displays four easily identifiable control points
arranged in a rectangle, and that the front edge of the control
rectangle is parallel to the &lt;span class="math"&gt;\(x\)&lt;/span&gt;-axis of the camera's coordinate
system. With these additional assumptions, it isn't too hard to invert
the perspective projection and recover the keyboard-space coordinates
of each keypress from the image-space coordinates of the fingertips.&lt;/p&gt;
&lt;h1&gt;Results&lt;/h1&gt;
&lt;p&gt;After implementing my virtual keyboard system in python, I analyzed
its performance under different lighting and usage conditions. My
tests suggest that a camera-based user interface that uses shadow
analysis will work best under conditions where one has fine control
over the lighting conditions and the user does not need to enter very
much data at one time. For example, a camera-based user interface
would work well in an interactive museum exhibit, but it might not be
a very good tool for word processing in a dark coffee shop. Currently,
camera-based keyboards cannot provide the speed and accuracy
achievable on physical keyboards (but for that matter, neither do
touchscreen keyboards).&lt;/p&gt;
&lt;h1&gt;Downloads&lt;/h1&gt;
&lt;p&gt;Below are links to the paper and code I wrote for the term project. I
used the code within &lt;a href="http://ipython.org/"&gt;ipython&lt;/a&gt; to conduct my
experiments, and used the &lt;a href="http://opencv.org/"&gt;OpenCV&lt;/a&gt; project to get
data from the camera. OpenCV's support for python is still under
development, so if you examine my code you may have to adapt it to
work with your particular hardware and copy of OpenCV.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Paper:
  &lt;a href="https://jsthomas.github.io/docs/vkeyboard/vkeyboard.pdf"&gt;A Camera Based Virtual Keyboard with Touch Detection by Shadow Analysis&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Project Code: &lt;a href="https://jsthomas.github.io/docs/vkeyboard/vkeyboard.zip"&gt;vkeyboard.zip&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Y. Adajania, J. Gosalia, A. Kanade, H. Mehta, and N. Shekokar. Virtual
keyboard using shadow analysis. In Emerging Trends in Engineering and
Technology (ICETET), 2010 3rd International Conference on, page 163 to
165, 2010.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;E. Posner, N. Starzicki, and E. Katz. A single camera based floating virtual
keyboard with improved touch detection. In Electrical Electronics Engineers
in Israel (IEEEI), 2012 IEEE 27th Convention of, page 1 to 5, 2012.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;M. Hagara and J. Pucik. Fingertip detection for virtual keyboard
based on camera. In Radioelektronika (RADIOELEKTRONIKA), 2013 23rd
International Conference, page 356 to 360, 2013.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="Python"></category></entry></feed>