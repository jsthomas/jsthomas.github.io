<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Joe Thomas</title><link href="https://jsthomas.github.io/" rel="alternate"></link><link href="https://jsthomas.github.io/feeds/all.atom.xml" rel="self"></link><id>https://jsthomas.github.io/</id><updated>2021-08-30T00:00:00-04:00</updated><entry><title>Things I learned at ICFP 2021</title><link href="https://jsthomas.github.io/icfp-2021.html" rel="alternate"></link><published>2021-08-30T00:00:00-04:00</published><updated>2021-08-30T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2021-08-30:/icfp-2021.html</id><summary type="html">&lt;p&gt;A summary of the sessions I attended at ICFP 2021&lt;/p&gt;</summary><content type="html">&lt;p&gt;Last week I attended ICFP for the first time. Due to the pandemic, the
conference was entirely online. This made it really easy and
inexpensive to attend (were it in person, I would've had to fly to
Korea), but also made it harder to meet people and benefit from "the
hallway track".&lt;/p&gt;
&lt;p&gt;Despite the circumstances, there were a number of interesting
sessions. Below is a summary of some of the projects I learned about
at the conference. Some caveats:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;ICFP has a lot of parallel tracks. I was focused primarily on ML and
  OCaml sessions, so I'm sure there were interesting talks that I
  missed.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I missed some talks due to timezone issues.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I'm approaching the conference as someone who primarily works on the
  backend of analytics applications, so I wasn't as interested in new
  results about PL theory.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I think conferences are a great way to hear about new technologies,
but for depth you have to study on your own afterwards. As such, this
post is a bit of a "listicle" capturing topics I might want to
investigate later.&lt;/p&gt;
&lt;h1&gt;Keynote&lt;/h1&gt;
&lt;p&gt;Ravi Chugh gave an interesting keynote about how programming language
techniques can be applied to human-computer interaction problems. He
demonstrated a 2D graphics editor called Sketch-n-sketch where the
user could create an image using a GUI or a programming language, and
synchronize between the two.&lt;/p&gt;
&lt;p&gt;Before this session, I didn't realize how much research has been done
into applying FP/PL techniques to human/computer interfaces. It would
be interesting to apply similar techniques to a 3D animation system
like Blender. When I used to work on animation (long, long ago), I
wanted GUI capabilities for building individual models in a scene but
would have preferred a programming language when rigging characters or
automating certain motions. Debugging GUI-based automation was
no fun at all.&lt;/p&gt;
&lt;h1&gt;Historical Talks&lt;/h1&gt;
&lt;p&gt;Don Syme gave a talk about the history of F#. This covered the
original motivation for the language, it's interactions with the C#
community, and the impact of Object Orient Programming's popularity on
PL research. Xavier Leroy gave a presentation about the history of
OCaml (this year was the language's 25th anniversary), and also
commented on the impact of OO. It was interesting to hear about how
OCaml was used for teaching programming in Universities and how this
language related to research in automated theorem proving.&lt;/p&gt;
&lt;h1&gt;Research and Industry Talks&lt;/h1&gt;
&lt;p&gt;Marten Agren gave a talk about how Standard Chartered uses a strict
version of Haskell for their work, and how FP is especially suited to
scalable inter-operation with spreadsheets. Before this talk, I didn't
know that some people use Haskell without lazy evaluation.&lt;/p&gt;
&lt;p&gt;Denis Merigoux gave a &lt;a href="https://youtu.be/jmHwAh_-IOU"&gt;presentation&lt;/a&gt;
about a new DSL called &lt;a href="https://github.com/CatalaLang"&gt;Catala&lt;/a&gt; that
makes it possible to model laws (e.g. tax law) with code. The compiler
for the language is written in OCaml. Naturally, the correctness of
these types of systems is quite important; errors mean that essential
social services aren't delivered (e.g. paychecks for government
workers). It's interesting to think about other areas where this work
could be applied beyond tax law. For example, most utility costs are
also a matter of public record and having an open, formally verified
system for calculating those costs would help ensure rate payers are
billed fairly.&lt;/p&gt;
&lt;h2&gt;Talks about tooling and libraries&lt;/h2&gt;
&lt;p&gt;The OCaml workshop featured several exciting talks about improvements
to the OCaml ecosystem.&lt;/p&gt;
&lt;p&gt;Laurent Mazare spoke about how Jane Street makes OCaml libraries
accessible from within python, with a special focus on Jupyter
notebooks. As someone who has worked supporting data scientists in the
past, this seems like a great way to get the benefits of the Python
data science ecosystem while building primarily in a strongly typed
language. I'm not sure what this work means for projects like Owl that
try to provide a similar feature set as Numpy/SciPy/Pandas in OCaml.&lt;/p&gt;
&lt;p&gt;Di Long Li and Gabriel Radanne presented a new library called
&lt;a href="https://github.com/daypack-dev/timere"&gt;&lt;code&gt;timere&lt;/code&gt;&lt;/a&gt; that makes it easier
to work with dates and times. The library simplifies solving
recurrence-rule problems like "tell me which Christmases fall on a
Wednesday from now on". I think this is a great development,
especially if you're building an application that works with time
series data from a business domain. Gabriel Radanne also presented
&lt;a href="https://github.com/Drup/dowsing"&gt;&lt;code&gt;dowsing&lt;/code&gt;&lt;/a&gt; a tool that allows the
user to search OCaml codebases using a type signature. This is a bit
like &lt;a href="https://hoogle.haskell.org/"&gt;hoogle&lt;/a&gt;, but the underlying
techniques used to enable search are quite different.&lt;/p&gt;
&lt;p&gt;Thomas Leonard gave an impressive talk about applying the new effect
system in multicore OCaml to the &lt;code&gt;angstrom&lt;/code&gt; library, demonstrating
performance on par with Rust. I think it will be exciting to start
using effects as they become available in the next year or two.&lt;/p&gt;
&lt;p&gt;Two different teams discussed their efforts to improve the state of
OCaml documentation, so that a site similar to
&lt;a href="https://hackage.haskell.org/"&gt;hackage&lt;/a&gt; could be generated directly
from OPAM. This seems like a great way to lower one of the barriers to
entry for maintainers and make OCaml documentation more consistent.&lt;/p&gt;
&lt;p&gt;Gargi Sharma presented work that a team at Tarides is doing on
&lt;a href="https://github.com/ocurrent/current-bench"&gt;&lt;code&gt;current-bench&lt;/code&gt;&lt;/a&gt;, a system
for analyzing benchmarking data that integrates with OCaml CI
systems. Using their tools, one can track trends in benchmark data
over time and identify builds that improved or degraded
performance. This system also provides a nice example of how to build
an analytics app using FP techniques. They use &lt;code&gt;rescript&lt;/code&gt; for their
frontend, &lt;code&gt;hasura&lt;/code&gt; to serve analytics results via GraphQL, and an
OCaml program for ingesting performance data into their database.&lt;/p&gt;
&lt;h1&gt;Takeaways&lt;/h1&gt;
&lt;p&gt;There was a lot of focus on "ecosystem tooling" at the OCaml workshop
and considerable excitement about the upcoming release of multicore
OCaml. I didn't hear much about work on the frontend (ReasonML,
Bucklescript, Rescript) or updates about applications of OCaml to
statistics/numerical computing. Possibly this was just a function of
the unusual pandemic environment or the nature of a conference with a
more academic focus. In any case, I'm excited to dive into some of
these new tools, and especially to start getting the benefits of
improved documentation and search capabilities for OCaml libraries.&lt;/p&gt;</content><category term="FP, ICFP"></category></entry><entry><title>Debugging an SMTP Integration in OCaml</title><link href="https://jsthomas.github.io/smtp-debugging.html" rel="alternate"></link><published>2021-08-25T00:00:00-04:00</published><updated>2021-08-25T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2021-08-25:/smtp-debugging.html</id><summary type="html">&lt;p&gt;Things I learned while fixing some SMTP problems.&lt;/p&gt;</summary><content type="html">&lt;p&gt;For the last few weeks I've been working on a side project to create a
small library called
&lt;a href="https://github.com/jsthomas/tidy-email"&gt;&lt;code&gt;tidy_email&lt;/code&gt;&lt;/a&gt; that makes it
easier to send email in OCaml. The repository has some example
programs illustrating how to connect to different email services. I
wanted to make sure that these programs would fail gracefully if
configured with the wrong credentials. But when I ran my example &lt;a href="https://github.com/jsthomas/tidy-email/blob/main/smtp/example/send.ml"&gt;SMTP
app&lt;/a&gt;
with an invalid password, I saw this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;Send failed. Details: Error: Stack overflow&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I expected to see some sort of "not authorized" message. Why was
this happening? This post summarizes how I debugged this problem.&lt;/p&gt;
&lt;h2&gt;Context&lt;/h2&gt;
&lt;p&gt;Among email services (like Mailgun, Sendgrid, and Amazon SES) there
are typically two ways for a web application to send email: make a
request to a REST API or use
&lt;a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol"&gt;SMTP&lt;/a&gt;. REST
APIs are convenient because they expose more features. In particular,
when you provide malformed data, the API can respond with a detailed
explanation of what the application did incorrectly. On the other
hand, SMTP is advantageous if you already have a mail server, want to
integrate with a legacy system, or can't be bothered to write a custom
REST API integration.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;tidy_email&lt;/code&gt; provides a simple wrapper around other libraries that
handle HTTP requests and/or SMTP. For SMTP, it uses
&lt;a href="https://github.com/oxidizing/letters"&gt;&lt;code&gt;letters&lt;/code&gt;&lt;/a&gt;, which in turn
depends on a library called
&lt;a href="https://github.com/mirage/colombe/"&gt;&lt;code&gt;colombe&lt;/code&gt;&lt;/a&gt;. At a high level, what
I wanted to understand was why &lt;code&gt;letters&lt;/code&gt; was experiencing a stack
overflow when provided with bad SMTP credentials.&lt;/p&gt;
&lt;p&gt;The specific SMTP server I was testing against was provided by
Mailgun. I had previously had some
&lt;a href="https://github.com/oxidizing/letters/issues/35"&gt;difficulties&lt;/a&gt; with
this server; these came about because Mailgun's implementation doesn't
strictly adhere to the relevant RFCs, and I thought something similar
might be occurring here.&lt;/p&gt;
&lt;h2&gt;Gathering Data&lt;/h2&gt;
&lt;p&gt;I started by cloning the &lt;code&gt;letters&lt;/code&gt; and &lt;code&gt;colombe&lt;/code&gt; repositories from
github. Fortunately, I already had
&lt;a href="https://github.com/ocaml/merlin/wiki/emacs-from-scratch#configuring-your-project"&gt;&lt;code&gt;merlin&lt;/code&gt;&lt;/a&gt;
installed for Emacs. This gave me the ability to jump from a function
call in my source code to the function's definition (&lt;code&gt;C-c l&lt;/code&gt;). It also
allowed me to quickly look up types (&lt;code&gt;C-c t&lt;/code&gt;). These hotkeys were
invaluable for efficiently working with unfamiliar code.&lt;/p&gt;
&lt;p&gt;Before I started digging into the source code, I tried running
&lt;code&gt;strace&lt;/code&gt; on my test app. This tool produces a log of all system calls
made by the app under test. This results in a &lt;em&gt;lot&lt;/em&gt; of output; here is
an excerpt of what I saw:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;read(5, "220 Mailgun Influx ready\r\n", 4096) = 26&lt;/span&gt;
&lt;span class="err"&gt;read(5, 0x56132a92d460, 4096)           = -1 EAGAIN (Resource temporarily unavailable)&lt;/span&gt;
&lt;span class="err"&gt;write(5, "EHLO glenmeretechnologies.com\r\n", 31) = 31&lt;/span&gt;
&lt;span class="err"&gt;getpid()                                = 15565&lt;/span&gt;
&lt;span class="err"&gt;epoll_wait(3, [{EPOLLIN, {u32=5, u64=8589934597}}], 64, 9879) = 1&lt;/span&gt;
&lt;span class="err"&gt;read(5, "250-smtp-out-n02.prod.us-west-2."..., 4096) = 144&lt;/span&gt;
&lt;span class="err"&gt;read(5, 0x56132a92d460, 4096)           = -1 EAGAIN (Resource temporarily unavailable)&lt;/span&gt;
&lt;span class="err"&gt;write(5, "STARTTLS\r\n", 10)            = 10&lt;/span&gt;
&lt;span class="err"&gt;getpid()                                = 15565&lt;/span&gt;
&lt;span class="err"&gt;epoll_wait(3, [{EPOLLIN, {u32=5, u64=8589934597}}], 64, 9840) = 1&lt;/span&gt;
&lt;span class="err"&gt;read(5, "220 Go ahead\r\n", 4096)       = 14&lt;/span&gt;
&lt;span class="err"&gt;brk(0x56132a954000)                     = 0x56132a954000&lt;/span&gt;
&lt;span class="err"&gt;brk(0x56132a975000)                     = 0x56132a975000&lt;/span&gt;
&lt;span class="err"&gt;brk(0x56132a996000)                     = 0x56132a996000&lt;/span&gt;
&lt;span class="err"&gt;read(5, 0x56132a92d460, 4096)           = -1 EAGAIN (Resource temporarily unavailable)&lt;/span&gt;
&lt;span class="err"&gt;write(5, "\26\3\3\2\0\1\0\1\374\3\0033y\374\354\246\200\2749u\7\375P\226\273\37\342|\257\235\277h"..., 517) = 517&lt;/span&gt;
&lt;span class="err"&gt;getpid()                                = 15565&lt;/span&gt;
&lt;span class="err"&gt;epoll_wait(3, [{EPOLLIN, {u32=5, u64=8589934597}}], 64, 9796) = 1&lt;/span&gt;
&lt;span class="err"&gt;read(5, "\26\3\3\0Z\2\0\0V\3\3\22c1v\234\367\0\322fR\230\264\236;\314\f\23\234$\245\33"..., 4096) = 3389&lt;/span&gt;
&lt;span class="err"&gt;read(5, 0x56132a92d460, 4096)           = -1 EAGAIN (Resource temporarily unavailable)&lt;/span&gt;
&lt;span class="err"&gt;...&lt;/span&gt;
&lt;span class="err"&gt;read(5, "", 4096)                       = 0&lt;/span&gt;
&lt;span class="err"&gt;(last line repeats hundreds of times)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;From this output, I was able to glean a couple of things:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;My app is successfully connecting to &lt;code&gt;smtp.mailgun.org&lt;/code&gt;, as
   evidenced by the &lt;code&gt;220 Go ahead&lt;/code&gt; message.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The hundreds of &lt;code&gt;read&lt;/code&gt; calls seem related to the stack overflow
   issue. They suggest some sort of infinite loop or that the app is
   trying to read data that isn't available for some reason.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Getting more information about SMTP&lt;/h2&gt;
&lt;p&gt;At this point, I decided I needed to learn a little bit about how SMTP
works. Fortunately, wikipedia provides a fairly concise
&lt;a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol"&gt;overview&lt;/a&gt;
with an example of a successful SMTP session (&lt;code&gt;S&lt;/code&gt; = Server, &lt;code&gt;C&lt;/code&gt; = Client):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;S&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;220&lt;/span&gt; &lt;span class="n"&gt;smtp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;example&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt; &lt;span class="n"&gt;ESMTP&lt;/span&gt; &lt;span class="n"&gt;Postfix&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;HELO&lt;/span&gt; &lt;span class="n"&gt;relay&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;example&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt;
&lt;span class="n"&gt;S&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;250&lt;/span&gt; &lt;span class="n"&gt;smtp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;example&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;I&lt;/span&gt; &lt;span class="n"&gt;am&lt;/span&gt; &lt;span class="n"&gt;glad&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;meet&lt;/span&gt; &lt;span class="n"&gt;you&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;MAIL&lt;/span&gt; &lt;span class="n"&gt;FROM&lt;/span&gt;&lt;span class="o"&gt;:&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;bob&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;example&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="n"&gt;S&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;250&lt;/span&gt; &lt;span class="n"&gt;Ok&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;RCPT&lt;/span&gt; &lt;span class="n"&gt;TO&lt;/span&gt;&lt;span class="o"&gt;:&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;alice&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;example&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="n"&gt;S&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;250&lt;/span&gt; &lt;span class="n"&gt;Ok&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;RCPT&lt;/span&gt; &lt;span class="n"&gt;TO&lt;/span&gt;&lt;span class="o"&gt;:&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;theboss&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;example&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="n"&gt;S&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;250&lt;/span&gt; &lt;span class="n"&gt;Ok&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;DATA&lt;/span&gt;
&lt;span class="n"&gt;S&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;354&lt;/span&gt; &lt;span class="n"&gt;End&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;CR&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;LF&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;.&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;CR&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;LF&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;From&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"Bob Example"&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;bob&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;example&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;To&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Alice&lt;/span&gt; &lt;span class="n"&gt;Example&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;alice&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;example&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Cc&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;theboss&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;example&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Date&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Tue&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;15&lt;/span&gt; &lt;span class="n"&gt;Jan&lt;/span&gt; &lt;span class="mi"&gt;2008&lt;/span&gt; &lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;02&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;43&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;0500&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Subject&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Test&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Hello&lt;/span&gt; &lt;span class="n"&gt;Alice&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;This&lt;/span&gt; &lt;span class="k"&gt;is&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="n"&gt;test&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt; &lt;span class="n"&gt;header&lt;/span&gt; &lt;span class="n"&gt;fields&lt;/span&gt; &lt;span class="n"&gt;and&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt; &lt;span class="n"&gt;lines&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Your&lt;/span&gt; &lt;span class="n"&gt;friend&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Bob&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;S&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;250&lt;/span&gt; &lt;span class="n"&gt;Ok&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;queued&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="mi"&gt;12345&lt;/span&gt;
&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;QUIT&lt;/span&gt;
&lt;span class="n"&gt;S&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;221&lt;/span&gt; &lt;span class="n"&gt;Bye&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Unfortunately, this excerpt doesn't explain much about how a session
using STARTTLS should look. Since I saw some successful &lt;code&gt;read&lt;/code&gt; calls
in my strace output, with arguments that weren't readable text, I
inferred that TLS was probably interfering with my ability to easily
see what was going on in the session after the first 220 response.&lt;/p&gt;
&lt;h2&gt;Getting more data from logs&lt;/h2&gt;
&lt;p&gt;I used &lt;code&gt;merlin&lt;/code&gt; to jump to the &lt;a href="https://github.com/mirage/colombe/blob/master/sendmail/sendmail_with_starttls.ml"&gt;relevant
parts&lt;/a&gt;
of the &lt;code&gt;colombe&lt;/code&gt; source code and noticed that &lt;code&gt;colombe&lt;/code&gt; uses the
&lt;code&gt;Logs&lt;/code&gt; module. Adding these two lines at the start of my test app
allowed me to start collecting log output, and see what was going on
in &lt;code&gt;colombe&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;  &lt;span class="nn"&gt;Logs&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_reporter&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Logs&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format_reporter&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
  &lt;span class="nn"&gt;Logs&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_level&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="nn"&gt;Logs&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;Info&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When I took a look at the log output, I saw:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;...&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;Return&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;READ&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;220&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Mailgun&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Influx&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;ready&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;READ&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;250&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;smtp&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;out&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;n01&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;prod&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;us&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;west&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mf"&gt;2.&lt;/span&gt;&lt;span class="n"&gt;postgun&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="mi"&gt;250&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;AUTH&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;PLAIN&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;LOGIN&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="mi"&gt;250&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;SIZE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;52428800&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="mi"&gt;250&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="n"&gt;BITMIME&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="mi"&gt;250&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;SMTPUTF8&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="mi"&gt;250&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;PIPELINING&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="mi"&gt;250&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;STARTTLS&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;Return&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;READ&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;Return&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;WARNING&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;The&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;an&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;invalid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;base64&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;value&lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="ss"&gt;"Go ahead"&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;READ&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;Return&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;535&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Authentication&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;failed&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Quitting&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;...&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;Before&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;recv&lt;/span&gt;&lt;span class="p"&gt;...&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="nl"&gt;send&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;READ&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;repeats&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;hundreds&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;of&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;times&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Similar to the &lt;code&gt;strace&lt;/code&gt; results, I could see many failed reads. But
this time I could see they occurred after a &lt;code&gt;535 Authentication
failed&lt;/code&gt; message came back from the server.&lt;/p&gt;
&lt;p&gt;During this phase of analysis it was helpful to be able to add my own
log points to the source code. In order to do this, though, I needed
to ensure that my test app would build against my modified version of
&lt;code&gt;colombe&lt;/code&gt;, not the published version on &lt;code&gt;opam&lt;/code&gt;. Within the &lt;code&gt;colombe&lt;/code&gt;
repo, I ran&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;dune build src &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; dune install colombe &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; dune build sendmail &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; dune install sendmail
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This pinned both &lt;code&gt;colombe&lt;/code&gt; and &lt;code&gt;sendmail&lt;/code&gt; to my local versions on
disk. Because &lt;code&gt;letters&lt;/code&gt; uses these two libraries, I also needed to go
to my &lt;code&gt;letters&lt;/code&gt; repo and run:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;dune build . &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; dune install letters
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With these two steps taken care of, I could use &lt;code&gt;dune&lt;/code&gt; to execute my
test app and see the custom instrumentation that I'd added to the
underlying libraries.&lt;/p&gt;
&lt;h2&gt;Reproducing the problem&lt;/h2&gt;
&lt;p&gt;At this point, I was pretty confident that &lt;code&gt;colombe&lt;/code&gt; was having
problems immediately after trying to quit the SMTP session by sending
a &lt;code&gt;QUIT&lt;/code&gt;. After some google searching, I learned that &lt;code&gt;openssl&lt;/code&gt;
allows you to run an SMTP session interactively. To test, I ran:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;openssl s_client -connect smtp.mailgun.org:587 -starttls smtp&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The first part of the session looked like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;250 STARTTLS
---
Post-Handshake New Session Ticket arrived:
SSL-Session:
    Protocol  : TLSv1.3
    Cipher    : TLS_AES_128_GCM_SHA256
    Session-ID: 7E83FE3CC7D65BE60AF56A2E049C09A27AB33DF834454617B81C0469A32EEC62
    Session-ID-ctx:
    Resumption PSK: 4A7C875CECCCA5633D3FF2107857EAF220FF561B782AAC3AC416385612E08AAB
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 604800 (seconds)
    TLS session ticket:
    0000 - 4a 79 8c 03 d5 1e 3f 5d-dc b2 2d b6 38 db 4e 10   Jy....?]..-.8.N.
    0010 - 91 b6 1d 44 d2 95 c9 50-f3 f9 a7 89 8d 0e b9 7e   ...D...P.......~
    0020 - f1 d6 52 da 3d 84 f5 ee-58 72 a8 81 1e 0f ad c7   ..R.=...Xr......
    0030 - c7 76 8f 8c d9 d9 56 8f-f3 72 de 0e bf 17 b0 2f   .v....V..r...../
    0040 - 72 a7 98 cd 92 46 da 45-fc b8 a9 d4 6e 73 71 f5   r....F.E....nsq.
    0050 - 74 f2 1d eb 83 b3 01 83-77 3f 7a e0 9a 36 4a fe   t.......w?z..6J.
    0060 - b3 89 3e c7 4c aa 87 eb-6d 46 42 46 73 8f 35 1f   ..&amp;gt;.L...mFBFs.5.
    0070 - 8c                                                .

    Start Time: 1630180065
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
    Max Early Data: 0
---
read R BLOCK
EHLO
250-smtp-out-n02.prod.us-west-2.postgun.com
250-AUTH PLAIN LOGIN
250-SIZE 52428800
250-8BITMIME
250-SMTPUTF8
250 PIPELINING
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By running &lt;code&gt;EHLO&lt;/code&gt;, I was able to see the different operations this
SMTP server supports. In the output above, we can see that one of
those operations is &lt;code&gt;AUTH PLAIN&lt;/code&gt;. I tried to authenticate with invalid
credentials, and saw this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;AUTH PLAIN BADPASSWORD
501 Invalid response encoding
535 Authentication failed
closed
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This means that after a client provides bad credentials, Mailgun's
SMTP implementation immediately terminates the connection. But, when
&lt;code&gt;colombe&lt;/code&gt; encountered a failure to authenticate, it tried to clean up
the session like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;properly_quit_and_fail&lt;/span&gt; &lt;span class="n"&gt;ctx&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;open&lt;/span&gt; &lt;span class="nc"&gt;Monad&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt;&lt;span class="n"&gt;txts&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;send&lt;/span&gt; &lt;span class="n"&gt;ctx&lt;/span&gt; &lt;span class="nn"&gt;Value&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;Quit&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="k"&gt;fun&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;recv&lt;/span&gt; &lt;span class="n"&gt;ctx&lt;/span&gt; &lt;span class="nn"&gt;Value&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;PP_221&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nc"&gt;Error&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So &lt;code&gt;colombe&lt;/code&gt; tried to send a &lt;code&gt;QUIT&lt;/code&gt; message and await a &lt;code&gt;221 Bye&lt;/code&gt;, but
that message never arrived because the server had already closed the
connection.&lt;/p&gt;
&lt;h2&gt;Fixing the problem&lt;/h2&gt;
&lt;p&gt;Once I understood the problem, I realized I could avoid the issue by
revising &lt;code&gt;properly_quit_and_fail&lt;/code&gt; to prevent waiting on a response
from the server. Effectively, this meant changing a &lt;code&gt;let*&lt;/code&gt; to a &lt;code&gt;let&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;properly_quit_and_fail&lt;/span&gt; &lt;span class="n"&gt;ctx&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;open&lt;/span&gt; &lt;span class="nc"&gt;Monad&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt;&lt;span class="n"&gt;txts&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;send&lt;/span&gt; &lt;span class="n"&gt;ctx&lt;/span&gt; &lt;span class="nn"&gt;Value&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;Quit&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="k"&gt;fun&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;recv&lt;/span&gt; &lt;span class="n"&gt;ctx&lt;/span&gt; &lt;span class="nn"&gt;Value&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;PP_221&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nc"&gt;Error&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I also filed this
&lt;a href="https://github.com/mirage/colombe/issues/46"&gt;issue&lt;/a&gt;, which prompted
one of the maintainers to
&lt;a href="https://github.com/mirage/colombe/pull/47"&gt;refactor&lt;/a&gt; how connections
are managed, with a much more thorough solution than what I had
done. (Many thanks to Calascibetta Romain for fixing my issue so
quickly!) Once merged, other &lt;code&gt;colombe&lt;/code&gt; users shouldn't encounter the
stack overflow issues I described here.&lt;/p&gt;
&lt;h2&gt;Final Thoughts&lt;/h2&gt;
&lt;p&gt;This was an interesting bug to investigate because it covered a number
of unfamiliar topics. I didn't know much about SMTP when I started,
and I learned a couple useful facts while debugging:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SMTP sessions consist of a handful of commands that are fairly easy
  to understand.&lt;/li&gt;
&lt;li&gt;OpenSSL's tooling makes it easy to test SMTP by hand.&lt;/li&gt;
&lt;li&gt;Even very commonly used mail services like Mailgun may not work
  exactly the way you expect from reading RFCs or other documentation!&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I also learned some useful techniques I can reuse the next time I need
to debug OCaml problems:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;When writing test apps, enable logging (at info level) from the
  beginning!&lt;/li&gt;
&lt;li&gt;Use &lt;code&gt;dune install&lt;/code&gt; to add instrumentation and temporary bug fixes to
  libraries.&lt;/li&gt;
&lt;li&gt;Developer tooling like &lt;code&gt;merlin&lt;/code&gt; is very helpful for efficiently
  navigating unfamiliar code.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Feedback&lt;/h2&gt;
&lt;p&gt;If you found this post useful (or conversely, found an error), send me
an email. I'm interested in adding more tutorial resources to the
OCaml ecosystem and would happy to hear suggestions about how to make
these resources better. My contact information is listed on the
&lt;a href="/"&gt;About&lt;/a&gt; page.&lt;/p&gt;</content><category term="OCaml, SMTP, Debugging"></category></entry><entry><title>Thoughts on running a job search in 2021</title><link href="https://jsthomas.github.io/job-search-2021.html" rel="alternate"></link><published>2021-08-17T00:00:00-04:00</published><updated>2021-08-17T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2021-08-17:/job-search-2021.html</id><summary type="html">&lt;p&gt;Some notes from my most recent job search.&lt;/p&gt;</summary><content type="html">&lt;p&gt;I recently wrapped up a job search. My new job starts as I'm in the
process of leaving the &lt;a href="https://www.recurse.com/"&gt;Recurse Center&lt;/a&gt;, so
I thought this would be a good time to summarize my impressions of the
job market for software developers in 2021.&lt;/p&gt;
&lt;p&gt;I've encountered a fair amount of advice for software developers who
are just getting out of university, but less advice for developers on
their second or third job. This post is my attempt to fill that gap a
bit and write down some advice to my earlier self. Hopefully it
contains useful suggestions for other job seekers, especially other
Recursers.&lt;/p&gt;
&lt;h2&gt;Background&lt;/h2&gt;
&lt;p&gt;Like many software engineers, I have mixed feelings about how our
industry (specifically, software companies in the US) conduct
interviews. My first few interviews out of university (circa 2010)
were pretty difficult. These consisted of solving "leetcode" style
problems in a panel interview format, where 5-6 older engineers scowl
at you while you work at a whiteboard. Having been both an interviewer
and an interviewee, my impression is that the process is pretty ad-hoc
and varies a lot between companies. As an industry, we just aren't
that scientific about crafting interviews and reviewing the results.&lt;/p&gt;
&lt;p&gt;After talking to a number of experienced developers and reading
comments on Hacker News, I think many software engineers find the
interview process frustratingly artificial, like a sort of "hazing"
ritual. In this viewpoint, the difficulty of interviewing forces
candidates into a "scarcity" mindset where interviews are hard to get,
job offers are even harder to obtain, and unemployment is to be
constantly feared.&lt;/p&gt;
&lt;p&gt;My mission this Summer has been to change my perspective on that. I
don't think that finding a job will ever be "fun" per se. It's always
a bit stressful. But, I didn't want to operate from the basis that
interviewing is to be feared, especially when that feeling is
amplified by sentiments on social media (e.g. Hacker News).&lt;/p&gt;
&lt;h2&gt;General Strategy&lt;/h2&gt;
&lt;p&gt;Talking to people about their job searches, I observed two
main strategies:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Develop one strong resume and send it out to many companies.&lt;/li&gt;
&lt;li&gt;Target a handful of specific companies that fit your interests.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I lean heavily toward the second strategy and applied to 6-10
positions this time. The following criteria narrowed my search quite a
bit:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I wanted to continue working on analytics/data engineering problems.&lt;/li&gt;
&lt;li&gt;The role needed to allow for remote work.&lt;/li&gt;
&lt;li&gt;I wasn't interested in working for a FAANG type company this time
  out; as far as I can tell, interviewing for these roles is quite
  different from interviewing with a startup.&lt;/li&gt;
&lt;li&gt;I wouldn't take a position that I felt had serious negative
  externalities (i.e. cryptocurrency/NFTs, fossil fuels).&lt;/li&gt;
&lt;li&gt;The role would ideally involve some amount of functional programming.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In general, I didn't apply to positions unless I met the majority of
the requirements in the job spec. For most positions I prepared a
custom cover letter. I primarily applied to most companies directly
through their website. The main exception to this rule was companies
affiliated with the Recurse Center; for these I applied via RC's
career services program.&lt;/p&gt;
&lt;p&gt;Before I started my search, I overhauled my personal website, LinkedIn
page, and resume. My previous job at a smaller, sales-focused company
had a significant advantage: It was much easier to frame my past work
in terms of a benefit to the company's business. Instead of saying &lt;em&gt;"I
set up server X and built technology Y"&lt;/em&gt;, I could write: &lt;em&gt;"I built X
which serves Y percent of all customers and saved Z dollars."&lt;/em&gt; This
was more difficult when I was working in a research role, separated
from users by several degrees. I think my resume was stronger on this
job search than on previous ones, largely because I kept an up to date
"achievement list" in my previous role.&lt;/p&gt;
&lt;h2&gt;Companies with an Open Source Presence&lt;/h2&gt;
&lt;p&gt;This time I applied to more companies that list their source code on
github. For these I followed a somewhat different strategy.&lt;/p&gt;
&lt;p&gt;I started by making a list of public repos the company was actively
developing. This can typically be worked out by examining github
activity and (in some cases) presentations from recent conferences. I
downloaded some of these projects to get a sense of how they worked;
this was a helpful test to determine whether I would want to do this
type of work long term. If I found a project with a smallish issue
that I could solve, I prepared a pull request.&lt;/p&gt;
&lt;p&gt;This process had a few benefits:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;It helped me learn a little more about the company's code review
  practices.&lt;/li&gt;
&lt;li&gt;A merged PR gave me something to mention in my cover letter, to help
  me stand out from other applicants.&lt;/li&gt;
&lt;li&gt;It allowed me to expand my portfolio of open source work.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This &lt;em&gt;was&lt;/em&gt; a more labor-intensive strategy, but I considered it worth
the effort. In some cases, this technique allowed me to skip over
technical assessments or other "take home" assignments, because the
hiring manager was happy to use the PR I had prepared as a
substitute. In general, this technique seemed to "fast track" my
application when it worked.&lt;/p&gt;
&lt;h2&gt;Contracting&lt;/h2&gt;
&lt;p&gt;During my job search I also explored the possibility of working as a
contractor. This came about because one of the companies I applied to
wanted to hire me full time but didn't have the funds to do so;
instead they offered me part time work until they could afford bring
me on full time.&lt;/p&gt;
&lt;p&gt;Setting up an LLC isn't terribly difficult (perhaps a day worth of
work and $100-600, all in) and gives you the ability to do some
part-time work while looking for a permanent position. This took some
of the pressure off of my job search and helped me feel more confident
that I could support myself while looking for work. My general
impression is that it's easier to get hired as a contractor than as a
full time employee, because neither side is committed for the long
term.&lt;/p&gt;
&lt;p&gt;It's probably worth noting that this strategy might not work as well
if you haven't already built up a broad professional network or are
earlier in your career.&lt;/p&gt;
&lt;h2&gt;Things I could have improved&lt;/h2&gt;
&lt;p&gt;Although I'm happy with the outcome of my job search, there are some
things I could have done better.&lt;/p&gt;
&lt;p&gt;Most of my mistakes were errors in "timing" my applications. I applied
to a French company in late July and failed to realize many European
companies are completely shut down in August due to vacations. This
meant that even though they were interested in talking to me in
September, any other offers I received would arrive well &lt;em&gt;before&lt;/em&gt; I
could start their interview process.&lt;/p&gt;
&lt;p&gt;I decided to stagger my job applications such that the applications I
felt least confident about went out first and the ones I considered
"safe fallbacks" went out last. I thought this was reasonable because
I was writing custom cover letters, at a rate of 1-2 per day. In
retrospect, this approach was suboptimal. It had the effect of making
my job search longer than it needed to be. One of the "safe fallback"
jobs I had applied to had already been filled earlier in the month; it
couldn't have helped me, even though I was a good fit! It would've
been better to just learn that first thing.&lt;/p&gt;
&lt;p&gt;I augmented my main job search by using two jobs boards, AngelList and
FunctionalWorks. I didn't get useful leads from either service,
despite having had success with AngelList in the past. I suspect that
because these tools make it easy to apply to lots of jobs at once,
it's very hard to make your resume stand out when you use these
channels.&lt;/p&gt;
&lt;p&gt;I spent a lot of time working on leetcode problems. To my surprise,
this didn't actually come up much during my interviews. The firms I
was really interested in asked me for a sample of my open source work
(i.e. links to github) and/or gave me a take-home exercise that was
quite reasonable. There were no tricky algorithm/puzzle questions. I'm
not sure if I will bother with "grinding leetcode" in the future; I'd
much rather just focus on consistently growing my open source
portfolio and let that speak for itself.&lt;/p&gt;
&lt;h2&gt;Things that went well&lt;/h2&gt;
&lt;p&gt;I found that my professional network was very useful this Summer. My
experience has been that networking effects take time to build up, but
they yield information that would be difficult to obtain any other
way. People I met at the Recurse Center offered to connect me with
managers they knew. Conferences I had attended some years ago produced
useful leads on new jobs. Friends from grad school who had startup
experience and other scientific expertise gave me valuable advice
about whether certain jobs would be a good fit.&lt;/p&gt;
&lt;p&gt;Previously, I was uncertain about whether having a blog was especially
useful. My website was very helpful on this job search. Multiple
interviewers mentioned reading through my posts and asked me questions
about past projects I had documented. If I had one recommendation for
new software developers, it would be to start keeping a blog
early. Add a technical post every month or two. Github pages makes
this really easy (and it's free). I now feel pretty confident that a
blog is a good way to "make a name for yourself" especially if you're
interested in somewhat niche topics.&lt;/p&gt;
&lt;p&gt;Due to the pandemic, the chances of an onsite interview were basically
zero. I knew that I would need to come across well on video so I set
up my home office such that I would be in front of a plain white wall
with a whiteboard. This ensured I could easily talk through a design
if I needed. I wore a dress shirt for all of my interviews;
essentially the same outfit I wore when I worked in an office in
Boston. I'm not sure that this was strictly necessary, but I think it
gave me a small psychological boost and communicated that I was a
reliable professional with a quality home office.&lt;/p&gt;
&lt;p&gt;I spent a fair amount of time preparing questions for interviewers,
especially longer on-site interviews. I found that it can be very
helpful to frame questions in a way that's quantitative and does not
contain a value judgement. For example, instead of asking "How stable
is your production environment?" (value judgement, qualitative) I
instead asked "How many times have you been paged in the last 6
months?" (quantitative). This approach yielded more quantitative &lt;em&gt;and&lt;/em&gt;
qualitative data about a company's technology, so that I was better
informed about the day to day experience of working in a particular
role.&lt;/p&gt;
&lt;p&gt;The final thing that I did well was to end some interview processes
early, when I identified that the company or manager wasn't a good fit
for me. Some hiring managers were very pushy about knowing my "three
greatest weaknesses" or my past salary. I decided not to deal with
them further after a first interview, which saved everyone time and
effort. I also terminated some interview processes because managers
described business goals that didn't make sense to me. I used the
following test: "How would my former tech leads react if I presented
this proposal to them?" If the answer was "very negatively", I often
reconsidered whether to continue with an interview.&lt;/p&gt;
&lt;h2&gt;Feedback&lt;/h2&gt;
&lt;p&gt;Interviewing is always somewhat stressful. If you're in the midst of a
job search, my main advice is: Hang in there, you'll find a job if
you're persistent and ask the right questions.&lt;/p&gt;
&lt;p&gt;If you found this post useful (or conversely, think that this advice
is bad), send me an email. My contact information is listed on the
&lt;a href="/"&gt;About&lt;/a&gt; page.&lt;/p&gt;</content><category term="Jobs"></category></entry><entry><title>How to send emails from Dream</title><link href="https://jsthomas.github.io/ocaml-email.html" rel="alternate"></link><published>2021-07-23T00:00:00-04:00</published><updated>2021-07-23T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2021-07-23:/ocaml-email.html</id><summary type="html">&lt;p&gt;How to build an email queue system for a Dream web server.&lt;/p&gt;</summary><content type="html">&lt;p&gt;I recently &lt;a href="https://github.com/aantron/dream/issues/138"&gt;learned&lt;/a&gt; the
OCaml ecosystem has most of the libraries needed to build email
features, but I wasn't able to find an example that brings all of
those pieces together. I wanted a simple example I could easily adapt
to build common account verification and password recovery workflows
in the Dream web framework. This post is my attempt to solve that
problem and explain what I learned in the process. The accompanying
code can be found
&lt;a href="https://github.com/jsthomas/dream-email-example"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;Defining the problem&lt;/h2&gt;
&lt;p&gt;As an application developer, my main concerns when
sending mail are:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Trying to ensure the address I'm sending to is valid.&lt;/li&gt;
&lt;li&gt;Handling the email synthesis process asynchronously, so it doesn't
   block the web server from handling requests quickly.&lt;/li&gt;
&lt;li&gt;Transmitting the email content (SMTP or a REST API call)&lt;/li&gt;
&lt;li&gt;Monitoring that the applications messages aren't getting
   blocked/dropped for some reason.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;To test how easily I could satisfy these requirements, I built a web
app that lets the user send an arbitary email.&lt;/p&gt;
&lt;p&gt;&lt;img alt="A screenshot of the email form." src="https://jsthomas.github.io/images/ocaml-email/screenshot.png" style="width: 671px; height: auto;"/&gt;&lt;/p&gt;
&lt;p&gt;The app has two parts:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A server process responsible for showing the form above and
  validating user inputs.&lt;/li&gt;
&lt;li&gt;A "worker" process responsible for sending mail. The worker gets its
  tasks from a queue populated by the server.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Validating Email Addresses&lt;/h2&gt;
&lt;p&gt;I decided to utilize the library
&lt;a href="https://github.com/dinosaure/emile"&gt;&lt;code&gt;emile&lt;/code&gt;&lt;/a&gt; for address
validation. An email address might be invalid for reasons outside of
the application's control (like the domain going way), but &lt;code&gt;emile&lt;/code&gt; at
least provides a way to check a given string conforms to 5(!) RFCs
relevant to parsing email addresses. Check out the
&lt;a href="https://github.com/dinosaure/emile/blob/master/test/test.ml#L34"&gt;tests&lt;/a&gt;
to see the impressive diversity of valid email addresses on the web.&lt;/p&gt;
&lt;p&gt;The library provides several different predicates for checking
addresses. I utilized &lt;code&gt;Emile.of_string&lt;/code&gt;, which generates a simple
result type, like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;form_post&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;match&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;form&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"address"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="s2"&gt;"message"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="s2"&gt;"subject"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;subject&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Emile&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;of_string&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
      &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;alert&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sprintf&lt;/span&gt; &lt;span class="s2"&gt;"Sent an email to %s."&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Error&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sprintf&lt;/span&gt; &lt;span class="s2"&gt;"%s is not a valid email address."&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt;
      &lt;span class="k"&gt;in&lt;/span&gt;
      &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;queue_req&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;queue_email&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt; &lt;span class="n"&gt;subject&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Error&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;return_unit&lt;/span&gt;
    &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="n"&gt;queue_req&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;fun&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
        &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;html&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Template&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;show_form&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;alert&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;empty&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="nc"&gt;Bad_Request&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This way, if a user provides an invalid address, the form displays a simple
warning message and won't queue any email tasks.&lt;/p&gt;
&lt;h2&gt;Queuing Tasks with RabbitMQ&lt;/h2&gt;
&lt;p&gt;The second issue I needed to address is handling the email send
process with a background worker (&lt;code&gt;queue_email&lt;/code&gt; in the code excerpt
above). Sending an email can be a slow process, especially if you need
to make additional database queries or render images to produce a
customized email. That shouldn't block the web server from quickly
responding to the user's requests. Instead, the server should record
the email task in a &lt;em&gt;queue&lt;/em&gt;, to be handled by a background worker that
isn't as sensitive to latency.&lt;/p&gt;
&lt;p&gt;There are several different technologies that can be used to solve
this problem, for example &lt;a href="https://www.rabbitmq.com/"&gt;RabbitMQ&lt;/a&gt;,
&lt;a href="https://redislabs.com/ebook/part-2-core-concepts/chapter-6-application-components-in-redis/6-4-task-queues/6-4-1-first-in-first-out-queues/"&gt;Redis&lt;/a&gt;
and &lt;a href="https://aws.amazon.com/sqs/"&gt;SQS&lt;/a&gt;. I decided to use RabbitMQ
because I didn't want to tie my implementation to one cloud provider
and RabbitMQ is supported by
&lt;a href="https://github.com/andersfugmann/amqp-client"&gt;amqp-client&lt;/a&gt; on
OPAM. This isn't the only way to go: for Redis and SQS, you might have
success with the packages
&lt;a href="https://opam.ocaml.org/packages/redis/"&gt;redis&lt;/a&gt; or
&lt;a href="https://opam.ocaml.org/packages/aws-sqs/"&gt;aws-sqs&lt;/a&gt;, respectively.&lt;/p&gt;
&lt;p&gt;The worker and server process share a common function for establishing
a connection to RabbitMQ:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;rabbit_connection&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Connection&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connect&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"dream"&lt;/span&gt; &lt;span class="s2"&gt;"localhost"&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Connection&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;open_channel&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"email"&lt;/span&gt; &lt;span class="nn"&gt;Channel&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;no_confirm&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;queue&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Queue&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;declare&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;:[&lt;/span&gt;&lt;span class="nn"&gt;Rpc&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nn"&gt;Server&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_argument&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="s2"&gt;"email"&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;return&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I was initially little confused about why I needed a "channel" when I
already had a connection to the broker. Both the worker and the server
connect to the RabbitMQ Broker via TCP. It's common for clients to
need several connections to the broker, but it's costly to have many
TCP connections. RabbitMQ lets us avoid this cost with channels, which
are like "lightweight connections that share a single TCP
connection", according to these &lt;a href="https://www.rabbitmq.com/channels.html"&gt;docs&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I created this function to submit messages to the queue:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;type&lt;/span&gt; &lt;span class="n"&gt;email&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;subject&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="o"&gt;[@@&lt;/span&gt;&lt;span class="n"&gt;deriving&lt;/span&gt; &lt;span class="n"&gt;yojson&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;

&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;queue_email&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt; &lt;span class="n"&gt;subject&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;email&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;subject&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;email&lt;/span&gt; &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;yojson_of_email&lt;/span&gt; &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Yojson&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nn"&gt;Safe&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_string&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;queue&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;rabbit_connection&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Queue&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;publish&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="n"&gt;queue&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Message&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;make&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;return_unit&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here the server writes the address, subject, and text into a record
type that can be serialized to JSON before being pushed into the queue.&lt;/p&gt;
&lt;p&gt;The worker process, &lt;code&gt;queue_worker&lt;/code&gt;, is fairly simple to define:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;handle_message&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nn"&gt;Message&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;snd&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;email&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;
      &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Yojson&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nn"&gt;Safe&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from_string&lt;/span&gt; &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;email_of_yojson&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"Received invalid email record from RabbitMQ: %s"&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
      &lt;span class="nc"&gt;None&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;email&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;send_email&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;return_unit&lt;/span&gt;


&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;queue_worker&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"Starting Queue Worker&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;queue&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;rabbit_connection&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;rec&lt;/span&gt; &lt;span class="n"&gt;handle&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="nn"&gt;Queue&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;no_ack&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="bp"&gt;true&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="n"&gt;queue&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="k"&gt;fun&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;task&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
      &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;flush&lt;/span&gt; &lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;handle_message&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;
      &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"No new tasks, waiting.&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;flush&lt;/span&gt; &lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="nn"&gt;Lwt_unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
    &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="n"&gt;task&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="n"&gt;handle&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="n"&gt;handle&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The worker consists of an infinite loop. When the worker wakes and
finds tasks in the queue, it uses &lt;code&gt;yojson&lt;/code&gt; to deserialize the
messages and passes them to &lt;code&gt;send_email&lt;/code&gt;. If no work is available,
the worker just sleeps for 5 seconds.&lt;/p&gt;
&lt;h2&gt;Sending Email with &lt;code&gt;cohttp&lt;/code&gt; and Mailgun&lt;/h2&gt;
&lt;p&gt;In order to send mail, I set up a trial
&lt;a href="https://documentation.mailgun.com/en/latest/quickstart-sending.html#send-via-smtp"&gt;Mailgun&lt;/a&gt;
account. I selected this provider for several reasons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Mailgun has a generous free tier (5000 emails).&lt;/li&gt;
&lt;li&gt;A new account also comes with a "sandbox" domain, so I didn't have
  to deal with registering a domain.&lt;/li&gt;
&lt;li&gt;Mailgun supports both a REST API and SMTP, allowing me to try
  different integrations.&lt;/li&gt;
&lt;li&gt;Mailgun provides dashboards for tracking messages sent over time as
  well as emails that were rejected (bounced, marked as spam, etc.).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Mailgun's API allowed me to send an email by sending a POST with an API key and form
data, like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;send_email&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;email&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
   &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;open&lt;/span&gt; &lt;span class="nc"&gt;Cohttp&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
   &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;open&lt;/span&gt; &lt;span class="nc"&gt;Cohttp_lwt_unix&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;

   &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;api_key&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getenv&lt;/span&gt; &lt;span class="s2"&gt;"MAILGUN_API_KEY"&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
   &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;sender&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getenv&lt;/span&gt; &lt;span class="s2"&gt;"MAILGUN_SEND_ADDRESS"&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
   &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;api_base&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getenv&lt;/span&gt; &lt;span class="s2"&gt;"MAILGUN_API_BASE"&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;

   &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;
     &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"from"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;sender&lt;/span&gt;&lt;span class="o"&gt;]);&lt;/span&gt;
     &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"to"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="o"&gt;]);&lt;/span&gt;
     &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"subject"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;subject&lt;/span&gt;&lt;span class="o"&gt;]);&lt;/span&gt;
     &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"text"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="o"&gt;])&lt;/span&gt;
   &lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
   &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;cred&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="nc"&gt;Basic&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"api"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;api_key&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
   &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;uri&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;api_base&lt;/span&gt; &lt;span class="o"&gt;^&lt;/span&gt; &lt;span class="s2"&gt;"/messages"&lt;/span&gt; &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Uri&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;of_string&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
   &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;headers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Header&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_authorization&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Header&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;init&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;cred&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
   &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
     &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"Initiating email send to %s.&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
     &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gettimeofday&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
   &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rbody&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Client&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post_form&lt;/span&gt; &lt;span class="n"&gt;uri&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;headers&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
   &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;finish&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gettimeofday&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;return&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
   &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;rbody_str&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Cohttp_lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nn"&gt;Body&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_string&lt;/span&gt; &lt;span class="n"&gt;rbody&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
   &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"API Response Status: %d.&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Code&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;code_of_status&lt;/span&gt; &lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
   &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"API Response body %s.&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="n"&gt;rbody_str&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
   &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"Time to send an email: %.2fs&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;finish&lt;/span&gt; &lt;span class="o"&gt;-.&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
   &lt;span class="nn"&gt;Lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The endpoint replies with either 200 and a JSON body like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="nt"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;some mailgun email address here&amp;gt;"&lt;/span&gt;
  &lt;span class="s2"&gt;"message"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;"Queued. Thank you."&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;or else a 400 and an explanation of why the request was rejected. In
my tests, a successful API request typically took between 0.5 and 1
seconds. For comparison, the webserver can serve the email form in
less than 200 microseconds, so the performance benefits to shifting
email tasks to a background queue are nontrivial.&lt;/p&gt;
&lt;h2&gt;Sending email with SMTP&lt;/h2&gt;
&lt;p&gt;Mailgun supports SMTP but they recommend using their API, especially
for sending large amounts of mail at once. I used
&lt;a href="https://github.com/oxidizing/letters/"&gt;letters&lt;/a&gt; to test their SMTP
support with this script:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Letters&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;Plain&lt;/span&gt; &lt;span class="o"&gt;{|&lt;/span&gt;&lt;span class="nc"&gt;This&lt;/span&gt; &lt;span class="n"&gt;is&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="n"&gt;test&lt;/span&gt; &lt;span class="n"&gt;email&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;.|}&lt;/span&gt;

&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;send_email&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Letters&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nn"&gt;Config&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;make&lt;/span&gt;
      &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nn"&gt;Sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getenv&lt;/span&gt; &lt;span class="s2"&gt;"MAILGUN_SMTP_USER"&lt;/span&gt;
      &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nn"&gt;Sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getenv&lt;/span&gt; &lt;span class="s2"&gt;"MAILGUN_SMTP_PASSWORD"&lt;/span&gt;
      &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;hostname&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"smtp.mailgun.org"&lt;/span&gt;
      &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;with_starttls&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;sender&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getenv&lt;/span&gt; &lt;span class="s2"&gt;"MAILGUN_SMTP_SENDER"&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;recipients&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="nn"&gt;Letters&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;To&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getenv&lt;/span&gt; &lt;span class="s2"&gt;"EMAIL_ADDRESS"&lt;/span&gt;&lt;span class="o"&gt;)]&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;subject&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"Test email from mailgun."&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;mail&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Letters&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;build_email&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="n"&gt;sender&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;recipients&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;subject&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;

  &lt;span class="nn"&gt;Printexc&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;record_backtrace&lt;/span&gt; &lt;span class="bp"&gt;true&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;mail&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt;
       &lt;span class="nn"&gt;Letters&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;sender&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;recipients&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt;
      &lt;span class="n"&gt;e&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"Error. %s&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Printexc&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_string&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
      &lt;span class="nn"&gt;Printexc&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;print_backtrace&lt;/span&gt; &lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
      &lt;span class="nn"&gt;Lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;return_unit&lt;/span&gt;
   &lt;span class="o"&gt;)&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Error&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"Message synthesis failed."&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;flush&lt;/span&gt; &lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="nn"&gt;Lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;return_unit&lt;/span&gt;


&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="nn"&gt;Lwt_main&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="n"&gt;send_email&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I ran into some
&lt;a href="https://github.com/oxidizing/letters/issues/35"&gt;difficulties&lt;/a&gt; because
Mailgun does not consistently follow RFC 4954 (thanks to Calascibetta
Romain for figuring out the problem and creating a
&lt;a href="https://github.com/mirage/colombe/pull/41"&gt;patch&lt;/a&gt;). Once I applied
the patch, I was able to send mail successfully.&lt;/p&gt;
&lt;p&gt;I haven't fully explored the tradeoffs of using SMTP versus an
API. The main goal of my experiements was to confirm that if I needed
to integrate with a specific SMTP server, I knew how to do so.&lt;/p&gt;
&lt;h2&gt;Discussion&lt;/h2&gt;
&lt;p&gt;This example focused on email, but task queues and background workers
can be used to implement other important pieces of functionality for
web applications. For example, I've utilized
&lt;a href="https://docs.celeryproject.org/en/stable/getting-started/introduction.html"&gt;celery&lt;/a&gt;
in the past to generate weekly reports and schedule recurring ETL
jobs. This exercise was a nice opportunity to see how one would
construct a system similar to &lt;code&gt;celery&lt;/code&gt; in OCaml. It also provides a
simple illustration of how we can utilize queues to facilitate
horizontal scaling. If the volume of email requests grows too big for
one machine, we can put the web server and the worker on separate
instances or have multiple worker instances consuming from the email
queue.&lt;/p&gt;
&lt;p&gt;I didn't cover error handling in this example, but that's clearly an
important piece of functionality to include when building a production
email system. At a minimum, it would be useful to add a retry
mechanism in the event that Mailgun is unavailable.&lt;/p&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;p&gt;I found the resources below helpful for working on this project:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The &lt;code&gt;amqp-client&lt;/code&gt;
&lt;a href="https://andersfugmann.github.io/amqp-client/amqp-client-lwt/index.html"&gt;documentation&lt;/a&gt;,
  especially the
  &lt;a href="https://github.com/andersfugmann/amqp-client/tree/master/examples"&gt;examples&lt;/a&gt;
  were helpful for setting up with RabbitMQ.&lt;/li&gt;
&lt;li&gt;The &lt;a href="https://github.com/mirage/ocaml-cohttp#client-tutorial"&gt;client
  tutorial&lt;/a&gt;
  was helpful for getting started with &lt;code&gt;cohttp&lt;/code&gt;. Later, I utilized
  &lt;a href="https://mirage.github.io/ocaml-cohttp/cohttp-lwt-unix/Cohttp_lwt_unix/Client/index.html"&gt;this
  section&lt;/a&gt;
  of the docs to understand that I needed to use &lt;code&gt;post_form&lt;/code&gt; instead
  of &lt;code&gt;post&lt;/code&gt; when interacting with Mailgun's API.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Feedback&lt;/h2&gt;
&lt;p&gt;If you ended up looking through the source code for this example, let
me know how what you thought! I'm interested in adding more tutorial
resources to the OCaml ecosystem, so feel free to post a PR or issue
to
&lt;a href="https://github.com/jsthomas/dream-email-example"&gt;dream-email-example&lt;/a&gt;
if you have ideas about how to make these resources better.&lt;/p&gt;</content><category term="OCaml"></category></entry><entry><title>Writing a REST API with Dream</title><link href="https://jsthomas.github.io/ocaml-dream-api.html" rel="alternate"></link><published>2021-07-12T00:00:00-04:00</published><updated>2021-07-12T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2021-07-12:/ocaml-dream-api.html</id><summary type="html">&lt;p&gt;Writing a REST API in Dream&lt;/p&gt;</summary><content type="html">&lt;p&gt;In the last few weeks I've been building a simple REST API using the
&lt;a href="https://aantron.github.io/dream/"&gt;Dream&lt;/a&gt; web framework. Writing APIs
has been one major component of my paid programming work and I wanted
to compare and contrast the experience of writing an API in a strongly
typed functional programming language with the same workflow in a
dynamically typed language like Python.&lt;/p&gt;
&lt;p&gt;You can find the source code for this project
&lt;a href="https://github.com/jsthomas/sensors"&gt;here&lt;/a&gt;. Hopefully, this repo will
be a useful resource for anyone who wants to look at a slightly larger
example application that uses Dream. Though I'm still a beginner, I
was surprised how easy it was to complete familiar tasks in this
framework. I'm optimistic about the future of web programming in
OCaml!&lt;/p&gt;
&lt;p&gt;This post provides a sort of "experience report" for working with
Dream, Yojson, and Caqti. Obviously, these types of reports are highly
subjective and you should run your own experiments too!  I'll be
comparing with my experience in working with
&lt;a href="https://trypyramid.com/"&gt;Pyramid&lt;/a&gt; and
&lt;a href="https://www.sqlalchemy.org/"&gt;SQLAlchemy&lt;/a&gt;, since those are the Python
projects I've used most.&lt;/p&gt;
&lt;p&gt;Finally, it's important to point out that Dream is in alpha (version
&lt;code&gt;1.0.0~alpha2&lt;/code&gt; as of this writing). This is an early version!
Comparisons with frameworks like Pyramid or Flask are in some sense
apples-and-oranges, because those projects have had a long time (and
many engineering hours) to mature. Ultimately, the point of this post
(and the repo that goes with it) isn't to make make value judgements
("framework X is good, Y is bad"), but rather to understand how to
translate concepts from one workflow to another.&lt;/p&gt;
&lt;h2&gt;Problem Definition&lt;/h2&gt;
&lt;p&gt;I decided to build a API for managing time series data. My
requirements for the project were as follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The API will allow creating, reading, and deleting "sensors". A
  sensor is an abstract IoT device that measures a floating point
  quantity at a specific cadence (for example a weather station
  measuring average hourly windspeed).&lt;/li&gt;
&lt;li&gt;Every sensor gets an API key that allows it to upload (POST) data to
  an endpoint.&lt;/li&gt;
&lt;li&gt;A GET endpoint will allow users to retrieve the data a sensor
  generated between two dates.&lt;/li&gt;
&lt;li&gt;The API sends and receives data formatted as JSON and must be backed
  by a PostgreSQL database.&lt;/li&gt;
&lt;li&gt;The API should have &lt;code&gt;login/logout&lt;/code&gt; endpoints for a (not yet built)
  frontend to use.&lt;/li&gt;
&lt;li&gt;Finally, a user should only be allowed to access sensor data that
  belongs to them.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I chose these requirements because they cover a number of different
read/write operations that require data formatting/parsing and
tracking relationships between four different entities (users, keys,
sensors, and readings).&lt;/p&gt;
&lt;h2&gt;Dependencies and Setup&lt;/h2&gt;
&lt;p&gt;For this build, I needed three core dependencies:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;A server to handle web requests (Dream).&lt;/li&gt;
&lt;li&gt;Support for parsing and synthesizing JSON records.&lt;/li&gt;
&lt;li&gt;A library for integrating with PostgreSQL.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;After a bit of research, I settled on
&lt;a href="https://opam.ocaml.org/packages/yojson/"&gt;Yojson&lt;/a&gt; and
&lt;a href="https://opam.ocaml.org/packages/caqti/"&gt;Caqti&lt;/a&gt; for (2) and (3)
respectively. Both of these are fairly standard and appear in the
excellent corpus of
&lt;a href="https://github.com/aantron/dream/tree/master/example"&gt;examples&lt;/a&gt; that
accompany Dream. Since I had previously written an
&lt;a href="https://github.com/aantron/dream/tree/master/example/w-docker-postgres"&gt;example&lt;/a&gt;
of how to use Dream with a dockerized PostrgreSQL container, I used
that as a starting point.&lt;/p&gt;
&lt;p&gt;It's useful to have a way to run (and re-run) ad-hoc requests against
the API during development. I used &lt;a href="https://insomnia.rest/"&gt;Insomnia&lt;/a&gt;
for this, but other tools like &lt;code&gt;curl&lt;/code&gt; would work too.&lt;/p&gt;
&lt;h2&gt;Adding an endpoint&lt;/h2&gt;
&lt;p&gt;To give a sense of my development workflow, I want to walk through my
process for adding a simple endpoint, &lt;code&gt;/api/login&lt;/code&gt;. Inside the router,
that endpoint looks like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt; &lt;span class="s2"&gt;"/api/login"&lt;/span&gt; &lt;span class="n"&gt;login&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In this excerpt &lt;code&gt;login&lt;/code&gt; is a "handler". Handlers are responsible for
translating requests into responses; this is captured in their &lt;a href="https://aantron.github.io/dream/#type-handler"&gt;type
signature&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Conceptually, the &lt;code&gt;login&lt;/code&gt; handler needs to do three things:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Receive a JSON body and confirm it's formatted as expected.&lt;/li&gt;
&lt;li&gt;Look up the relevant user/password combination in the database.&lt;/li&gt;
&lt;li&gt;Load the relevant session information if the credentials are valid.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;For the first part, the endpoint needs to receive a JSON payload that
looks like &lt;code&gt;{"username": "...", "password": "..."}&lt;/code&gt;. To describe that
payload, I introduced a simple record type:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;type&lt;/span&gt; &lt;span class="n"&gt;login_doc&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;username&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;password&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="o"&gt;[@@&lt;/span&gt;&lt;span class="n"&gt;deriving&lt;/span&gt; &lt;span class="n"&gt;yojson&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Adding &lt;code&gt;[@@deriving yojson]&lt;/code&gt; means the compiler can generate functions
to convert these records to and from JSON. In this case those
functions are called &lt;code&gt;login_doc_of_yojson&lt;/code&gt; and &lt;code&gt;yojson_of_login_doc&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;My &lt;code&gt;login&lt;/code&gt; handler looked roughly like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;json_receiver&lt;/span&gt; &lt;span class="n"&gt;json_parser&lt;/span&gt; &lt;span class="n"&gt;handler&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;
      &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;
      &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Yojson&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nn"&gt;Safe&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from_string&lt;/span&gt;
      &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;json_parser&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="nc"&gt;None&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;doc&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;handler&lt;/span&gt; &lt;span class="n"&gt;doc&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"Received invalid JSON input."&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;
    &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;yojson_of_error_doc&lt;/span&gt;
    &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;json_response&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="nc"&gt;Bad_Request&lt;/span&gt;


&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;login&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;login_base&lt;/span&gt; &lt;span class="n"&gt;login_doc&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;user_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sql&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;
        &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Models&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nn"&gt;User&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="n"&gt;login_doc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt; &lt;span class="n"&gt;login_doc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;user_id&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;invalidate_session&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
      &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;put_session&lt;/span&gt; &lt;span class="s2"&gt;"user"&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Int&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_string&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
      &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;empty&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="nc"&gt;OK&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;empty&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="nc"&gt;Forbidden&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="n"&gt;json_receiver&lt;/span&gt; &lt;span class="n"&gt;login_doc_of_yojson&lt;/span&gt; &lt;span class="n"&gt;login_base&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If a user uploads an invalid JSON body, this will cause
&lt;code&gt;login_doc_of_yojson&lt;/code&gt; to throw an exception. By default, this produces
a 500 server error response. To handle this situation more gracefully,
I introduced &lt;code&gt;json_receiver&lt;/code&gt;. If the parser passed to &lt;code&gt;json_receiver&lt;/code&gt;
succeeds on the request body, the results are passed to the inner
handler. Otherwise, the server responds with a &lt;code&gt;400 Bad
Request&lt;/code&gt;. Re-using &lt;code&gt;json_receiver&lt;/code&gt; across my endpoints allows me to
avoid introducing a&lt;code&gt;try/with&lt;/code&gt; block any time time I need to handle
JSON input.&lt;/p&gt;
&lt;p&gt;I decided to manage models in a separate library, &lt;code&gt;Models&lt;/code&gt;. The
build tool, &lt;code&gt;dune&lt;/code&gt;, made this easy to do; I just needed separate
&lt;code&gt;dune&lt;/code&gt; files for the &lt;code&gt;server/model&lt;/code&gt; and &lt;code&gt;server/bin&lt;/code&gt; folders. I like
this design because it simplifies re-use of the database portion of my
project. For example, if I later needed to build a CLI admin tool,
that tool could utilize my existing queries without being exposed to
API concerns.&lt;/p&gt;
&lt;p&gt;Inside &lt;code&gt;User&lt;/code&gt;, the &lt;code&gt;get&lt;/code&gt; query function is defined as:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;query&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="nn"&gt;R&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find_opt&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tup2&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;int&lt;/span&gt;
      &lt;span class="s2"&gt;"SELECT id FROM app_user WHERE username = ? and password = ?"&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;fun&lt;/span&gt; &lt;span class="n"&gt;username&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;module&lt;/span&gt; &lt;span class="nc"&gt;Db&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nc"&gt;DB&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;user_or_error&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find_opt&lt;/span&gt; &lt;span class="n"&gt;query&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="nn"&gt;Caqti_lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;or_fail&lt;/span&gt; &lt;span class="n"&gt;user_or_error&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Caqti allows us to define a function that consumes our query
parameters (the username and password) along with a database
connection, and produces a promise that will resolve with the results
of the query. In this case, the types encode that the function
produces an &lt;code&gt;int option&lt;/code&gt; containing the user's primary key if the
credentials are valid. (Note that it's not a good idea to store
passwords in plain text like this; this is just for illustrative
purposes.)&lt;/p&gt;
&lt;p&gt;Session management, the final item that the endpoint needs to address,
is handled by Dream. The framework allows sessions to be stored in
cookies, memory, or the database; I opted for database sessions
because I had used similar session backends in the past. Sessions
allow us to store pairs key/value strings across requests. I used the
session just to store the logged-in user's ID, so that the API has
easy access in later database queries.&lt;/p&gt;
&lt;h2&gt;Thoughts on the Dream Router&lt;/h2&gt;
&lt;p&gt;The final router for my server looked like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;interface&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"0.0.0.0"&lt;/span&gt;
  &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;logger&lt;/span&gt;
  &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sql_pool&lt;/span&gt; &lt;span class="s2"&gt;"postgresql://sensors@127.0.0.1/sensors"&lt;/span&gt;
  &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sql_sessions&lt;/span&gt;
  &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;router&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;
    &lt;span class="c"&gt;(* More endpoints here ... *)&lt;/span&gt;

    &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="s2"&gt;"/version"&lt;/span&gt; &lt;span class="n"&gt;version&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt; &lt;span class="s2"&gt;"/api/login"&lt;/span&gt; &lt;span class="n"&gt;login&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt; &lt;span class="s2"&gt;"/api/logout"&lt;/span&gt; &lt;span class="n"&gt;logout&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="s2"&gt;"/api"&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;login_required&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;
      &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="s2"&gt;"/user/:user_id"&lt;/span&gt; &lt;span class="n"&gt;user&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
      &lt;span class="c"&gt;(* More endpoints here... *)&lt;/span&gt;
    &lt;span class="o"&gt;];&lt;/span&gt;

    &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="s2"&gt;"/sensor"&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;
      &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt; &lt;span class="s2"&gt;"/upload"&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="n"&gt;api_key_required&lt;/span&gt; &lt;span class="n"&gt;sensor_upload&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;not_found&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I really appreciate how Dream makes it possible to get a concise
overview of the API; in some Pyramid projects, I found this wasn't
always possible. In fact, in Pyramid I sometimes struggled with subtle
routing bugs that were not obvious until run time. Having the compiler
validate the router in Dream was a welcome change.&lt;/p&gt;
&lt;p&gt;At the moment, Pyramid makes it somewhat easier to handle
access/permissions concerns compared to Dream. Working in Pyramid, it
was relatively common for the routes to manage some amount of
parameter validation and permissions. For example, given a path
&lt;code&gt;/user/123/article/abc456&lt;/code&gt;, the route (or "resources" in Pyramid
terminology) would be responsible for:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Extracting the user and article IDs (&lt;code&gt;123&lt;/code&gt; and &lt;code&gt;abc456&lt;/code&gt;).&lt;/li&gt;
&lt;li&gt;Determining those records actually exist in the database, and
  passing them to the view/handler in a context record.&lt;/li&gt;
&lt;li&gt;Validating that the requester has permissions to operate on those
User and Article records.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is discussed a bit more in the Pyramid Docs under &lt;a href="https://docs.pylonsproject.org/projects/pyramid/en/latest/narr/traversal.html"&gt;URL
traversal&lt;/a&gt;.
Effectively, Pyramid resources mean that handler/view code downstream
can focus on updating database records and/or rendering HTML/JSON
without worrying about permissions concerns.&lt;/p&gt;
&lt;p&gt;I didn't want to build a permissions system for my API so instead I
incorporated User IDs into my function signatures in &lt;code&gt;Model&lt;/code&gt; and used
inner joins to model permissions. For example, here is an example of a
query that fetches the metadata for all sensors belonging to a
particular user:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;description&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;k&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;uuid&lt;/span&gt;
&lt;span class="k"&gt;FROM&lt;/span&gt; &lt;span class="n"&gt;sensor&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;
&lt;span class="k"&gt;INNER&lt;/span&gt; &lt;span class="k"&gt;JOIN&lt;/span&gt; &lt;span class="n"&gt;user_sensor&lt;/span&gt; &lt;span class="n"&gt;us&lt;/span&gt;
 &lt;span class="k"&gt;ON&lt;/span&gt; &lt;span class="n"&gt;us&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sensor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="k"&gt;AND&lt;/span&gt; &lt;span class="n"&gt;us&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;app_user&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="k"&gt;AND&lt;/span&gt; &lt;span class="n"&gt;us&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sensor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;
&lt;span class="k"&gt;INNER&lt;/span&gt; &lt;span class="k"&gt;JOIN&lt;/span&gt; &lt;span class="n"&gt;api_key&lt;/span&gt; &lt;span class="n"&gt;k&lt;/span&gt;
 &lt;span class="k"&gt;ON&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;api_key&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;k&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By joining against &lt;code&gt;user_sensor&lt;/code&gt;, I ensure that a user only gets data
for the sensors they own.&lt;/p&gt;
&lt;p&gt;I should point out that Dream allows us to use a custom router,
however! The project has &lt;a href="https://github.com/aantron/dream/issues/122"&gt;an
issue&lt;/a&gt; for more elaborate
routing and Ulrik Strid has introduced
&lt;a href="https://github.com/ulrikstrid/dream-routes"&gt;dream-routes&lt;/a&gt;, which
allows additional type information to be encoded in routes. So,
writing a more sophisticated router that behaves like Pyramid's
resource system is certainly possible.&lt;/p&gt;
&lt;h2&gt;Comparing Caqti and SQLAlchemy&lt;/h2&gt;
&lt;p&gt;As a web programmer, especially one working on an analytics project,
it's important to get comfortable working with the database library
you've chosen for your project. Indeed, a significant portion of this
project consisted of familiarizing myself with &lt;code&gt;Caqti&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Caqti is a bit different from SQLAlchemy. With SQLAlchemy, you
typically define one class for each table. Then, using SQLAlchemy's
metaprogramming features, those classes are used to define
queries. For comparison, here are equivalent queries against the user
table:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Caqti&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;query&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="nn"&gt;R&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find_opt&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tup2&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;int&lt;/span&gt;
      &lt;span class="s2"&gt;"SELECT id FROM app_user WHERE username = ? and password = ?"&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;fun&lt;/span&gt; &lt;span class="n"&gt;username&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;module&lt;/span&gt; &lt;span class="nc"&gt;Db&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nc"&gt;DB&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;user_or_error&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find_opt&lt;/span&gt; &lt;span class="n"&gt;query&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="nn"&gt;Caqti_lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;or_fail&lt;/span&gt; &lt;span class="n"&gt;user_or_error&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;SQLAlchemy&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;db&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; \
    &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;username&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;password&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;one_or_none&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Working with Caqti, a mistake in the syntax of a SQL query won't be
discovered until runtime. I made fewer mistakes like this with
SQLAlchemy because most queries are written in Python and can be
linted by the IDE. Another recurring point of confusion for me with
Caqti had to do with matching the function on the &lt;code&gt;Caqti_request&lt;/code&gt;
(&lt;code&gt;R.find_opt&lt;/code&gt; above) with the function invoked in &lt;code&gt;Db&lt;/code&gt;
(&lt;code&gt;Db.find_opt&lt;/code&gt;); this is how we indicate that the query produces zero,
one, zero/one, or multiple rows. If the two don't agree, the program
won't compile; initially I struggled to understand what this
compiler error meant:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;The&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="n"&gt;applied&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt; &lt;span class="n"&gt;argument&lt;/span&gt; &lt;span class="n"&gt;has&lt;/span&gt; &lt;span class="n"&gt;type&lt;/span&gt;
         &lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;:(&lt;/span&gt;&lt;span class="n"&gt;Caqti_driver_info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;t&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Caqti_query&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;t&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
         &lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="n"&gt;oneshot&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="n"&gt;bool&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
         &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;unit&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;[&amp;lt;&lt;/span&gt; &lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="n"&gt;Many&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="n"&gt;One&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="n"&gt;Zero&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="n"&gt;Zero&lt;/span&gt; &lt;span class="o"&gt;])&lt;/span&gt; &lt;span class="n"&gt;Caqti_request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;t&lt;/span&gt;
&lt;span class="n"&gt;This&lt;/span&gt; &lt;span class="n"&gt;argument&lt;/span&gt; &lt;span class="n"&gt;cannot&lt;/span&gt; &lt;span class="n"&gt;be&lt;/span&gt; &lt;span class="n"&gt;applied&lt;/span&gt; &lt;span class="n"&gt;without&lt;/span&gt; &lt;span class="n"&gt;label&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Using Caqti became easier as I became accustomed to thinking in terms of
prepared queries. About halfway through the project I realized I
needed to switch from SQLite to PostgreSQL, and changing databases was
fairly painless because Caqti supports both.&lt;/p&gt;
&lt;p&gt;I also made use of Caqti's features for dealing with custom column
types. Caqti does not have built-in support for JSON columns, but
adding a custom column type to handle this was straightforward:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;type&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;readings&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nc"&gt;float&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;option&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;array&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;@@deriving yojson&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;sql_readings&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nl"&gt;a&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;readings&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Ok&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;yojson_of_readings&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Yojson&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Safe&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_string&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="ow"&gt;in&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;decode&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nc"&gt;text&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Ok&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;text&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Yojson&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Safe&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from_string&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;readings_of_yojson&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="ow"&gt;in&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.(&lt;/span&gt;&lt;span class="n"&gt;custom&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;decode&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In my case, the JSON that I needed to store consisted of arrays of
floating point numbers, so building the custom type was simply a
matter of connecting Yojson and Caqti in the right way.&lt;/p&gt;
&lt;h2&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Ever since I started building web applications in Python, I've thought
of an API server as a big function that transforms requests into
responses, with any nontrivial state residing in databases or services
like S3. Dream provides a modern web framework that matches my mental
model for how a web server should work.&lt;/p&gt;
&lt;p&gt;Web programming in OCaml "feels" a bit different than working in
Python. In Python it's possible to get something running quickly, but
it's also easy to forget corner cases and introduce defects that have
to be addressed later in the application's lifecycle. An OCaml project
requires some up-front investment, but this investment pays off later
in several ways. First, fast feedback from the compiler (together with
editor integrations like &lt;code&gt;merlin&lt;/code&gt; and &lt;code&gt;tuareg&lt;/code&gt;) helped me to identify
issues earlier. &lt;code&gt;Yojson&lt;/code&gt; made it simple to enforce that JSON requests
and responses adhered to a fixed schema, and helped me process inputs
more systematically. OCaml made refactoring safe and easy, so that I
could confidently adapt my design as I introduced new requirements. In
the right context, I think the advantages of using OCaml could
significantly reduce the total lifecycle costs of maintaining many web
applications without reducing the pace of new development.&lt;/p&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;p&gt;I found the resources below helpful for working on this project:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The Dream &lt;a href="https://aantron.github.io/dream/"&gt;API docs&lt;/a&gt; set a high
  standard for readability and helped me quickly get up to speed with
  the framework.&lt;/li&gt;
&lt;li&gt;This &lt;a href="https://github.com/aantron/dream/tree/master/example"&gt;section&lt;/a&gt;
  of the Dream repo has excellent examples, both for working with the
  framework and deploying it.&lt;/li&gt;
&lt;li&gt;I referred to Bobby Priambodo's &lt;a href="https://medium.com/@bobbypriambodo/interfacing-ocaml-and-postgresql-with-caqti-a92515bdaa11"&gt;blog
  posts&lt;/a&gt;
  about interfacing Caqti and PostgreSQL as I wrote the models in my project.&lt;/li&gt;
&lt;li&gt;The Caqti
  &lt;a href="https://paurkedal.github.io/ocaml-caqti/index.html"&gt;docs&lt;/a&gt;,
  especially for &lt;code&gt;Caqti_type&lt;/code&gt; and &lt;code&gt;Caqti_request&lt;/code&gt; were helpful as I
  was writing queries.&lt;/li&gt;
&lt;li&gt;There is also an
  &lt;a href="https://github.com/paurkedal/ocaml-caqti/blob/master/tests/bikereg.ml"&gt;example&lt;/a&gt;
  in the Caqti repo that is worth looking through.&lt;/li&gt;
&lt;li&gt;The README on
  &lt;a href="https://github.com/janestreet/ppx_yojson_conv"&gt;ppx_yojson_conv&lt;/a&gt; had
  helpful examples that I referred to while writing my own
  JSON-related types.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Feedback&lt;/h2&gt;
&lt;p&gt;If you ended up looking through the source code for my API, let me
know how what you thought! I'm interested in adding more tutorial
resources to the OCaml ecosystem, so feel free to post a PR or issue
to
&lt;a href="https://github.com/jsthomas/sensors"&gt;sensors&lt;/a&gt;
if you have ideas about how to make these resources better.&lt;/p&gt;</content><category term="OCaml"></category></entry><entry><title>Let's write a shell in OCaml!</title><link href="https://jsthomas.github.io/ocaml-shell.html" rel="alternate"></link><published>2021-07-01T00:00:00-04:00</published><updated>2021-07-01T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2021-07-01:/ocaml-shell.html</id><summary type="html">&lt;p&gt;A user experience report about writing a simple shell in OCaml&lt;/p&gt;</summary><content type="html">&lt;p&gt;This Summer I'm studying OCaml and systems programming at the &lt;a href="https://www.recurse.com/"&gt;Recurse
Center&lt;/a&gt;. Currently I'm reading the
delightful book &lt;a href="https://pages.cs.wisc.edu/~remzi/OSTEP/"&gt;&lt;em&gt;Operating Systems: Three Easy
Pieces&lt;/em&gt;&lt;/a&gt; by Remzi
Arpaci-Dusseau and Andrea Arpaci-Dusseau. Besides great exposition,
the book includes several interesting projects, one of which is to
&lt;a href="https://github.com/remzi-arpacidusseau/ostep-projects/tree/master/processes-shell"&gt;write a
shell&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The project materials, a set of shell scripts that define tests, are
language agnostic. I believe the authors intended for students to use
C, but I worked through the exercise in OCaml; you can find the final
result &lt;a href="https://github.com/jsthomas/simple-ocaml-shell"&gt;in this
repo&lt;/a&gt;. This blog post
is a short experience report; if you're interested in working on a
beginner OCaml project, hopefully it provides some useful scaffolding
for your studies.&lt;/p&gt;
&lt;h2&gt;Shell features&lt;/h2&gt;
&lt;p&gt;The shell I built (&lt;code&gt;osh&lt;/code&gt;) has a somewhat limited feature set. It:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Allows several commands to be run in parallel (e.g. &lt;code&gt;program1 arg1 &amp;amp;
  program2 arg2 arg3&lt;/code&gt;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Supports simple output redirection (e.g. &lt;code&gt;echo "hello" &amp;gt;
  hello.txt&lt;/code&gt;). Both &lt;code&gt;stdout&lt;/code&gt; and &lt;code&gt;stderr&lt;/code&gt; go to the same file.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Has three builtin functions, &lt;code&gt;cd&lt;/code&gt;, &lt;code&gt;exit&lt;/code&gt;, and &lt;code&gt;path&lt;/code&gt;. &lt;code&gt;path&lt;/code&gt; allows
  you to define a list of directories to search for executables; we
  need this because environment variables aren't supported.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Other niceties, like tab completion and pipes, aren't supported. To
facilitate testing, the shell can run in a batch mode (&lt;code&gt;osh &amp;lt;my file
of commands&amp;gt;&lt;/code&gt;) as well as an interactive mode. A final simplifying
assumption is that &lt;code&gt;osh&lt;/code&gt; only provides a basic error message when
inputs are malformed.&lt;/p&gt;
&lt;h2&gt;Concepts&lt;/h2&gt;
&lt;p&gt;There are three main topics I studied while working on this project:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The &lt;code&gt;Unix&lt;/code&gt; module, especially &lt;code&gt;fork&lt;/code&gt; and
    &lt;code&gt;execv&lt;/code&gt;. &lt;a href="https://ocaml.github.io/ocamlunix/ocamlunix.html"&gt;This
    page&lt;/a&gt;, from
    Xavier Leroy and Didier Rmy, was helpful for getting up to
    speed. The man-pages were also useful.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;a href="https://ocaml.org/api/Stream.html"&gt;&lt;code&gt;Stream&lt;/code&gt;&lt;/a&gt; module. Streams
   in OCaml are roughly analogous to generators in Python; they
   allowed me to use a single type (a &lt;code&gt;string Stream.t&lt;/code&gt;) to represent
   commands coming from an interactive session or a batch file.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;a href="https://github.com/inhabitedtype/angstrom"&gt;Angstrom&lt;/a&gt;
   parser-combinator library. I used this library to determine whether
   a given line of user input is well formed.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I suspect you could implement the parser without Angstrom, if you
really wanted to. I wanted to learn more about this library, and this
project seemed like a good place to try it out.&lt;/p&gt;
&lt;p&gt;Although I previously worked through some simple monadic parser
exercises in Haskell, I struggled the most with Angstrom. Reading one
of the main &lt;a href="https://github.com/inhabitedtype/angstrom/blob/master/lib/angstrom.mli"&gt;mli
files&lt;/a&gt;
seemed to be the best way to get an overview of the combinators the
library provides. I also spent a fair amount of time experimenting in
&lt;code&gt;utop&lt;/code&gt; as I put my parser together.&lt;/p&gt;
&lt;h2&gt;Steps&lt;/h2&gt;
&lt;p&gt;Here is a rough outline for how I built my shell.&lt;/p&gt;
&lt;p&gt;First, I defined a main function that would fetch a line of text from
&lt;code&gt;stdin&lt;/code&gt; and echo it back to the user. Then I added the ability to
represent either interactive or batch input with a &lt;code&gt;Stream&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;prompt_stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"osh&amp;gt; "&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;read_line&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;


&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;file_stream&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;in_channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;open_in&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;
      &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;input_line&lt;/span&gt; &lt;span class="n"&gt;in_channel&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="nc"&gt;End_of_file&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="n"&gt;close_in&lt;/span&gt; &lt;span class="n"&gt;in_channel&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
      &lt;span class="nc"&gt;None&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It's useful to do this part as early as possible, since batch input
allows you to run the tests.&lt;/p&gt;
&lt;p&gt;Once I could get &lt;code&gt;osh&lt;/code&gt; to fail all 22 test cases, I started adding the
simpler built-in commands &lt;code&gt;cd&lt;/code&gt; and &lt;code&gt;exit&lt;/code&gt;. (Note &lt;code&gt;./test-osh.sh -c&lt;/code&gt;
will run all 22 tests, without stopping at the first one that fails.)&lt;/p&gt;
&lt;p&gt;My first version of &lt;code&gt;main&lt;/code&gt; just treated user input as &lt;code&gt;string list&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;rec&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;String&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split_on_char&lt;/span&gt; &lt;span class="sc"&gt;' '&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;  &lt;span class="c"&gt;(* Empty lines should just be treated as no-ops. *)&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;""&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"exit"&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;exit&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"cd"&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;chdir&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="s2"&gt;"cd"&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;print_error&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;xs&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fork&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
      &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Child *)&lt;/span&gt;
        &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;execv&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Array&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;of_list&lt;/span&gt; &lt;span class="n"&gt;xs&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
      &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Parent *)&lt;/span&gt;
        &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;waitpid&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt;
        &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iter&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This worked well enough for running simple commands like &lt;code&gt;/usr/bin/ls
-lah&lt;/code&gt;. In order to get output redirection and &lt;code&gt;&amp;amp;&lt;/code&gt; to work, I needed to
upgrade the program's parsing capabilities. I switched from
representing user input with a &lt;code&gt;string list&lt;/code&gt; to a variant type:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;type&lt;/span&gt; &lt;span class="n"&gt;exec&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="kt"&gt;list&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;option&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;type&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;NoOp&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;ChangeDirectory&lt;/span&gt; &lt;span class="k"&gt;of&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;PathChange&lt;/span&gt; &lt;span class="k"&gt;of&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="kt"&gt;list&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Executable&lt;/span&gt; &lt;span class="k"&gt;of&lt;/span&gt; &lt;span class="n"&gt;exec&lt;/span&gt; &lt;span class="kt"&gt;list&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Quit&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I found the OCaml compiler (and its emacs integrations, &lt;code&gt;merlin&lt;/code&gt; and
&lt;code&gt;tuareg&lt;/code&gt;) very helpful for refactoring. When I revised my types to
make them better reflect the data I wanted to model, type errors
identified all of the places I needed to update. At this point, I
introduced an Angstrom parser and re-implemented support for &lt;code&gt;cd&lt;/code&gt;,
&lt;code&gt;exit&lt;/code&gt;, and &lt;code&gt;path&lt;/code&gt;. That allowed me to get familiar with the parser
combinators &lt;code&gt;*&amp;gt;&lt;/code&gt;, &lt;code&gt;many&lt;/code&gt;, and &lt;code&gt;choice&lt;/code&gt;, before attempting the more
complicated parsers needed to support &lt;code&gt;&amp;amp;&lt;/code&gt; and &lt;code&gt;&amp;gt;&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The type system protected me from a number of silly mistakes, but it
wasn't a silver bullet. I spent an hour confused about why one of my
parsers would go into an infinite loop before realizing I needed to
use &lt;code&gt;many1&lt;/code&gt; instead of &lt;code&gt;many&lt;/code&gt;. I think this is the sort of mistake I
would learn to avoid if I spent more time working with Angstrom.&lt;/p&gt;
&lt;h2&gt;Discussion&lt;/h2&gt;
&lt;p&gt;As I worked through this project, I started to appreciate how OCaml
chooses "good defaults" for my code (especially immutable data)
without forbidding me from working in an imperative mode when I need
to.&lt;/p&gt;
&lt;p&gt;For example, I found that the function responsible for running a child
process was most natural to express with imperative language features:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;run_executable&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;full_paths&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;fun&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;^&lt;/span&gt; &lt;span class="s2"&gt;"/"&lt;/span&gt; &lt;span class="o"&gt;^&lt;/span&gt; &lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;executables&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt; &lt;span class="n"&gt;full_paths&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;present&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt; &lt;span class="n"&gt;executable_present&lt;/span&gt; &lt;span class="n"&gt;executables&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;

  &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;present&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;print_error&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fork&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Child *)&lt;/span&gt;
       &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;openfile&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;O_TRUNC&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;O_WRONLY&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;O_CREAT&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="mo"&gt;0o640&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;
       &lt;span class="k"&gt;in&lt;/span&gt;
       &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stderr&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt;
       &lt;span class="k"&gt;in&lt;/span&gt;
       &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dup2&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
       &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dup2&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stderr&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
       &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;execv&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Array&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;of_list&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Parent *)&lt;/span&gt;
      &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Writing this way made it easy for me to switch between C and OCaml; in
both languages, we follow a pattern of calling &lt;code&gt;fork&lt;/code&gt;, then &lt;code&gt;execv&lt;/code&gt; in
the child process. The fact that I can easily re-use my knowledge of
the UNIX APIs across different programming languages is one of the
main reasons I'm excited to learn more systems programming concepts!&lt;/p&gt;
&lt;p&gt;Variants and pattern matching are features I miss when working in
languages like Python. These features make it so easy to look at a
function like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ref&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"/bin"&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="nn"&gt;Parser&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse_line&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Error&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;print_error&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;NoOp&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="c"&gt;(* Empty lines should just be treated as no-ops. *)&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Quit&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;exit&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;ChangeDirectory&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;change_directory&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;PathChange&lt;/span&gt; &lt;span class="n"&gt;paths&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;cwd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getcwd&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
      &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;amend_path&lt;/span&gt; &lt;span class="n"&gt;cwd&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;paths&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Executable&lt;/span&gt; &lt;span class="n"&gt;execs&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;run_executables&lt;/span&gt; &lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="n"&gt;execs&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iter&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and quickly understand all of the different commands &lt;code&gt;osh&lt;/code&gt; supports.&lt;/p&gt;
&lt;p&gt;Although it took me some time to get up and running with Angstrom, I
strongly prefer working with parser combinators to writing an
imperative parser (as I've had to do in Python and Java). Angstrom
makes it easy to build up small parsers and test them in isolation
before composing them into the larger parser you really need. If I
planned to develop a shell with more features, I would probably break
&lt;code&gt;Parser&lt;/code&gt; out into its own file with separate unit tests.&lt;/p&gt;
&lt;h2&gt;Feedback&lt;/h2&gt;
&lt;p&gt;If you give this project a try, let me know how it turned out! I'm
interested in adding more tutorial resources to the OCaml ecosystem,
so feel free to post a PR or issue to
&lt;a href="https://github.com/jsthomas/simple-ocaml-shell"&gt;simple-ocaml-shell&lt;/a&gt;
if you have ideas about how to make these resources better.&lt;/p&gt;</content><category term="OCaml"></category></entry><entry><title>How I Contribute to Open Source Projects</title><link href="https://jsthomas.github.io/oss-how-why.html" rel="alternate"></link><published>2021-06-27T00:00:00-04:00</published><updated>2021-06-27T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2021-06-27:/oss-how-why.html</id><summary type="html">&lt;p&gt;A short explanation of my open source process.&lt;/p&gt;</summary><content type="html">&lt;p&gt;Contributing to public projects is one of the most fulfilling aspects
of my software development practice. It allows me to make new
professional connections and gain exposure to challenges I would never
encounter on the job. But it &lt;em&gt;is&lt;/em&gt; effortful, especially after a full
day of paid work. Over time, I've developed (mostly by trial and
error) a process that makes it easier for me to fit open source work
into my schedule and make this extra effort worthwhile.&lt;/p&gt;
&lt;p&gt;Earlier in my career I wanted to contribute to public projects but
didn't know how to begin. In this post, I tried to provide a concise
summary of the advice I wish I'd received long ago.&lt;/p&gt;
&lt;h2&gt;Why contribute?&lt;/h2&gt;
&lt;p&gt;Like most engineers, my paid work has been on years-long,
closed-source projects driven by deadlines and business
requirements. In that context, it's normal to build with the most
standard components possible. If your Django app needs flash messages,
you probably want to use the &lt;a href="https://docs.djangoproject.com/en/3.2/ref/contrib/messages/"&gt;messages
framework&lt;/a&gt;,
rather than rolling your own solution; there just isn't much business
value in writing something new. As a result, there are some design
problems you don't get to spend much time thinking about while doing paid
work.&lt;/p&gt;
&lt;p&gt;Working on OSS projects lets me to grow my skills beyond boundaries
imposed by business concerns. For instance, working on &lt;a href="https://github.com/aantron/dream/issues/43"&gt;this
issue&lt;/a&gt; let me build a
flash message system for a new web framework,
&lt;a href="https://aantron.github.io/dream/"&gt;Dream&lt;/a&gt;. Within the structure of
that project, I had an opportunity to study how Rails, Django, and
Phoenix implement flash messages. Discussing the merits of these
different approaches with more experienced engineers helped me become
a better designer.&lt;/p&gt;
&lt;p&gt;I've also found that OSS projects are an effective way to practice the
investigative skills I use on the first few months of a new job. When
I join an organization, I have to get up to speed on new codebases
(sometimes in a language I haven't used before).  Working on an
unfamiliar open source project simulates these conditions, without the
accompanying pressures of a new job.&lt;/p&gt;
&lt;h2&gt;How do I find new projects to work on?&lt;/h2&gt;
&lt;p&gt;Conferences focused on a specific programming language or family of
technologies are a great way to meet maintainers. When I attended
&lt;a href="http://www.composeconference.org/2017/"&gt;Compose 2017&lt;/a&gt;, a
serendipitous conversation in between sessions led to a 3-4 month
period of making contributions to
&lt;a href="https://github.com/ocsigen/lwt/"&gt;lwt&lt;/a&gt;, learning a lot more about
OCaml, and this &lt;a href="https://jsthomas.github.io/map-comparison.html"&gt;blog
post&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Conferences &lt;em&gt;can&lt;/em&gt; be a bit of a gamble. The costs of travel, lodging,
and fees are significant. Most conferences will post their talks
later. Watching these is a great way to stay informed. This Strange
Loop &lt;a href="https://youtu.be/gCWtkvDQ2ZI"&gt;talk&lt;/a&gt;, for instance, gave me a
good overview of the Unison programming language, which eventually
allowed me to contribute this
&lt;a href="https://github.com/unisonweb/unison/pull/1639"&gt;change&lt;/a&gt;. This approach
is much more efficient for finding projects that spark your interest,
since you can watch talks at 2x speed and skip ones that aren't
useful.&lt;/p&gt;
&lt;h2&gt;Evaluating whether a project is a good fit&lt;/h2&gt;
&lt;p&gt;Once I've found a project (usually on github) that I think is
interesting, there are a few things I check before deciding whether to
contribute.&lt;/p&gt;
&lt;p&gt;First, I look at whether the project has recent commits. If the most
recent commit is more than a few months old, that might mean the
project is abandoned. Since I'm interested in being a contributor
rather than a maintainer, working on these repos is usually not a good
use of time.&lt;/p&gt;
&lt;p&gt;The second thing I look at are the project's pull requests. If there
are many old, open pull requests (ones that don't have any comments),
this is another sign that the project might be abandoned. Looking
through closed PRs, or PRs with a lot of comments, typically gives me
some idea of how contributors and maintainers interact. The
maintainers I've interacted with have been friendly and welcoming; I
avoid projects where that isn't the norm.&lt;/p&gt;
&lt;p&gt;Next, I'll take a look at the project's issue list. If users and
maintainers write clearly, it's much easier for me to make progress on
an issue without having to ask too many questions. Issues with links
to relevant code, minimal working examples, and repro steps are all
good signs.&lt;/p&gt;
&lt;p&gt;I also look to see whether the project has Travis or Circle CI set up,
since that means I can get quick feedback on a PR without talking to
anyone. The CI systems is also helpful as a model for setting up my
development environment; often I will look through the CI
configuration in order to run my unit tests with the exact same
databases/dependencies/settings.&lt;/p&gt;
&lt;p&gt;Finally, I'll take a more in-depth look at the codebase itself. At
this point, I'm just trying to answer basic questions, like:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;How is the source tree organized?&lt;/li&gt;
&lt;li&gt;Do most of the functions/classes/modules have comprehensible names?&lt;/li&gt;
&lt;li&gt;Where are the tests? Where would I add new tests?&lt;/li&gt;
&lt;li&gt;Are there comments?&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Finding a task&lt;/h2&gt;
&lt;p&gt;Once I'm confident that I want to participate, my next step is to
choose an open issue to work on. Ones that are marked "good first
issue" or "beginner" are great for a first contribution, and I'll
often start with those.&lt;/p&gt;
&lt;p&gt;I try to keep the scope of my first contribution small. For example,
&lt;a href="https://github.com/arenadotio/pgx/issues/97"&gt;this issue&lt;/a&gt; on the OCaml
library &lt;code&gt;pgx&lt;/code&gt; asked for someone to add support for a different
date-time library (in this case &lt;code&gt;ptime&lt;/code&gt;) because not everyone can use
Jane Street's &lt;code&gt;Core&lt;/code&gt; library. This was an ideal first issue because I
could use the existing &lt;code&gt;Core&lt;/code&gt; implementation as a model for what I
needed to build.&lt;/p&gt;
&lt;p&gt;If an issue is a little bit old, it's a good idea to leave a note
asking whether the maintainer is still interested in having it
addressed. For example, I was interested in working on this
&lt;a href="https://github.com/aantron/dream/issues/43"&gt;issue&lt;/a&gt;, but it was a
month old. Rather than jumping into an implementation that might go to
waste, I left a comment expressing interest and offering some design
ideas. Replies in that thread allowed me to create this &lt;a href="https://github.com/aantron/dream/pull/62"&gt;pull
request&lt;/a&gt;, confident in the
knowledge that someone would want to use my work.&lt;/p&gt;
&lt;p&gt;Once I've picked out task, it's (finally) time to implement a
solution. If I can get as far as implementing some unit tests and
getting most of them to pass, I post a comment on the issue indicating
that I'm working on a pull request. Personally, I consider it best
practice to &lt;em&gt;only&lt;/em&gt; post one of these comments if I'm very confident
that I'll have a PR ready in the next few days. Conversely, no-one
wants to duplicate effort, so it's courteous to indicate that you're
preparing a PR.&lt;/p&gt;
&lt;h2&gt;Pull request and review&lt;/h2&gt;
&lt;p&gt;Since pull requests take time to review, I try to perform at least one
round of self-review before opening a PR. Generally, I won't open a PR
unless I have fairly good test coverage for my work and the tests (and
lint steps) are passing. At a paid position, it's easy to have a
meeting or use slack to discuss a change. Public projects tend to be
more asynchronous, so it's important to read instructions carefully,
write clearly, and address obvious issues on your own.&lt;/p&gt;
&lt;p&gt;When I write a description for my PR, I include a link to the issue it
addresses, usually in the first sentence. If the change adds new types
or functions, I include a summary of that as well. If there are design
details I'm unsure of, I flag these with comments so that the
reviewer(s) can discuss them with me.&lt;/p&gt;
&lt;p&gt;The code review process on a public project can be a little different
from code review inside a company. At some jobs, I've observed an
unspoken rule that PRs need to be more or less correct on the first or
second try, otherwise you'll be considered ineffective. My sense is
that the review process on public projects is much more
iterative. Sometimes it isn't possible to gather all of the necessary
requirements until a first PR is drafted and people have something to
react to. It can take several rounds of revision before all of the
interested parties agree that the design is right.&lt;/p&gt;
&lt;p&gt;This &lt;a href="https://github.com/aantron/dream/pull/62"&gt;PR&lt;/a&gt; for instance,
required several tries to find a flash message implementation that fit
with the philosophy of the project. These situations are an
opportunity to practice discussing (and justifying) your design
decisions with other technical-minded people. I think the key to
success with public reviews is to read reviewer's comments carefully,
make an effort to understand their goals, and then fit your changes to
support those goals.&lt;/p&gt;
&lt;h2&gt;General suggestions&lt;/h2&gt;
&lt;p&gt;If you plan on making OSS contributions long term, I'd suggest having
both a schedule and dedicated hardware for your work. Working after
dinner from 6 to 8 PM weeknights helps me get into a productive
mindset quickly. Time-boxing my work also helps me avoid exhausting my
interest in a project by putting in too many consecutive hours. Using
an inexpensive, second-hand laptop for my public projects makes it
easy for me to suspend my work when I'm done for the night and then
start the next day exactly where I left off, without having to set up
my browser/editor/terminals again.&lt;/p&gt;</content><category term="OSS, Projects"></category></entry><entry><title>Microbenchmarking Implementations of Map in OCaml</title><link href="https://jsthomas.github.io/map-comparison.html" rel="alternate"></link><published>2017-06-06T00:00:00-04:00</published><updated>2017-06-06T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2017-06-06:/map-comparison.html</id><summary type="html">&lt;p&gt;A comparison of different implementations of map in OCaml&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;code&gt;Map&lt;/code&gt; is one of the first higher-order functions I remember
encountering when I learned some rudimentary functional programming
topics as an undergraduate. More recently I began learning OCaml. The
&lt;code&gt;map&lt;/code&gt;
&lt;a href="https://github.com/ocaml/ocaml/blob/2691c40f2ff9bc34912db39bc1f17045c9241473/stdlib/list.ml#L80-L82"&gt;implementation&lt;/a&gt;
I found in the standard library was the textbook definition I was
expecting&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;rec&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;function&lt;/span&gt;
   &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;but I was surprised to learn there are actually several
implementations of &lt;code&gt;map&lt;/code&gt; in the OCaml ecosystem. I wanted to know more
about these different implementations and their performance
characteristics. This article summarizes what I learned.&lt;/p&gt;
&lt;p&gt;Part of my motivation to write this post arose from
&lt;a href="https://github.com/ocsigen/lwt/pull/347"&gt;this discussion&lt;/a&gt; of a pull
request that proposes the default &lt;code&gt;map&lt;/code&gt; implementation in &lt;code&gt;lwt&lt;/code&gt; should
be tail recursive. After reading all of the comments, I wanted to
develop experiments that would convince me whether this was a good
idea.&lt;/p&gt;
&lt;h1&gt;Introduction&lt;/h1&gt;
&lt;p&gt;Since I'll introduce several versions of &lt;code&gt;map&lt;/code&gt;, I'll refer to the
implementation above as &lt;code&gt;stdlib&lt;/code&gt;. An important aspect of this version
is that it isn't &lt;em&gt;tail recursive&lt;/em&gt;. A tail recursive function uses
recursion in a specific way; it only calls itself as the final
operation in the function. In OCaml, tail recursive functions get the
benefit of tail-call optimization so that they only use one frame on
the stack. In contrast, the &lt;code&gt;stdlib&lt;/code&gt; implementation takes space on the
stack proportional to the length of the input list. For long enough
lists, this causes a stack overflow.&lt;/p&gt;
&lt;p&gt;We can make a basic tail-recursive version of &lt;code&gt;map&lt;/code&gt; by composing two
standard library functions that are tail recursive: &lt;code&gt;List.rev_map&lt;/code&gt;
(which creates the output of &lt;code&gt;map&lt;/code&gt;, but in reversed order) and
&lt;code&gt;List.rev&lt;/code&gt; which reverses lists. I'll call this naive implementation
&lt;code&gt;ntr&lt;/code&gt; (naive tail recursive). Compared to &lt;code&gt;stdlib&lt;/code&gt;, &lt;code&gt;ntr&lt;/code&gt; allocates
twice as much space on the heap (one list for the output of
&lt;code&gt;List.rev_map&lt;/code&gt;, and a second equally long list for &lt;code&gt;List.rev&lt;/code&gt;) and
spends additional time performing a list traversal. The benefit is
that with this implementation, calling &lt;code&gt;map&lt;/code&gt; on a long list won't
result in a stack overflow.&lt;/p&gt;
&lt;p&gt;As we'll see later in the Results section, the naive tail recursive
implementation is, overall, slower than the &lt;code&gt;stdlib&lt;/code&gt;
implementation. However, there are some optimizations we can apply to
improve the performance of both versions.&lt;/p&gt;
&lt;p&gt;The first trick I call "unrolling". Similar to
&lt;a href="https://en.wikipedia.org/wiki/Loop_unrolling"&gt;loop unrolling in procedural languages&lt;/a&gt;,
the idea is to use cases to &lt;code&gt;map&lt;/code&gt; on groups of list elements so fewer
function calls are needed to complete the work. For example, an
unrolled version of &lt;code&gt;stdlib&lt;/code&gt; looks like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;rec&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;f1&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;f1&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;x3&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;tl&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f3&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x3&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;f3&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;tl&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We get to choose how many elements to unroll (here I picked 3); some
profiling is needed to decide the most appropriate number.&lt;/p&gt;
&lt;p&gt;The second trick I call "hybridizing". The &lt;code&gt;stdlib&lt;/code&gt; version is faster,
but isn't safe for long lists. The tail recursive implementation is
slow, but safe for all lists. When we "hybridize" the two, we use the
faster version up to some fixed number of elements (e.g. 1000), and
then switch to the safe version for the remainder of the list.&lt;/p&gt;
&lt;p&gt;These two optimizations are useful for understanding the
implementations of &lt;code&gt;map&lt;/code&gt; we find in other libraries. For example, both
&lt;a href="https://github.com/janestreet/base/blob/f10483e957206dc6b656a28ffec667d8b068c149/src/list.ml#L311-L345"&gt;&lt;code&gt;base&lt;/code&gt;&lt;/a&gt;
and
&lt;a href="https://github.com/c-cube/ocaml-containers/blob/d659ba677e3dbd95430f59b3794ac2f2a5677d61/src/core/CCList.ml#L20-L37"&gt;&lt;code&gt;containers&lt;/code&gt;&lt;/a&gt;
use an unrolled &lt;code&gt;stdlib&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt;, hybridized with an
&lt;code&gt;ntr&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Looking at &lt;code&gt;ntr&lt;/code&gt;, one might ask: Is it strictly necessary to use
additional heap space to get the implementation to be tail recursive?
The answer is no. The &lt;code&gt;batteries&lt;/code&gt; package
&lt;a href="https://github.com/ocaml-batteries-team/batteries-included/blob/c10c65a203a7590b15b9a370f66e8c2884817428/src/batList.mlv#L163-L173"&gt;implements &lt;code&gt;map&lt;/code&gt;&lt;/a&gt;
so that the work is done by a single tail recursive function, creating
one new list on the heap. To achieve this, the implementation uses
mutable state and casting to avoid a second list traversal
(specifically,
&lt;a href="https://github.com/ocaml-batteries-team/batteries-included/blob/c10c65a203a7590b15b9a370f66e8c2884817428/src/batList.mlv#L69"&gt;here&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;As with any optimization, one makes tradeoffs between elegance,
performance, and the language features one considers acceptable to
use. I wanted to know:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Which version is the fastest in practice?&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;How much speed does one lose using the safer tail recursive version?&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Both &lt;code&gt;base&lt;/code&gt; and &lt;code&gt;containers&lt;/code&gt; decided to hybridize with an &lt;code&gt;ntr&lt;/code&gt;-style
&lt;code&gt;map&lt;/code&gt; for safety. But the &lt;code&gt;batteries&lt;/code&gt; implementation is also robust to
stack overflow. That led to one final question:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;How fast is an unrolled &lt;code&gt;stdlib&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt; hybridized with a
  &lt;code&gt;batteries&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt;?&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Experimental Setup&lt;/h1&gt;
&lt;p&gt;In 2014, Jane Street introduced a
&lt;a href="https://github.com/janestreet/core_bench"&gt;library&lt;/a&gt; for
microbenchmarking called &lt;code&gt;core_bench&lt;/code&gt;. As they explain
&lt;a href="https://blogs.janestreet.com/core_bench-micro-benchmarking-for-ocaml/"&gt;on their blog&lt;/a&gt;,
&lt;code&gt;core_bench&lt;/code&gt; is intended to measure the performance of small pieces of
OCaml code. This library helps developers to better understand the
cost of individual operations, like &lt;code&gt;map&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;There are a couple benefits to measuring &lt;code&gt;map&lt;/code&gt; implementations with
&lt;code&gt;core_bench&lt;/code&gt;.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The library makes it easy to track both time and use of the heap.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Once you specify your test, &lt;code&gt;core_bench&lt;/code&gt; automatically provides
   many &lt;a href="https://github.com/janestreet/core_bench/wiki/Getting-Started-with-Core_bench"&gt;command line
   options&lt;/a&gt;
   to help you present your test data in different ways.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The library uses statistical techniques (bootstrapping and linear
   regression) to reduce many runs worth of data to a small number of
   meaningful performance metrics that account for the amortized cost
   of garbage collection and error introduced by system activity.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I wrote
&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/maptest.ml"&gt;this program&lt;/a&gt;
to compare performance between the six implementations I described
above. The program includes the batteries-hybrid I described above,
which I'll refer to as &lt;code&gt;batt-hybr&lt;/code&gt;. Other test details:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I tested each algorithm against lists of lengths &lt;span class="math"&gt;\(N=10^2, 10^3,
  10^4\)&lt;/span&gt; and &lt;span class="math"&gt;\(10^5\)&lt;/span&gt;. On my system, &lt;span class="math"&gt;\(N=10^5\)&lt;/span&gt; was the highest power of 10
  for which the &lt;code&gt;stdlib&lt;/code&gt; implementation did not fail due to a stack
  overflow.&lt;/li&gt;
&lt;li&gt;Each list consisted of integer elements (all 0), and the function
  mapped onto the list simply added one to each element.&lt;/li&gt;
&lt;li&gt;I ran these tests on a Lenovo X220, Intel Core i5-2520M CPU (2.50GHz 
  4 cores), with 4GB RAM.&lt;/li&gt;
&lt;li&gt;I used the OCaml 4.03.0 compiler, and compiled to native code
  without using &lt;code&gt;flambda&lt;/code&gt;. (&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/makefile"&gt;This
  makefile&lt;/a&gt;
  gives the full specifications.)&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Results&lt;/h1&gt;
&lt;p&gt;For each list size, &lt;code&gt;core_bench&lt;/code&gt; produces a table with several metrics besides time:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;mWd&lt;/code&gt; : Words allocated on the minor heap.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;mjWd&lt;/code&gt; : Words allocated on the major heap.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Prom&lt;/code&gt; : Words promoted from minor to major heap.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The library also allows us to produce 95% confidence intervals and
&lt;span class="math"&gt;\(R^2\)&lt;/span&gt; values for the time estimates.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 100&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;&lt;/span&gt;
&lt;span class="err"&gt; Name        Time R^2  Time/Run           95ci  mWd/Run  mjWd/Run  Prom/Run  Percentage &lt;/span&gt;
&lt;span class="err"&gt;&lt;/span&gt;
&lt;span class="err"&gt; ntr             1.00  741.20ns  -0.23% +0.22%  609.01w     0.53w     0.53w     100.00% &lt;/span&gt;
&lt;span class="err"&gt; containers      1.00  439.55ns  -0.64% +0.67%  304.03w     0.17w     0.17w      59.30% &lt;/span&gt;
&lt;span class="err"&gt; batteries       1.00  581.65ns  -0.14% +0.16%  309.01w     0.35w     0.35w      78.47% &lt;/span&gt;
&lt;span class="err"&gt; base            1.00  438.63ns  -0.19% +0.20%  304.03w     0.16w     0.16w      59.18% &lt;/span&gt;
&lt;span class="err"&gt; stdlib          1.00  610.45ns  -0.10% +0.11%  304.01w     0.17w     0.17w      82.36% &lt;/span&gt;
&lt;span class="err"&gt; batt-hybr       1.00  426.76ns  -0.15% +0.17%  304.03w     0.17w     0.17w      57.58% &lt;/span&gt;
&lt;span class="err"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 1000&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;&lt;/span&gt;
&lt;span class="err"&gt; Name        Time R^2  Time/Run           95ci  mWd/Run  mjWd/Run  Prom/Run  Percentage &lt;/span&gt;
&lt;span class="err"&gt;&lt;/span&gt;
&lt;span class="err"&gt; ntr             1.00    8.84us  -0.14% +0.15%   6.01kw    52.08w    52.08w     100.00% &lt;/span&gt;
&lt;span class="err"&gt; containers      1.00    5.07us  -0.13% +0.15%   3.00kw    17.23w    17.23w      57.34% &lt;/span&gt;
&lt;span class="err"&gt; batteries       1.00    6.57us  -0.14% +0.14%   3.01kw    34.71w    34.71w      74.32% &lt;/span&gt;
&lt;span class="err"&gt; base            1.00    4.99us  -0.20% +0.24%   3.00kw    17.08w    17.08w      56.44% &lt;/span&gt;
&lt;span class="err"&gt; stdlib          1.00    6.84us  -0.10% +0.10%   3.00kw    17.22w    17.22w      77.34% &lt;/span&gt;
&lt;span class="err"&gt; batt-hybr       1.00    4.96us  -0.13% +0.13%   3.00kw    17.07w    17.07w      56.10% &lt;/span&gt;
&lt;span class="err"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 10,000&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;&lt;/span&gt;
&lt;span class="err"&gt; Name        Time R^2  Time/Run           95ci  mWd/Run  mjWd/Run  Prom/Run  Percentage &lt;/span&gt;
&lt;span class="err"&gt;&lt;/span&gt;
&lt;span class="err"&gt; ntr             0.99  203.11us  -0.45% +0.53%  60.01kw    5.40kw    5.40kw     100.00% &lt;/span&gt;
&lt;span class="err"&gt; containers      1.00  144.95us  -0.50% +0.60%  48.01kw    3.04kw    3.04kw      71.37% &lt;/span&gt;
&lt;span class="err"&gt; batteries       1.00  136.87us  -0.51% +0.63%  30.01kw    3.64kw    3.64kw      67.39% &lt;/span&gt;
&lt;span class="err"&gt; base            1.00  130.85us  -0.34% +0.39%  44.98kw    2.66kw    2.66kw      64.42% &lt;/span&gt;
&lt;span class="err"&gt; stdlib          1.00  118.70us  -0.30% +0.29%  30.00kw    1.80kw    1.80kw      58.44% &lt;/span&gt;
&lt;span class="err"&gt; batt-hybr       1.00  106.91us  -0.42% +0.52%  30.01kw    2.22kw    2.22kw      52.64% &lt;/span&gt;
&lt;span class="err"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 100,000&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;&lt;/span&gt;
&lt;span class="err"&gt; Name        Time R^2  Time/Run           95ci   mWd/Run  mjWd/Run  Prom/Run  Percentage &lt;/span&gt;
&lt;span class="err"&gt;&lt;/span&gt;
&lt;span class="err"&gt; ntr             0.98   10.27ms  -2.39% +2.32%  600.02kw  411.83kw  411.83kw      94.33% &lt;/span&gt;
&lt;span class="err"&gt; containers      0.99   10.62ms  -2.19% +1.83%  588.02kw  404.91kw  404.91kw      97.61% &lt;/span&gt;
&lt;span class="err"&gt; batteries       1.00    7.19ms  -0.78% +0.79%  300.02kw  300.35kw  300.35kw      66.02% &lt;/span&gt;
&lt;span class="err"&gt; base            0.99   10.88ms  -1.54% +1.41%  584.99kw  397.60kw  397.60kw     100.00% &lt;/span&gt;
&lt;span class="err"&gt; stdlib          0.99    6.33ms  -1.08% +1.07%  300.01kw  171.73kw  171.73kw      58.18% &lt;/span&gt;
&lt;span class="err"&gt; batt-hybr       0.93    6.09ms  -4.30% +4.63%  300.02kw  285.46kw  285.46kw      55.93% &lt;/span&gt;
&lt;span class="err"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;A few things I noticed about the data:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The tail recursive implementation is slow, but not always the
  slowest. In the &lt;span class="math"&gt;\(N=10^5\)&lt;/span&gt; case, &lt;code&gt;ntr&lt;/code&gt;,&lt;code&gt;base&lt;/code&gt;, and &lt;code&gt;containers&lt;/code&gt; show
  similar performance; this makes sense given they have the same
  behavior after a prefix of the list.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;For short lists, &lt;code&gt;base&lt;/code&gt;, &lt;code&gt;containers&lt;/code&gt;, and &lt;code&gt;batt-hybr&lt;/code&gt; are fastest,
  likely because of unrolling.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We can see from the &lt;code&gt;mWd&lt;/code&gt; and &lt;code&gt;mjWd&lt;/code&gt; columns that &lt;code&gt;ntr&lt;/code&gt; uses the
  most heap space, as we would expect.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;As we increase the size of the list, &lt;code&gt;stdlib&lt;/code&gt; gets faster relative
  to &lt;code&gt;ntr&lt;/code&gt;; I suspect this can be attributed to the cost of garbage
  collection.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Overall, &lt;code&gt;batt-hybr&lt;/code&gt; appears to have the best performance (though in
  the &lt;span class="math"&gt;\(N=10^5\)&lt;/span&gt; case, the confidence interval is large enough that we
  can't conclude &lt;code&gt;batt-hybr&lt;/code&gt; is faster than &lt;code&gt;stdlib&lt;/code&gt;, and the &lt;span class="math"&gt;\(R^2\)&lt;/span&gt;
  value is a bit low).&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Conclusions&lt;/h1&gt;
&lt;p&gt;The data above suggest three main findings:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The stack-based standard library implementation of &lt;code&gt;map&lt;/code&gt; is faster
   than the naive tail recursive implementation, taking about 60-80%
   of the time to do the same work depending on the size of the list.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;There are clear benefits to both unrolling and
   hybridizing. Hybridizing lets us take an implementation that
   performs well on long lists (&lt;code&gt;batteries&lt;/code&gt;), and make it even better
   by combining it with one that's fast on short lists, to produce
   &lt;code&gt;batt-hybr&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Overall, the data show we don't have to give up safety (resistance
   to stack overflow) to get better performance. A tail recursive
   implementation can be quite competitive, albeit more complex.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h1&gt;Discussion&lt;/h1&gt;
&lt;p&gt;A follow up question to this analysis, in the context of the
discussion of &lt;code&gt;Lwt_list.map_p&lt;/code&gt; is: "How significant is the cost of
&lt;code&gt;map&lt;/code&gt; compared to other operations?" To partially address this, I
wrote
&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/bufftest.ml"&gt;another program&lt;/a&gt;
that measures how long it takes to write 4096 bytes to a Unix pipe
using &lt;code&gt;Lwt_unix.write&lt;/code&gt;, and then read it back using &lt;code&gt;Lwt_unix.read&lt;/code&gt;. Using
&lt;code&gt;core_bench&lt;/code&gt;, I found:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Unix Pipe Read/Write Benchmark&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;&lt;/span&gt;
&lt;span class="err"&gt;Time R^2  Time/Run           95ci  mWd/Run  Percentage &lt;/span&gt;
&lt;span class="err"&gt;&lt;/span&gt;
&lt;span class="err"&gt;    1.00  893.33ns  -0.16% +0.18%   56.00w     100.00% &lt;/span&gt;
&lt;span class="err"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It seems reasonable to estimate that &lt;code&gt;Lwt_list.map_p&lt;/code&gt; would primarily
be applied to IO operations like the ones in this experiment. In that
case, the data suggest the cost per element of applying the slowest
&lt;code&gt;map&lt;/code&gt; implementation (&lt;code&gt;ntr&lt;/code&gt;) is about 0.82% of the cost of one 4KB
read/write operation on a unix pipe. In the context of &lt;code&gt;Lwt&lt;/code&gt;, it seems
reasonable to conclude the implementation of &lt;code&gt;map&lt;/code&gt; isn't a significant
concern; the real cost is performing IO. In light of that, it seems
preferable to use an implementation that cannot cause a stack
overflow.&lt;/p&gt;
&lt;p&gt;A second question that might be asked about this analysis is: "Was it
necessary to introduce the added complexity of &lt;code&gt;core_bench&lt;/code&gt; to measure
the performance of &lt;code&gt;map&lt;/code&gt;?" For example, one might set up a performance
test with just successive calls to &lt;code&gt;Time.now&lt;/code&gt; or
&lt;code&gt;Unix.gettimeofday&lt;/code&gt;. In an earlier draft of this article, I tried such
an
&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/profile.ml"&gt;approach&lt;/a&gt;,
producing some misleading data. In that test, I did a full garbage
collection in between runs (applications of &lt;code&gt;map&lt;/code&gt;), which suppressed
that (nontrivial) cost and made the tail recursive implementation
appear quite fast. &lt;code&gt;core_bench&lt;/code&gt; does a much better job incorporating
the cost of garbage collection by varying the number of test runs
performed in a row and then establishing a trend (with linear
regression) that reflects the amortized cost of garbage collection per
run.&lt;/p&gt;
&lt;p&gt;One interesting finding did arise from my earlier tests: for short
lists, allocating memory on the heap actually appears to be faster
than creating frames on the stack. Since the tests perform a full
garbage collection between test runs, the timings show only the cost
of allocating space on the heap. This produced data like the
following:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary Statistics, &lt;span class="math"&gt;\(N=10^3\)&lt;/span&gt; Garbage Collected Map Benchmark Times (s)&lt;/strong&gt;&lt;/p&gt;
&lt;table class="dataframe"&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;Std. Lib.&lt;/th&gt;
&lt;th&gt;NTR&lt;/th&gt;
&lt;th&gt;Base&lt;/th&gt;
&lt;th&gt;Batteries&lt;/th&gt;
&lt;th&gt;Containers&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;th&gt;Mean&lt;/th&gt;
&lt;td&gt;27.18&lt;/td&gt;
&lt;td&gt;27.21&lt;/td&gt;
&lt;td&gt;11.23&lt;/td&gt;
&lt;td&gt;19.03&lt;/td&gt;
&lt;td&gt;13.06&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Min&lt;/th&gt;
&lt;td&gt;15.97&lt;/td&gt;
&lt;td&gt;14.07&lt;/td&gt;
&lt;td&gt;6.91&lt;/td&gt;
&lt;td&gt;9.06&lt;/td&gt;
&lt;td&gt;7.87&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;25%&lt;/th&gt;
&lt;td&gt;18.84&lt;/td&gt;
&lt;td&gt;17.88&lt;/td&gt;
&lt;td&gt;7.15&lt;/td&gt;
&lt;td&gt;10.97&lt;/td&gt;
&lt;td&gt;10.01&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;50%&lt;/th&gt;
&lt;td&gt;20.03&lt;/td&gt;
&lt;td&gt;19.07&lt;/td&gt;
&lt;td&gt;8.11&lt;/td&gt;
&lt;td&gt;15.50&lt;/td&gt;
&lt;td&gt;10.01&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;75%&lt;/th&gt;
&lt;td&gt;23.13&lt;/td&gt;
&lt;td&gt;22.17&lt;/td&gt;
&lt;td&gt;12.87&lt;/td&gt;
&lt;td&gt;18.84&lt;/td&gt;
&lt;td&gt;10.97&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Max&lt;/th&gt;
&lt;td&gt;849.01&lt;/td&gt;
&lt;td&gt;576.02&lt;/td&gt;
&lt;td&gt;379.80&lt;/td&gt;
&lt;td&gt;622.03&lt;/td&gt;
&lt;td&gt;434.88&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;Summary Statistics, &lt;span class="math"&gt;\(N=10^4\)&lt;/span&gt; Garbage Collected Map Benchmark Times (s)&lt;/strong&gt;&lt;/p&gt;
&lt;table class="dataframe"&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;Std. Lib.&lt;/th&gt;
&lt;th&gt;NTR&lt;/th&gt;
&lt;th&gt;Base&lt;/th&gt;
&lt;th&gt;Batteries&lt;/th&gt;
&lt;th&gt;Containers&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;th&gt;Mean&lt;/th&gt;
&lt;td&gt;230.23&lt;/td&gt;
&lt;td&gt;216.60&lt;/td&gt;
&lt;td&gt;141.39&lt;/td&gt;
&lt;td&gt;144.59&lt;/td&gt;
&lt;td&gt;161.56&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Min&lt;/th&gt;
&lt;td&gt;77.01&lt;/td&gt;
&lt;td&gt;73.91&lt;/td&gt;
&lt;td&gt;61.04&lt;/td&gt;
&lt;td&gt;54.84&lt;/td&gt;
&lt;td&gt;63.18&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;25%&lt;/th&gt;
&lt;td&gt;97.04&lt;/td&gt;
&lt;td&gt;86.07&lt;/td&gt;
&lt;td&gt;67.95&lt;/td&gt;
&lt;td&gt;58.89&lt;/td&gt;
&lt;td&gt;70.81&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;50%&lt;/th&gt;
&lt;td&gt;121.95&lt;/td&gt;
&lt;td&gt;99.90&lt;/td&gt;
&lt;td&gt;75.10&lt;/td&gt;
&lt;td&gt;61.99&lt;/td&gt;
&lt;td&gt;77.01&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;75%&lt;/th&gt;
&lt;td&gt;193.83&lt;/td&gt;
&lt;td&gt;284.91&lt;/td&gt;
&lt;td&gt;148.59&lt;/td&gt;
&lt;td&gt;118.26&lt;/td&gt;
&lt;td&gt;175.24&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Max&lt;/th&gt;
&lt;td&gt;12719.87&lt;/td&gt;
&lt;td&gt;2753.97&lt;/td&gt;
&lt;td&gt;2960.21&lt;/td&gt;
&lt;td&gt;3616.09&lt;/td&gt;
&lt;td&gt;13603.93&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;When we ignore the time spent on garbage collection, we see that &lt;code&gt;ntr&lt;/code&gt;
is surprisingly competitive, especially in comparison with &lt;code&gt;stdlib&lt;/code&gt;;
the difference between the two implementations, of course, is that
&lt;code&gt;ntr&lt;/code&gt; allocates more memory on the heap while &lt;code&gt;stdlib&lt;/code&gt; creates more
stack frames.&lt;/p&gt;
&lt;h2&gt;Notes&lt;/h2&gt;
&lt;p&gt;Thanks to &lt;a href="https://github.com/aantron"&gt;Anton Bachin&lt;/a&gt; and
&lt;a href="https://github.com/c-cube/"&gt;Simon Cruanes&lt;/a&gt; for reading drafts of this
post.&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="OCaml"></category></entry><entry><title>Refactoring Python Code</title><link href="https://jsthomas.github.io/mgptree-refactor.html" rel="alternate"></link><published>2017-05-01T00:00:00-04:00</published><updated>2017-05-01T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2017-05-01:/mgptree-refactor.html</id><summary type="html">&lt;p&gt;Refactoring some python code from many years ago.&lt;/p&gt;</summary><content type="html">&lt;p&gt;Recently, a friend from grad-school asked me about an
&lt;a href="https://github.com/jsthomas/mgptree"&gt;experimental python data visualization tool&lt;/a&gt;
I wrote in 2012. Since the code had rotted (to the point that it no
longer worked), and my understanding of python has changed quite a bit
since I originally wrote it, I thought this would be a good
opportunity to write about my current processes for debugging and refactoring.&lt;/p&gt;
&lt;h2&gt;What's this supposed to do again?&lt;/h2&gt;
&lt;p&gt;The premise of the program is pretty simple:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The
   &lt;a href="https://www.genealogy.math.ndsu.nodak.edu/"&gt;Mathematics Genealogy Project (MGP)&lt;/a&gt;
   lets us search for advisor-advisee relationships between names.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We want to take a list of names &lt;span class="math"&gt;\(L\)&lt;/span&gt; and an integer &lt;span class="math"&gt;\(n\)&lt;/span&gt;, and look up
   &lt;span class="math"&gt;\(n\)&lt;/span&gt; generations of mathematicians, starting from &lt;span class="math"&gt;\(L\)&lt;/span&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Then, we want to render the digraph of advisee-advisor
   relationships using the &lt;a href="http://graphviz.org/"&gt;&lt;code&gt;graphviz&lt;/code&gt;&lt;/a&gt; program
   &lt;code&gt;dot&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Looking at this code it's surprising some of the things I did and
didn't know:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Prior to 2014, I wasn't in the habit of using virtual environments
   and &lt;code&gt;pip&lt;/code&gt;. For this project, that's not really a big deal because
   there aren't a lot of dependencies.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I wasn't aware of &lt;code&gt;pylint&lt;/code&gt;. Today, I find that &lt;code&gt;pylint&lt;/code&gt; makes it a
   lot easier to write clean python and refactor existing code.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Some things that haven't changed:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;I still think graphviz is really great. It makes plotting directed
   graphs &lt;em&gt;so&lt;/em&gt; easy, and it's easy to decorate them with a lot of
   metadata.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;argparse&lt;/code&gt; makes it easy to write a command line interface that
   works just like other familiar unix tools. I especially like that
   adds &lt;code&gt;-h&lt;/code&gt; options for displaying help, which are invaluable when
   building a more extensive CLI tool.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Phase 1: Cleaning up lint issues.&lt;/h2&gt;
&lt;p&gt;Whenever I'm starting on unfamiliar python code, I like to begin with
&lt;code&gt;pylint&lt;/code&gt;'s suggestions.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="o"&gt;```&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;384&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Invalid&lt;/span&gt; &lt;span class="k"&gt;method&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="ss"&gt;"extractPersonalData"&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;invalid&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;384&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Missing&lt;/span&gt; &lt;span class="k"&gt;method&lt;/span&gt; &lt;span class="n"&gt;docstring&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;missing&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;docstring&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;391&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;11&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="k"&gt;Do&lt;/span&gt; &lt;span class="k"&gt;not&lt;/span&gt; &lt;span class="n"&gt;use&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SEQUENCE&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;condition&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;as&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;condition&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;395&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;11&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="k"&gt;Do&lt;/span&gt; &lt;span class="k"&gt;not&lt;/span&gt; &lt;span class="n"&gt;use&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SEQUENCE&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;condition&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;as&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;condition&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;399&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;11&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="k"&gt;Do&lt;/span&gt; &lt;span class="k"&gt;not&lt;/span&gt; &lt;span class="n"&gt;use&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SEQUENCE&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;condition&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;as&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;condition&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;402&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Missing&lt;/span&gt; &lt;span class="k"&gt;method&lt;/span&gt; &lt;span class="n"&gt;docstring&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;missing&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;docstring&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;C&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;405&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Missing&lt;/span&gt; &lt;span class="k"&gt;method&lt;/span&gt; &lt;span class="n"&gt;docstring&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;missing&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;docstring&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;408&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Unused&lt;/span&gt; &lt;span class="k"&gt;variable&lt;/span&gt; &lt;span class="s1"&gt;'name'&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;unused&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;variable&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;---------------------------------------------------------------------&lt;/span&gt;
&lt;span class="n"&gt;Your&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="n"&gt;has&lt;/span&gt; &lt;span class="n"&gt;been&lt;/span&gt; &lt;span class="n"&gt;rated&lt;/span&gt; &lt;span class="k"&gt;at&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;83&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;
&lt;span class="o"&gt;```&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Pylint scored my original code -1.83/10. D'oh. It turns out one of the
things I wasn't following in 2012 was PEP8, which means I had a lot of
formatting/whitespace issues. Fixing these, my score rose to
6.94/10.&lt;/p&gt;
&lt;p&gt;One thing that I really like about &lt;code&gt;pylint&lt;/code&gt; is how it dramatically
simplifies finding unused variables in my code. Sometimes, I even use
this to help me refactor more systematically: First I change whatever
lines I planned to simplify, then I let &lt;code&gt;pylint&lt;/code&gt; confirm that I can
get rid of the variables I'd planned to eliminate. It turns out I had
four unused variables in 430 lines of code, all easy to fix.&lt;/p&gt;
&lt;p&gt;Another convention I wasn't following in 2012 is the use of
docstrings. Instead, I was writing big block comments, like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;################################################################################&lt;/span&gt;
&lt;span class="c1"&gt;# Procedure: validate_scrape&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Input: Parser and options objects from optparse&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Output: A list of well-formed name tuples.&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Effects: Checks the options object to confirm the inputs are well formed.&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;################################################################################&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that I work with jupyter and ipython more often, I have a better
appreciation for docstrings. It's really helpful to be able to do
&lt;code&gt;function_i_dont_remember ?&lt;/code&gt; at a REPL and immediately pull up
documentation without context switching.&lt;/p&gt;
&lt;h2&gt;Phase 2: Cleaning up the output.&lt;/h2&gt;
&lt;p&gt;After fixing documentation, the next issue I wanted to improve was the
script's lack of logging. For some reason, I'd thought it would be a
good idea to send everything directly to &lt;code&gt;stdout&lt;/code&gt; or &lt;code&gt;stderr&lt;/code&gt;. I even
added a &lt;code&gt;verbose&lt;/code&gt; command line flag, and then introduced conditionals
in my code, like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;OPTIONS&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;verbose_on&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Searching MGP for &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;, &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;, &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;.&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;last&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;first&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;middle&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To simplify this, I introduced the &lt;code&gt;logging&lt;/code&gt; package with a simple
configuration:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;logging&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basicConfig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;level&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;logging&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;INFO&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                    &lt;span class="nb"&gt;format&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;&lt;span class="si"&gt;%(asctime)s&lt;/span&gt;&lt;span class="s1"&gt; &lt;/span&gt;&lt;span class="si"&gt;%(message)s&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                    &lt;span class="n"&gt;datefmt&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'%m/&lt;/span&gt;&lt;span class="si"&gt;%d&lt;/span&gt;&lt;span class="s1"&gt;/%Y %I:%M:%S %p'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;which let me write logs at several different levels whose visibility
can be adjusted in the configuration.&lt;/p&gt;
&lt;h2&gt;Phase 3: Fixing bugs.&lt;/h2&gt;
&lt;p&gt;At this point, I'd resolved most of the obvious issues I wanted to
fix, and narrowed down &lt;code&gt;pylint&lt;/code&gt;'s suggestions to four issues, two of
which were TODOs I'd notice while addressing other issues:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="o"&gt;*************&lt;/span&gt; &lt;span class="n"&gt;Module&lt;/span&gt; &lt;span class="n"&gt;mgptree&lt;/span&gt;
&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;58&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Refactor&lt;/span&gt; &lt;span class="k"&gt;options&lt;/span&gt; &lt;span class="k"&gt;to&lt;/span&gt; &lt;span class="n"&gt;be&lt;/span&gt; &lt;span class="n"&gt;either&lt;/span&gt; &lt;span class="n"&gt;completely&lt;/span&gt; &lt;span class="k"&gt;global&lt;/span&gt; &lt;span class="k"&gt;or&lt;/span&gt; &lt;span class="k"&gt;not&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fixme&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;158&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Consider&lt;/span&gt; &lt;span class="n"&gt;refactor&lt;/span&gt; &lt;span class="n"&gt;here&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fixme&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;36&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="k"&gt;Using&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="k"&gt;global&lt;/span&gt; &lt;span class="k"&gt;statement&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;global&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="k"&gt;statement&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;R&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;208&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Too&lt;/span&gt; &lt;span class="n"&gt;many&lt;/span&gt; &lt;span class="n"&gt;instance&lt;/span&gt; &lt;span class="n"&gt;attributes&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;7&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;too&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;many&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;attributes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;--------------------------------------------------------------------&lt;/span&gt;
&lt;span class="n"&gt;Your&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="n"&gt;has&lt;/span&gt; &lt;span class="n"&gt;been&lt;/span&gt; &lt;span class="n"&gt;rated&lt;/span&gt; &lt;span class="k"&gt;at&lt;/span&gt; &lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;77&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Fixing the whitespace/formatting issues turned out to be a good way to
re-familiarize myself with the code before attempting to fix the
functional issues.&lt;/p&gt;
&lt;p&gt;After running &lt;code&gt;mgptree&lt;/code&gt; on a couple simple examples and looking at the
logs, I realized that the main functional issue was in the function
&lt;code&gt;fetch_id_num&lt;/code&gt;. This function is supposed to take a tuple of names
(first, middle, and last) and determine the ID number of the
mathematician with that name in the MGP service (if the lookup fails
or returns multiple answers, we return &lt;code&gt;None&lt;/code&gt;). The function is
supposed to do this by using &lt;code&gt;requests&lt;/code&gt; to make a POST to the URL
associated with the PHP script that handles users' searches on the MGP
site, and then scraping the resulting reply.&lt;/p&gt;
&lt;p&gt;Looking at the MGP website, it didn't appear to be very different from
what I remembered seeing in 2012, so I was puzzled why my scraping
code had stopped working. After running my function a few times in an
&lt;code&gt;ipython&lt;/code&gt; shell, I realized my main error was my URL. Like a lot of
websites, the math genealogy has moved to HTTPS since 2012. Fixing
that and one other formatting change in the pages' &lt;code&gt;&amp;lt;title&amp;gt;&lt;/code&gt; section
and my scraping code was working properly again.&lt;/p&gt;
&lt;h2&gt;Wrapping Up&lt;/h2&gt;
&lt;p&gt;Overall, the improvements I made to my script were pretty trivial,
but they illustrate some practices that I think are really helpful for
increasing one's personal productivity:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;em&gt;Restoring an Invariant&lt;/em&gt;: When I don't know what to do next (or
   where to start), I find &lt;code&gt;pylint&lt;/code&gt; and &lt;code&gt;nosetests&lt;/code&gt; are great
   guides. Both tools specify an invariant (no lint errors above a
   certain level, all unit tests passing, etc.) that should be
   maintained whenever code gets committed. If the invariant isn't
   satisfied, the next steps are clear: Investigate why, and fix it.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;em&gt;One Thing a Time:&lt;/em&gt; Even though my changes were simple, I made a
   total of 8 commits to get my code back in working order. Each one
   focusses on a single issue I wanted to improve in the code
   (i.e. remove all whitespace lint errors). I find it can be really
   easy to start "improving" two or three issues at the same time, and
   then do a poor job on all of them (or get stuck). For me, following
   the rule of one issue per commit has been a great way to stay
   organized and break larger problems into manageable pieces.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I can see a couple of areas I might want to improve in the future. It
would be nice to to store scraped data in an &lt;code&gt;sqlite&lt;/code&gt; database, which
might simplify computing other graph-based presentations of the
dataset (for example, finding all of the students descended from a
particular mathematician). It might also be cool to convert this to a
django or flask app, so that people unfamiliar with the command line
can generate their own graphs.&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="Python, Projects, Refactoring"></category></entry><entry><title>A Mathematics Geneaology Project Visualizer</title><link href="https://jsthomas.github.io/math-genealogy-visualizer.html" rel="alternate"></link><published>2014-04-02T00:00:00-04:00</published><updated>2014-04-02T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2014-04-02:/math-genealogy-visualizer.html</id><summary type="html">&lt;p&gt;A program to visualize data from the Mathematics Geneaology Project&lt;/p&gt;</summary><content type="html">&lt;p&gt;The
&lt;a href="http://genealogy.math.ndsu.nodak.edu/"&gt;Mathematics Geneaology Project&lt;/a&gt;
(MGP) is a publicly searchable database that records advisor-advisee
relations between mathematicians. Their website is interesting,
particularly if you're interested in the history of
mathematics. Unfortunately, their website is also mostly text-based;
there isn't a way to visualize the relationships between large groups
of people.&lt;/p&gt;
&lt;p&gt;I've created a tool that produces a directed graph displaying the
advisor-advisee relations stored in the MGP database. I created this
tool in 2012 in order to learn about how to process data from the web
using python.&lt;/p&gt;
&lt;h2&gt;Example Output&lt;/h2&gt;
&lt;p&gt;After reading the steps below, you should be able to produce a picture
like the one below.&lt;/p&gt;
&lt;p&gt;&lt;img alt="A genealogical tree" src="https://jsthomas.github.io/images/mgptree/gauss.png" style="width: 764px; height: auto;"/&gt;&lt;/p&gt;
&lt;p&gt;Naturally, the real purpose of the tool is to make much bigger graphs
than this!&lt;/p&gt;
&lt;h2&gt;Download&lt;/h2&gt;
&lt;p&gt;You will need the following:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;A copy of my python script which you can &lt;a href="https://github.com/jsthomas/mgptree"&gt;download here&lt;/a&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;An installation of &lt;a href="http://www.graphviz.org/"&gt;graphviz&lt;/a&gt; (this
program takes care of the actual graph drawing).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Basic knowledge of the command line.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;On an Ubuntu machine, these dependencies (&lt;code&gt;graphviz&lt;/code&gt; and &lt;code&gt;requests&lt;/code&gt;)
can be installed via:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ sudo apt install virtualenv graphviz
$ virtualenv venv
$ venv/bin/activate
&lt;span class="o"&gt;(&lt;/span&gt;venv&lt;span class="o"&gt;)&lt;/span&gt; $ pip install requirements.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Usage Example&lt;/h2&gt;
&lt;p&gt;The easiest way to learn how to use this tool is by way of an
example. Place the &lt;code&gt;mgptree&lt;/code&gt; script in a convenient folder (the
program generates a number of files). Change the permissions on the
script so that you can execute it.&lt;/p&gt;
&lt;p&gt;Let's say we want to generate a tree for Gau and Fourier, going back
5 generations. The first step is to prepare a file of names for our
search:&lt;/p&gt;
&lt;p&gt;So, we create a unicode text file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;Gau, Carl, Friedrich&lt;/span&gt;
&lt;span class="err"&gt;Fourier, Jean-Baptiste, Joseph&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I'll call the file &lt;code&gt;gf.txt&lt;/code&gt;. Now we need to get some data from the
web. We do this as follows:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;(venv) $ python mgptree.py -g 5 -s -i gf.txt -o gf.mgp&lt;/span&gt;
&lt;span class="err"&gt;Saved 25 records to file gf.mgp.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;code&gt;-s&lt;/code&gt; option indicates we want to "scrape" data from the MGP
website. The &lt;code&gt;-g&lt;/code&gt; option indicates how many generations backward we
want to search. The &lt;code&gt;-i&lt;/code&gt; denotes our input file, the &lt;code&gt;-o gf.mgp&lt;/code&gt;
indicates that we want to save our results in a database named
&lt;code&gt;gf.mgp&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Now we need to graph the data, so we type the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;(venv) $ python mgptree.py -p -i gf.mgp -o gf.dot&lt;/span&gt;
&lt;span class="err"&gt;(venv) $ dot -Tpng gf.dot -o gf.png&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In the first line, the &lt;code&gt;-p&lt;/code&gt; indicates we are now in "plotting mode"
where we want to convert the input database &lt;code&gt;gf.mgp&lt;/code&gt; to a textual
format, which we'll save as &lt;code&gt;gf.dot&lt;/code&gt;. The next line hands the textual
data to the graphviz program &lt;code&gt;dot&lt;/code&gt;, which converts it to a PNG image
file named &lt;code&gt;gf.png&lt;/code&gt;. (Many other file formats are available.)&lt;/p&gt;
&lt;p&gt;&lt;img alt="Genealogical trees of Gauss and Fourier" src="https://jsthomas.github.io/images/mgptree/gf.png" style="width: 1915px; height: auto;"/&gt;&lt;/p&gt;
&lt;p&gt;Creating the intermediate database &lt;code&gt;gf.mgp&lt;/code&gt; allows us to work with the
data offline, without having to query the web while we are figuring
out how we want to plot the data.  For example, suppose we only want
to present two generations of the data we just downloaded. Then we'd
type&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;(venv) $ python mgptree.py -p -g2 -i gf.mgp -o gf_tiny.dot&lt;/span&gt;
&lt;span class="err"&gt;(venv) $ dot -Tpng gf_tiny.dot -o gf_tiny.png&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and we wouldn't have to retrieve any information from the web. The
result, &lt;code&gt;gf_tiny.png&lt;/code&gt; looks like this:&lt;/p&gt;
&lt;p&gt;&lt;img alt="A small genealogical tree of Gauss and Fourier." src="https://jsthomas.github.io/images/mgptree/gf_tiny.png" style="width: 907px; height: auto;"/&gt;&lt;/p&gt;
&lt;p&gt;This feature can be pretty useful if you're trying to work with very
large sets of data and don't know how much information you want to
present.&lt;/p&gt;
&lt;h2&gt;Usage Tips&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The Math Geneaology Project has some "holes" in its data. This seems
to be particularly true for mathematicians who didn't get their degree
in Europe or the US. If you or your advisor aren't listed, add your
data to their website
&lt;a href="http://genealogy.math.ndsu.nodak.edu/submit.php"&gt;here&lt;/a&gt; to help fill
in the gaps!&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The number of requests to the MGP's database can grow to be quite
large if you search back 10 or more generations. In particular, it's
probably not a good idea to try to generate a tree for a large number
of people &lt;em&gt;and&lt;/em&gt; many generations.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Accurately matching name data isn't easy. For example, the
mathematician Felix Klein is really named Christian Felix Klein. If
your searches don't succeed, check to make sure you've got your name
data right. This is particularly true for names with accents and
umlauts.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Making Pretty Graphs&lt;/h2&gt;
&lt;p&gt;Because my script produces an intermediate &lt;code&gt;.dot&lt;/code&gt; file, it is possible
for you to edit that file to add additional information or decorations
to the graph. Don't like the font I chose? Change the &lt;code&gt;font=Courier&lt;/code&gt;
entry in the &lt;code&gt;.dot&lt;/code&gt; file. Want to adjust a few nodes so that
significant mathematicians have special node colors? Search for their
names in the &lt;code&gt;.dot&lt;/code&gt; file, then add the metadata
&lt;code&gt;color=[your color here]&lt;/code&gt; to their nodes. The documentation for
graphviz is very useful for tasks like this.&lt;/p&gt;</content><category term="Python, Projects"></category></entry><entry><title>A Camera-Based Virtual Keyboard System</title><link href="https://jsthomas.github.io/vkeyboard.html" rel="alternate"></link><published>2013-12-10T00:00:00-05:00</published><updated>2013-12-10T00:00:00-05:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2013-12-10:/vkeyboard.html</id><summary type="html">&lt;p&gt;A brief summary of my term project for ECE 532&lt;/p&gt;</summary><content type="html">&lt;p&gt;In the Fall of 2013, I developed a camera-based keyboard system as my
term project for an image analysis course. This page provides a brief
summary of my project.&lt;/p&gt;
&lt;p&gt;In my system, a webcam looks down on a user's hands, which rest on a
paper keyboard template. My program collects images from the webcam to
determine when and where the user touches the keyboard template. When
the user touches a key, my program produces the corresponding letter
as output.&lt;/p&gt;
&lt;p&gt;Virtual keyboards are still actively researched in computer science
and electrical engineering. The system I implemented uses techniques
published in [1]-[3] between 2010 and 2013. Camera-based virtual
keyboards require a number of interesting image analysis techniques to
implement. They are particularly of interest in mobile applications
and in areas where one would like to avoid the cost of a physical
keyboard (for example, projects providing computers to people in the
developing world).&lt;/p&gt;
&lt;h1&gt;Processing Steps&lt;/h1&gt;
&lt;p&gt;The virtual keyboard system I implemented needed to solve three main
problems:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Detect the locations of the user's fingertips.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Detect whether any fingertips are in contact with the tabletop.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;When a fingertip touches the tabletop, determine which key was
pressed on the keyboard.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The first problem can be solved by segmenting an input image &lt;span class="math"&gt;\(I\)&lt;/span&gt; into
two regions: one representing the hands and another representing the
background. For each connected component of the hand region, we can
extract a contour &lt;span class="math"&gt;\(\gamma\)&lt;/span&gt; that traverses the boundary
counterclockwise. Places where &lt;span class="math"&gt;\(\gamma\)&lt;/span&gt; has high curvature (the
places where &lt;span class="math"&gt;\(\gamma\)&lt;/span&gt; bends the most sharply) typically correspond to
fingertips.&lt;/p&gt;
&lt;p&gt;&lt;img alt="Virtual keyboard processing steps." src="https://jsthomas.github.io/images/vkeyboard/kb_processing.png" style="width: 1680px; height: auto;"/&gt;&lt;/p&gt;
&lt;p&gt;I addressed the second problem using a technique called &lt;em&gt;shadow
analysis&lt;/em&gt;, which is discussed in [1]. With this technique, we perform
another segmentation on &lt;span class="math"&gt;\(I\)&lt;/span&gt;, to locate the regions in the image that
represent the shadows of the user's hands. Then, we examine small
neighborhoods near the user's fingertips. If the proportion of
shadow-pixels in a given neighborhood is above a certain threshold, we
infer that the corresponding fingertip is not in contact with the
tabletop (because it has a shadow). Otherwise, we declare that
fingertip to be touching the keyboard.&lt;/p&gt;
&lt;p&gt;The last problem is solved by making some assumptions about the
geometry of the keyboard and imaging system. I assumed that the
keyboard template displays four easily identifiable control points
arranged in a rectangle, and that the front edge of the control
rectangle is parallel to the &lt;span class="math"&gt;\(x\)&lt;/span&gt;-axis of the camera's coordinate
system. With these additional assumptions, it isn't too hard to invert
the perspective projection and recover the keyboard-space coordinates
of each keypress from the image-space coordinates of the fingertips.&lt;/p&gt;
&lt;h1&gt;Results&lt;/h1&gt;
&lt;p&gt;After implementing my virtual keyboard system in python, I analyzed
its performance under different lighting and usage conditions. My
tests suggest that a camera-based user interface that uses shadow
analysis will work best under conditions where one has fine control
over the lighting conditions and the user does not need to enter very
much data at one time. For example, a camera-based user interface
would work well in an interactive museum exhibit, but it might not be
a very good tool for word processing in a dark coffee shop. Currently,
camera-based keyboards cannot provide the speed and accuracy
achievable on physical keyboards (but for that matter, neither do
touchscreen keyboards).&lt;/p&gt;
&lt;h1&gt;Downloads&lt;/h1&gt;
&lt;p&gt;Below are links to the paper and code I wrote for the term project. I
used the code within &lt;a href="http://ipython.org/"&gt;ipython&lt;/a&gt; to conduct my
experiments, and used the &lt;a href="http://opencv.org/"&gt;OpenCV&lt;/a&gt; project to get
data from the camera. OpenCV's support for python is still under
development, so if you examine my code you may have to adapt it to
work with your particular hardware and copy of OpenCV.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Paper:
  &lt;a href="https://jsthomas.github.io/docs/vkeyboard/vkeyboard.pdf"&gt;A Camera Based Virtual Keyboard with Touch Detection by Shadow Analysis&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Project Code: &lt;a href="https://jsthomas.github.io/docs/vkeyboard/vkeyboard.zip"&gt;vkeyboard.zip&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Y. Adajania, J. Gosalia, A. Kanade, H. Mehta, and N. Shekokar. Virtual
keyboard using shadow analysis. In Emerging Trends in Engineering and
Technology (ICETET), 2010 3rd International Conference on, page 163 to
165, 2010.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;E. Posner, N. Starzicki, and E. Katz. A single camera based floating virtual
keyboard with improved touch detection. In Electrical Electronics Engineers
in Israel (IEEEI), 2012 IEEE 27th Convention of, page 1 to 5, 2012.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;M. Hagara and J. Pucik. Fingertip detection for virtual keyboard
based on camera. In Radioelektronika (RADIOELEKTRONIKA), 2013 23rd
International Conference, page 356 to 360, 2013.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="Python"></category></entry></feed>