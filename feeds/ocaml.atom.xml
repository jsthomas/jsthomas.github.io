<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Joe Thomas - OCaml</title><link href="https://jsthomas.github.io/" rel="alternate"></link><link href="https://jsthomas.github.io/feeds/ocaml.atom.xml" rel="self"></link><id>https://jsthomas.github.io/</id><updated>2021-07-12T00:00:00-04:00</updated><entry><title>Writing a REST API with Dream</title><link href="https://jsthomas.github.io/ocaml-dream-api.html" rel="alternate"></link><published>2021-07-12T00:00:00-04:00</published><updated>2021-07-12T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2021-07-12:/ocaml-dream-api.html</id><summary type="html">&lt;p&gt;Writing a REST API in Dream&lt;/p&gt;</summary><content type="html">&lt;p&gt;In the last few weeks I've been building a simple REST API using the
&lt;a href="https://aantron.github.io/dream/"&gt;Dream&lt;/a&gt; web framework. Writing APIs
has been one major component of my paid programming work and I wanted
to compare and contrast the experience of writing an API in a strongly
typed functional programming language with the same workflow in a
dynamically typed language like Python.&lt;/p&gt;
&lt;p&gt;You can find the source code for this project
&lt;a href="https://github.com/jsthomas/sensors"&gt;here&lt;/a&gt;. Hopefully, this repo will
be a useful resource for anyone who wants to look at a slightly larger
example application that uses Dream. Though I'm still a beginner, I
was surprised how easy it was to complete familiar tasks in this
framework. I'm optimistic about the future of web programming in
OCaml!&lt;/p&gt;
&lt;p&gt;This post provides a sort of "experience report" for working with
Dream, Yojson, and Caqti. Obviously, these types of reports are highly
subjective and you should run your own experiments too!  I'll be
comparing with my experience in working with
&lt;a href="https://trypyramid.com/"&gt;Pyramid&lt;/a&gt; and
&lt;a href="https://www.sqlalchemy.org/"&gt;SQLAlchemy&lt;/a&gt;, since those are the Python
projects I've used most.&lt;/p&gt;
&lt;p&gt;Finally, it's important to point out that Dream is in alpha (version
&lt;code&gt;1.0.0~alpha2&lt;/code&gt; as of this writing). This is an early version!
Comparisons with frameworks like Pyramid or Flask are in some sense
apples-and-oranges, because those projects have had a long time (and
many engineering hours) to mature. Ultimately, the point of this post
(and the repo that goes with it) isn't to make make value judgements
("framework X is good, Y is bad"), but rather to understand how to
translate concepts from one workflow to another.&lt;/p&gt;
&lt;h2&gt;Problem Definition&lt;/h2&gt;
&lt;p&gt;I decided to build a API for managing time series data. My
requirements for the project were as follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The API will allow creating, reading, and deleting "sensors". A
  sensor is an abstract IoT device that measures a floating point
  quantity at a specific cadence (for example a weather station
  measuring average hourly windspeed).&lt;/li&gt;
&lt;li&gt;Every sensor gets an API key that allows it to upload (POST) data to
  an endpoint.&lt;/li&gt;
&lt;li&gt;A GET endpoint will allow users to retrieve the data a sensor
  generated between two dates.&lt;/li&gt;
&lt;li&gt;The API sends and receives data formatted as JSON and must be backed
  by a PostgreSQL database.&lt;/li&gt;
&lt;li&gt;The API should have &lt;code&gt;login/logout&lt;/code&gt; endpoints for a (not yet built)
  frontend to use.&lt;/li&gt;
&lt;li&gt;Finally, a user should only be allowed to access sensor data that
  belongs to them.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I chose these requirements because they cover a number of different
read/write operations that require data formatting/parsing and
tracking relationships between four different entities (users, keys,
sensors, and readings).&lt;/p&gt;
&lt;h2&gt;Dependencies and Setup&lt;/h2&gt;
&lt;p&gt;For this build, I needed three core dependencies:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;A server to handle web requests (Dream).&lt;/li&gt;
&lt;li&gt;Support for parsing and synthesizing JSON records.&lt;/li&gt;
&lt;li&gt;A library for integrating with PostgreSQL.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;After a bit of research, I settled on
&lt;a href="https://opam.ocaml.org/packages/yojson/"&gt;Yojson&lt;/a&gt; and
&lt;a href="https://opam.ocaml.org/packages/caqti/"&gt;Caqti&lt;/a&gt; for (2) and (3)
respectively. Both of these are fairly standard and appear in the
excellent corpus of
&lt;a href="https://github.com/aantron/dream/tree/master/example"&gt;examples&lt;/a&gt; that
accompany Dream. Since I had previously written an
&lt;a href="https://github.com/aantron/dream/tree/master/example/w-docker-postgres"&gt;example&lt;/a&gt;
of how to use Dream with a dockerized PostrgreSQL container, I used
that as a starting point.&lt;/p&gt;
&lt;p&gt;It's useful to have a way to run (and re-run) ad-hoc requests against
the API during development. I used &lt;a href="https://insomnia.rest/"&gt;Insomnia&lt;/a&gt;
for this, but other tools like &lt;code&gt;curl&lt;/code&gt; would work too.&lt;/p&gt;
&lt;h2&gt;Adding an endpoint&lt;/h2&gt;
&lt;p&gt;To give a sense of my development workflow, I want to walk through my
process for adding a simple endpoint, &lt;code&gt;/api/login&lt;/code&gt;. Inside the router,
that endpoint looks like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt; &lt;span class="s2"&gt;"/api/login"&lt;/span&gt; &lt;span class="n"&gt;login&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In this excerpt &lt;code&gt;login&lt;/code&gt; is a "handler". Handlers are responsible for
translating requests into responses; this is captured in their &lt;a href="https://aantron.github.io/dream/#type-handler"&gt;type
signature&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Conceptually, the &lt;code&gt;login&lt;/code&gt; handler needs to do three things:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Receive a JSON body and confirm it's formatted as expected.&lt;/li&gt;
&lt;li&gt;Look up the relevant user/password combination in the database.&lt;/li&gt;
&lt;li&gt;Load the relevant session information if the credentials are valid.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;For the first part, the endpoint needs to receive a JSON payload that
looks like &lt;code&gt;{"username": "...", "password": "..."}&lt;/code&gt;. To describe that
payload, I introduced a simple record type:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;type&lt;/span&gt; &lt;span class="n"&gt;login_doc&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;username&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;password&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="o"&gt;[@@&lt;/span&gt;&lt;span class="n"&gt;deriving&lt;/span&gt; &lt;span class="n"&gt;yojson&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Adding &lt;code&gt;[@@deriving yojson]&lt;/code&gt; means the compiler can generate functions
to convert these records to and from JSON. In this case those
functions are called &lt;code&gt;login_doc_of_yojson&lt;/code&gt; and &lt;code&gt;yojson_of_login_doc&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;My &lt;code&gt;login&lt;/code&gt; handler looked roughly like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;json_receiver&lt;/span&gt; &lt;span class="n"&gt;json_parser&lt;/span&gt; &lt;span class="n"&gt;handler&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;
      &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;
      &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Yojson&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nn"&gt;Safe&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from_string&lt;/span&gt;
      &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;json_parser&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="nc"&gt;None&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;doc&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;handler&lt;/span&gt; &lt;span class="n"&gt;doc&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"Received invalid JSON input."&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;
    &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;yojson_of_error_doc&lt;/span&gt;
    &lt;span class="o"&gt;|&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;json_response&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="nc"&gt;Bad_Request&lt;/span&gt;


&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;login&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;login_base&lt;/span&gt; &lt;span class="n"&gt;login_doc&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;user_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sql&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;
        &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Models&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nn"&gt;User&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="n"&gt;login_doc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt; &lt;span class="n"&gt;login_doc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;user_id&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;invalidate_session&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
      &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;put_session&lt;/span&gt; &lt;span class="s2"&gt;"user"&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Int&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_string&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
      &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;empty&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="nc"&gt;OK&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;empty&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="nc"&gt;Forbidden&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="n"&gt;json_receiver&lt;/span&gt; &lt;span class="n"&gt;login_doc_of_yojson&lt;/span&gt; &lt;span class="n"&gt;login_base&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If a user uploads an invalid JSON body, this will cause
&lt;code&gt;login_doc_of_yojson&lt;/code&gt; to throw an exception. By default, this produces
a 500 server error response. To handle this situation more gracefully,
I introduced &lt;code&gt;json_receiver&lt;/code&gt;. If the parser passed to &lt;code&gt;json_receiver&lt;/code&gt;
succeeds on the request body, the results are passed to the inner
handler. Otherwise, the server responds with a &lt;code&gt;400 Bad
Request&lt;/code&gt;. Re-using &lt;code&gt;json_receiver&lt;/code&gt; across my endpoints allows me to
avoid introducing a&lt;code&gt;try/with&lt;/code&gt; block any time time I need to handle
JSON input.&lt;/p&gt;
&lt;p&gt;I decided to manage models in a separate library, &lt;code&gt;Models&lt;/code&gt;. The
build tool, &lt;code&gt;dune&lt;/code&gt;, made this easy to do; I just needed separate
&lt;code&gt;dune&lt;/code&gt; files for the &lt;code&gt;server/model&lt;/code&gt; and &lt;code&gt;server/bin&lt;/code&gt; folders. I like
this design because it simplifies re-use of the database portion of my
project. For example, if I later needed to build a CLI admin tool,
that tool could utilize my existing queries without being exposed to
API concerns.&lt;/p&gt;
&lt;p&gt;Inside &lt;code&gt;User&lt;/code&gt;, the &lt;code&gt;get&lt;/code&gt; query function is defined as:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;query&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="nn"&gt;R&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find_opt&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tup2&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;int&lt;/span&gt;
      &lt;span class="s2"&gt;"SELECT id FROM app_user WHERE username = ? and password = ?"&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;fun&lt;/span&gt; &lt;span class="n"&gt;username&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;module&lt;/span&gt; &lt;span class="nc"&gt;Db&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nc"&gt;DB&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;user_or_error&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find_opt&lt;/span&gt; &lt;span class="n"&gt;query&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="nn"&gt;Caqti_lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;or_fail&lt;/span&gt; &lt;span class="n"&gt;user_or_error&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Caqti allows us to define a function that consumes our query
parameters (the username and password) along with a database
connection, and produces a promise that will resolve with the results
of the query. In this case, the types encode that the function
produces an &lt;code&gt;int option&lt;/code&gt; containing the user's primary key if the
credentials are valid. (Note that it's not a good idea to store
passwords in plain text like this; this is just for illustrative
purposes.)&lt;/p&gt;
&lt;p&gt;Session management, the final item that the endpoint needs to address,
is handled by Dream. The framework allows sessions to be stored in
cookies, memory, or the database; I opted for database sessions
because I had used similar session backends in the past. Sessions
allow us to store pairs key/value strings across requests. I used the
session just to store the logged-in user's ID, so that the API has
easy access in later database queries.&lt;/p&gt;
&lt;h2&gt;Thoughts on the Dream Router&lt;/h2&gt;
&lt;p&gt;The final router for my server looked like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;interface&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"0.0.0.0"&lt;/span&gt;
  &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;logger&lt;/span&gt;
  &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sql_pool&lt;/span&gt; &lt;span class="s2"&gt;"postgresql://sensors@127.0.0.1/sensors"&lt;/span&gt;
  &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sql_sessions&lt;/span&gt;
  &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;router&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;
    &lt;span class="c"&gt;(* More endpoints here ... *)&lt;/span&gt;

    &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="s2"&gt;"/version"&lt;/span&gt; &lt;span class="n"&gt;version&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt; &lt;span class="s2"&gt;"/api/login"&lt;/span&gt; &lt;span class="n"&gt;login&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt; &lt;span class="s2"&gt;"/api/logout"&lt;/span&gt; &lt;span class="n"&gt;logout&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="s2"&gt;"/api"&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;login_required&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;
      &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="s2"&gt;"/user/:user_id"&lt;/span&gt; &lt;span class="n"&gt;user&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
      &lt;span class="c"&gt;(* More endpoints here... *)&lt;/span&gt;
    &lt;span class="o"&gt;];&lt;/span&gt;

    &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="s2"&gt;"/sensor"&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;
      &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt; &lt;span class="s2"&gt;"/upload"&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="n"&gt;api_key_required&lt;/span&gt; &lt;span class="n"&gt;sensor_upload&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Dream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;not_found&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I really appreciate how Dream makes it possible to get a concise
overview of the API; in some Pyramid projects, I found this wasn't
always possible. In fact, in Pyramid I sometimes struggled with subtle
routing bugs that were not obvious until run time. Having the compiler
validate the router in Dream was a welcome change.&lt;/p&gt;
&lt;p&gt;At the moment, Pyramid makes it somewhat easier to handle
access/permissions concerns compared to Dream. Working in Pyramid, it
was relatively common for the routes to manage some amount of
parameter validation and permissions. For example, given a path
&lt;code&gt;/user/123/article/abc456&lt;/code&gt;, the route (or "resources" in Pyramid
terminology) would be responsible for:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Extracting the user and article IDs (&lt;code&gt;123&lt;/code&gt; and &lt;code&gt;abc456&lt;/code&gt;).&lt;/li&gt;
&lt;li&gt;Determining those records actually exist in the database, and
  passing them to the view/handler in a context record.&lt;/li&gt;
&lt;li&gt;Validating that the requester has permissions to operate on those
User and Article records.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is discussed a bit more in the Pyramid Docs under &lt;a href="https://docs.pylonsproject.org/projects/pyramid/en/latest/narr/traversal.html"&gt;URL
traversal&lt;/a&gt;.
Effectively, Pyramid resources mean that handler/view code downstream
can focus on updating database records and/or rendering HTML/JSON
without worrying about permissions concerns.&lt;/p&gt;
&lt;p&gt;I didn't want to build a permissions system for my API so instead I
incorporated User IDs into my function signatures in &lt;code&gt;Model&lt;/code&gt; and used
inner joins to model permissions. For example, here is an example of a
query that fetches the metadata for all sensors belonging to a
particular user:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;description&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;k&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;uuid&lt;/span&gt;
&lt;span class="k"&gt;FROM&lt;/span&gt; &lt;span class="n"&gt;sensor&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;
&lt;span class="k"&gt;INNER&lt;/span&gt; &lt;span class="k"&gt;JOIN&lt;/span&gt; &lt;span class="n"&gt;user_sensor&lt;/span&gt; &lt;span class="n"&gt;us&lt;/span&gt;
 &lt;span class="k"&gt;ON&lt;/span&gt; &lt;span class="n"&gt;us&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sensor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="k"&gt;AND&lt;/span&gt; &lt;span class="n"&gt;us&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;app_user&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="k"&gt;AND&lt;/span&gt; &lt;span class="n"&gt;us&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sensor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;
&lt;span class="k"&gt;INNER&lt;/span&gt; &lt;span class="k"&gt;JOIN&lt;/span&gt; &lt;span class="n"&gt;api_key&lt;/span&gt; &lt;span class="n"&gt;k&lt;/span&gt;
 &lt;span class="k"&gt;ON&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;api_key&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;k&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By joining against &lt;code&gt;user_sensor&lt;/code&gt;, I ensure that a user only gets data
for the sensors they own.&lt;/p&gt;
&lt;p&gt;I should point out that Dream allows us to use a custom router,
however! The project has &lt;a href="https://github.com/aantron/dream/issues/122"&gt;an
issue&lt;/a&gt; for more elaborate
routing and Ulrik Strid has introduced
&lt;a href="https://github.com/ulrikstrid/dream-routes"&gt;dream-routes&lt;/a&gt;, which
allows additional type information to be encoded in routes. So,
writing a more sophisticated router that behaves like Pyramid's
resource system is certainly possible.&lt;/p&gt;
&lt;h2&gt;Comparing Caqti and SQLAlchemy&lt;/h2&gt;
&lt;p&gt;As a web programmer, especially one working on an analytics project,
it's important to get comfortable working with the database library
you've chosen for your project. Indeed, a significant portion of this
project consisted of familiarizing myself with &lt;code&gt;Caqti&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Caqti is a bit different from SQLAlchemy. With SQLAlchemy, you
typically define one class for each table. Then, using SQLAlchemy's
metaprogramming features, those classes are used to define
queries. For comparison, here are equivalent queries against the user
table:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Caqti&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;query&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="nn"&gt;R&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find_opt&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tup2&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="nn"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;int&lt;/span&gt;
      &lt;span class="s2"&gt;"SELECT id FROM app_user WHERE username = ? and password = ?"&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;fun&lt;/span&gt; &lt;span class="n"&gt;username&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;module&lt;/span&gt; &lt;span class="nc"&gt;Db&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nc"&gt;DB&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;lwt&lt;/span&gt; &lt;span class="n"&gt;user_or_error&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Db&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find_opt&lt;/span&gt; &lt;span class="n"&gt;query&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="nn"&gt;Caqti_lwt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;or_fail&lt;/span&gt; &lt;span class="n"&gt;user_or_error&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;SQLAlchemy&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;db&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; \
    &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;username&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;username&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;password&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;one_or_none&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Working with Caqti, a mistake in the syntax of a SQL query won't be
discovered until runtime. I made fewer mistakes like this with
SQLAlchemy because most queries are written in Python and can be
linted by the IDE. Another recurring point of confusion for me with
Caqti had to do with matching the function on the &lt;code&gt;Caqti_request&lt;/code&gt;
(&lt;code&gt;R.find_opt&lt;/code&gt; above) with the function invoked in &lt;code&gt;Db&lt;/code&gt;
(&lt;code&gt;Db.find_opt&lt;/code&gt;); this is how we indicate that the query produces zero,
one, zero/one, or multiple rows. If the two don't agree, the program
won't compile; initially I struggled to understand what this
compiler error meant:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;The&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="n"&gt;applied&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt; &lt;span class="n"&gt;argument&lt;/span&gt; &lt;span class="n"&gt;has&lt;/span&gt; &lt;span class="n"&gt;type&lt;/span&gt;
         &lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;:(&lt;/span&gt;&lt;span class="n"&gt;Caqti_driver_info&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;t&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Caqti_query&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;t&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
         &lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="n"&gt;oneshot&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="n"&gt;bool&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
         &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;unit&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;[&amp;lt;&lt;/span&gt; &lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="n"&gt;Many&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="n"&gt;One&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="n"&gt;Zero&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="n"&gt;Zero&lt;/span&gt; &lt;span class="o"&gt;])&lt;/span&gt; &lt;span class="n"&gt;Caqti_request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;t&lt;/span&gt;
&lt;span class="n"&gt;This&lt;/span&gt; &lt;span class="n"&gt;argument&lt;/span&gt; &lt;span class="n"&gt;cannot&lt;/span&gt; &lt;span class="n"&gt;be&lt;/span&gt; &lt;span class="n"&gt;applied&lt;/span&gt; &lt;span class="n"&gt;without&lt;/span&gt; &lt;span class="n"&gt;label&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Using Caqti became easier as I became accustomed to thinking in terms of
prepared queries. About halfway through the project I realized I
needed to switch from SQLite to PostgreSQL, and changing databases was
fairly painless because Caqti supports both.&lt;/p&gt;
&lt;p&gt;I also made use of Caqti's features for dealing with custom column
types. Caqti does not have built-in support for JSON columns, but
adding a custom column type to handle this was straightforward:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;type&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;readings&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nc"&gt;float&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;option&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;array&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;@@deriving yojson&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;sql_readings&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nl"&gt;a&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;readings&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Ok&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;yojson_of_readings&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Yojson&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Safe&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_string&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="ow"&gt;in&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;decode&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nc"&gt;text&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Ok&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;text&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Yojson&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Safe&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from_string&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;readings_of_yojson&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="ow"&gt;in&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;.(&lt;/span&gt;&lt;span class="n"&gt;custom&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;decode&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In my case, the JSON that I needed to store consisted of arrays of
floating point numbers, so building the custom type was simply a
matter of connecting Yojson and Caqti in the right way.&lt;/p&gt;
&lt;h2&gt;Discussion&lt;/h2&gt;
&lt;p&gt;Ever since I started building web applications in Python, I've thought
of an API server as a big function that transforms requests into
responses, with any nontrivial state residing in databases or services
like S3. Dream provides a modern web framework that matches my mental
model for how a web server should work.&lt;/p&gt;
&lt;p&gt;Web programming in OCaml "feels" a bit different than working in
Python. In Python it's possible to get something running quickly, but
it's also easy to forget corner cases and introduce defects that have
to be addressed later in the application's lifecycle. An OCaml project
requires some up-front investment, but this investment pays off later
in several ways. First, fast feedback from the compiler (together with
editor integrations like &lt;code&gt;merlin&lt;/code&gt; and &lt;code&gt;tuareg&lt;/code&gt;) helped me to identify
issues earlier. &lt;code&gt;Yojson&lt;/code&gt; made it simple to enforce that JSON requests
and responses adhered to a fixed schema, and helped me process inputs
more systematically. OCaml made refactoring safe and easy, so that I
could confidently adapt my design as I introduced new requirements. In
the right context, I think the advantages of using OCaml could
significantly reduce the total lifecycle costs of maintaining many web
applications without reducing the pace of new development.&lt;/p&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;p&gt;I found the resources below helpful for working on this project:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The Dream &lt;a href="https://aantron.github.io/dream/"&gt;API docs&lt;/a&gt; set a high
  standard for readability and helped me quickly get up to speed with
  the framework.&lt;/li&gt;
&lt;li&gt;This &lt;a href="https://github.com/aantron/dream/tree/master/example"&gt;section&lt;/a&gt;
  of the Dream repo has excellent examples, both for working with the
  framework and deploying it.&lt;/li&gt;
&lt;li&gt;I referred to Bobby Priambodo's &lt;a href="https://medium.com/@bobbypriambodo/interfacing-ocaml-and-postgresql-with-caqti-a92515bdaa11"&gt;blog
  posts&lt;/a&gt;
  about interfacing Caqti and PostgreSQL as I wrote the models in my project.&lt;/li&gt;
&lt;li&gt;The Caqti
  &lt;a href="https://paurkedal.github.io/ocaml-caqti/index.html"&gt;docs&lt;/a&gt;,
  especially for &lt;code&gt;Caqti_type&lt;/code&gt; and &lt;code&gt;Caqti_request&lt;/code&gt; were helpful as I
  was writing queries.&lt;/li&gt;
&lt;li&gt;There is also an
  &lt;a href="https://github.com/paurkedal/ocaml-caqti/blob/master/tests/bikereg.ml"&gt;example&lt;/a&gt;
  in the Caqti repo that is worth looking through.&lt;/li&gt;
&lt;li&gt;The README on
  &lt;a href="https://github.com/janestreet/ppx_yojson_conv"&gt;ppx_yojson_conv&lt;/a&gt; had
  helpful examples that I referred to while writing my own
  JSON-related types.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Feedback&lt;/h2&gt;
&lt;p&gt;If you ended up looking through the source code for my API, let me
know how what you thought! I'm interested in adding more tutorial
resources to the OCaml ecosystem, so feel free to post a PR or issue
to
&lt;a href="https://github.com/jsthomas/sensors"&gt;sensors&lt;/a&gt;
if you have ideas about how to make these resources better.&lt;/p&gt;</content><category term="OCaml"></category></entry><entry><title>Let's write a shell in OCaml!</title><link href="https://jsthomas.github.io/ocaml-shell.html" rel="alternate"></link><published>2021-07-01T00:00:00-04:00</published><updated>2021-07-01T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2021-07-01:/ocaml-shell.html</id><summary type="html">&lt;p&gt;A user experience report about writing a simple shell in OCaml&lt;/p&gt;</summary><content type="html">&lt;p&gt;This Summer I'm studying OCaml and systems programming at the &lt;a href="https://www.recurse.com/"&gt;Recurse
Center&lt;/a&gt;. Currently I'm reading the
delightful book &lt;a href="https://pages.cs.wisc.edu/~remzi/OSTEP/"&gt;&lt;em&gt;Operating Systems: Three Easy
Pieces&lt;/em&gt;&lt;/a&gt; by Remzi
Arpaci-Dusseau and Andrea Arpaci-Dusseau. Besides great exposition,
the book includes several interesting projects, one of which is to
&lt;a href="https://github.com/remzi-arpacidusseau/ostep-projects/tree/master/processes-shell"&gt;write a
shell&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The project materials, a set of shell scripts that define tests, are
language agnostic. I believe the authors intended for students to use
C, but I worked through the exercise in OCaml; you can find the final
result &lt;a href="https://github.com/jsthomas/simple-ocaml-shell"&gt;in this
repo&lt;/a&gt;. This blog post
is a short experience report; if you're interested in working on a
beginner OCaml project, hopefully it provides some useful scaffolding
for your studies.&lt;/p&gt;
&lt;h2&gt;Shell features&lt;/h2&gt;
&lt;p&gt;The shell I built (&lt;code&gt;osh&lt;/code&gt;) has a somewhat limited feature set. It:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Allows several commands to be run in parallel (e.g. &lt;code&gt;program1 arg1 &amp;amp;
  program2 arg2 arg3&lt;/code&gt;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Supports simple output redirection (e.g. &lt;code&gt;echo "hello" &amp;gt;
  hello.txt&lt;/code&gt;). Both &lt;code&gt;stdout&lt;/code&gt; and &lt;code&gt;stderr&lt;/code&gt; go to the same file.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Has three builtin functions, &lt;code&gt;cd&lt;/code&gt;, &lt;code&gt;exit&lt;/code&gt;, and &lt;code&gt;path&lt;/code&gt;. &lt;code&gt;path&lt;/code&gt; allows
  you to define a list of directories to search for executables; we
  need this because environment variables aren't supported.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Other niceties, like tab completion and pipes, aren't supported. To
facilitate testing, the shell can run in a batch mode (&lt;code&gt;osh &amp;lt;my file
of commands&amp;gt;&lt;/code&gt;) as well as an interactive mode. A final simplifying
assumption is that &lt;code&gt;osh&lt;/code&gt; only provides a basic error message when
inputs are malformed.&lt;/p&gt;
&lt;h2&gt;Concepts&lt;/h2&gt;
&lt;p&gt;There are three main topics I studied while working on this project:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The &lt;code&gt;Unix&lt;/code&gt; module, especially &lt;code&gt;fork&lt;/code&gt; and
    &lt;code&gt;execv&lt;/code&gt;. &lt;a href="https://ocaml.github.io/ocamlunix/ocamlunix.html"&gt;This
    page&lt;/a&gt;, from
    Xavier Leroy and Didier RÃ©my, was helpful for getting up to
    speed. The man-pages were also useful.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;a href="https://ocaml.org/api/Stream.html"&gt;&lt;code&gt;Stream&lt;/code&gt;&lt;/a&gt; module. Streams
   in OCaml are roughly analogous to generators in Python; they
   allowed me to use a single type (a &lt;code&gt;string Stream.t&lt;/code&gt;) to represent
   commands coming from an interactive session or a batch file.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;a href="https://github.com/inhabitedtype/angstrom"&gt;Angstrom&lt;/a&gt;
   parser-combinator library. I used this library to determine whether
   a given line of user input is well formed.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I suspect you could implement the parser without Angstrom, if you
really wanted to. I wanted to learn more about this library, and this
project seemed like a good place to try it out.&lt;/p&gt;
&lt;p&gt;Although I previously worked through some simple monadic parser
exercises in Haskell, I struggled the most with Angstrom. Reading one
of the main &lt;a href="https://github.com/inhabitedtype/angstrom/blob/master/lib/angstrom.mli"&gt;mli
files&lt;/a&gt;
seemed to be the best way to get an overview of the combinators the
library provides. I also spent a fair amount of time experimenting in
&lt;code&gt;utop&lt;/code&gt; as I put my parser together.&lt;/p&gt;
&lt;h2&gt;Steps&lt;/h2&gt;
&lt;p&gt;Here is a rough outline for how I built my shell.&lt;/p&gt;
&lt;p&gt;First, I defined a main function that would fetch a line of text from
&lt;code&gt;stdin&lt;/code&gt; and echo it back to the user. Then I added the ability to
represent either interactive or batch input with a &lt;code&gt;Stream&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;prompt_stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="nn"&gt;Printf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"osh&amp;gt; "&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;read_line&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;


&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;file_stream&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;in_channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;open_in&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;
      &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;input_line&lt;/span&gt; &lt;span class="n"&gt;in_channel&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="nc"&gt;End_of_file&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="n"&gt;close_in&lt;/span&gt; &lt;span class="n"&gt;in_channel&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
      &lt;span class="nc"&gt;None&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It's useful to do this part as early as possible, since batch input
allows you to run the tests.&lt;/p&gt;
&lt;p&gt;Once I could get &lt;code&gt;osh&lt;/code&gt; to fail all 22 test cases, I started adding the
simpler built-in commands &lt;code&gt;cd&lt;/code&gt; and &lt;code&gt;exit&lt;/code&gt;. (Note &lt;code&gt;./test-osh.sh -c&lt;/code&gt;
will run all 22 tests, without stopping at the first one that fails.)&lt;/p&gt;
&lt;p&gt;My first version of &lt;code&gt;main&lt;/code&gt; just treated user input as &lt;code&gt;string list&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;rec&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;String&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split_on_char&lt;/span&gt; &lt;span class="sc"&gt;' '&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;parse&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;  &lt;span class="c"&gt;(* Empty lines should just be treated as no-ops. *)&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;""&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"exit"&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;exit&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"cd"&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;chdir&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="s2"&gt;"cd"&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;print_error&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;xs&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fork&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
      &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Child *)&lt;/span&gt;
        &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;execv&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;Array&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;of_list&lt;/span&gt; &lt;span class="n"&gt;xs&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
      &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Parent *)&lt;/span&gt;
        &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;waitpid&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt;
        &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iter&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This worked well enough for running simple commands like &lt;code&gt;/usr/bin/ls
-lah&lt;/code&gt;. In order to get output redirection and &lt;code&gt;&amp;amp;&lt;/code&gt; to work, I needed to
upgrade the program's parsing capabilities. I switched from
representing user input with a &lt;code&gt;string list&lt;/code&gt; to a variant type:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;type&lt;/span&gt; &lt;span class="n"&gt;exec&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="kt"&gt;list&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="n"&gt;option&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;type&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;NoOp&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;ChangeDirectory&lt;/span&gt; &lt;span class="k"&gt;of&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;PathChange&lt;/span&gt; &lt;span class="k"&gt;of&lt;/span&gt; &lt;span class="kt"&gt;string&lt;/span&gt; &lt;span class="kt"&gt;list&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Executable&lt;/span&gt; &lt;span class="k"&gt;of&lt;/span&gt; &lt;span class="n"&gt;exec&lt;/span&gt; &lt;span class="kt"&gt;list&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Quit&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I found the OCaml compiler (and its emacs integrations, &lt;code&gt;merlin&lt;/code&gt; and
&lt;code&gt;tuareg&lt;/code&gt;) very helpful for refactoring. When I revised my types to
make them better reflect the data I wanted to model, type errors
identified all of the places I needed to update. At this point, I
introduced an Angstrom parser and re-implemented support for &lt;code&gt;cd&lt;/code&gt;,
&lt;code&gt;exit&lt;/code&gt;, and &lt;code&gt;path&lt;/code&gt;. That allowed me to get familiar with the parser
combinators &lt;code&gt;*&amp;gt;&lt;/code&gt;, &lt;code&gt;many&lt;/code&gt;, and &lt;code&gt;choice&lt;/code&gt;, before attempting the more
complicated parsers needed to support &lt;code&gt;&amp;amp;&lt;/code&gt; and &lt;code&gt;&amp;gt;&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The type system protected me from a number of silly mistakes, but it
wasn't a silver bullet. I spent an hour confused about why one of my
parsers would go into an infinite loop before realizing I needed to
use &lt;code&gt;many1&lt;/code&gt; instead of &lt;code&gt;many&lt;/code&gt;. I think this is the sort of mistake I
would learn to avoid if I spent more time working with Angstrom.&lt;/p&gt;
&lt;h2&gt;Discussion&lt;/h2&gt;
&lt;p&gt;As I worked through this project, I started to appreciate how OCaml
chooses "good defaults" for my code (especially immutable data)
without forbidding me from working in an imperative mode when I need
to.&lt;/p&gt;
&lt;p&gt;For example, I found that the function responsible for running a child
process was most natural to express with imperative language features:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;run_executable&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;full_paths&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;fun&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;^&lt;/span&gt; &lt;span class="s2"&gt;"/"&lt;/span&gt; &lt;span class="o"&gt;^&lt;/span&gt; &lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;executables&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt; &lt;span class="n"&gt;full_paths&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;present&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt; &lt;span class="n"&gt;executable_present&lt;/span&gt; &lt;span class="n"&gt;executables&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;

  &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;present&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;print_error&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fork&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Child *)&lt;/span&gt;
       &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;openfile&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;O_TRUNC&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;O_WRONLY&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nc"&gt;O_CREAT&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="mo"&gt;0o640&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;
       &lt;span class="k"&gt;in&lt;/span&gt;
       &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;None&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stderr&lt;/span&gt;
         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt;
       &lt;span class="k"&gt;in&lt;/span&gt;
       &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dup2&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
       &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dup2&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stderr&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
       &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;execv&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="nn"&gt;Array&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;of_list&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt; &lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;(* Parent *)&lt;/span&gt;
      &lt;span class="nc"&gt;Some&lt;/span&gt; &lt;span class="n"&gt;child_pid&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Writing this way made it easy for me to switch between C and OCaml; in
both languages, we follow a pattern of calling &lt;code&gt;fork&lt;/code&gt;, then &lt;code&gt;execv&lt;/code&gt; in
the child process. The fact that I can easily re-use my knowledge of
the UNIX APIs across different programming languages is one of the
main reasons I'm excited to learn more systems programming concepts!&lt;/p&gt;
&lt;p&gt;Variants and pattern matching are features I miss when working in
languages like Python. These features make it so easy to look at a
function like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;main&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ref&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"/bin"&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
    &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="nn"&gt;Parser&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse_line&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Error&lt;/span&gt; &lt;span class="o"&gt;_&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;print_error&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;NoOp&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="c"&gt;(* Empty lines should just be treated as no-ops. *)&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Quit&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;exit&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;ChangeDirectory&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;change_directory&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;PathChange&lt;/span&gt; &lt;span class="n"&gt;paths&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;cwd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;Unix&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getcwd&lt;/span&gt; &lt;span class="bp"&gt;()&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
      &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="nn"&gt;List&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;amend_path&lt;/span&gt; &lt;span class="n"&gt;cwd&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;paths&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="nc"&gt;Ok&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nc"&gt;Executable&lt;/span&gt; &lt;span class="n"&gt;execs&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;run_executables&lt;/span&gt; &lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="n"&gt;execs&lt;/span&gt;
  &lt;span class="k"&gt;in&lt;/span&gt;
  &lt;span class="nn"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iter&lt;/span&gt; &lt;span class="n"&gt;process&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and quickly understand all of the different commands &lt;code&gt;osh&lt;/code&gt; supports.&lt;/p&gt;
&lt;p&gt;Although it took me some time to get up and running with Angstrom, I
strongly prefer working with parser combinators to writing an
imperative parser (as I've had to do in Python and Java). Angstrom
makes it easy to build up small parsers and test them in isolation
before composing them into the larger parser you really need. If I
planned to develop a shell with more features, I would probably break
&lt;code&gt;Parser&lt;/code&gt; out into its own file with separate unit tests.&lt;/p&gt;
&lt;h2&gt;Feedback&lt;/h2&gt;
&lt;p&gt;If you give this project a try, let me know how it turned out! I'm
interested in adding more tutorial resources to the OCaml ecosystem,
so feel free to post a PR or issue to
&lt;a href="https://github.com/jsthomas/simple-ocaml-shell"&gt;simple-ocaml-shell&lt;/a&gt;
if you have ideas about how to make these resources better.&lt;/p&gt;</content><category term="OCaml"></category></entry><entry><title>Microbenchmarking Implementations of Map in OCaml</title><link href="https://jsthomas.github.io/map-comparison.html" rel="alternate"></link><published>2017-06-06T00:00:00-04:00</published><updated>2017-06-06T00:00:00-04:00</updated><author><name>Joe Thomas</name></author><id>tag:jsthomas.github.io,2017-06-06:/map-comparison.html</id><summary type="html">&lt;p&gt;A comparison of different implementations of map in OCaml&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;code&gt;Map&lt;/code&gt; is one of the first higher-order functions I remember
encountering when I learned some rudimentary functional programming
topics as an undergraduate. More recently I began learning OCaml. The
&lt;code&gt;map&lt;/code&gt;
&lt;a href="https://github.com/ocaml/ocaml/blob/2691c40f2ff9bc34912db39bc1f17045c9241473/stdlib/list.ml#L80-L82"&gt;implementation&lt;/a&gt;
I found in the standard library was the textbook definition I was
expecting&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;rec&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;function&lt;/span&gt;
   &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;but I was surprised to learn there are actually several
implementations of &lt;code&gt;map&lt;/code&gt; in the OCaml ecosystem. I wanted to know more
about these different implementations and their performance
characteristics. This article summarizes what I learned.&lt;/p&gt;
&lt;p&gt;Part of my motivation to write this post arose from
&lt;a href="https://github.com/ocsigen/lwt/pull/347"&gt;this discussion&lt;/a&gt; of a pull
request that proposes the default &lt;code&gt;map&lt;/code&gt; implementation in &lt;code&gt;lwt&lt;/code&gt; should
be tail recursive. After reading all of the comments, I wanted to
develop experiments that would convince me whether this was a good
idea.&lt;/p&gt;
&lt;h1&gt;Introduction&lt;/h1&gt;
&lt;p&gt;Since I'll introduce several versions of &lt;code&gt;map&lt;/code&gt;, I'll refer to the
implementation above as &lt;code&gt;stdlib&lt;/code&gt;. An important aspect of this version
is that it isn't &lt;em&gt;tail recursive&lt;/em&gt;. A tail recursive function uses
recursion in a specific way; it only calls itself as the final
operation in the function. In OCaml, tail recursive functions get the
benefit of tail-call optimization so that they only use one frame on
the stack. In contrast, the &lt;code&gt;stdlib&lt;/code&gt; implementation takes space on the
stack proportional to the length of the input list. For long enough
lists, this causes a stack overflow.&lt;/p&gt;
&lt;p&gt;We can make a basic tail-recursive version of &lt;code&gt;map&lt;/code&gt; by composing two
standard library functions that are tail recursive: &lt;code&gt;List.rev_map&lt;/code&gt;
(which creates the output of &lt;code&gt;map&lt;/code&gt;, but in reversed order) and
&lt;code&gt;List.rev&lt;/code&gt; which reverses lists. I'll call this naive implementation
&lt;code&gt;ntr&lt;/code&gt; (naive tail recursive). Compared to &lt;code&gt;stdlib&lt;/code&gt;, &lt;code&gt;ntr&lt;/code&gt; allocates
twice as much space on the heap (one list for the output of
&lt;code&gt;List.rev_map&lt;/code&gt;, and a second equally long list for &lt;code&gt;List.rev&lt;/code&gt;) and
spends additional time performing a list traversal. The benefit is
that with this implementation, calling &lt;code&gt;map&lt;/code&gt; on a long list won't
result in a stack overflow.&lt;/p&gt;
&lt;p&gt;As we'll see later in the Results section, the naive tail recursive
implementation is, overall, slower than the &lt;code&gt;stdlib&lt;/code&gt;
implementation. However, there are some optimizations we can apply to
improve the performance of both versions.&lt;/p&gt;
&lt;p&gt;The first trick I call "unrolling". Similar to
&lt;a href="https://en.wikipedia.org/wiki/Loop_unrolling"&gt;loop unrolling in procedural languages&lt;/a&gt;,
the idea is to use cases to &lt;code&gt;map&lt;/code&gt; on groups of list elements so fewer
function calls are needed to complete the work. For example, an
unrolled version of &lt;code&gt;stdlib&lt;/code&gt; looks like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="k"&gt;rec&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
  &lt;span class="k"&gt;match&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="k"&gt;with&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="bp"&gt;[]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;f1&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;f1&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;x3&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;tl&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="k"&gt;let&lt;/span&gt; &lt;span class="n"&gt;f3&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x3&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt;
    &lt;span class="n"&gt;f1&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;f2&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;f3&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="n"&gt;tl&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We get to choose how many elements to unroll (here I picked 3); some
profiling is needed to decide the most appropriate number.&lt;/p&gt;
&lt;p&gt;The second trick I call "hybridizing". The &lt;code&gt;stdlib&lt;/code&gt; version is faster,
but isn't safe for long lists. The tail recursive implementation is
slow, but safe for all lists. When we "hybridize" the two, we use the
faster version up to some fixed number of elements (e.g. 1000), and
then switch to the safe version for the remainder of the list.&lt;/p&gt;
&lt;p&gt;These two optimizations are useful for understanding the
implementations of &lt;code&gt;map&lt;/code&gt; we find in other libraries. For example, both
&lt;a href="https://github.com/janestreet/base/blob/f10483e957206dc6b656a28ffec667d8b068c149/src/list.ml#L311-L345"&gt;&lt;code&gt;base&lt;/code&gt;&lt;/a&gt;
and
&lt;a href="https://github.com/c-cube/ocaml-containers/blob/d659ba677e3dbd95430f59b3794ac2f2a5677d61/src/core/CCList.ml#L20-L37"&gt;&lt;code&gt;containers&lt;/code&gt;&lt;/a&gt;
use an unrolled &lt;code&gt;stdlib&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt;, hybridized with an
&lt;code&gt;ntr&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Looking at &lt;code&gt;ntr&lt;/code&gt;, one might ask: Is it strictly necessary to use
additional heap space to get the implementation to be tail recursive?
The answer is no. The &lt;code&gt;batteries&lt;/code&gt; package
&lt;a href="https://github.com/ocaml-batteries-team/batteries-included/blob/c10c65a203a7590b15b9a370f66e8c2884817428/src/batList.mlv#L163-L173"&gt;implements &lt;code&gt;map&lt;/code&gt;&lt;/a&gt;
so that the work is done by a single tail recursive function, creating
one new list on the heap. To achieve this, the implementation uses
mutable state and casting to avoid a second list traversal
(specifically,
&lt;a href="https://github.com/ocaml-batteries-team/batteries-included/blob/c10c65a203a7590b15b9a370f66e8c2884817428/src/batList.mlv#L69"&gt;here&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;As with any optimization, one makes tradeoffs between elegance,
performance, and the language features one considers acceptable to
use. I wanted to know:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Which version is the fastest in practice?&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;How much speed does one lose using the safer tail recursive version?&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Both &lt;code&gt;base&lt;/code&gt; and &lt;code&gt;containers&lt;/code&gt; decided to hybridize with an &lt;code&gt;ntr&lt;/code&gt;-style
&lt;code&gt;map&lt;/code&gt; for safety. But the &lt;code&gt;batteries&lt;/code&gt; implementation is also robust to
stack overflow. That led to one final question:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;How fast is an unrolled &lt;code&gt;stdlib&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt; hybridized with a
  &lt;code&gt;batteries&lt;/code&gt;-style &lt;code&gt;map&lt;/code&gt;?&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Experimental Setup&lt;/h1&gt;
&lt;p&gt;In 2014, Jane Street introduced a
&lt;a href="https://github.com/janestreet/core_bench"&gt;library&lt;/a&gt; for
microbenchmarking called &lt;code&gt;core_bench&lt;/code&gt;. As they explain
&lt;a href="https://blogs.janestreet.com/core_bench-micro-benchmarking-for-ocaml/"&gt;on their blog&lt;/a&gt;,
&lt;code&gt;core_bench&lt;/code&gt; is intended to measure the performance of small pieces of
OCaml code. This library helps developers to better understand the
cost of individual operations, like &lt;code&gt;map&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;There are a couple benefits to measuring &lt;code&gt;map&lt;/code&gt; implementations with
&lt;code&gt;core_bench&lt;/code&gt;.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The library makes it easy to track both time and use of the heap.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Once you specify your test, &lt;code&gt;core_bench&lt;/code&gt; automatically provides
   many &lt;a href="https://github.com/janestreet/core_bench/wiki/Getting-Started-with-Core_bench"&gt;command line
   options&lt;/a&gt;
   to help you present your test data in different ways.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The library uses statistical techniques (bootstrapping and linear
   regression) to reduce many runs worth of data to a small number of
   meaningful performance metrics that account for the amortized cost
   of garbage collection and error introduced by system activity.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I wrote
&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/maptest.ml"&gt;this program&lt;/a&gt;
to compare performance between the six implementations I described
above. The program includes the batteries-hybrid I described above,
which I'll refer to as &lt;code&gt;batt-hybr&lt;/code&gt;. Other test details:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I tested each algorithm against lists of lengths &lt;span class="math"&gt;\(N=10^2, 10^3,
  10^4\)&lt;/span&gt; and &lt;span class="math"&gt;\(10^5\)&lt;/span&gt;. On my system, &lt;span class="math"&gt;\(N=10^5\)&lt;/span&gt; was the highest power of 10
  for which the &lt;code&gt;stdlib&lt;/code&gt; implementation did not fail due to a stack
  overflow.&lt;/li&gt;
&lt;li&gt;Each list consisted of integer elements (all 0), and the function
  mapped onto the list simply added one to each element.&lt;/li&gt;
&lt;li&gt;I ran these tests on a Lenovo X220, Intel Core i5-2520M CPU (2.50GHz Ã
  4 cores), with 4GB RAM.&lt;/li&gt;
&lt;li&gt;I used the OCaml 4.03.0 compiler, and compiled to native code
  without using &lt;code&gt;flambda&lt;/code&gt;. (&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/makefile"&gt;This
  makefile&lt;/a&gt;
  gives the full specifications.)&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Results&lt;/h1&gt;
&lt;p&gt;For each list size, &lt;code&gt;core_bench&lt;/code&gt; produces a table with several metrics besides time:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;mWd&lt;/code&gt; : Words allocated on the minor heap.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;mjWd&lt;/code&gt; : Words allocated on the major heap.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Prom&lt;/code&gt; : Words promoted from minor to major heap.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The library also allows us to produce 95% confidence intervals and
&lt;span class="math"&gt;\(R^2\)&lt;/span&gt; values for the time estimates.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 100&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;ââââââââââââââ¬âââââââââââ¬âââââââââââ¬ââââââââââââââââ¬ââââââââââ¬âââââââââââ¬âââââââââââ¬âââââââââââââ&lt;/span&gt;
&lt;span class="err"&gt;â Name       â Time R^2 â Time/Run â          95ci â mWd/Run â mjWd/Run â Prom/Run â Percentage â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ¼âââââââââââ¼âââââââââââ¼ââââââââââââââââ¼ââââââââââ¼âââââââââââ¼âââââââââââ¼âââââââââââââ¤&lt;/span&gt;
&lt;span class="err"&gt;â ntr        â     1.00 â 741.20ns â -0.23% +0.22% â 609.01w â    0.53w â    0.53w â    100.00% â&lt;/span&gt;
&lt;span class="err"&gt;â containers â     1.00 â 439.55ns â -0.64% +0.67% â 304.03w â    0.17w â    0.17w â     59.30% â&lt;/span&gt;
&lt;span class="err"&gt;â batteries  â     1.00 â 581.65ns â -0.14% +0.16% â 309.01w â    0.35w â    0.35w â     78.47% â&lt;/span&gt;
&lt;span class="err"&gt;â base       â     1.00 â 438.63ns â -0.19% +0.20% â 304.03w â    0.16w â    0.16w â     59.18% â&lt;/span&gt;
&lt;span class="err"&gt;â stdlib     â     1.00 â 610.45ns â -0.10% +0.11% â 304.01w â    0.17w â    0.17w â     82.36% â&lt;/span&gt;
&lt;span class="err"&gt;â batt-hybr  â     1.00 â 426.76ns â -0.15% +0.17% â 304.03w â    0.17w â    0.17w â     57.58% â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ´âââââââââââ´âââââââââââ´ââââââââââââââââ´ââââââââââ´âââââââââââ´âââââââââââ´âââââââââââââ&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 1000&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;ââââââââââââââ¬âââââââââââ¬âââââââââââ¬ââââââââââââââââ¬ââââââââââ¬âââââââââââ¬âââââââââââ¬âââââââââââââ&lt;/span&gt;
&lt;span class="err"&gt;â Name       â Time R^2 â Time/Run â          95ci â mWd/Run â mjWd/Run â Prom/Run â Percentage â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ¼âââââââââââ¼âââââââââââ¼ââââââââââââââââ¼ââââââââââ¼âââââââââââ¼âââââââââââ¼âââââââââââââ¤&lt;/span&gt;
&lt;span class="err"&gt;â ntr        â     1.00 â   8.84us â -0.14% +0.15% â  6.01kw â   52.08w â   52.08w â    100.00% â&lt;/span&gt;
&lt;span class="err"&gt;â containers â     1.00 â   5.07us â -0.13% +0.15% â  3.00kw â   17.23w â   17.23w â     57.34% â&lt;/span&gt;
&lt;span class="err"&gt;â batteries  â     1.00 â   6.57us â -0.14% +0.14% â  3.01kw â   34.71w â   34.71w â     74.32% â&lt;/span&gt;
&lt;span class="err"&gt;â base       â     1.00 â   4.99us â -0.20% +0.24% â  3.00kw â   17.08w â   17.08w â     56.44% â&lt;/span&gt;
&lt;span class="err"&gt;â stdlib     â     1.00 â   6.84us â -0.10% +0.10% â  3.00kw â   17.22w â   17.22w â     77.34% â&lt;/span&gt;
&lt;span class="err"&gt;â batt-hybr  â     1.00 â   4.96us â -0.13% +0.13% â  3.00kw â   17.07w â   17.07w â     56.10% â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ´âââââââââââ´âââââââââââ´ââââââââââââââââ´ââââââââââ´âââââââââââ´âââââââââââ´âââââââââââââ&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 10,000&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;ââââââââââââââ¬âââââââââââ¬âââââââââââ¬ââââââââââââââââ¬ââââââââââ¬âââââââââââ¬âââââââââââ¬âââââââââââââ&lt;/span&gt;
&lt;span class="err"&gt;â Name       â Time R^2 â Time/Run â          95ci â mWd/Run â mjWd/Run â Prom/Run â Percentage â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ¼âââââââââââ¼âââââââââââ¼ââââââââââââââââ¼ââââââââââ¼âââââââââââ¼âââââââââââ¼âââââââââââââ¤&lt;/span&gt;
&lt;span class="err"&gt;â ntr        â     0.99 â 203.11us â -0.45% +0.53% â 60.01kw â   5.40kw â   5.40kw â    100.00% â&lt;/span&gt;
&lt;span class="err"&gt;â containers â     1.00 â 144.95us â -0.50% +0.60% â 48.01kw â   3.04kw â   3.04kw â     71.37% â&lt;/span&gt;
&lt;span class="err"&gt;â batteries  â     1.00 â 136.87us â -0.51% +0.63% â 30.01kw â   3.64kw â   3.64kw â     67.39% â&lt;/span&gt;
&lt;span class="err"&gt;â base       â     1.00 â 130.85us â -0.34% +0.39% â 44.98kw â   2.66kw â   2.66kw â     64.42% â&lt;/span&gt;
&lt;span class="err"&gt;â stdlib     â     1.00 â 118.70us â -0.30% +0.29% â 30.00kw â   1.80kw â   1.80kw â     58.44% â&lt;/span&gt;
&lt;span class="err"&gt;â batt-hybr  â     1.00 â 106.91us â -0.42% +0.52% â 30.01kw â   2.22kw â   2.22kw â     52.64% â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ´âââââââââââ´âââââââââââ´ââââââââââââââââ´ââââââââââ´âââââââââââ´âââââââââââ´âââââââââââââ&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Map Benchmark, N = 100,000&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;ââââââââââââââ¬âââââââââââ¬âââââââââââ¬ââââââââââââââââ¬âââââââââââ¬âââââââââââ¬âââââââââââ¬âââââââââââââ&lt;/span&gt;
&lt;span class="err"&gt;â Name       â Time R^2 â Time/Run â          95ci â  mWd/Run â mjWd/Run â Prom/Run â Percentage â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ¼âââââââââââ¼âââââââââââ¼ââââââââââââââââ¼âââââââââââ¼âââââââââââ¼âââââââââââ¼âââââââââââââ¤&lt;/span&gt;
&lt;span class="err"&gt;â ntr        â     0.98 â  10.27ms â -2.39% +2.32% â 600.02kw â 411.83kw â 411.83kw â     94.33% â&lt;/span&gt;
&lt;span class="err"&gt;â containers â     0.99 â  10.62ms â -2.19% +1.83% â 588.02kw â 404.91kw â 404.91kw â     97.61% â&lt;/span&gt;
&lt;span class="err"&gt;â batteries  â     1.00 â   7.19ms â -0.78% +0.79% â 300.02kw â 300.35kw â 300.35kw â     66.02% â&lt;/span&gt;
&lt;span class="err"&gt;â base       â     0.99 â  10.88ms â -1.54% +1.41% â 584.99kw â 397.60kw â 397.60kw â    100.00% â&lt;/span&gt;
&lt;span class="err"&gt;â stdlib     â     0.99 â   6.33ms â -1.08% +1.07% â 300.01kw â 171.73kw â 171.73kw â     58.18% â&lt;/span&gt;
&lt;span class="err"&gt;â batt-hybr  â     0.93 â   6.09ms â -4.30% +4.63% â 300.02kw â 285.46kw â 285.46kw â     55.93% â&lt;/span&gt;
&lt;span class="err"&gt;ââââââââââââââ´âââââââââââ´âââââââââââ´ââââââââââââââââ´âââââââââââ´âââââââââââ´âââââââââââ´âââââââââââââ&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;A few things I noticed about the data:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The tail recursive implementation is slow, but not always the
  slowest. In the &lt;span class="math"&gt;\(N=10^5\)&lt;/span&gt; case, &lt;code&gt;ntr&lt;/code&gt;,&lt;code&gt;base&lt;/code&gt;, and &lt;code&gt;containers&lt;/code&gt; show
  similar performance; this makes sense given they have the same
  behavior after a prefix of the list.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;For short lists, &lt;code&gt;base&lt;/code&gt;, &lt;code&gt;containers&lt;/code&gt;, and &lt;code&gt;batt-hybr&lt;/code&gt; are fastest,
  likely because of unrolling.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;We can see from the &lt;code&gt;mWd&lt;/code&gt; and &lt;code&gt;mjWd&lt;/code&gt; columns that &lt;code&gt;ntr&lt;/code&gt; uses the
  most heap space, as we would expect.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;As we increase the size of the list, &lt;code&gt;stdlib&lt;/code&gt; gets faster relative
  to &lt;code&gt;ntr&lt;/code&gt;; I suspect this can be attributed to the cost of garbage
  collection.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Overall, &lt;code&gt;batt-hybr&lt;/code&gt; appears to have the best performance (though in
  the &lt;span class="math"&gt;\(N=10^5\)&lt;/span&gt; case, the confidence interval is large enough that we
  can't conclude &lt;code&gt;batt-hybr&lt;/code&gt; is faster than &lt;code&gt;stdlib&lt;/code&gt;, and the &lt;span class="math"&gt;\(R^2\)&lt;/span&gt;
  value is a bit low).&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Conclusions&lt;/h1&gt;
&lt;p&gt;The data above suggest three main findings:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The stack-based standard library implementation of &lt;code&gt;map&lt;/code&gt; is faster
   than the naive tail recursive implementation, taking about 60-80%
   of the time to do the same work depending on the size of the list.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;There are clear benefits to both unrolling and
   hybridizing. Hybridizing lets us take an implementation that
   performs well on long lists (&lt;code&gt;batteries&lt;/code&gt;), and make it even better
   by combining it with one that's fast on short lists, to produce
   &lt;code&gt;batt-hybr&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Overall, the data show we don't have to give up safety (resistance
   to stack overflow) to get better performance. A tail recursive
   implementation can be quite competitive, albeit more complex.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h1&gt;Discussion&lt;/h1&gt;
&lt;p&gt;A follow up question to this analysis, in the context of the
discussion of &lt;code&gt;Lwt_list.map_p&lt;/code&gt; is: "How significant is the cost of
&lt;code&gt;map&lt;/code&gt; compared to other operations?" To partially address this, I
wrote
&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/bufftest.ml"&gt;another program&lt;/a&gt;
that measures how long it takes to write 4096 bytes to a Unix pipe
using &lt;code&gt;Lwt_unix.write&lt;/code&gt;, and then read it back using &lt;code&gt;Lwt_unix.read&lt;/code&gt;. Using
&lt;code&gt;core_bench&lt;/code&gt;, I found:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Unix Pipe Read/Write Benchmark&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="err"&gt;âââââââââââ¬âââââââââââ¬ââââââââââââââââ¬ââââââââââ¬âââââââââââââ&lt;/span&gt;
&lt;span class="err"&gt;âTime R^2 â Time/Run â          95ci â mWd/Run â Percentage â&lt;/span&gt;
&lt;span class="err"&gt;âââââââââââ¼âââââââââââ¼ââââââââââââââââ¼ââââââââââ¼âââââââââââââ¤&lt;/span&gt;
&lt;span class="err"&gt;â    1.00 â 893.33ns â -0.16% +0.18% â  56.00w â    100.00% â&lt;/span&gt;
&lt;span class="err"&gt;âââââââââââ´âââââââââââ´ââââââââââââââââ´ââââââââââ´âââââââââââââ&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It seems reasonable to estimate that &lt;code&gt;Lwt_list.map_p&lt;/code&gt; would primarily
be applied to IO operations like the ones in this experiment. In that
case, the data suggest the cost per element of applying the slowest
&lt;code&gt;map&lt;/code&gt; implementation (&lt;code&gt;ntr&lt;/code&gt;) is about 0.82% of the cost of one 4KB
read/write operation on a unix pipe. In the context of &lt;code&gt;Lwt&lt;/code&gt;, it seems
reasonable to conclude the implementation of &lt;code&gt;map&lt;/code&gt; isn't a significant
concern; the real cost is performing IO. In light of that, it seems
preferable to use an implementation that cannot cause a stack
overflow.&lt;/p&gt;
&lt;p&gt;A second question that might be asked about this analysis is: "Was it
necessary to introduce the added complexity of &lt;code&gt;core_bench&lt;/code&gt; to measure
the performance of &lt;code&gt;map&lt;/code&gt;?" For example, one might set up a performance
test with just successive calls to &lt;code&gt;Time.now&lt;/code&gt; or
&lt;code&gt;Unix.gettimeofday&lt;/code&gt;. In an earlier draft of this article, I tried such
an
&lt;a href="https://github.com/jsthomas/ocaml-analysis/blob/master/map/profile.ml"&gt;approach&lt;/a&gt;,
producing some misleading data. In that test, I did a full garbage
collection in between runs (applications of &lt;code&gt;map&lt;/code&gt;), which suppressed
that (nontrivial) cost and made the tail recursive implementation
appear quite fast. &lt;code&gt;core_bench&lt;/code&gt; does a much better job incorporating
the cost of garbage collection by varying the number of test runs
performed in a row and then establishing a trend (with linear
regression) that reflects the amortized cost of garbage collection per
run.&lt;/p&gt;
&lt;p&gt;One interesting finding did arise from my earlier tests: for short
lists, allocating memory on the heap actually appears to be faster
than creating frames on the stack. Since the tests perform a full
garbage collection between test runs, the timings show only the cost
of allocating space on the heap. This produced data like the
following:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary Statistics, &lt;span class="math"&gt;\(N=10^3\)&lt;/span&gt; Garbage Collected Map Benchmark Times (Î¼s)&lt;/strong&gt;&lt;/p&gt;
&lt;table class="dataframe"&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;Std. Lib.&lt;/th&gt;
&lt;th&gt;NTR&lt;/th&gt;
&lt;th&gt;Base&lt;/th&gt;
&lt;th&gt;Batteries&lt;/th&gt;
&lt;th&gt;Containers&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;th&gt;Mean&lt;/th&gt;
&lt;td&gt;27.18&lt;/td&gt;
&lt;td&gt;27.21&lt;/td&gt;
&lt;td&gt;11.23&lt;/td&gt;
&lt;td&gt;19.03&lt;/td&gt;
&lt;td&gt;13.06&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Min&lt;/th&gt;
&lt;td&gt;15.97&lt;/td&gt;
&lt;td&gt;14.07&lt;/td&gt;
&lt;td&gt;6.91&lt;/td&gt;
&lt;td&gt;9.06&lt;/td&gt;
&lt;td&gt;7.87&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;25%&lt;/th&gt;
&lt;td&gt;18.84&lt;/td&gt;
&lt;td&gt;17.88&lt;/td&gt;
&lt;td&gt;7.15&lt;/td&gt;
&lt;td&gt;10.97&lt;/td&gt;
&lt;td&gt;10.01&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;50%&lt;/th&gt;
&lt;td&gt;20.03&lt;/td&gt;
&lt;td&gt;19.07&lt;/td&gt;
&lt;td&gt;8.11&lt;/td&gt;
&lt;td&gt;15.50&lt;/td&gt;
&lt;td&gt;10.01&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;75%&lt;/th&gt;
&lt;td&gt;23.13&lt;/td&gt;
&lt;td&gt;22.17&lt;/td&gt;
&lt;td&gt;12.87&lt;/td&gt;
&lt;td&gt;18.84&lt;/td&gt;
&lt;td&gt;10.97&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Max&lt;/th&gt;
&lt;td&gt;849.01&lt;/td&gt;
&lt;td&gt;576.02&lt;/td&gt;
&lt;td&gt;379.80&lt;/td&gt;
&lt;td&gt;622.03&lt;/td&gt;
&lt;td&gt;434.88&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;Summary Statistics, &lt;span class="math"&gt;\(N=10^4\)&lt;/span&gt; Garbage Collected Map Benchmark Times (Î¼s)&lt;/strong&gt;&lt;/p&gt;
&lt;table class="dataframe"&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;Std. Lib.&lt;/th&gt;
&lt;th&gt;NTR&lt;/th&gt;
&lt;th&gt;Base&lt;/th&gt;
&lt;th&gt;Batteries&lt;/th&gt;
&lt;th&gt;Containers&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;th&gt;Mean&lt;/th&gt;
&lt;td&gt;230.23&lt;/td&gt;
&lt;td&gt;216.60&lt;/td&gt;
&lt;td&gt;141.39&lt;/td&gt;
&lt;td&gt;144.59&lt;/td&gt;
&lt;td&gt;161.56&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Min&lt;/th&gt;
&lt;td&gt;77.01&lt;/td&gt;
&lt;td&gt;73.91&lt;/td&gt;
&lt;td&gt;61.04&lt;/td&gt;
&lt;td&gt;54.84&lt;/td&gt;
&lt;td&gt;63.18&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;25%&lt;/th&gt;
&lt;td&gt;97.04&lt;/td&gt;
&lt;td&gt;86.07&lt;/td&gt;
&lt;td&gt;67.95&lt;/td&gt;
&lt;td&gt;58.89&lt;/td&gt;
&lt;td&gt;70.81&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;50%&lt;/th&gt;
&lt;td&gt;121.95&lt;/td&gt;
&lt;td&gt;99.90&lt;/td&gt;
&lt;td&gt;75.10&lt;/td&gt;
&lt;td&gt;61.99&lt;/td&gt;
&lt;td&gt;77.01&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;75%&lt;/th&gt;
&lt;td&gt;193.83&lt;/td&gt;
&lt;td&gt;284.91&lt;/td&gt;
&lt;td&gt;148.59&lt;/td&gt;
&lt;td&gt;118.26&lt;/td&gt;
&lt;td&gt;175.24&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Max&lt;/th&gt;
&lt;td&gt;12719.87&lt;/td&gt;
&lt;td&gt;2753.97&lt;/td&gt;
&lt;td&gt;2960.21&lt;/td&gt;
&lt;td&gt;3616.09&lt;/td&gt;
&lt;td&gt;13603.93&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;When we ignore the time spent on garbage collection, we see that &lt;code&gt;ntr&lt;/code&gt;
is surprisingly competitive, especially in comparison with &lt;code&gt;stdlib&lt;/code&gt;;
the difference between the two implementations, of course, is that
&lt;code&gt;ntr&lt;/code&gt; allocates more memory on the heap while &lt;code&gt;stdlib&lt;/code&gt; creates more
stack frames.&lt;/p&gt;
&lt;h2&gt;Notes&lt;/h2&gt;
&lt;p&gt;Thanks to &lt;a href="https://github.com/aantron"&gt;Anton Bachin&lt;/a&gt; and
&lt;a href="https://github.com/c-cube/"&gt;Simon Cruanes&lt;/a&gt; for reading drafts of this
post.&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="OCaml"></category></entry></feed>